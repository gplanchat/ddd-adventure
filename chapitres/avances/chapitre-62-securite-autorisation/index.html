<!doctype html><html lang=fr-fr><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><title>Chapitre 62 : S√©curit√© et Autorisation - Prot√©ger votre API Platform | DDD Adventure</title><meta name=robots content="noindex"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Ma√Ætriser la s√©curit√© et l'autorisation dans une API Platform avec DDD"><meta name=keywords content="Documentation,Hugo,Hugo Theme,Bootstrap"><meta name=author content="Colin Wilson - Lotus Labs"><meta name=email content="support@aigis.uk"><meta name=website content="https://lotusdocs.dev"><meta name=Version content="v0.1.0"><link rel=icon href=http://localhost:1313/favicon.ico sizes=any><link rel=icon type=image/svg+xml href=http://localhost:1313/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=http://localhost:1313/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=http://localhost:1313/site.webmanifest><meta property="og:title" content="Chapitre 62 : S√©curit√© et Autorisation - Prot√©ger votre API Platform"><meta property="og:description" content="Ma√Ætriser la s√©curit√© et l'autorisation dans une API Platform avec DDD"><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/chapitres/avances/chapitre-62-securite-autorisation/"><meta property="og:image" content="http://localhost:1313/opengraph/card-base-2_hu_6c1d84b7cd255f02.png"><meta property="article:section" content="chapitres"><meta property="article:published_time" content="2024-12-19T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-19T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="http://localhost:1313/opengraph/card-base-2_hu_6c1d84b7cd255f02.png"><meta name=twitter:title content="Chapitre 62 : S√©curit√© et Autorisation - Prot√©ger votre API Platform"><meta name=twitter:description content="Ma√Ætriser la s√©curit√© et l'autorisation dans une API Platform avec DDD"><link rel=alternate type=application/atom+xml title="Atom feed for DDD Adventure" href=/index.xml><script type=text/javascript src=http://localhost:1313/docs/js/flexsearch.bundle.js></script><link rel=stylesheet href=/docs/scss/style.css crossorigin=anonymous></head><body><div class=content><div class="page-wrapper toggled"><nav id=sidebar class=sidebar-wrapper><div class=sidebar-brand><a href=/ aria-label=HomePage alt=HomePage><svg id="Layer_1" viewBox="0 0 250 250"><path d="m143 39.5c-18 0-18 18-18 18s0-18-18-18H22c-2.76.0-5 2.24-5 5v143c0 2.76 2.24 5 5 5h76c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h76c2.76.0 5-2.24 5-5V44.5c0-2.76-2.24-5-5-5h-85zM206 163c0 1.38-1.12 2.5-2.5 2.5H143c-18 0-18 18-18 18s0-18-18-18H46.5c-1.38.0-2.5-1.12-2.5-2.5V69c0-1.38 1.12-2.5 2.5-2.5H98c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h51.5c1.38.0 2.5 1.12 2.5 2.5v94z" style="fill:#06f"/></svg></a></div><div class=sidebar-content style="height:calc(100% - 131px)"><ul class=sidebar-menu><li class="sidebar-dropdown no-icon"><button class=btn>
Chapitres Fondamentaux</button><div class=sidebar-submenu><ul><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/fondamentaux/chapitre-01-introduction-event-storming-ddd/>Chapitre 1 : Introduction au Domain-Driven Design et Event Storming</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/fondamentaux/chapitre-02-impact-mapping/>Chapitre 2 : L'Impact Mapping - Aligner le Produit sur les Objectifs Business</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/fondamentaux/chapitre-03-atelier-event-storming/>Chapitre 3 : L'Atelier Event Storming - Guide Pratique</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/fondamentaux/chapitre-04-example-mapping/>Chapitre 4 : L'Example Mapping - D√©tailer les R√®gles M√©tier</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/fondamentaux/chapitre-05-complexite-accidentelle-essentielle/>Chapitre 5 : Complexit√© Accidentelle vs Essentielle - Le Choix Architectural</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/fondamentaux/chapitre-06-granularite-choix-architecturaux/>Chapitre 6 : Granularit√© des Choix Architecturaux</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/fondamentaux/chapitre-07-modeles-riches-vs-anemiques/>Chapitre 7 : Mod√®les Riches vs Mod√®les An√©miques</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/fondamentaux/chapitre-08-architecture-evenementielle/>Chapitre 8 : Architecture √âv√©nementielle</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/fondamentaux/chapitre-09-repositories-persistance/>Chapitre 9 : Repositories et Persistance</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/fondamentaux/chapitre-10-choix-type-stockage/>Chapitre 15 : Choix du Type de Stockage</a></li></ul></div></li><li class="sidebar-dropdown no-icon"><button class=btn>
Chapitres Optionnels</button><div class=sidebar-submenu><ul><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/optionnels/chapitre-13-architecture-cqrs/>Chapitre 15 : Architecture CQRS avec API Platform</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/optionnels/chapitre-12-architecture-cqs/>Chapitre 15 : Architecture CQS - Command Query Separation</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/optionnels/chapitre-11-event-sourcing/>Chapitre 15 : Event Sourcing - La Source de V√©rit√©</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/optionnels/chapitre-14-cqrs-event-sourcing-combines/>Chapitre 15 : CQRS + Event Sourcing Combin√©s</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/optionnels/chapitre-15-projections-event-sourcing/>Chapitre 15 : Projections Event Sourcing</a></li></ul></div></li><li class="sidebar-dropdown no-icon"><button class=btn>
Chapitres de Stockage</button><div class=sidebar-submenu><ul><li class="sidebar-dropdown nested no-icon"><button class=btn>
Stockage SQL</button><div class=sidebar-submenu><ul><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/sql/chapitre-16-stockage-sql-classique/>Chapitre 16 : Stockage SQL - Approche Classique</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/sql/chapitre-17-stockage-sql-cqs/>Chapitre 17 : Stockage SQL - Approche CQS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/sql/chapitre-18-stockage-sql-cqrs/>Chapitre 18 : Stockage SQL - Approche CQRS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/sql/chapitre-19-stockage-sql-event-sourcing/>Chapitre 19 : Stockage SQL - Event Sourcing Seul</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/sql/chapitre-20-stockage-sql-event-sourcing-cqs/>Chapitre 58 : Stockage SQL - Event Sourcing + CQS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/sql/chapitre-21-stockage-sql-event-sourcing-cqrs/>Chapitre 59 : Stockage SQL - Event Sourcing + CQRS</a></li></ul></div></li><li class="sidebar-dropdown nested no-icon"><button class=btn>
Stockage API</button><div class=sidebar-submenu><ul><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/api/chapitre-26-stockage-api-event-sourcing-cqs/>Chapitre 26 : Stockage API - Event Sourcing + CQS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/api/chapitre-27-stockage-api-event-sourcing-cqrs/>Chapitre 27 : Stockage API - Event Sourcing + CQRS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/api/chapitre-22-stockage-api-classique/>Chapitre 60 : Stockage API - Approche Classique</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/api/chapitre-23-stockage-api-cqs/>Chapitre 61 : Stockage API - Approche CQS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/api/chapitre-24-stockage-api-cqrs/>Chapitre 62 : Stockage API - Approche CQRS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/api/chapitre-25-stockage-api-event-sourcing/>Chapitre 63 : Stockage API - Event Sourcing Seul</a></li></ul></div></li><li class="sidebar-dropdown nested no-icon"><button class=btn>
Stockage MongoDB</button><div class=sidebar-submenu><ul><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/mongodb/chapitre-28-stockage-mongodb-classique/>Chapitre 28 : Stockage MongoDB - Approche Classique</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/mongodb/chapitre-29-stockage-mongodb-cqs/>Chapitre 29 : Stockage MongoDB - Approche CQS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/mongodb/chapitre-30-stockage-mongodb-cqrs/>Chapitre 30 : Stockage MongoDB - Approche CQRS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/mongodb/chapitre-31-stockage-mongodb-event-sourcing/>Chapitre 31 : Stockage MongoDB - Event Sourcing</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/mongodb/chapitre-32-stockage-mongodb-event-sourcing-cqs/>Stockage MongoDB - Event Sourcing + CQS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/mongodb/chapitre-33-stockage-mongodb-event-sourcing-cqrs/>Stockage MongoDB - Event Sourcing + CQRS</a></li></ul></div></li><li class="sidebar-dropdown nested no-icon"><button class=btn>
Stockage ElasticSearch</button><div class=sidebar-submenu><ul><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/elasticsearch/chapitre-34-stockage-elasticsearch-classique/>Stockage ElasticSearch - Approche Classique</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/elasticsearch/chapitre-35-stockage-elasticsearch-cqs/>Stockage ElasticSearch - CQS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/elasticsearch/chapitre-36-stockage-elasticsearch-cqrs/>Stockage ElasticSearch - CQRS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/elasticsearch/chapitre-37-stockage-elasticsearch-event-sourcing/>Stockage ElasticSearch - Event Sourcing</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/elasticsearch/chapitre-38-stockage-elasticsearch-event-sourcing-cqs/>Stockage ElasticSearch - Event Sourcing + CQS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/elasticsearch/chapitre-39-stockage-elasticsearch-event-sourcing-cqrs/>Stockage ElasticSearch - Event Sourcing + CQRS</a></li></ul></div></li><li class="sidebar-dropdown nested no-icon"><button class=btn>
Stockage In-Memory</button><div class=sidebar-submenu><ul><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/in-memory/chapitre-40-stockage-in-memory-classique/>Stockage In-Memory - Approche Classique</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/in-memory/chapitre-41-stockage-in-memory-cqs/>Stockage In-Memory - CQS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/in-memory/chapitre-42-stockage-in-memory-cqrs/>Stockage In-Memory - CQRS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/in-memory/chapitre-43-stockage-in-memory-event-sourcing/>Stockage In-Memory - Event Sourcing</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/in-memory/chapitre-44-stockage-in-memory-event-sourcing-cqs/>Stockage In-Memory - Event Sourcing + CQS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/in-memory/chapitre-45-stockage-in-memory-event-sourcing-cqrs/>Stockage In-Memory - Event Sourcing + CQRS</a></li></ul></div></li><li class="sidebar-dropdown nested no-icon"><button class=btn>
Stockage Composite pilot√© par Temporal</button><div class=sidebar-submenu><ul><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/temporal/chapitre-46-stockage-temporal-classique/>Stockage Temporal - Approche Classique</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/temporal/chapitre-47-stockage-temporal-cqs/>Stockage Temporal - CQS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/temporal/chapitre-48-stockage-temporal-cqrs/>Stockage Temporal - CQRS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/temporal/chapitre-49-stockage-temporal-event-sourcing/>Stockage Temporal - Event Sourcing</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/temporal/chapitre-50-stockage-temporal-event-sourcing-cqs/>Stockage Temporal - Event Sourcing + CQS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/temporal/chapitre-51-stockage-temporal-event-sourcing-cqrs/>Stockage Temporal - Event Sourcing + CQRS</a></li></ul></div></li><li class="sidebar-dropdown nested no-icon"><button class=btn>
Stockage Multi-sources</button><div class=sidebar-submenu><ul><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/multi-sources/chapitre-52-stockage-multi-sources-classique/>Stockage Multi-sources - Approche Classique</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/multi-sources/chapitre-53-stockage-multi-sources-cqs/>Stockage Multi-sources - CQS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/multi-sources/chapitre-54-stockage-multi-sources-cqrs/>Stockage Multi-sources - CQRS</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/multi-sources/chapitre-55-stockage-multi-sources-event-sourcing/>Stockage Multi-sources avec Event Sourcing</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/multi-sources/chapitre-56-stockage-multi-sources-strategies-avancees/>Strat√©gies Avanc√©es de R√©plication Multi-sources</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/stockage/multi-sources/chapitre-57-stockage-multi-sources-resolution-conflits/>R√©solution de Conflits Multi-sources</a></li></ul></div></li></ul></div></li><li class="sidebar-dropdown no-icon"><button class=btn>
Chapitres Techniques</button><div class=sidebar-submenu><ul><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/techniques/chapitre-58-gestion-donnees-validation/>Chapitre 58 : Gestion des Donn√©es et Validation</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/techniques/chapitre-59-pagination-performance/>Chapitre 59 : Pagination et Performance</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/techniques/chapitre-60-gestion-erreurs-observabilite/>Chapitre 60 : Gestion d'Erreurs et Observabilit√©</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/techniques/chapitre-61-tests-qualite/>Chapitre 61 : Tests et Qualit√©</a></li></ul></div></li><li class="sidebar-dropdown no-icon current active"><button class=btn>
Chapitres Avanc√©s</button><div class="sidebar-submenu d-block"><ul><li class="current no-icon"><a class=sidebar-nested-link href=http://localhost:1313/chapitres/avances/chapitre-62-securite-autorisation/>Chapitre 62 : S√©curit√© et Autorisation - Prot√©ger votre API Platform</a></li><li class=no-icon><a class=sidebar-nested-link href=http://localhost:1313/chapitres/avances/chapitre-63-frontend-integration/>Chapitre 63 : Frontend et Int√©gration - Connecter votre Interface Utilisateur</a></li></ul></div></li></ul></div><ul class="sidebar-footer list-unstyled mb-0"></ul></nav><main class="page-content bg-transparent"><div id=top-header class="top-header d-print-none"><div class="header-bar d-flex justify-content-between"><div class="d-flex align-items-center"><a href=/ class="logo-icon me-3" aria-label=HomePage alt=HomePage><div class=small><svg id="Layer_1" viewBox="0 0 250 250"><path d="m143 39.5c-18 0-18 18-18 18s0-18-18-18H22c-2.76.0-5 2.24-5 5v143c0 2.76 2.24 5 5 5h76c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h76c2.76.0 5-2.24 5-5V44.5c0-2.76-2.24-5-5-5h-85zM206 163c0 1.38-1.12 2.5-2.5 2.5H143c-18 0-18 18-18 18s0-18-18-18H46.5c-1.38.0-2.5-1.12-2.5-2.5V69c0-1.38 1.12-2.5 2.5-2.5H98c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h51.5c1.38.0 2.5 1.12 2.5 2.5v94z" style="fill:#06f"/></svg></div><div class=big><svg id="Layer_1" viewBox="0 0 250 250"><path d="m143 39.5c-18 0-18 18-18 18s0-18-18-18H22c-2.76.0-5 2.24-5 5v143c0 2.76 2.24 5 5 5h76c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h76c2.76.0 5-2.24 5-5V44.5c0-2.76-2.24-5-5-5h-85zM206 163c0 1.38-1.12 2.5-2.5 2.5H143c-18 0-18 18-18 18s0-18-18-18H46.5c-1.38.0-2.5-1.12-2.5-2.5V69c0-1.38 1.12-2.5 2.5-2.5H98c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h51.5c1.38.0 2.5 1.12 2.5 2.5v94z" style="fill:#06f"/></svg></div></a><button id=close-sidebar class="btn btn-icon btn-soft">
<span class="material-icons size-20 menu-icon align-middle">menu</span>
</button>
<button id=flexsearch-button class="ms-3 btn btn-soft" data-bs-toggle=collapse data-bs-target=#FlexSearchCollapse aria-expanded=false aria-controls=FlexSearchCollapse>
<span class="material-icons size-20 menu-icon align-middle">search</span>
<span class="flexsearch-button-placeholder ms-1 me-2 d-none d-sm-block">Search</span><div class="d-none d-sm-block"><span class=flexsearch-button-keys><kbd class=flexsearch-button-cmd-key><svg width="44" height="15"><path d="M2.118 11.5A1.519 1.519.0 011 11.042 1.583 1.583.0 011 8.815a1.519 1.519.0 011.113-.458h.715V6.643h-.71A1.519 1.519.0 011 6.185 1.519 1.519.0 01.547 5.071 1.519 1.519.0 011 3.958 1.519 1.519.0 012.118 3.5a1.519 1.519.0 011.114.458A1.519 1.519.0 013.69 5.071v.715H5.4V5.071A1.564 1.564.0 016.976 3.5 1.564 1.564.0 018.547 5.071 1.564 1.564.0 016.976 6.643H6.261V8.357h.715a1.575 1.575.0 011.113 2.685 1.583 1.583.0 01-2.227.0A1.519 1.519.0 015.4 9.929V9.214H3.69v.715a1.519 1.519.0 01-.458 1.113A1.519 1.519.0 012.118 11.5zm0-.857a.714.714.0 00.715-.714V9.214H2.118a.715.715.0 100 1.429zm4.858.0a.715.715.0 100-1.429H6.261v.715a.714.714.0 00.715.714zM3.69 8.357H5.4V6.643H3.69zM2.118 5.786h.715V5.071a.714.714.0 00-.715-.714.715.715.0 00-.5 1.22A.686.686.0 002.118 5.786zm4.143.0h.715a.715.715.0 00.5-1.22.715.715.0 00-1.22.5z" fill="currentColor"/><path d="M12.4 11.475H11.344l3.879-7.95h1.056z" fill="currentColor"/><path d="M25.073 5.384l-.864.576a2.121 2.121.0 00-1.786-.923 2.207 2.207.0 00-2.266 2.326 2.206 2.206.0 002.266 2.325 2.1 2.1.0 001.782-.918l.84.617a3.108 3.108.0 01-2.622 1.293 3.217 3.217.0 01-3.349-3.317 3.217 3.217.0 013.349-3.317A3.046 3.046.0 0125.073 5.384z" fill="currentColor"/><path d="M30.993 5.142h-2.07v5.419H27.891V5.142h-2.07V4.164h5.172z" fill="currentColor"/><path d="M34.67 4.164c1.471.0 2.266.658 2.266 1.851.0 1.087-.832 1.809-2.134 1.855l2.107 2.691h-1.28L33.591 7.87H33.07v2.691H32.038v-6.4zm-1.6.969v1.8h1.572c.832.0 1.22-.3 1.22-.918s-.411-.882-1.22-.882z" fill="currentColor"/><path d="M42.883 10.561H38.31v-6.4h1.033V9.583h3.54z" fill="currentColor"/></svg>
</kbd><kbd class=flexsearch-button-key><svg width="15" height="15"><path d="M5.926 12.279H4.41L9.073 2.721H10.59z" fill="currentColor"/></svg></kbd></span></div></button></div><div class="d-flex align-items-center"><ul class="list-unstyled mb-0"><li class="list-inline-item mb-0"><a href=https://twitter.com/gplanchat alt=twitter rel="noopener noreferrer" target=_blank><div class="btn btn-icon btn-default border-0"><svg width="24" height="24" viewBox="0 0 24 24"><title>Twitter / X</title><path d="M.088.768l9.266 12.39L.029 23.231h2.1l8.163-8.819 6.6 8.819h7.142L14.242 10.145 22.921.768h-2.1L13.3 8.891 7.229.768zM3.174 2.314H6.455L20.942 21.685h-3.28z" fill="currentColor"/></svg></div></a></li></ul></div></div><div class=collapse id=FlexSearchCollapse><div class=flexsearch-container><div class=flexsearch-keymap><li><kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Arrow down" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 3.5v8m3-3-3 3-3-3"/></g></svg></kbd>
<kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Arrow up" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 11.5v-8m3 3-3-3-3 3"/></g></svg></kbd>
<span class=flexsearch-key-label>to navigate</span></li><li><kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Enter key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M12 3.53088v3c0 1-1 2-2 2H4m3 3-3-3 3-3"/></g></svg></kbd>
<span class=flexsearch-key-label>to select</span></li><li><kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Escape key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M13.6167 8.936c-.1065.3583-.6883.962-1.4875.962-.7993.0-1.653-.9165-1.653-2.1258v-.5678c0-1.2548.7896-2.1016 1.653-2.1016s1.3601.4778 1.4875 1.0724M9 6c-.1352-.4735-.7506-.9219-1.46-.8972-.7092.0246-1.344.57-1.344 1.2166s.4198.8812 1.3445.9805C8.465 7.3992 8.968 7.9337 9 8.5s-.454 1.398-1.4595 1.398C6.6593 9.898 6 9 5.963 8.4851m-1.4748.5368c-.2635.5941-.8099.876-1.5443.876s-1.7073-.6248-1.7073-2.204v-.4603c0-1.0416.721-2.131 1.7073-2.131.9864.0 1.6425 1.031 1.5443 2.2492h-2.956"/></g></svg></kbd>
<span class=flexsearch-key-label>to close</span></li></div><form class="flexsearch position-relative flex-grow-1 ms-2 me-2"><div class="d-flex flex-row"><input id=flexsearch class=form-control type=search placeholder=Search aria-label=Search autocomplete=off>
<button id=hideFlexsearch type=button class="ms-2 btn btn-soft">
cancel</button></div><div id=suggestions class="shadow rounded-1 d-none"></div></form></div></div></div><div class=container-fluid><div class=layout-spacing><div class="d-md-flex justify-content-between align-items-center"><nav aria-label=breadcrumb class="d-inline-block pb-2 mt-1 mt-sm-0"><ul id=breadcrumbs class="breadcrumb bg-transparent mb-0" itemscope itemtype=https://schema.org/BreadcrumbList><li class="breadcrumb-item text-capitalize active" aria-current=page itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=/chapitres/><i class="material-icons size-20 align-text-bottom" itemprop=name>Home</i>
</a><meta itemprop=position content='1'></li><li class="breadcrumb-item text-capitalize" itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=/chapitres/avances/><span itemprop=name>Chapitres Avanc√©s</span>
</a><meta itemprop=position content='2'></li><li class="breadcrumb-item text-capitalize active" itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><span itemprop=name>Chapitre 62 : S√©curit√© et Autorisation - Prot√©ger votre API Platform</span>
<meta itemprop=position content='3'></li></ul></nav></div><div class="row flex-xl-nowrap"><div class="docs-toc col-xl-3 d-xl-block"><toc><div class="fw-bold text-uppercase mb-2">On this page</div><nav id=TableOfContents><ul><li><a href=#-objectif-de-ce-chapitre-mon-probl√®me--comment-s√©curiser-une-api-platform-complexe-voici-ce-qui-s--javais-une-api-platform-qui-fonctionnait-bien-mais-la-s√©curit√©-√©tait-un-vrai-casse-t√™te-comment-g√©rer-les-permissions--comment-s√©curiser-les-endpoints--comment-g√©rer-lauthentification-multi-tenant-mais-attendez-quand-jai-voulu-impl√©menter-une-s√©curit√©-robuste-j√©tais-perdu-oauth2-jwt-rbac-abac-keycloak-tellement-doptions--comment-choisir--comment-impl√©menter-soudain-je-r√©alisais-que-la-s√©curit√©-n-il-me-fallait-une-approche-structur√©e-et-compl√®te-la-s√©curit√©--mon-guide-completla-s√©curit√©-dans-une-api-platform-avec-ddd-ma-permis-de---prot√©ger-les-donn√©es-sensibles--contr√¥ler-lacc√®s-aux-ressources--g√©rer-les-permissions-granulaires--auditer-les-actions-utilisateurs-quest-ce-que-la-s√©curit√©-dans-une-api-platform--le-concept-fondamentalla-s√©curit√©-dans-une-api-platform-consiste-√†-prot√©ger-les-ressources-et-contr√¥ler-lacc√®s-l--chaque-requ√™te-doit-√™tre-authentifi√©e-et-autoris√©e-avant-dacc√©der-aux-donn√©esavec-gyroscops-voici-comment-j--les-4-piliers-de-la-s√©curit√©-1-authentification---qui-√™tes-vous-voici-comment-j-oauth2--jwt---tokens-jwt-pour-lauthentification--refresh-tokens-pour-la-s√©curit√©--expiration-automatique-des-tokenskeycloak---gestion-centralis√©e-des-utilisateurs--int√©gration-oauth2--gestion-des-r√¥les-et-permissions-2-autorisation---que-pouvez-vous-faire-voici-comment-j-rbac-role-based-access-control---r√¥les-d√©finis-par-domaine--permissions-granulaires--hi√©rarchie-des-r√¥lesabac-attribute-based-access-control---contr√¥le-bas√©-sur-les-attributs--r√®gles-m√©tier-complexes--contexte-dynamique-3-validation---les-donn√©es-sont-elles-valides-voici-comment-j-validation-des-entr√©es---validation-des-donn√©es-dentr√©e--sanitisation-des-donn√©es--gestion-des-erreursvalidation-des-permissions---v√©rification-des-permissions--contr√¥le-dacc√®s-aux-ressources--audit-des-actions-4-audit---que-sest-il-pass√©-voici-comment-j-logging-de-s√©curit√©---logs-dauthentification--logs-dautorisation--logs-dauditmonitoring---d√©tection-dintrusions--alertes-de-s√©curit√©--m√©triques-de-s√©curit√©-comment-impl√©menter-la-s√©curit√©-1-configuration-de-l--jai-configur√©-lauthentification-yamlsecurity----providers--------keycloak------------id-appsecuritykeycloakuserprovider----firewalls--------api------------pattern-api------------stateless-true------------jwt-----access_control-----------path-apiauth-roles-public_access------------path-api-roles-role_user-r√©sultat--authentification-jwt-configur√©e-2-impl√©mentation-de-l--jai-impl√©ment√©-lautorisation-phprouteapipayments-methods-getisgrantedpayment_read-subject-organizationpublic-function-getpaymentsorganization-organization-jsonresponse-----logique-m√©tierr√©sultat--autorisation-bas√©e-sur-les-permissions-3-gestion-des-permissions--jai-g√©r√©-les-permissions-phpfinal-class-paymentvoter-extends-voter----protected-function-supportsstring-attribute-mixed-subject-bool------------return-in_arrayattribute-payment_read-payment_write-payment_delete-------------subject-instanceof-payment------------protected-function-voteonattributestring-attribute-mixed-subject-tokeninterface-token-bool------------user--token-getuser----------------return-match-attribute-------------payment_read--this-canreaduser-subject------------payment_write--this-canwriteuser-subject------------payment_delete--this-candeleteuser-subject------------default--false------------r√©sultat--permissions-granulaires-et-flexibles-4-audit-et-monitoring--jai-impl√©ment√©-laudit-phpfinal-class-securityauditlogger----public-function-logauthenticationstring-userid-bool-success-void------------this-logger-infoauthentication-attempt-------------user_id--userid------------success--success------------timestamp--new-datetimeimmutable--------------------public-function-logauthorizationstring-userid-string-resource-string-action-bool-granted-void------------this-logger-infoauthorization-check-------------user_id--userid------------resource--resource------------action--action------------granted--granted------------timestamp--new-datetimeimmutable------------r√©sultat--audit-complet-des-actions-de-s√©curit√©-les-avantages-de-la-s√©curit√©-structur√©e-1-protection-des-donn√©es--la-s√©curit√©-structur√©e-prot√®ge-les-donn√©es---acc√®s-contr√¥l√©-aux-ressources--donn√©es-sensibles-prot√©g√©es--conformit√©-r√©glementairer√©sultat--donn√©es-s√©curis√©es-et-conformes-2-contr√¥le-d--la-s√©curit√©-structur√©e-permet-un-contr√¥le-granulaire---permissions-par-ressource--r√¥les-contextuels--r√®gles-m√©tier-complexesr√©sultat--contr√¥le-dacc√®s-pr√©cis-et-flexible-3-audit-et-conformit√©--la-s√©curit√©-structur√©e-facilite-laudit---logs-complets-des-actions--tra√ßabilit√©-des-acc√®s--conformit√©-r√©glementairer√©sultat--audit-complet-et-conformit√©-assur√©e-4-√©volutivit√©--la-s√©curit√©-structur√©e-est-√©volutive---ajout-facile-de-nouvelles-permissions--extension-des-r√¥les--adaptation-aux-besoins-m√©tierr√©sultat--s√©curit√©-√©volutive-et-maintenable-les-inconv√©nients-de-la-s√©curit√©-structur√©e-1-complexit√©-accrue--la-s√©curit√©-structur√©e-ajoute-de-la-complexit√©---configuration-complexe--gestion-des-permissions--debugging-plus-difficiler√©sultat--courbe-dapprentissage-plus-importante-2-performance--la-s√©curit√©-structur√©e-peut-impacter-les-performances---v√©rifications-dautorisation--validation-des-tokens--logs-dauditr√©sultat--performance-potentiellement-d√©grad√©e-3-maintenance--la-s√©curit√©-structur√©e-n√©cessite-de-la-maintenance---mise-√†-jour-des-permissions--gestion-des-r√¥les--monitoring-continur√©sultat--maintenance-plus-complexe-4-gestion-des-erreurs--la-s√©curit√©-structur√©e-complique-la-gestion-des-erreurs---erreurs-dauthentification--erreurs-dautorisation--messages-derreur-appropri√©sr√©sultat--gestion-derreurs-plus-complexe-les-pi√®ges-√†-√©viter-1-s√©curit√©-par-obscurit√©-mauvais--compter-sur-lobscurit√©-pour-la-s√©curit√©-bon--s√©curit√©-bas√©e-sur-des-standards-√©prouv√©spourquoi-c-lobscurit√©-nest-pas-une-s√©curit√©-2-permissions-trop-granulaires-mauvais--une-permission-pour-chaque-action-bon--permissions-par-domaine-m√©tierpourquoi-c-des-permissions-trop-granulaires-sont-difficiles-√†-g√©rer-3-ignorer-l-mauvais--pas-daudit-des-actions-de-s√©curit√©-bon--audit-complet-des-actionspourquoi-c-laudit-est-essentiel-pour-la-s√©curit√©-4-tokens-non-s√©curis√©s-mauvais--tokens-non-s√©curis√©s-ou-non-expir√©s-bon--tokens-s√©curis√©s-avec-expirationpourquoi-c-les-tokens-non-s√©curis√©s-sont-une-faille-de-s√©curit√©-l√©volution-vers-la-s√©curit√©-structur√©e-phase-1--authentification-basiqueavec-gyroscops--au-d√©but-javais-une-authentification-basique---loginpassword-simple--sessions-php--pas-dautorisationr√©sultat--d√©veloppement-rapide-s√©curit√©-faible-phase-2--introduction-de-lautorisationavec-gyroscops--jai-introduit-lautorisation---r√¥les-basiques--permissions-simples--contr√¥le-dacc√®sr√©sultat--s√©curit√©-am√©lior√©e-complexit√©-accrue-phase-3--s√©curit√©-compl√®teavec-gyroscops--maintenant-jai-une-s√©curit√©-compl√®te---oauth2--jwt--rbac--abac--audit-completr√©sultat--s√©curit√©-robuste-et-√©volutive--impl√©mentation-concr√®te-dans-le-projet-gyroscops-cloud-s√©curit√©-appliqu√©e-√†-gyroscops-cloudle-gyroscops-cloud-applique-concr√®tement-les-principes-de-s√©curit√©-√†-travers-son-architecture-et-ses-adr-architecture-decision-records-voici-comment--syst√®me-dauthentification-gyroscops-cloudphp--syst√®me-dauthentification-gyroscops-cloud-projet-gyroscops-cloudfinal-class-hiveauthenticationservice----public-function-__construct--------private-keycloakclient-keycloakclient--------private-jwttokenservice-jwtservice--------private-userrepositoryinterface-userrepository--------private-loggerinterface-logger-------------public-function-authenticatestring-email-string-password-authresult------------this-logger-infoauthentication-attempt-------------email--email------------timestamp--new-datetimeimmutable------------------------try-------------keycloakuser--this-keycloakclient-authenticateemail-password------------------------if-keycloakuser-----------------this-logger-warningauthentication-failed---------------------email--email--------------------reason--invalid-credentials------------------------------------------------return-authresultfailureinvalid-credentials------------------------------------user--this-userrepository-findbyemailnew-emailemail------------if-user-----------------this-logger-warninguser-not-found---------------------email--email------------------------------------------------return-authresultfailureuser-not-found------------------------------------token--this-jwtservice-generatetokenuser------------------------this-logger-infoauthentication-successful-----------------user_id--user-getid-tostring----------------email--email------------------------------------return-authresultsuccessuser-token---------------------catch-exception-e-------------this-logger-errorauthentication-error-----------------email--email----------------error--e-getmessage------------------------------------return-authresultfailureauthentication-failed--------------------public-function-refreshtokenstring-refreshtoken-authresult------------try-------------newtoken--this-jwtservice-refreshtokenrefreshtoken------------------------this-logger-infotoken-refreshed-successfully------------------------return-authresultsuccessnull-newtoken---------------------catch-exception-e-------------this-logger-errortoken-refresh-failed-----------------error--e-getmessage------------------------------------return-authresultfailuretoken-refresh-failed-------------syst√®me-dautorisation-gyroscops-cloudphp--syst√®me-dautorisation-gyroscops-cloud-projet-gyroscops-cloudfinal-class-hiveauthorizationservice----public-function-__construct--------private-permissionrepositoryinterface-permissionrepository--------private-rolerepositoryinterface-rolerepository--------private-loggerinterface-logger-------------public-function-haspermissionuser-user-string-resource-string-action-bool------------this-logger-infochecking-permission-------------user_id--user-getid-tostring------------resource--resource------------action--action------------------------try-------------userroles--this-rolerepository-findbyuseruser------------------------foreach-userroles-as-role-----------------permissions--this-permissionrepository-findbyrolerole--------------------------------foreach-permissions-as-permission---------------------if-permission-matchesresource-action-------------------------this-logger-infopermission-granted-----------------------------user_id--user-getid-tostring----------------------------resource--resource----------------------------action--action----------------------------role--role-getname------------------------------------------------------------------------return-true------------------------------------------------------------------------this-logger-warningpermission-denied-----------------user_id--user-getid-tostring----------------resource--resource----------------action--action------------------------------------return-false---------------------catch-exception-e-------------this-logger-errorauthorization-error-----------------user_id--user-getid-tostring----------------resource--resource----------------action--action----------------error--e-getmessage------------------------------------return-false--------------------public-function-checkresourceaccessuser-user-string-resource-string-action-mixed-subject-bool-------------v√©rification-des-permissions-de-base--------if-this-haspermissionuser-resource-action-------------return-false-------------------------v√©rification-des-permissions-contextuelles--------if-subject-instanceof-organizationaware-------------return-this-checkorganizationaccessuser-subject------------------------if-subject-instanceof-useraware-------------return-this-checkuseraccessuser-subject------------------------return-true------------private-function-checkorganizationaccessuser-user-organizationaware-subject-bool------------userorganizations--this-getuserorganizationsuser--------subjectorganization--subject-getorganizationid----------------return-in_arraysubjectorganization-userorganizations------------private-function-checkuseraccessuser-user-useraware-subject-bool------------return-user-getid-equalssubject-getuserid-----voters-de-s√©curit√©-gyroscops-cloudphp--voters-de-s√©curit√©-gyroscops-cloud-projet-gyroscops-cloudfinal-class-paymentvoter-extends-voter----public-function-__construct--------private-hiveauthorizationservice-authorizationservice--------private-loggerinterface-logger-------------protected-function-supportsstring-attribute-mixed-subject-bool------------return-in_arrayattribute-------------payment_read------------payment_write------------payment_delete------------payment_approve------------payment_refund----------subject-instanceof-payment------------protected-function-voteonattributestring-attribute-mixed-subject-tokeninterface-token-bool------------user--token-getuser----------------if-user-instanceof-user-------------return-false------------------------this-logger-infovoting-on-payment-permission-------------user_id--user-getid-tostring------------attribute--attribute------------payment_id--subject-getid-tostring------------------------result--match-attribute-------------payment_read--this-canreaduser-subject------------payment_write--this-canwriteuser-subject------------payment_delete--this-candeleteuser-subject------------payment_approve--this-canapproveuser-subject------------payment_refund--this-canrefunduser-subject------------default--false------------------------this-logger-infovote-result-------------user_id--user-getid-tostring------------attribute--attribute------------result--result------------------------return-result------------private-function-canreaduser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------read------------payment--------------------private-function-canwriteuser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------write------------payment--------------------private-function-candeleteuser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------delete------------payment--------------------private-function-canapproveuser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------approve------------payment--------------------private-function-canrefunduser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------refund------------payment-------------audit-de-s√©curit√©-gyroscops-cloudphp--audit-de-s√©curit√©-gyroscops-cloud-projet-gyroscops-cloudfinal-class-hivesecurityauditservice----public-function-__construct--------private-loggerinterface-logger--------private-securityeventrepositoryinterface-eventrepository-------------public-function-logauthenticationeventstring-userid-bool-success-array-context---void------------event--new-securityevent------------securityeventtypeauthentication------------userid------------success------------context------------------------this-eventrepository-saveevent----------------this-logger-infoauthentication-event-logged-------------user_id--userid------------success--success------------context--context--------------------public-function-logauthorizationeventstring-userid-string-resource-string-action-bool-granted-array-context---void------------event--new-securityevent------------securityeventtypeauthorization------------userid------------granted------------array_mergecontext-----------------resource--resource----------------action--action------------------------------------this-eventrepository-saveevent----------------this-logger-infoauthorization-event-logged-------------user_id--userid------------resource--resource------------action--action------------granted--granted------------context--context--------------------public-function-logsecurityviolationstring-userid-string-violationtype-array-context---void------------event--new-securityevent------------securityeventtypeviolation------------userid------------false------------array_mergecontext-----------------violation_type--violationtype------------------------------------this-eventrepository-saveevent----------------this-logger-warningsecurity-violation-logged-------------user_id--userid------------violation_type--violationtype------------context--context-------------r√©f√©rences-aux-adr-du-projet-gyroscops-cloudce-chapitre-sappuie-sur-les-architecture-decision-records-adr-suivants-du-gyroscops-cloud---hive025--authorization-system---syst√®me-dautorisation--hive026--keycloak-resource-and-scope-management---gestion-des-ressources-et-scopes--hive040--enhanced-models-with-property-access-patterns---mod√®les-enrichis-pour-la-s√©curit√©--hive041--cross-cutting-concerns-architecture---architecture-des-pr√©occupations-transversaleshahahugoshortcode9s0hbhb>üéØ Objectif de ce Chapitre### Mon Probl√®me : Comment S√©curiser une API Platform Complexe ?<strong>Voici ce qui s‚Äôest pass√© avec Gyroscops</strong> : J‚Äôavais une API Platform qui fonctionnait bien, mais la s√©curit√© √©tait un vrai casse-t√™te. Comment g√©rer les permissions ? Comment s√©curiser les endpoints ? Comment g√©rer l‚Äôauthentification multi-tenant ?<strong>Mais attendez‚Ä¶</strong> Quand j‚Äôai voulu impl√©menter une s√©curit√© robuste, j‚Äô√©tais perdu. OAuth2, JWT, RBAC, ABAC, Keycloak‚Ä¶ Tellement d‚Äôoptions ! Comment choisir ? Comment impl√©menter ?<strong>Soudain, je r√©alisais que la s√©curit√© n‚Äô√©tait pas optionnelle !</strong> Il me fallait une approche structur√©e et compl√®te.### La S√©curit√© : Mon Guide CompletLa s√©curit√© dans une API Platform avec DDD m‚Äôa permis de :- <strong>Prot√©ger</strong> les donn√©es sensibles- <strong>Contr√¥ler</strong> l‚Äôacc√®s aux ressources- <strong>G√©rer</strong> les permissions granulaires- <strong>Auditer</strong> les actions utilisateurs## Qu‚Äôest-ce que la S√©curit√© dans une API Platform ?### Le Concept FondamentalLa s√©curit√© dans une API Platform consiste √† prot√©ger les ressources et contr√¥ler l‚Äôacc√®s. <strong>L‚Äôid√©e</strong> : Chaque requ√™te doit √™tre authentifi√©e et autoris√©e avant d‚Äôacc√©der aux donn√©es.<strong>Avec Gyroscops, voici comment j‚Äôai structur√© la s√©curit√©</strong> :### Les 4 Piliers de la S√©curit√©#### 1. <strong>Authentification</strong> - Qui √™tes-vous ?<strong>Voici comment j‚Äôai impl√©ment√© l‚Äôauthentification avec Gyroscops</strong> :<strong>OAuth2 + JWT</strong> :- Tokens JWT pour l‚Äôauthentification- Refresh tokens pour la s√©curit√©- Expiration automatique des tokens<strong>Keycloak</strong> :- Gestion centralis√©e des utilisateurs- Int√©gration OAuth2- Gestion des r√¥les et permissions#### 2. <strong>Autorisation</strong> - Que pouvez-vous faire ?<strong>Voici comment j‚Äôai impl√©ment√© l‚Äôautorisation avec Gyroscops</strong> :<strong>RBAC (Role-Based Access Control)</strong> :- R√¥les d√©finis par domaine- Permissions granulaires- Hi√©rarchie des r√¥les<strong>ABAC (Attribute-Based Access Control)</strong> :- Contr√¥le bas√© sur les attributs- R√®gles m√©tier complexes- Contexte dynamique#### 3. <strong>Validation</strong> - Les donn√©es sont-elles valides ?<strong>Voici comment j‚Äôai impl√©ment√© la validation avec Gyroscops</strong> :<strong>Validation des Entr√©es</strong> :- Validation des donn√©es d‚Äôentr√©e- Sanitisation des donn√©es- Gestion des erreurs<strong>Validation des Permissions</strong> :- V√©rification des permissions- Contr√¥le d‚Äôacc√®s aux ressources- Audit des actions#### 4. <strong>Audit</strong> - Que s‚Äôest-il pass√© ?<strong>Voici comment j‚Äôai impl√©ment√© l‚Äôaudit avec Gyroscops</strong> :<strong>Logging de S√©curit√©</strong> :- Logs d‚Äôauthentification- Logs d‚Äôautorisation- Logs d‚Äôaudit<strong>Monitoring</strong> :- D√©tection d‚Äôintrusions- Alertes de s√©curit√©- M√©triques de s√©curit√©## Comment Impl√©menter la S√©curit√©### 1. <strong>Configuration de l‚ÄôAuthentification****Avec Gyroscops</strong> : J‚Äôai configur√© l‚Äôauthentification :<code>yamlsecurity: providers: keycloak: id: App\Security\KeycloakUserProvider firewalls: api: pattern: ^/api stateless: true jwt: ~ access_control: - { path: ^/api/auth, roles: PUBLIC_ACCESS } - { path: ^/api, roles: ROLE_USER }</code><strong>R√©sultat</strong> : Authentification JWT configur√©e.### 2. <strong>Impl√©mentation de l‚ÄôAutorisation****Avec Gyroscops</strong> : J‚Äôai impl√©ment√© l‚Äôautorisation :<code>php#[Route('/api/payments', methods: ['GET'])]#[IsGranted('PAYMENT_READ', subject: 'organization')]public function getPayments(Organization $organization): JsonResponse{ // Logique m√©tier}</code><strong>R√©sultat</strong> : Autorisation bas√©e sur les permissions.### 3. <strong>Gestion des Permissions****Avec Gyroscops</strong> : J‚Äôai g√©r√© les permissions :<code>phpfinal class PaymentVoter extends Voter{ protected function supports(string $attribute, mixed $subject): bool { return in_array($attribute, ['PAYMENT_READ', 'PAYMENT_WRITE', 'PAYMENT_DELETE']) && $subject instanceof Payment; } protected function voteOnAttribute(string $attribute, mixed $subject, TokenInterface $token): bool { $user = $token->getUser(); return match ($attribute) { 'PAYMENT_READ' => $this->canRead($user, $subject), 'PAYMENT_WRITE' => $this->canWrite($user, $subject), 'PAYMENT_DELETE' => $this->canDelete($user, $subject), default => false }; }}</code><strong>R√©sultat</strong> : Permissions granulaires et flexibles.### 4. <strong>Audit et Monitoring****Avec Gyroscops</strong> : J‚Äôai impl√©ment√© l‚Äôaudit :<code>phpfinal class SecurityAuditLogger{ public function logAuthentication(string $userId, bool $success): void { $this->logger->info('Authentication attempt', [ 'user_id' => $userId, 'success' => $success, 'timestamp' => new \DateTimeImmutable() ]); } public function logAuthorization(string $userId, string $resource, string $action, bool $granted): void { $this->logger->info('Authorization check', [ 'user_id' => $userId, 'resource' => $resource, 'action' => $action, 'granted' => $granted, 'timestamp' => new \DateTimeImmutable() ]); }}</code><strong>R√©sultat</strong> : Audit complet des actions de s√©curit√©.## Les Avantages de la S√©curit√© Structur√©e### 1. <strong>Protection des Donn√©es****Avec Gyroscops</strong> : La s√©curit√© structur√©e prot√®ge les donn√©es :- Acc√®s contr√¥l√© aux ressources- Donn√©es sensibles prot√©g√©es- Conformit√© r√©glementaire<strong>R√©sultat</strong> : Donn√©es s√©curis√©es et conformes.### 2. <strong>Contr√¥le d‚ÄôAcc√®s Granulaire****Avec Gyroscops</strong> : La s√©curit√© structur√©e permet un contr√¥le granulaire :- Permissions par ressource- R√¥les contextuels- R√®gles m√©tier complexes<strong>R√©sultat</strong> : Contr√¥le d‚Äôacc√®s pr√©cis et flexible.### 3. <strong>Audit et Conformit√©****Avec Gyroscops</strong> : La s√©curit√© structur√©e facilite l‚Äôaudit :- Logs complets des actions- Tra√ßabilit√© des acc√®s- Conformit√© r√©glementaire<strong>R√©sultat</strong> : Audit complet et conformit√© assur√©e.### 4. <strong>√âvolutivit√©****Avec Gyroscops</strong> : La s√©curit√© structur√©e est √©volutive :- Ajout facile de nouvelles permissions- Extension des r√¥les- Adaptation aux besoins m√©tier<strong>R√©sultat</strong> : S√©curit√© √©volutive et maintenable.## Les Inconv√©nients de la S√©curit√© Structur√©e### 1. <strong>Complexit√© Accrue****Avec Gyroscops</strong> : La s√©curit√© structur√©e ajoute de la complexit√© :- Configuration complexe- Gestion des permissions- Debugging plus difficile<strong>R√©sultat</strong> : Courbe d‚Äôapprentissage plus importante.### 2. <strong>Performance****Avec Gyroscops</strong> : La s√©curit√© structur√©e peut impacter les performances :- V√©rifications d‚Äôautorisation- Validation des tokens- Logs d‚Äôaudit<strong>R√©sultat</strong> : Performance potentiellement d√©grad√©e.### 3. <strong>Maintenance****Avec Gyroscops</strong> : La s√©curit√© structur√©e n√©cessite de la maintenance :- Mise √† jour des permissions- Gestion des r√¥les- Monitoring continu<strong>R√©sultat</strong> : Maintenance plus complexe.### 4. <strong>Gestion des Erreurs****Avec Gyroscops</strong> : La s√©curit√© structur√©e complique la gestion des erreurs :- Erreurs d‚Äôauthentification- Erreurs d‚Äôautorisation- Messages d‚Äôerreur appropri√©s<strong>R√©sultat</strong> : Gestion d‚Äôerreurs plus complexe.## Les Pi√®ges √† √âviter### 1. <strong>S√©curit√© par Obscurit√©</strong>**‚ùå Mauvais** : Compter sur l‚Äôobscurit√© pour la s√©curit√©**‚úÖ Bon** : S√©curit√© bas√©e sur des standards √©prouv√©s<strong>Pourquoi c‚Äôest important ?</strong> L‚Äôobscurit√© n‚Äôest pas une s√©curit√©.### 2. <strong>Permissions Trop Granulaires</strong>**‚ùå Mauvais** : Une permission pour chaque action**‚úÖ Bon** : Permissions par domaine m√©tier<strong>Pourquoi c‚Äôest crucial ?</strong> Des permissions trop granulaires sont difficiles √† g√©rer.### 3. <strong>Ignorer l‚ÄôAudit</strong>**‚ùå Mauvais** : Pas d‚Äôaudit des actions de s√©curit√©**‚úÖ Bon** : Audit complet des actions<strong>Pourquoi c‚Äôest essentiel ?</strong> L‚Äôaudit est essentiel pour la s√©curit√©.### 4. <strong>Tokens Non S√©curis√©s</strong>**‚ùå Mauvais** : Tokens non s√©curis√©s ou non expir√©s**‚úÖ Bon** : Tokens s√©curis√©s avec expiration<strong>Pourquoi c‚Äôest la cl√© ?</strong> Les tokens non s√©curis√©s sont une faille de s√©curit√©.## L‚Äô√âvolution vers la S√©curit√© Structur√©e### Phase 1 : Authentification Basique<strong>Avec Gyroscops</strong> : Au d√©but, j‚Äôavais une authentification basique :- Login/password simple- Sessions PHP- Pas d‚Äôautorisation<strong>R√©sultat</strong> : D√©veloppement rapide, s√©curit√© faible.### Phase 2 : Introduction de l‚ÄôAutorisation<strong>Avec Gyroscops</strong> : J‚Äôai introduit l‚Äôautorisation :- R√¥les basiques- Permissions simples- Contr√¥le d‚Äôacc√®s<strong>R√©sultat</strong> : S√©curit√© am√©lior√©e, complexit√© accrue.### Phase 3 : S√©curit√© Compl√®te<strong>Avec Gyroscops</strong> : Maintenant, j‚Äôai une s√©curit√© compl√®te :- OAuth2 + JWT- RBAC + ABAC- Audit complet<strong>R√©sultat</strong> : S√©curit√© robuste et √©volutive.## üèóÔ∏è Impl√©mentation Concr√®te dans le Projet Gyroscops Cloud### S√©curit√© Appliqu√©e √† Gyroscops CloudLe Gyroscops Cloud applique concr√®tement les principes de s√©curit√© √† travers son architecture et ses ADR (Architecture Decision Records). Voici comment :#### Syst√®me d‚ÄôAuthentification Gyroscops Cloud<code>php// ‚úÖ Syst√®me d'Authentification Gyroscops Cloud (Projet Gyroscops Cloud)final class HiveAuthenticationService{ public function __construct( private KeycloakClient $keycloakClient, private JwtTokenService $jwtService, private UserRepositoryInterface $userRepository, private LoggerInterface $logger ) {} public function authenticate(string $email, string $password): AuthResult { $this->logger->info('Authentication attempt', [ 'email' => $email, 'timestamp' => new \DateTimeImmutable() ]); try { $keycloakUser = $this->keycloakClient->authenticate($email, $password); if (!$keycloakUser) { $this->logger->warning('Authentication failed', [ 'email' => $email, 'reason' => 'Invalid credentials' ]); return AuthResult::failure('Invalid credentials'); } $user = $this->userRepository->findByEmail(new Email($email)); if (!$user) { $this->logger->warning('User not found', [ 'email' => $email ]); return AuthResult::failure('User not found'); } $token = $this->jwtService->generateToken($user); $this->logger->info('Authentication successful', [ 'user_id' => $user->getId()->toString(), 'email' => $email ]); return AuthResult::success($user, $token); } catch (\Exception $e) { $this->logger->error('Authentication error', [ 'email' => $email, 'error' => $e->getMessage() ]); return AuthResult::failure('Authentication failed'); } } public function refreshToken(string $refreshToken): AuthResult { try { $newToken = $this->jwtService->refreshToken($refreshToken); $this->logger->info('Token refreshed successfully'); return AuthResult::success(null, $newToken); } catch (\Exception $e) { $this->logger->error('Token refresh failed', [ 'error' => $e->getMessage() ]); return AuthResult::failure('Token refresh failed'); } }}</code>#### Syst√®me d‚ÄôAutorisation Gyroscops Cloud<code>php// ‚úÖ Syst√®me d'Autorisation Gyroscops Cloud (Projet Gyroscops Cloud)final class HiveAuthorizationService{ public function __construct( private PermissionRepositoryInterface $permissionRepository, private RoleRepositoryInterface $roleRepository, private LoggerInterface $logger ) {} public function hasPermission(User $user, string $resource, string $action): bool { $this->logger->info('Checking permission', [ 'user_id' => $user->getId()->toString(), 'resource' => $resource, 'action' => $action ]); try { $userRoles = $this->roleRepository->findByUser($user); foreach ($userRoles as $role) { $permissions = $this->permissionRepository->findByRole($role); foreach ($permissions as $permission) { if ($permission->matches($resource, $action)) { $this->logger->info('Permission granted', [ 'user_id' => $user->getId()->toString(), 'resource' => $resource, 'action' => $action, 'role' => $role->getName() ]); return true; } } } $this->logger->warning('Permission denied', [ 'user_id' => $user->getId()->toString(), 'resource' => $resource, 'action' => $action ]); return false; } catch (\Exception $e) { $this->logger->error('Authorization error', [ 'user_id' => $user->getId()->toString(), 'resource' => $resource, 'action' => $action, 'error' => $e->getMessage() ]); return false; } } public function checkResourceAccess(User $user, string $resource, string $action, mixed $subject): bool { // V√©rification des permissions de base if (!$this->hasPermission($user, $resource, $action)) { return false; } // V√©rification des permissions contextuelles if ($subject instanceof OrganizationAware) { return $this->checkOrganizationAccess($user, $subject); } if ($subject instanceof UserAware) { return $this->checkUserAccess($user, $subject); } return true; } private function checkOrganizationAccess(User $user, OrganizationAware $subject): bool { $userOrganizations = $this->getUserOrganizations($user); $subjectOrganization = $subject->getOrganizationId(); return in_array($subjectOrganization, $userOrganizations); } private function checkUserAccess(User $user, UserAware $subject): bool { return $user->getId()->equals($subject->getUserId()); }}</code>#### Voters de S√©curit√© Gyroscops Cloud<code>php// ‚úÖ Voters de S√©curit√© Gyroscops Cloud (Projet Gyroscops Cloud)final class PaymentVoter extends Voter{ public function __construct( private HiveAuthorizationService $authorizationService, private LoggerInterface $logger ) {} protected function supports(string $attribute, mixed $subject): bool { return in_array($attribute, [ 'PAYMENT_READ', 'PAYMENT_WRITE', 'PAYMENT_DELETE', 'PAYMENT_APPROVE', 'PAYMENT_REFUND' ]) && $subject instanceof Payment; } protected function voteOnAttribute(string $attribute, mixed $subject, TokenInterface $token): bool { $user = $token->getUser(); if (!$user instanceof User) { return false; } $this->logger->info('Voting on payment permission', [ 'user_id' => $user->getId()->toString(), 'attribute' => $attribute, 'payment_id' => $subject->getId()->toString() ]); $result = match ($attribute) { 'PAYMENT_READ' => $this->canRead($user, $subject), 'PAYMENT_WRITE' => $this->canWrite($user, $subject), 'PAYMENT_DELETE' => $this->canDelete($user, $subject), 'PAYMENT_APPROVE' => $this->canApprove($user, $subject), 'PAYMENT_REFUND' => $this->canRefund($user, $subject), default => false }; $this->logger->info('Vote result', [ 'user_id' => $user->getId()->toString(), 'attribute' => $attribute, 'result' => $result ]); return $result; } private function canRead(User $user, Payment $payment): bool { return $this->authorizationService->checkResourceAccess( $user, 'payment', 'read', $payment ); } private function canWrite(User $user, Payment $payment): bool { return $this->authorizationService->checkResourceAccess( $user, 'payment', 'write', $payment ); } private function canDelete(User $user, Payment $payment): bool { return $this->authorizationService->checkResourceAccess( $user, 'payment', 'delete', $payment ); } private function canApprove(User $user, Payment $payment): bool { return $this->authorizationService->checkResourceAccess( $user, 'payment', 'approve', $payment ); } private function canRefund(User $user, Payment $payment): bool { return $this->authorizationService->checkResourceAccess( $user, 'payment', 'refund', $payment ); }}</code>#### Audit de S√©curit√© Gyroscops Cloud<code>php// ‚úÖ Audit de S√©curit√© Gyroscops Cloud (Projet Gyroscops Cloud)final class HiveSecurityAuditService{ public function __construct( private LoggerInterface $logger, private SecurityEventRepositoryInterface $eventRepository ) {} public function logAuthenticationEvent(string $userId, bool $success, array $context = []): void { $event = new SecurityEvent( SecurityEventType::AUTHENTICATION, $userId, $success, $context ); $this->eventRepository->save($event); $this->logger->info('Authentication event logged', [ 'user_id' => $userId, 'success' => $success, 'context' => $context ]); } public function logAuthorizationEvent(string $userId, string $resource, string $action, bool $granted, array $context = []): void { $event = new SecurityEvent( SecurityEventType::AUTHORIZATION, $userId, $granted, array_merge($context, [ 'resource' => $resource, 'action' => $action ]) ); $this->eventRepository->save($event); $this->logger->info('Authorization event logged', [ 'user_id' => $userId, 'resource' => $resource, 'action' => $action, 'granted' => $granted, 'context' => $context ]); } public function logSecurityViolation(string $userId, string $violationType, array $context = []): void { $event = new SecurityEvent( SecurityEventType::VIOLATION, $userId, false, array_merge($context, [ 'violation_type' => $violationType ]) ); $this->eventRepository->save($event); $this->logger->warning('Security violation logged', [ 'user_id' => $userId, 'violation_type' => $violationType, 'context' => $context ]); }}</code>### R√©f√©rences aux ADR du Projet Gyroscops CloudCe chapitre s‚Äôappuie sur les Architecture Decision Records (ADR) suivants du Gyroscops Cloud :- <strong>HIVE025</strong> : Authorization System - Syst√®me d‚Äôautorisation- <strong>HIVE026</strong> : Keycloak Resource and Scope Management - Gestion des ressources et scopes- <strong>HIVE040</strong> : Enhanced Models with Property Access Patterns - Mod√®les enrichis pour la s√©curit√©- <strong>HIVE041</strong> : Cross-Cutting Concerns Architecture - Architecture des pr√©occupations transversalesHAHAHUGOSHORTCODE9s0HBHB</a></li></ul></nav></toc></div><div class="docs-toc-mobile d-print-none d-xl-none"><button id=toc-dropdown-btn class="btn-secondary dropdown-toggle" type=button data-bs-toggle=dropdown data-bs-offset=0,0 aria-expanded=false>
Table of Contents</button><nav id=toc-mobile><ul class=dropdown-menu><li><a href=#-objectif-de-ce-chapitre-mon-probl√®me--comment-s√©curiser-une-api-platform-complexe-voici-ce-qui-s--javais-une-api-platform-qui-fonctionnait-bien-mais-la-s√©curit√©-√©tait-un-vrai-casse-t√™te-comment-g√©rer-les-permissions--comment-s√©curiser-les-endpoints--comment-g√©rer-lauthentification-multi-tenant-mais-attendez-quand-jai-voulu-impl√©menter-une-s√©curit√©-robuste-j√©tais-perdu-oauth2-jwt-rbac-abac-keycloak-tellement-doptions--comment-choisir--comment-impl√©menter-soudain-je-r√©alisais-que-la-s√©curit√©-n-il-me-fallait-une-approche-structur√©e-et-compl√®te-la-s√©curit√©--mon-guide-completla-s√©curit√©-dans-une-api-platform-avec-ddd-ma-permis-de---prot√©ger-les-donn√©es-sensibles--contr√¥ler-lacc√®s-aux-ressources--g√©rer-les-permissions-granulaires--auditer-les-actions-utilisateurs-quest-ce-que-la-s√©curit√©-dans-une-api-platform--le-concept-fondamentalla-s√©curit√©-dans-une-api-platform-consiste-√†-prot√©ger-les-ressources-et-contr√¥ler-lacc√®s-l--chaque-requ√™te-doit-√™tre-authentifi√©e-et-autoris√©e-avant-dacc√©der-aux-donn√©esavec-gyroscops-voici-comment-j--les-4-piliers-de-la-s√©curit√©-1-authentification---qui-√™tes-vous-voici-comment-j-oauth2--jwt---tokens-jwt-pour-lauthentification--refresh-tokens-pour-la-s√©curit√©--expiration-automatique-des-tokenskeycloak---gestion-centralis√©e-des-utilisateurs--int√©gration-oauth2--gestion-des-r√¥les-et-permissions-2-autorisation---que-pouvez-vous-faire-voici-comment-j-rbac-role-based-access-control---r√¥les-d√©finis-par-domaine--permissions-granulaires--hi√©rarchie-des-r√¥lesabac-attribute-based-access-control---contr√¥le-bas√©-sur-les-attributs--r√®gles-m√©tier-complexes--contexte-dynamique-3-validation---les-donn√©es-sont-elles-valides-voici-comment-j-validation-des-entr√©es---validation-des-donn√©es-dentr√©e--sanitisation-des-donn√©es--gestion-des-erreursvalidation-des-permissions---v√©rification-des-permissions--contr√¥le-dacc√®s-aux-ressources--audit-des-actions-4-audit---que-sest-il-pass√©-voici-comment-j-logging-de-s√©curit√©---logs-dauthentification--logs-dautorisation--logs-dauditmonitoring---d√©tection-dintrusions--alertes-de-s√©curit√©--m√©triques-de-s√©curit√©-comment-impl√©menter-la-s√©curit√©-1-configuration-de-l--jai-configur√©-lauthentification-yamlsecurity----providers--------keycloak------------id-appsecuritykeycloakuserprovider----firewalls--------api------------pattern-api------------stateless-true------------jwt-----access_control-----------path-apiauth-roles-public_access------------path-api-roles-role_user-r√©sultat--authentification-jwt-configur√©e-2-impl√©mentation-de-l--jai-impl√©ment√©-lautorisation-phprouteapipayments-methods-getisgrantedpayment_read-subject-organizationpublic-function-getpaymentsorganization-organization-jsonresponse-----logique-m√©tierr√©sultat--autorisation-bas√©e-sur-les-permissions-3-gestion-des-permissions--jai-g√©r√©-les-permissions-phpfinal-class-paymentvoter-extends-voter----protected-function-supportsstring-attribute-mixed-subject-bool------------return-in_arrayattribute-payment_read-payment_write-payment_delete-------------subject-instanceof-payment------------protected-function-voteonattributestring-attribute-mixed-subject-tokeninterface-token-bool------------user--token-getuser----------------return-match-attribute-------------payment_read--this-canreaduser-subject------------payment_write--this-canwriteuser-subject------------payment_delete--this-candeleteuser-subject------------default--false------------r√©sultat--permissions-granulaires-et-flexibles-4-audit-et-monitoring--jai-impl√©ment√©-laudit-phpfinal-class-securityauditlogger----public-function-logauthenticationstring-userid-bool-success-void------------this-logger-infoauthentication-attempt-------------user_id--userid------------success--success------------timestamp--new-datetimeimmutable--------------------public-function-logauthorizationstring-userid-string-resource-string-action-bool-granted-void------------this-logger-infoauthorization-check-------------user_id--userid------------resource--resource------------action--action------------granted--granted------------timestamp--new-datetimeimmutable------------r√©sultat--audit-complet-des-actions-de-s√©curit√©-les-avantages-de-la-s√©curit√©-structur√©e-1-protection-des-donn√©es--la-s√©curit√©-structur√©e-prot√®ge-les-donn√©es---acc√®s-contr√¥l√©-aux-ressources--donn√©es-sensibles-prot√©g√©es--conformit√©-r√©glementairer√©sultat--donn√©es-s√©curis√©es-et-conformes-2-contr√¥le-d--la-s√©curit√©-structur√©e-permet-un-contr√¥le-granulaire---permissions-par-ressource--r√¥les-contextuels--r√®gles-m√©tier-complexesr√©sultat--contr√¥le-dacc√®s-pr√©cis-et-flexible-3-audit-et-conformit√©--la-s√©curit√©-structur√©e-facilite-laudit---logs-complets-des-actions--tra√ßabilit√©-des-acc√®s--conformit√©-r√©glementairer√©sultat--audit-complet-et-conformit√©-assur√©e-4-√©volutivit√©--la-s√©curit√©-structur√©e-est-√©volutive---ajout-facile-de-nouvelles-permissions--extension-des-r√¥les--adaptation-aux-besoins-m√©tierr√©sultat--s√©curit√©-√©volutive-et-maintenable-les-inconv√©nients-de-la-s√©curit√©-structur√©e-1-complexit√©-accrue--la-s√©curit√©-structur√©e-ajoute-de-la-complexit√©---configuration-complexe--gestion-des-permissions--debugging-plus-difficiler√©sultat--courbe-dapprentissage-plus-importante-2-performance--la-s√©curit√©-structur√©e-peut-impacter-les-performances---v√©rifications-dautorisation--validation-des-tokens--logs-dauditr√©sultat--performance-potentiellement-d√©grad√©e-3-maintenance--la-s√©curit√©-structur√©e-n√©cessite-de-la-maintenance---mise-√†-jour-des-permissions--gestion-des-r√¥les--monitoring-continur√©sultat--maintenance-plus-complexe-4-gestion-des-erreurs--la-s√©curit√©-structur√©e-complique-la-gestion-des-erreurs---erreurs-dauthentification--erreurs-dautorisation--messages-derreur-appropri√©sr√©sultat--gestion-derreurs-plus-complexe-les-pi√®ges-√†-√©viter-1-s√©curit√©-par-obscurit√©-mauvais--compter-sur-lobscurit√©-pour-la-s√©curit√©-bon--s√©curit√©-bas√©e-sur-des-standards-√©prouv√©spourquoi-c-lobscurit√©-nest-pas-une-s√©curit√©-2-permissions-trop-granulaires-mauvais--une-permission-pour-chaque-action-bon--permissions-par-domaine-m√©tierpourquoi-c-des-permissions-trop-granulaires-sont-difficiles-√†-g√©rer-3-ignorer-l-mauvais--pas-daudit-des-actions-de-s√©curit√©-bon--audit-complet-des-actionspourquoi-c-laudit-est-essentiel-pour-la-s√©curit√©-4-tokens-non-s√©curis√©s-mauvais--tokens-non-s√©curis√©s-ou-non-expir√©s-bon--tokens-s√©curis√©s-avec-expirationpourquoi-c-les-tokens-non-s√©curis√©s-sont-une-faille-de-s√©curit√©-l√©volution-vers-la-s√©curit√©-structur√©e-phase-1--authentification-basiqueavec-gyroscops--au-d√©but-javais-une-authentification-basique---loginpassword-simple--sessions-php--pas-dautorisationr√©sultat--d√©veloppement-rapide-s√©curit√©-faible-phase-2--introduction-de-lautorisationavec-gyroscops--jai-introduit-lautorisation---r√¥les-basiques--permissions-simples--contr√¥le-dacc√®sr√©sultat--s√©curit√©-am√©lior√©e-complexit√©-accrue-phase-3--s√©curit√©-compl√®teavec-gyroscops--maintenant-jai-une-s√©curit√©-compl√®te---oauth2--jwt--rbac--abac--audit-completr√©sultat--s√©curit√©-robuste-et-√©volutive--impl√©mentation-concr√®te-dans-le-projet-gyroscops-cloud-s√©curit√©-appliqu√©e-√†-gyroscops-cloudle-gyroscops-cloud-applique-concr√®tement-les-principes-de-s√©curit√©-√†-travers-son-architecture-et-ses-adr-architecture-decision-records-voici-comment--syst√®me-dauthentification-gyroscops-cloudphp--syst√®me-dauthentification-gyroscops-cloud-projet-gyroscops-cloudfinal-class-hiveauthenticationservice----public-function-__construct--------private-keycloakclient-keycloakclient--------private-jwttokenservice-jwtservice--------private-userrepositoryinterface-userrepository--------private-loggerinterface-logger-------------public-function-authenticatestring-email-string-password-authresult------------this-logger-infoauthentication-attempt-------------email--email------------timestamp--new-datetimeimmutable------------------------try-------------keycloakuser--this-keycloakclient-authenticateemail-password------------------------if-keycloakuser-----------------this-logger-warningauthentication-failed---------------------email--email--------------------reason--invalid-credentials------------------------------------------------return-authresultfailureinvalid-credentials------------------------------------user--this-userrepository-findbyemailnew-emailemail------------if-user-----------------this-logger-warninguser-not-found---------------------email--email------------------------------------------------return-authresultfailureuser-not-found------------------------------------token--this-jwtservice-generatetokenuser------------------------this-logger-infoauthentication-successful-----------------user_id--user-getid-tostring----------------email--email------------------------------------return-authresultsuccessuser-token---------------------catch-exception-e-------------this-logger-errorauthentication-error-----------------email--email----------------error--e-getmessage------------------------------------return-authresultfailureauthentication-failed--------------------public-function-refreshtokenstring-refreshtoken-authresult------------try-------------newtoken--this-jwtservice-refreshtokenrefreshtoken------------------------this-logger-infotoken-refreshed-successfully------------------------return-authresultsuccessnull-newtoken---------------------catch-exception-e-------------this-logger-errortoken-refresh-failed-----------------error--e-getmessage------------------------------------return-authresultfailuretoken-refresh-failed-------------syst√®me-dautorisation-gyroscops-cloudphp--syst√®me-dautorisation-gyroscops-cloud-projet-gyroscops-cloudfinal-class-hiveauthorizationservice----public-function-__construct--------private-permissionrepositoryinterface-permissionrepository--------private-rolerepositoryinterface-rolerepository--------private-loggerinterface-logger-------------public-function-haspermissionuser-user-string-resource-string-action-bool------------this-logger-infochecking-permission-------------user_id--user-getid-tostring------------resource--resource------------action--action------------------------try-------------userroles--this-rolerepository-findbyuseruser------------------------foreach-userroles-as-role-----------------permissions--this-permissionrepository-findbyrolerole--------------------------------foreach-permissions-as-permission---------------------if-permission-matchesresource-action-------------------------this-logger-infopermission-granted-----------------------------user_id--user-getid-tostring----------------------------resource--resource----------------------------action--action----------------------------role--role-getname------------------------------------------------------------------------return-true------------------------------------------------------------------------this-logger-warningpermission-denied-----------------user_id--user-getid-tostring----------------resource--resource----------------action--action------------------------------------return-false---------------------catch-exception-e-------------this-logger-errorauthorization-error-----------------user_id--user-getid-tostring----------------resource--resource----------------action--action----------------error--e-getmessage------------------------------------return-false--------------------public-function-checkresourceaccessuser-user-string-resource-string-action-mixed-subject-bool-------------v√©rification-des-permissions-de-base--------if-this-haspermissionuser-resource-action-------------return-false-------------------------v√©rification-des-permissions-contextuelles--------if-subject-instanceof-organizationaware-------------return-this-checkorganizationaccessuser-subject------------------------if-subject-instanceof-useraware-------------return-this-checkuseraccessuser-subject------------------------return-true------------private-function-checkorganizationaccessuser-user-organizationaware-subject-bool------------userorganizations--this-getuserorganizationsuser--------subjectorganization--subject-getorganizationid----------------return-in_arraysubjectorganization-userorganizations------------private-function-checkuseraccessuser-user-useraware-subject-bool------------return-user-getid-equalssubject-getuserid-----voters-de-s√©curit√©-gyroscops-cloudphp--voters-de-s√©curit√©-gyroscops-cloud-projet-gyroscops-cloudfinal-class-paymentvoter-extends-voter----public-function-__construct--------private-hiveauthorizationservice-authorizationservice--------private-loggerinterface-logger-------------protected-function-supportsstring-attribute-mixed-subject-bool------------return-in_arrayattribute-------------payment_read------------payment_write------------payment_delete------------payment_approve------------payment_refund----------subject-instanceof-payment------------protected-function-voteonattributestring-attribute-mixed-subject-tokeninterface-token-bool------------user--token-getuser----------------if-user-instanceof-user-------------return-false------------------------this-logger-infovoting-on-payment-permission-------------user_id--user-getid-tostring------------attribute--attribute------------payment_id--subject-getid-tostring------------------------result--match-attribute-------------payment_read--this-canreaduser-subject------------payment_write--this-canwriteuser-subject------------payment_delete--this-candeleteuser-subject------------payment_approve--this-canapproveuser-subject------------payment_refund--this-canrefunduser-subject------------default--false------------------------this-logger-infovote-result-------------user_id--user-getid-tostring------------attribute--attribute------------result--result------------------------return-result------------private-function-canreaduser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------read------------payment--------------------private-function-canwriteuser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------write------------payment--------------------private-function-candeleteuser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------delete------------payment--------------------private-function-canapproveuser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------approve------------payment--------------------private-function-canrefunduser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------refund------------payment-------------audit-de-s√©curit√©-gyroscops-cloudphp--audit-de-s√©curit√©-gyroscops-cloud-projet-gyroscops-cloudfinal-class-hivesecurityauditservice----public-function-__construct--------private-loggerinterface-logger--------private-securityeventrepositoryinterface-eventrepository-------------public-function-logauthenticationeventstring-userid-bool-success-array-context---void------------event--new-securityevent------------securityeventtypeauthentication------------userid------------success------------context------------------------this-eventrepository-saveevent----------------this-logger-infoauthentication-event-logged-------------user_id--userid------------success--success------------context--context--------------------public-function-logauthorizationeventstring-userid-string-resource-string-action-bool-granted-array-context---void------------event--new-securityevent------------securityeventtypeauthorization------------userid------------granted------------array_mergecontext-----------------resource--resource----------------action--action------------------------------------this-eventrepository-saveevent----------------this-logger-infoauthorization-event-logged-------------user_id--userid------------resource--resource------------action--action------------granted--granted------------context--context--------------------public-function-logsecurityviolationstring-userid-string-violationtype-array-context---void------------event--new-securityevent------------securityeventtypeviolation------------userid------------false------------array_mergecontext-----------------violation_type--violationtype------------------------------------this-eventrepository-saveevent----------------this-logger-warningsecurity-violation-logged-------------user_id--userid------------violation_type--violationtype------------context--context-------------r√©f√©rences-aux-adr-du-projet-gyroscops-cloudce-chapitre-sappuie-sur-les-architecture-decision-records-adr-suivants-du-gyroscops-cloud---hive025--authorization-system---syst√®me-dautorisation--hive026--keycloak-resource-and-scope-management---gestion-des-ressources-et-scopes--hive040--enhanced-models-with-property-access-patterns---mod√®les-enrichis-pour-la-s√©curit√©--hive041--cross-cutting-concerns-architecture---architecture-des-pr√©occupations-transversaleshahahugoshortcode9s0hbhb>üéØ Objectif de ce Chapitre### Mon Probl√®me : Comment S√©curiser une API Platform Complexe ?<strong>Voici ce qui s‚Äôest pass√© avec Gyroscops</strong> : J‚Äôavais une API Platform qui fonctionnait bien, mais la s√©curit√© √©tait un vrai casse-t√™te. Comment g√©rer les permissions ? Comment s√©curiser les endpoints ? Comment g√©rer l‚Äôauthentification multi-tenant ?<strong>Mais attendez‚Ä¶</strong> Quand j‚Äôai voulu impl√©menter une s√©curit√© robuste, j‚Äô√©tais perdu. OAuth2, JWT, RBAC, ABAC, Keycloak‚Ä¶ Tellement d‚Äôoptions ! Comment choisir ? Comment impl√©menter ?<strong>Soudain, je r√©alisais que la s√©curit√© n‚Äô√©tait pas optionnelle !</strong> Il me fallait une approche structur√©e et compl√®te.### La S√©curit√© : Mon Guide CompletLa s√©curit√© dans une API Platform avec DDD m‚Äôa permis de :- <strong>Prot√©ger</strong> les donn√©es sensibles- <strong>Contr√¥ler</strong> l‚Äôacc√®s aux ressources- <strong>G√©rer</strong> les permissions granulaires- <strong>Auditer</strong> les actions utilisateurs## Qu‚Äôest-ce que la S√©curit√© dans une API Platform ?### Le Concept FondamentalLa s√©curit√© dans une API Platform consiste √† prot√©ger les ressources et contr√¥ler l‚Äôacc√®s. <strong>L‚Äôid√©e</strong> : Chaque requ√™te doit √™tre authentifi√©e et autoris√©e avant d‚Äôacc√©der aux donn√©es.<strong>Avec Gyroscops, voici comment j‚Äôai structur√© la s√©curit√©</strong> :### Les 4 Piliers de la S√©curit√©#### 1. <strong>Authentification</strong> - Qui √™tes-vous ?<strong>Voici comment j‚Äôai impl√©ment√© l‚Äôauthentification avec Gyroscops</strong> :<strong>OAuth2 + JWT</strong> :- Tokens JWT pour l‚Äôauthentification- Refresh tokens pour la s√©curit√©- Expiration automatique des tokens<strong>Keycloak</strong> :- Gestion centralis√©e des utilisateurs- Int√©gration OAuth2- Gestion des r√¥les et permissions#### 2. <strong>Autorisation</strong> - Que pouvez-vous faire ?<strong>Voici comment j‚Äôai impl√©ment√© l‚Äôautorisation avec Gyroscops</strong> :<strong>RBAC (Role-Based Access Control)</strong> :- R√¥les d√©finis par domaine- Permissions granulaires- Hi√©rarchie des r√¥les<strong>ABAC (Attribute-Based Access Control)</strong> :- Contr√¥le bas√© sur les attributs- R√®gles m√©tier complexes- Contexte dynamique#### 3. <strong>Validation</strong> - Les donn√©es sont-elles valides ?<strong>Voici comment j‚Äôai impl√©ment√© la validation avec Gyroscops</strong> :<strong>Validation des Entr√©es</strong> :- Validation des donn√©es d‚Äôentr√©e- Sanitisation des donn√©es- Gestion des erreurs<strong>Validation des Permissions</strong> :- V√©rification des permissions- Contr√¥le d‚Äôacc√®s aux ressources- Audit des actions#### 4. <strong>Audit</strong> - Que s‚Äôest-il pass√© ?<strong>Voici comment j‚Äôai impl√©ment√© l‚Äôaudit avec Gyroscops</strong> :<strong>Logging de S√©curit√©</strong> :- Logs d‚Äôauthentification- Logs d‚Äôautorisation- Logs d‚Äôaudit<strong>Monitoring</strong> :- D√©tection d‚Äôintrusions- Alertes de s√©curit√©- M√©triques de s√©curit√©## Comment Impl√©menter la S√©curit√©### 1. <strong>Configuration de l‚ÄôAuthentification****Avec Gyroscops</strong> : J‚Äôai configur√© l‚Äôauthentification :<code>yamlsecurity: providers: keycloak: id: App\Security\KeycloakUserProvider firewalls: api: pattern: ^/api stateless: true jwt: ~ access_control: - { path: ^/api/auth, roles: PUBLIC_ACCESS } - { path: ^/api, roles: ROLE_USER }</code><strong>R√©sultat</strong> : Authentification JWT configur√©e.### 2. <strong>Impl√©mentation de l‚ÄôAutorisation****Avec Gyroscops</strong> : J‚Äôai impl√©ment√© l‚Äôautorisation :<code>php#[Route('/api/payments', methods: ['GET'])]#[IsGranted('PAYMENT_READ', subject: 'organization')]public function getPayments(Organization $organization): JsonResponse{ // Logique m√©tier}</code><strong>R√©sultat</strong> : Autorisation bas√©e sur les permissions.### 3. <strong>Gestion des Permissions****Avec Gyroscops</strong> : J‚Äôai g√©r√© les permissions :<code>phpfinal class PaymentVoter extends Voter{ protected function supports(string $attribute, mixed $subject): bool { return in_array($attribute, ['PAYMENT_READ', 'PAYMENT_WRITE', 'PAYMENT_DELETE']) && $subject instanceof Payment; } protected function voteOnAttribute(string $attribute, mixed $subject, TokenInterface $token): bool { $user = $token->getUser(); return match ($attribute) { 'PAYMENT_READ' => $this->canRead($user, $subject), 'PAYMENT_WRITE' => $this->canWrite($user, $subject), 'PAYMENT_DELETE' => $this->canDelete($user, $subject), default => false }; }}</code><strong>R√©sultat</strong> : Permissions granulaires et flexibles.### 4. <strong>Audit et Monitoring****Avec Gyroscops</strong> : J‚Äôai impl√©ment√© l‚Äôaudit :<code>phpfinal class SecurityAuditLogger{ public function logAuthentication(string $userId, bool $success): void { $this->logger->info('Authentication attempt', [ 'user_id' => $userId, 'success' => $success, 'timestamp' => new \DateTimeImmutable() ]); } public function logAuthorization(string $userId, string $resource, string $action, bool $granted): void { $this->logger->info('Authorization check', [ 'user_id' => $userId, 'resource' => $resource, 'action' => $action, 'granted' => $granted, 'timestamp' => new \DateTimeImmutable() ]); }}</code><strong>R√©sultat</strong> : Audit complet des actions de s√©curit√©.## Les Avantages de la S√©curit√© Structur√©e### 1. <strong>Protection des Donn√©es****Avec Gyroscops</strong> : La s√©curit√© structur√©e prot√®ge les donn√©es :- Acc√®s contr√¥l√© aux ressources- Donn√©es sensibles prot√©g√©es- Conformit√© r√©glementaire<strong>R√©sultat</strong> : Donn√©es s√©curis√©es et conformes.### 2. <strong>Contr√¥le d‚ÄôAcc√®s Granulaire****Avec Gyroscops</strong> : La s√©curit√© structur√©e permet un contr√¥le granulaire :- Permissions par ressource- R√¥les contextuels- R√®gles m√©tier complexes<strong>R√©sultat</strong> : Contr√¥le d‚Äôacc√®s pr√©cis et flexible.### 3. <strong>Audit et Conformit√©****Avec Gyroscops</strong> : La s√©curit√© structur√©e facilite l‚Äôaudit :- Logs complets des actions- Tra√ßabilit√© des acc√®s- Conformit√© r√©glementaire<strong>R√©sultat</strong> : Audit complet et conformit√© assur√©e.### 4. <strong>√âvolutivit√©****Avec Gyroscops</strong> : La s√©curit√© structur√©e est √©volutive :- Ajout facile de nouvelles permissions- Extension des r√¥les- Adaptation aux besoins m√©tier<strong>R√©sultat</strong> : S√©curit√© √©volutive et maintenable.## Les Inconv√©nients de la S√©curit√© Structur√©e### 1. <strong>Complexit√© Accrue****Avec Gyroscops</strong> : La s√©curit√© structur√©e ajoute de la complexit√© :- Configuration complexe- Gestion des permissions- Debugging plus difficile<strong>R√©sultat</strong> : Courbe d‚Äôapprentissage plus importante.### 2. <strong>Performance****Avec Gyroscops</strong> : La s√©curit√© structur√©e peut impacter les performances :- V√©rifications d‚Äôautorisation- Validation des tokens- Logs d‚Äôaudit<strong>R√©sultat</strong> : Performance potentiellement d√©grad√©e.### 3. <strong>Maintenance****Avec Gyroscops</strong> : La s√©curit√© structur√©e n√©cessite de la maintenance :- Mise √† jour des permissions- Gestion des r√¥les- Monitoring continu<strong>R√©sultat</strong> : Maintenance plus complexe.### 4. <strong>Gestion des Erreurs****Avec Gyroscops</strong> : La s√©curit√© structur√©e complique la gestion des erreurs :- Erreurs d‚Äôauthentification- Erreurs d‚Äôautorisation- Messages d‚Äôerreur appropri√©s<strong>R√©sultat</strong> : Gestion d‚Äôerreurs plus complexe.## Les Pi√®ges √† √âviter### 1. <strong>S√©curit√© par Obscurit√©</strong>**‚ùå Mauvais** : Compter sur l‚Äôobscurit√© pour la s√©curit√©**‚úÖ Bon** : S√©curit√© bas√©e sur des standards √©prouv√©s<strong>Pourquoi c‚Äôest important ?</strong> L‚Äôobscurit√© n‚Äôest pas une s√©curit√©.### 2. <strong>Permissions Trop Granulaires</strong>**‚ùå Mauvais** : Une permission pour chaque action**‚úÖ Bon** : Permissions par domaine m√©tier<strong>Pourquoi c‚Äôest crucial ?</strong> Des permissions trop granulaires sont difficiles √† g√©rer.### 3. <strong>Ignorer l‚ÄôAudit</strong>**‚ùå Mauvais** : Pas d‚Äôaudit des actions de s√©curit√©**‚úÖ Bon** : Audit complet des actions<strong>Pourquoi c‚Äôest essentiel ?</strong> L‚Äôaudit est essentiel pour la s√©curit√©.### 4. <strong>Tokens Non S√©curis√©s</strong>**‚ùå Mauvais** : Tokens non s√©curis√©s ou non expir√©s**‚úÖ Bon** : Tokens s√©curis√©s avec expiration<strong>Pourquoi c‚Äôest la cl√© ?</strong> Les tokens non s√©curis√©s sont une faille de s√©curit√©.## L‚Äô√âvolution vers la S√©curit√© Structur√©e### Phase 1 : Authentification Basique<strong>Avec Gyroscops</strong> : Au d√©but, j‚Äôavais une authentification basique :- Login/password simple- Sessions PHP- Pas d‚Äôautorisation<strong>R√©sultat</strong> : D√©veloppement rapide, s√©curit√© faible.### Phase 2 : Introduction de l‚ÄôAutorisation<strong>Avec Gyroscops</strong> : J‚Äôai introduit l‚Äôautorisation :- R√¥les basiques- Permissions simples- Contr√¥le d‚Äôacc√®s<strong>R√©sultat</strong> : S√©curit√© am√©lior√©e, complexit√© accrue.### Phase 3 : S√©curit√© Compl√®te<strong>Avec Gyroscops</strong> : Maintenant, j‚Äôai une s√©curit√© compl√®te :- OAuth2 + JWT- RBAC + ABAC- Audit complet<strong>R√©sultat</strong> : S√©curit√© robuste et √©volutive.## üèóÔ∏è Impl√©mentation Concr√®te dans le Projet Gyroscops Cloud### S√©curit√© Appliqu√©e √† Gyroscops CloudLe Gyroscops Cloud applique concr√®tement les principes de s√©curit√© √† travers son architecture et ses ADR (Architecture Decision Records). Voici comment :#### Syst√®me d‚ÄôAuthentification Gyroscops Cloud<code>php// ‚úÖ Syst√®me d'Authentification Gyroscops Cloud (Projet Gyroscops Cloud)final class HiveAuthenticationService{ public function __construct( private KeycloakClient $keycloakClient, private JwtTokenService $jwtService, private UserRepositoryInterface $userRepository, private LoggerInterface $logger ) {} public function authenticate(string $email, string $password): AuthResult { $this->logger->info('Authentication attempt', [ 'email' => $email, 'timestamp' => new \DateTimeImmutable() ]); try { $keycloakUser = $this->keycloakClient->authenticate($email, $password); if (!$keycloakUser) { $this->logger->warning('Authentication failed', [ 'email' => $email, 'reason' => 'Invalid credentials' ]); return AuthResult::failure('Invalid credentials'); } $user = $this->userRepository->findByEmail(new Email($email)); if (!$user) { $this->logger->warning('User not found', [ 'email' => $email ]); return AuthResult::failure('User not found'); } $token = $this->jwtService->generateToken($user); $this->logger->info('Authentication successful', [ 'user_id' => $user->getId()->toString(), 'email' => $email ]); return AuthResult::success($user, $token); } catch (\Exception $e) { $this->logger->error('Authentication error', [ 'email' => $email, 'error' => $e->getMessage() ]); return AuthResult::failure('Authentication failed'); } } public function refreshToken(string $refreshToken): AuthResult { try { $newToken = $this->jwtService->refreshToken($refreshToken); $this->logger->info('Token refreshed successfully'); return AuthResult::success(null, $newToken); } catch (\Exception $e) { $this->logger->error('Token refresh failed', [ 'error' => $e->getMessage() ]); return AuthResult::failure('Token refresh failed'); } }}</code>#### Syst√®me d‚ÄôAutorisation Gyroscops Cloud<code>php// ‚úÖ Syst√®me d'Autorisation Gyroscops Cloud (Projet Gyroscops Cloud)final class HiveAuthorizationService{ public function __construct( private PermissionRepositoryInterface $permissionRepository, private RoleRepositoryInterface $roleRepository, private LoggerInterface $logger ) {} public function hasPermission(User $user, string $resource, string $action): bool { $this->logger->info('Checking permission', [ 'user_id' => $user->getId()->toString(), 'resource' => $resource, 'action' => $action ]); try { $userRoles = $this->roleRepository->findByUser($user); foreach ($userRoles as $role) { $permissions = $this->permissionRepository->findByRole($role); foreach ($permissions as $permission) { if ($permission->matches($resource, $action)) { $this->logger->info('Permission granted', [ 'user_id' => $user->getId()->toString(), 'resource' => $resource, 'action' => $action, 'role' => $role->getName() ]); return true; } } } $this->logger->warning('Permission denied', [ 'user_id' => $user->getId()->toString(), 'resource' => $resource, 'action' => $action ]); return false; } catch (\Exception $e) { $this->logger->error('Authorization error', [ 'user_id' => $user->getId()->toString(), 'resource' => $resource, 'action' => $action, 'error' => $e->getMessage() ]); return false; } } public function checkResourceAccess(User $user, string $resource, string $action, mixed $subject): bool { // V√©rification des permissions de base if (!$this->hasPermission($user, $resource, $action)) { return false; } // V√©rification des permissions contextuelles if ($subject instanceof OrganizationAware) { return $this->checkOrganizationAccess($user, $subject); } if ($subject instanceof UserAware) { return $this->checkUserAccess($user, $subject); } return true; } private function checkOrganizationAccess(User $user, OrganizationAware $subject): bool { $userOrganizations = $this->getUserOrganizations($user); $subjectOrganization = $subject->getOrganizationId(); return in_array($subjectOrganization, $userOrganizations); } private function checkUserAccess(User $user, UserAware $subject): bool { return $user->getId()->equals($subject->getUserId()); }}</code>#### Voters de S√©curit√© Gyroscops Cloud<code>php// ‚úÖ Voters de S√©curit√© Gyroscops Cloud (Projet Gyroscops Cloud)final class PaymentVoter extends Voter{ public function __construct( private HiveAuthorizationService $authorizationService, private LoggerInterface $logger ) {} protected function supports(string $attribute, mixed $subject): bool { return in_array($attribute, [ 'PAYMENT_READ', 'PAYMENT_WRITE', 'PAYMENT_DELETE', 'PAYMENT_APPROVE', 'PAYMENT_REFUND' ]) && $subject instanceof Payment; } protected function voteOnAttribute(string $attribute, mixed $subject, TokenInterface $token): bool { $user = $token->getUser(); if (!$user instanceof User) { return false; } $this->logger->info('Voting on payment permission', [ 'user_id' => $user->getId()->toString(), 'attribute' => $attribute, 'payment_id' => $subject->getId()->toString() ]); $result = match ($attribute) { 'PAYMENT_READ' => $this->canRead($user, $subject), 'PAYMENT_WRITE' => $this->canWrite($user, $subject), 'PAYMENT_DELETE' => $this->canDelete($user, $subject), 'PAYMENT_APPROVE' => $this->canApprove($user, $subject), 'PAYMENT_REFUND' => $this->canRefund($user, $subject), default => false }; $this->logger->info('Vote result', [ 'user_id' => $user->getId()->toString(), 'attribute' => $attribute, 'result' => $result ]); return $result; } private function canRead(User $user, Payment $payment): bool { return $this->authorizationService->checkResourceAccess( $user, 'payment', 'read', $payment ); } private function canWrite(User $user, Payment $payment): bool { return $this->authorizationService->checkResourceAccess( $user, 'payment', 'write', $payment ); } private function canDelete(User $user, Payment $payment): bool { return $this->authorizationService->checkResourceAccess( $user, 'payment', 'delete', $payment ); } private function canApprove(User $user, Payment $payment): bool { return $this->authorizationService->checkResourceAccess( $user, 'payment', 'approve', $payment ); } private function canRefund(User $user, Payment $payment): bool { return $this->authorizationService->checkResourceAccess( $user, 'payment', 'refund', $payment ); }}</code>#### Audit de S√©curit√© Gyroscops Cloud<code>php// ‚úÖ Audit de S√©curit√© Gyroscops Cloud (Projet Gyroscops Cloud)final class HiveSecurityAuditService{ public function __construct( private LoggerInterface $logger, private SecurityEventRepositoryInterface $eventRepository ) {} public function logAuthenticationEvent(string $userId, bool $success, array $context = []): void { $event = new SecurityEvent( SecurityEventType::AUTHENTICATION, $userId, $success, $context ); $this->eventRepository->save($event); $this->logger->info('Authentication event logged', [ 'user_id' => $userId, 'success' => $success, 'context' => $context ]); } public function logAuthorizationEvent(string $userId, string $resource, string $action, bool $granted, array $context = []): void { $event = new SecurityEvent( SecurityEventType::AUTHORIZATION, $userId, $granted, array_merge($context, [ 'resource' => $resource, 'action' => $action ]) ); $this->eventRepository->save($event); $this->logger->info('Authorization event logged', [ 'user_id' => $userId, 'resource' => $resource, 'action' => $action, 'granted' => $granted, 'context' => $context ]); } public function logSecurityViolation(string $userId, string $violationType, array $context = []): void { $event = new SecurityEvent( SecurityEventType::VIOLATION, $userId, false, array_merge($context, [ 'violation_type' => $violationType ]) ); $this->eventRepository->save($event); $this->logger->warning('Security violation logged', [ 'user_id' => $userId, 'violation_type' => $violationType, 'context' => $context ]); }}</code>### R√©f√©rences aux ADR du Projet Gyroscops CloudCe chapitre s‚Äôappuie sur les Architecture Decision Records (ADR) suivants du Gyroscops Cloud :- <strong>HIVE025</strong> : Authorization System - Syst√®me d‚Äôautorisation- <strong>HIVE026</strong> : Keycloak Resource and Scope Management - Gestion des ressources et scopes- <strong>HIVE040</strong> : Enhanced Models with Property Access Patterns - Mod√®les enrichis pour la s√©curit√©- <strong>HIVE041</strong> : Cross-Cutting Concerns Architecture - Architecture des pr√©occupations transversalesHAHAHUGOSHORTCODE9s0HBHB</a></li></ul></nav></div><div class="docs-content col-12 col-xl-9 mt-0"><div class="mb-0 d-flex"><h1 class="content-title mb-0">Chapitre 62 : S√©curit√© et Autorisation - Prot√©ger votre API Platform
<span class="badge bg-default fs-6 mb-1 align-middle">DRAFT</span></h1></div><div id=content class=main-content><div data-prismjs-copy data-prismjs-copy-success data-prismjs-copy-error><h2 id=-objectif-de-ce-chapitre-mon-probl√®me--comment-s√©curiser-une-api-platform-complexe-voici-ce-qui-s--javais-une-api-platform-qui-fonctionnait-bien-mais-la-s√©curit√©-√©tait-un-vrai-casse-t√™te-comment-g√©rer-les-permissions--comment-s√©curiser-les-endpoints--comment-g√©rer-lauthentification-multi-tenant-mais-attendez-quand-jai-voulu-impl√©menter-une-s√©curit√©-robuste-j√©tais-perdu-oauth2-jwt-rbac-abac-keycloak-tellement-doptions--comment-choisir--comment-impl√©menter-soudain-je-r√©alisais-que-la-s√©curit√©-n-il-me-fallait-une-approche-structur√©e-et-compl√®te-la-s√©curit√©--mon-guide-completla-s√©curit√©-dans-une-api-platform-avec-ddd-ma-permis-de---prot√©ger-les-donn√©es-sensibles--contr√¥ler-lacc√®s-aux-ressources--g√©rer-les-permissions-granulaires--auditer-les-actions-utilisateurs-quest-ce-que-la-s√©curit√©-dans-une-api-platform--le-concept-fondamentalla-s√©curit√©-dans-une-api-platform-consiste-√†-prot√©ger-les-ressources-et-contr√¥ler-lacc√®s-l--chaque-requ√™te-doit-√™tre-authentifi√©e-et-autoris√©e-avant-dacc√©der-aux-donn√©esavec-gyroscops-voici-comment-j--les-4-piliers-de-la-s√©curit√©-1-authentification---qui-√™tes-vous-voici-comment-j-oauth2--jwt---tokens-jwt-pour-lauthentification--refresh-tokens-pour-la-s√©curit√©--expiration-automatique-des-tokenskeycloak---gestion-centralis√©e-des-utilisateurs--int√©gration-oauth2--gestion-des-r√¥les-et-permissions-2-autorisation---que-pouvez-vous-faire-voici-comment-j-rbac-role-based-access-control---r√¥les-d√©finis-par-domaine--permissions-granulaires--hi√©rarchie-des-r√¥lesabac-attribute-based-access-control---contr√¥le-bas√©-sur-les-attributs--r√®gles-m√©tier-complexes--contexte-dynamique-3-validation---les-donn√©es-sont-elles-valides-voici-comment-j-validation-des-entr√©es---validation-des-donn√©es-dentr√©e--sanitisation-des-donn√©es--gestion-des-erreursvalidation-des-permissions---v√©rification-des-permissions--contr√¥le-dacc√®s-aux-ressources--audit-des-actions-4-audit---que-sest-il-pass√©-voici-comment-j-logging-de-s√©curit√©---logs-dauthentification--logs-dautorisation--logs-dauditmonitoring---d√©tection-dintrusions--alertes-de-s√©curit√©--m√©triques-de-s√©curit√©-comment-impl√©menter-la-s√©curit√©-1-configuration-de-l--jai-configur√©-lauthentification-yamlsecurity----providers--------keycloak------------id-appsecuritykeycloakuserprovider----firewalls--------api------------pattern-api------------stateless-true------------jwt-----access_control-----------path-apiauth-roles-public_access------------path-api-roles-role_user-r√©sultat--authentification-jwt-configur√©e-2-impl√©mentation-de-l--jai-impl√©ment√©-lautorisation-phprouteapipayments-methods-getisgrantedpayment_read-subject-organizationpublic-function-getpaymentsorganization-organization-jsonresponse-----logique-m√©tierr√©sultat--autorisation-bas√©e-sur-les-permissions-3-gestion-des-permissions--jai-g√©r√©-les-permissions-phpfinal-class-paymentvoter-extends-voter----protected-function-supportsstring-attribute-mixed-subject-bool------------return-in_arrayattribute-payment_read-payment_write-payment_delete-------------subject-instanceof-payment------------protected-function-voteonattributestring-attribute-mixed-subject-tokeninterface-token-bool------------user--token-getuser----------------return-match-attribute-------------payment_read--this-canreaduser-subject------------payment_write--this-canwriteuser-subject------------payment_delete--this-candeleteuser-subject------------default--false------------r√©sultat--permissions-granulaires-et-flexibles-4-audit-et-monitoring--jai-impl√©ment√©-laudit-phpfinal-class-securityauditlogger----public-function-logauthenticationstring-userid-bool-success-void------------this-logger-infoauthentication-attempt-------------user_id--userid------------success--success------------timestamp--new-datetimeimmutable--------------------public-function-logauthorizationstring-userid-string-resource-string-action-bool-granted-void------------this-logger-infoauthorization-check-------------user_id--userid------------resource--resource------------action--action------------granted--granted------------timestamp--new-datetimeimmutable------------r√©sultat--audit-complet-des-actions-de-s√©curit√©-les-avantages-de-la-s√©curit√©-structur√©e-1-protection-des-donn√©es--la-s√©curit√©-structur√©e-prot√®ge-les-donn√©es---acc√®s-contr√¥l√©-aux-ressources--donn√©es-sensibles-prot√©g√©es--conformit√©-r√©glementairer√©sultat--donn√©es-s√©curis√©es-et-conformes-2-contr√¥le-d--la-s√©curit√©-structur√©e-permet-un-contr√¥le-granulaire---permissions-par-ressource--r√¥les-contextuels--r√®gles-m√©tier-complexesr√©sultat--contr√¥le-dacc√®s-pr√©cis-et-flexible-3-audit-et-conformit√©--la-s√©curit√©-structur√©e-facilite-laudit---logs-complets-des-actions--tra√ßabilit√©-des-acc√®s--conformit√©-r√©glementairer√©sultat--audit-complet-et-conformit√©-assur√©e-4-√©volutivit√©--la-s√©curit√©-structur√©e-est-√©volutive---ajout-facile-de-nouvelles-permissions--extension-des-r√¥les--adaptation-aux-besoins-m√©tierr√©sultat--s√©curit√©-√©volutive-et-maintenable-les-inconv√©nients-de-la-s√©curit√©-structur√©e-1-complexit√©-accrue--la-s√©curit√©-structur√©e-ajoute-de-la-complexit√©---configuration-complexe--gestion-des-permissions--debugging-plus-difficiler√©sultat--courbe-dapprentissage-plus-importante-2-performance--la-s√©curit√©-structur√©e-peut-impacter-les-performances---v√©rifications-dautorisation--validation-des-tokens--logs-dauditr√©sultat--performance-potentiellement-d√©grad√©e-3-maintenance--la-s√©curit√©-structur√©e-n√©cessite-de-la-maintenance---mise-√†-jour-des-permissions--gestion-des-r√¥les--monitoring-continur√©sultat--maintenance-plus-complexe-4-gestion-des-erreurs--la-s√©curit√©-structur√©e-complique-la-gestion-des-erreurs---erreurs-dauthentification--erreurs-dautorisation--messages-derreur-appropri√©sr√©sultat--gestion-derreurs-plus-complexe-les-pi√®ges-√†-√©viter-1-s√©curit√©-par-obscurit√©-mauvais--compter-sur-lobscurit√©-pour-la-s√©curit√©-bon--s√©curit√©-bas√©e-sur-des-standards-√©prouv√©spourquoi-c-lobscurit√©-nest-pas-une-s√©curit√©-2-permissions-trop-granulaires-mauvais--une-permission-pour-chaque-action-bon--permissions-par-domaine-m√©tierpourquoi-c-des-permissions-trop-granulaires-sont-difficiles-√†-g√©rer-3-ignorer-l-mauvais--pas-daudit-des-actions-de-s√©curit√©-bon--audit-complet-des-actionspourquoi-c-laudit-est-essentiel-pour-la-s√©curit√©-4-tokens-non-s√©curis√©s-mauvais--tokens-non-s√©curis√©s-ou-non-expir√©s-bon--tokens-s√©curis√©s-avec-expirationpourquoi-c-les-tokens-non-s√©curis√©s-sont-une-faille-de-s√©curit√©-l√©volution-vers-la-s√©curit√©-structur√©e-phase-1--authentification-basiqueavec-gyroscops--au-d√©but-javais-une-authentification-basique---loginpassword-simple--sessions-php--pas-dautorisationr√©sultat--d√©veloppement-rapide-s√©curit√©-faible-phase-2--introduction-de-lautorisationavec-gyroscops--jai-introduit-lautorisation---r√¥les-basiques--permissions-simples--contr√¥le-dacc√®sr√©sultat--s√©curit√©-am√©lior√©e-complexit√©-accrue-phase-3--s√©curit√©-compl√®teavec-gyroscops--maintenant-jai-une-s√©curit√©-compl√®te---oauth2--jwt--rbac--abac--audit-completr√©sultat--s√©curit√©-robuste-et-√©volutive--impl√©mentation-concr√®te-dans-le-projet-gyroscops-cloud-s√©curit√©-appliqu√©e-√†-gyroscops-cloudle-gyroscops-cloud-applique-concr√®tement-les-principes-de-s√©curit√©-√†-travers-son-architecture-et-ses-adr-architecture-decision-records-voici-comment--syst√®me-dauthentification-gyroscops-cloudphp--syst√®me-dauthentification-gyroscops-cloud-projet-gyroscops-cloudfinal-class-hiveauthenticationservice----public-function-__construct--------private-keycloakclient-keycloakclient--------private-jwttokenservice-jwtservice--------private-userrepositoryinterface-userrepository--------private-loggerinterface-logger-------------public-function-authenticatestring-email-string-password-authresult------------this-logger-infoauthentication-attempt-------------email--email------------timestamp--new-datetimeimmutable------------------------try-------------keycloakuser--this-keycloakclient-authenticateemail-password------------------------if-keycloakuser-----------------this-logger-warningauthentication-failed---------------------email--email--------------------reason--invalid-credentials------------------------------------------------return-authresultfailureinvalid-credentials------------------------------------user--this-userrepository-findbyemailnew-emailemail------------if-user-----------------this-logger-warninguser-not-found---------------------email--email------------------------------------------------return-authresultfailureuser-not-found------------------------------------token--this-jwtservice-generatetokenuser------------------------this-logger-infoauthentication-successful-----------------user_id--user-getid-tostring----------------email--email------------------------------------return-authresultsuccessuser-token---------------------catch-exception-e-------------this-logger-errorauthentication-error-----------------email--email----------------error--e-getmessage------------------------------------return-authresultfailureauthentication-failed--------------------public-function-refreshtokenstring-refreshtoken-authresult------------try-------------newtoken--this-jwtservice-refreshtokenrefreshtoken------------------------this-logger-infotoken-refreshed-successfully------------------------return-authresultsuccessnull-newtoken---------------------catch-exception-e-------------this-logger-errortoken-refresh-failed-----------------error--e-getmessage------------------------------------return-authresultfailuretoken-refresh-failed-------------syst√®me-dautorisation-gyroscops-cloudphp--syst√®me-dautorisation-gyroscops-cloud-projet-gyroscops-cloudfinal-class-hiveauthorizationservice----public-function-__construct--------private-permissionrepositoryinterface-permissionrepository--------private-rolerepositoryinterface-rolerepository--------private-loggerinterface-logger-------------public-function-haspermissionuser-user-string-resource-string-action-bool------------this-logger-infochecking-permission-------------user_id--user-getid-tostring------------resource--resource------------action--action------------------------try-------------userroles--this-rolerepository-findbyuseruser------------------------foreach-userroles-as-role-----------------permissions--this-permissionrepository-findbyrolerole--------------------------------foreach-permissions-as-permission---------------------if-permission-matchesresource-action-------------------------this-logger-infopermission-granted-----------------------------user_id--user-getid-tostring----------------------------resource--resource----------------------------action--action----------------------------role--role-getname------------------------------------------------------------------------return-true------------------------------------------------------------------------this-logger-warningpermission-denied-----------------user_id--user-getid-tostring----------------resource--resource----------------action--action------------------------------------return-false---------------------catch-exception-e-------------this-logger-errorauthorization-error-----------------user_id--user-getid-tostring----------------resource--resource----------------action--action----------------error--e-getmessage------------------------------------return-false--------------------public-function-checkresourceaccessuser-user-string-resource-string-action-mixed-subject-bool-------------v√©rification-des-permissions-de-base--------if-this-haspermissionuser-resource-action-------------return-false-------------------------v√©rification-des-permissions-contextuelles--------if-subject-instanceof-organizationaware-------------return-this-checkorganizationaccessuser-subject------------------------if-subject-instanceof-useraware-------------return-this-checkuseraccessuser-subject------------------------return-true------------private-function-checkorganizationaccessuser-user-organizationaware-subject-bool------------userorganizations--this-getuserorganizationsuser--------subjectorganization--subject-getorganizationid----------------return-in_arraysubjectorganization-userorganizations------------private-function-checkuseraccessuser-user-useraware-subject-bool------------return-user-getid-equalssubject-getuserid-----voters-de-s√©curit√©-gyroscops-cloudphp--voters-de-s√©curit√©-gyroscops-cloud-projet-gyroscops-cloudfinal-class-paymentvoter-extends-voter----public-function-__construct--------private-hiveauthorizationservice-authorizationservice--------private-loggerinterface-logger-------------protected-function-supportsstring-attribute-mixed-subject-bool------------return-in_arrayattribute-------------payment_read------------payment_write------------payment_delete------------payment_approve------------payment_refund----------subject-instanceof-payment------------protected-function-voteonattributestring-attribute-mixed-subject-tokeninterface-token-bool------------user--token-getuser----------------if-user-instanceof-user-------------return-false------------------------this-logger-infovoting-on-payment-permission-------------user_id--user-getid-tostring------------attribute--attribute------------payment_id--subject-getid-tostring------------------------result--match-attribute-------------payment_read--this-canreaduser-subject------------payment_write--this-canwriteuser-subject------------payment_delete--this-candeleteuser-subject------------payment_approve--this-canapproveuser-subject------------payment_refund--this-canrefunduser-subject------------default--false------------------------this-logger-infovote-result-------------user_id--user-getid-tostring------------attribute--attribute------------result--result------------------------return-result------------private-function-canreaduser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------read------------payment--------------------private-function-canwriteuser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------write------------payment--------------------private-function-candeleteuser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------delete------------payment--------------------private-function-canapproveuser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------approve------------payment--------------------private-function-canrefunduser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------refund------------payment-------------audit-de-s√©curit√©-gyroscops-cloudphp--audit-de-s√©curit√©-gyroscops-cloud-projet-gyroscops-cloudfinal-class-hivesecurityauditservice----public-function-__construct--------private-loggerinterface-logger--------private-securityeventrepositoryinterface-eventrepository-------------public-function-logauthenticationeventstring-userid-bool-success-array-context---void------------event--new-securityevent------------securityeventtypeauthentication------------userid------------success------------context------------------------this-eventrepository-saveevent----------------this-logger-infoauthentication-event-logged-------------user_id--userid------------success--success------------context--context--------------------public-function-logauthorizationeventstring-userid-string-resource-string-action-bool-granted-array-context---void------------event--new-securityevent------------securityeventtypeauthorization------------userid------------granted------------array_mergecontext-----------------resource--resource----------------action--action------------------------------------this-eventrepository-saveevent----------------this-logger-infoauthorization-event-logged-------------user_id--userid------------resource--resource------------action--action------------granted--granted------------context--context--------------------public-function-logsecurityviolationstring-userid-string-violationtype-array-context---void------------event--new-securityevent------------securityeventtypeviolation------------userid------------false------------array_mergecontext-----------------violation_type--violationtype------------------------------------this-eventrepository-saveevent----------------this-logger-warningsecurity-violation-logged-------------user_id--userid------------violation_type--violationtype------------context--context-------------r√©f√©rences-aux-adr-du-projet-gyroscops-cloudce-chapitre-sappuie-sur-les-architecture-decision-records-adr-suivants-du-gyroscops-cloud---hive025--authorization-system---syst√®me-dautorisation--hive026--keycloak-resource-and-scope-management---gestion-des-ressources-et-scopes--hive040--enhanced-models-with-property-access-patterns---mod√®les-enrichis-pour-la-s√©curit√©--hive041--cross-cutting-concerns-architecture---architecture-des-pr√©occupations-transversaleshahahugoshortcode9s0hbhb>üéØ Objectif de ce Chapitre### Mon Probl√®me : Comment S√©curiser une API Platform Complexe ?<strong>Voici ce qui s&rsquo;est pass√© avec Gyroscops</strong> : J&rsquo;avais une API Platform qui fonctionnait bien, mais la s√©curit√© √©tait un vrai casse-t√™te. Comment g√©rer les permissions ? Comment s√©curiser les endpoints ? Comment g√©rer l&rsquo;authentification multi-tenant ?<strong>Mais attendez&mldr;</strong> Quand j&rsquo;ai voulu impl√©menter une s√©curit√© robuste, j&rsquo;√©tais perdu. OAuth2, JWT, RBAC, ABAC, Keycloak&mldr; Tellement d&rsquo;options ! Comment choisir ? Comment impl√©menter ?<strong>Soudain, je r√©alisais que la s√©curit√© n&rsquo;√©tait pas optionnelle !</strong> Il me fallait une approche structur√©e et compl√®te.### La S√©curit√© : Mon Guide CompletLa s√©curit√© dans une API Platform avec DDD m&rsquo;a permis de :- <strong>Prot√©ger</strong> les donn√©es sensibles- <strong>Contr√¥ler</strong> l&rsquo;acc√®s aux ressources- <strong>G√©rer</strong> les permissions granulaires- <strong>Auditer</strong> les actions utilisateurs## Qu&rsquo;est-ce que la S√©curit√© dans une API Platform ?### Le Concept FondamentalLa s√©curit√© dans une API Platform consiste √† prot√©ger les ressources et contr√¥ler l&rsquo;acc√®s. <strong>L&rsquo;id√©e</strong> : Chaque requ√™te doit √™tre authentifi√©e et autoris√©e avant d&rsquo;acc√©der aux donn√©es.<strong>Avec Gyroscops, voici comment j&rsquo;ai structur√© la s√©curit√©</strong> :### Les 4 Piliers de la S√©curit√©#### 1. <strong>Authentification</strong> - Qui √™tes-vous ?<strong>Voici comment j&rsquo;ai impl√©ment√© l&rsquo;authentification avec Gyroscops</strong> :<strong>OAuth2 + JWT</strong> :- Tokens JWT pour l&rsquo;authentification- Refresh tokens pour la s√©curit√©- Expiration automatique des tokens<strong>Keycloak</strong> :- Gestion centralis√©e des utilisateurs- Int√©gration OAuth2- Gestion des r√¥les et permissions#### 2. <strong>Autorisation</strong> - Que pouvez-vous faire ?<strong>Voici comment j&rsquo;ai impl√©ment√© l&rsquo;autorisation avec Gyroscops</strong> :<strong>RBAC (Role-Based Access Control)</strong> :- R√¥les d√©finis par domaine- Permissions granulaires- Hi√©rarchie des r√¥les<strong>ABAC (Attribute-Based Access Control)</strong> :- Contr√¥le bas√© sur les attributs- R√®gles m√©tier complexes- Contexte dynamique#### 3. <strong>Validation</strong> - Les donn√©es sont-elles valides ?<strong>Voici comment j&rsquo;ai impl√©ment√© la validation avec Gyroscops</strong> :<strong>Validation des Entr√©es</strong> :- Validation des donn√©es d&rsquo;entr√©e- Sanitisation des donn√©es- Gestion des erreurs<strong>Validation des Permissions</strong> :- V√©rification des permissions- Contr√¥le d&rsquo;acc√®s aux ressources- Audit des actions#### 4. <strong>Audit</strong> - Que s&rsquo;est-il pass√© ?<strong>Voici comment j&rsquo;ai impl√©ment√© l&rsquo;audit avec Gyroscops</strong> :<strong>Logging de S√©curit√©</strong> :- Logs d&rsquo;authentification- Logs d&rsquo;autorisation- Logs d&rsquo;audit<strong>Monitoring</strong> :- D√©tection d&rsquo;intrusions- Alertes de s√©curit√©- M√©triques de s√©curit√©## Comment Impl√©menter la S√©curit√©### 1. <strong>Configuration de l&rsquo;Authentification****Avec Gyroscops</strong> : J&rsquo;ai configur√© l&rsquo;authentification :<code>yamlsecurity: providers: keycloak: id: App\Security\KeycloakUserProvider firewalls: api: pattern: ^/api stateless: true jwt: ~ access_control: - { path: ^/api/auth, roles: PUBLIC_ACCESS } - { path: ^/api, roles: ROLE_USER }</code><strong>R√©sultat</strong> : Authentification JWT configur√©e.### 2. <strong>Impl√©mentation de l&rsquo;Autorisation****Avec Gyroscops</strong> : J&rsquo;ai impl√©ment√© l&rsquo;autorisation :<code>php#[Route('/api/payments', methods: ['GET'])]#[IsGranted('PAYMENT_READ', subject: 'organization')]public function getPayments(Organization $organization): JsonResponse{ // Logique m√©tier}</code><strong>R√©sultat</strong> : Autorisation bas√©e sur les permissions.### 3. <strong>Gestion des Permissions****Avec Gyroscops</strong> : J&rsquo;ai g√©r√© les permissions :<code>phpfinal class PaymentVoter extends Voter{ protected function supports(string $attribute, mixed $subject): bool { return in_array($attribute, ['PAYMENT_READ', 'PAYMENT_WRITE', 'PAYMENT_DELETE']) && $subject instanceof Payment; } protected function voteOnAttribute(string $attribute, mixed $subject, TokenInterface $token): bool { $user = $token->getUser(); return match ($attribute) { 'PAYMENT_READ' => $this->canRead($user, $subject), 'PAYMENT_WRITE' => $this->canWrite($user, $subject), 'PAYMENT_DELETE' => $this->canDelete($user, $subject), default => false }; }}</code><strong>R√©sultat</strong> : Permissions granulaires et flexibles.### 4. <strong>Audit et Monitoring****Avec Gyroscops</strong> : J&rsquo;ai impl√©ment√© l&rsquo;audit :<code>phpfinal class SecurityAuditLogger{ public function logAuthentication(string $userId, bool $success): void { $this->logger->info('Authentication attempt', [ 'user_id' => $userId, 'success' => $success, 'timestamp' => new \DateTimeImmutable() ]); } public function logAuthorization(string $userId, string $resource, string $action, bool $granted): void { $this->logger->info('Authorization check', [ 'user_id' => $userId, 'resource' => $resource, 'action' => $action, 'granted' => $granted, 'timestamp' => new \DateTimeImmutable() ]); }}</code><strong>R√©sultat</strong> : Audit complet des actions de s√©curit√©.## Les Avantages de la S√©curit√© Structur√©e### 1. <strong>Protection des Donn√©es****Avec Gyroscops</strong> : La s√©curit√© structur√©e prot√®ge les donn√©es :- Acc√®s contr√¥l√© aux ressources- Donn√©es sensibles prot√©g√©es- Conformit√© r√©glementaire<strong>R√©sultat</strong> : Donn√©es s√©curis√©es et conformes.### 2. <strong>Contr√¥le d&rsquo;Acc√®s Granulaire****Avec Gyroscops</strong> : La s√©curit√© structur√©e permet un contr√¥le granulaire :- Permissions par ressource- R√¥les contextuels- R√®gles m√©tier complexes<strong>R√©sultat</strong> : Contr√¥le d&rsquo;acc√®s pr√©cis et flexible.### 3. <strong>Audit et Conformit√©****Avec Gyroscops</strong> : La s√©curit√© structur√©e facilite l&rsquo;audit :- Logs complets des actions- Tra√ßabilit√© des acc√®s- Conformit√© r√©glementaire<strong>R√©sultat</strong> : Audit complet et conformit√© assur√©e.### 4. <strong>√âvolutivit√©****Avec Gyroscops</strong> : La s√©curit√© structur√©e est √©volutive :- Ajout facile de nouvelles permissions- Extension des r√¥les- Adaptation aux besoins m√©tier<strong>R√©sultat</strong> : S√©curit√© √©volutive et maintenable.## Les Inconv√©nients de la S√©curit√© Structur√©e### 1. <strong>Complexit√© Accrue****Avec Gyroscops</strong> : La s√©curit√© structur√©e ajoute de la complexit√© :- Configuration complexe- Gestion des permissions- Debugging plus difficile<strong>R√©sultat</strong> : Courbe d&rsquo;apprentissage plus importante.### 2. <strong>Performance****Avec Gyroscops</strong> : La s√©curit√© structur√©e peut impacter les performances :- V√©rifications d&rsquo;autorisation- Validation des tokens- Logs d&rsquo;audit<strong>R√©sultat</strong> : Performance potentiellement d√©grad√©e.### 3. <strong>Maintenance****Avec Gyroscops</strong> : La s√©curit√© structur√©e n√©cessite de la maintenance :- Mise √† jour des permissions- Gestion des r√¥les- Monitoring continu<strong>R√©sultat</strong> : Maintenance plus complexe.### 4. <strong>Gestion des Erreurs****Avec Gyroscops</strong> : La s√©curit√© structur√©e complique la gestion des erreurs :- Erreurs d&rsquo;authentification- Erreurs d&rsquo;autorisation- Messages d&rsquo;erreur appropri√©s<strong>R√©sultat</strong> : Gestion d&rsquo;erreurs plus complexe.## Les Pi√®ges √† √âviter### 1. <strong>S√©curit√© par Obscurit√©</strong>**‚ùå Mauvais** : Compter sur l&rsquo;obscurit√© pour la s√©curit√©**‚úÖ Bon** : S√©curit√© bas√©e sur des standards √©prouv√©s<strong>Pourquoi c&rsquo;est important ?</strong> L&rsquo;obscurit√© n&rsquo;est pas une s√©curit√©.### 2. <strong>Permissions Trop Granulaires</strong>**‚ùå Mauvais** : Une permission pour chaque action**‚úÖ Bon** : Permissions par domaine m√©tier<strong>Pourquoi c&rsquo;est crucial ?</strong> Des permissions trop granulaires sont difficiles √† g√©rer.### 3. <strong>Ignorer l&rsquo;Audit</strong>**‚ùå Mauvais** : Pas d&rsquo;audit des actions de s√©curit√©**‚úÖ Bon** : Audit complet des actions<strong>Pourquoi c&rsquo;est essentiel ?</strong> L&rsquo;audit est essentiel pour la s√©curit√©.### 4. <strong>Tokens Non S√©curis√©s</strong>**‚ùå Mauvais** : Tokens non s√©curis√©s ou non expir√©s**‚úÖ Bon** : Tokens s√©curis√©s avec expiration<strong>Pourquoi c&rsquo;est la cl√© ?</strong> Les tokens non s√©curis√©s sont une faille de s√©curit√©.## L&rsquo;√âvolution vers la S√©curit√© Structur√©e### Phase 1 : Authentification Basique<strong>Avec Gyroscops</strong> : Au d√©but, j&rsquo;avais une authentification basique :- Login/password simple- Sessions PHP- Pas d&rsquo;autorisation<strong>R√©sultat</strong> : D√©veloppement rapide, s√©curit√© faible.### Phase 2 : Introduction de l&rsquo;Autorisation<strong>Avec Gyroscops</strong> : J&rsquo;ai introduit l&rsquo;autorisation :- R√¥les basiques- Permissions simples- Contr√¥le d&rsquo;acc√®s<strong>R√©sultat</strong> : S√©curit√© am√©lior√©e, complexit√© accrue.### Phase 3 : S√©curit√© Compl√®te<strong>Avec Gyroscops</strong> : Maintenant, j&rsquo;ai une s√©curit√© compl√®te :- OAuth2 + JWT- RBAC + ABAC- Audit complet<strong>R√©sultat</strong> : S√©curit√© robuste et √©volutive.## üèóÔ∏è Impl√©mentation Concr√®te dans le Projet Gyroscops Cloud### S√©curit√© Appliqu√©e √† Gyroscops CloudLe Gyroscops Cloud applique concr√®tement les principes de s√©curit√© √† travers son architecture et ses ADR (Architecture Decision Records). Voici comment :#### Syst√®me d&rsquo;Authentification Gyroscops Cloud<code>php// ‚úÖ Syst√®me d'Authentification Gyroscops Cloud (Projet Gyroscops Cloud)final class HiveAuthenticationService{ public function __construct( private KeycloakClient $keycloakClient, private JwtTokenService $jwtService, private UserRepositoryInterface $userRepository, private LoggerInterface $logger ) {} public function authenticate(string $email, string $password): AuthResult { $this->logger->info('Authentication attempt', [ 'email' => $email, 'timestamp' => new \DateTimeImmutable() ]); try { $keycloakUser = $this->keycloakClient->authenticate($email, $password); if (!$keycloakUser) { $this->logger->warning('Authentication failed', [ 'email' => $email, 'reason' => 'Invalid credentials' ]); return AuthResult::failure('Invalid credentials'); } $user = $this->userRepository->findByEmail(new Email($email)); if (!$user) { $this->logger->warning('User not found', [ 'email' => $email ]); return AuthResult::failure('User not found'); } $token = $this->jwtService->generateToken($user); $this->logger->info('Authentication successful', [ 'user_id' => $user->getId()->toString(), 'email' => $email ]); return AuthResult::success($user, $token); } catch (\Exception $e) { $this->logger->error('Authentication error', [ 'email' => $email, 'error' => $e->getMessage() ]); return AuthResult::failure('Authentication failed'); } } public function refreshToken(string $refreshToken): AuthResult { try { $newToken = $this->jwtService->refreshToken($refreshToken); $this->logger->info('Token refreshed successfully'); return AuthResult::success(null, $newToken); } catch (\Exception $e) { $this->logger->error('Token refresh failed', [ 'error' => $e->getMessage() ]); return AuthResult::failure('Token refresh failed'); } }}</code>#### Syst√®me d&rsquo;Autorisation Gyroscops Cloud<code>php// ‚úÖ Syst√®me d'Autorisation Gyroscops Cloud (Projet Gyroscops Cloud)final class HiveAuthorizationService{ public function __construct( private PermissionRepositoryInterface $permissionRepository, private RoleRepositoryInterface $roleRepository, private LoggerInterface $logger ) {} public function hasPermission(User $user, string $resource, string $action): bool { $this->logger->info('Checking permission', [ 'user_id' => $user->getId()->toString(), 'resource' => $resource, 'action' => $action ]); try { $userRoles = $this->roleRepository->findByUser($user); foreach ($userRoles as $role) { $permissions = $this->permissionRepository->findByRole($role); foreach ($permissions as $permission) { if ($permission->matches($resource, $action)) { $this->logger->info('Permission granted', [ 'user_id' => $user->getId()->toString(), 'resource' => $resource, 'action' => $action, 'role' => $role->getName() ]); return true; } } } $this->logger->warning('Permission denied', [ 'user_id' => $user->getId()->toString(), 'resource' => $resource, 'action' => $action ]); return false; } catch (\Exception $e) { $this->logger->error('Authorization error', [ 'user_id' => $user->getId()->toString(), 'resource' => $resource, 'action' => $action, 'error' => $e->getMessage() ]); return false; } } public function checkResourceAccess(User $user, string $resource, string $action, mixed $subject): bool { // V√©rification des permissions de base if (!$this->hasPermission($user, $resource, $action)) { return false; } // V√©rification des permissions contextuelles if ($subject instanceof OrganizationAware) { return $this->checkOrganizationAccess($user, $subject); } if ($subject instanceof UserAware) { return $this->checkUserAccess($user, $subject); } return true; } private function checkOrganizationAccess(User $user, OrganizationAware $subject): bool { $userOrganizations = $this->getUserOrganizations($user); $subjectOrganization = $subject->getOrganizationId(); return in_array($subjectOrganization, $userOrganizations); } private function checkUserAccess(User $user, UserAware $subject): bool { return $user->getId()->equals($subject->getUserId()); }}</code>#### Voters de S√©curit√© Gyroscops Cloud<code>php// ‚úÖ Voters de S√©curit√© Gyroscops Cloud (Projet Gyroscops Cloud)final class PaymentVoter extends Voter{ public function __construct( private HiveAuthorizationService $authorizationService, private LoggerInterface $logger ) {} protected function supports(string $attribute, mixed $subject): bool { return in_array($attribute, [ 'PAYMENT_READ', 'PAYMENT_WRITE', 'PAYMENT_DELETE', 'PAYMENT_APPROVE', 'PAYMENT_REFUND' ]) && $subject instanceof Payment; } protected function voteOnAttribute(string $attribute, mixed $subject, TokenInterface $token): bool { $user = $token->getUser(); if (!$user instanceof User) { return false; } $this->logger->info('Voting on payment permission', [ 'user_id' => $user->getId()->toString(), 'attribute' => $attribute, 'payment_id' => $subject->getId()->toString() ]); $result = match ($attribute) { 'PAYMENT_READ' => $this->canRead($user, $subject), 'PAYMENT_WRITE' => $this->canWrite($user, $subject), 'PAYMENT_DELETE' => $this->canDelete($user, $subject), 'PAYMENT_APPROVE' => $this->canApprove($user, $subject), 'PAYMENT_REFUND' => $this->canRefund($user, $subject), default => false }; $this->logger->info('Vote result', [ 'user_id' => $user->getId()->toString(), 'attribute' => $attribute, 'result' => $result ]); return $result; } private function canRead(User $user, Payment $payment): bool { return $this->authorizationService->checkResourceAccess( $user, 'payment', 'read', $payment ); } private function canWrite(User $user, Payment $payment): bool { return $this->authorizationService->checkResourceAccess( $user, 'payment', 'write', $payment ); } private function canDelete(User $user, Payment $payment): bool { return $this->authorizationService->checkResourceAccess( $user, 'payment', 'delete', $payment ); } private function canApprove(User $user, Payment $payment): bool { return $this->authorizationService->checkResourceAccess( $user, 'payment', 'approve', $payment ); } private function canRefund(User $user, Payment $payment): bool { return $this->authorizationService->checkResourceAccess( $user, 'payment', 'refund', $payment ); }}</code>#### Audit de S√©curit√© Gyroscops Cloud<code>php// ‚úÖ Audit de S√©curit√© Gyroscops Cloud (Projet Gyroscops Cloud)final class HiveSecurityAuditService{ public function __construct( private LoggerInterface $logger, private SecurityEventRepositoryInterface $eventRepository ) {} public function logAuthenticationEvent(string $userId, bool $success, array $context = []): void { $event = new SecurityEvent( SecurityEventType::AUTHENTICATION, $userId, $success, $context ); $this->eventRepository->save($event); $this->logger->info('Authentication event logged', [ 'user_id' => $userId, 'success' => $success, 'context' => $context ]); } public function logAuthorizationEvent(string $userId, string $resource, string $action, bool $granted, array $context = []): void { $event = new SecurityEvent( SecurityEventType::AUTHORIZATION, $userId, $granted, array_merge($context, [ 'resource' => $resource, 'action' => $action ]) ); $this->eventRepository->save($event); $this->logger->info('Authorization event logged', [ 'user_id' => $userId, 'resource' => $resource, 'action' => $action, 'granted' => $granted, 'context' => $context ]); } public function logSecurityViolation(string $userId, string $violationType, array $context = []): void { $event = new SecurityEvent( SecurityEventType::VIOLATION, $userId, false, array_merge($context, [ 'violation_type' => $violationType ]) ); $this->eventRepository->save($event); $this->logger->warning('Security violation logged', [ 'user_id' => $userId, 'violation_type' => $violationType, 'context' => $context ]); }}</code>### R√©f√©rences aux ADR du Projet Gyroscops CloudCe chapitre s&rsquo;appuie sur les Architecture Decision Records (ADR) suivants du Gyroscops Cloud :- <strong>HIVE025</strong> : Authorization System - Syst√®me d&rsquo;autorisation- <strong>HIVE026</strong> : Keycloak Resource and Scope Management - Gestion des ressources et scopes- <strong>HIVE040</strong> : Enhanced Models with Property Access Patterns - Mod√®les enrichis pour la s√©curit√©- <strong>HIVE041</strong> : Cross-Cutting Concerns Architecture - Architecture des pr√©occupations transversales<div class=chapter-navigation><h2 class=chapter-nav-title>üéØ Votre Prochaine √âtape</h2><p class=chapter-nav-subtitle>Maintenant que vous comprenez les concepts de base et que j'ai partag√© mon exp√©rience avec Gyroscops, quel est votre contexte ?</p><div class=chapter-options>{<div class=chapter-option data-color=red><div class=chapter-option-header><div class=chapter-option-letter>A</div><div><h3 class=chapter-option-title>Je veux comprendre les chapitres de stockage</h3><p class=chapter-option-subtitle>Vous voulez voir comment impl√©menter la persistance selon diff√©rents patterns</p></div></div><div class=chapter-option-content><div class=chapter-option-criteria><h4 class=chapter-option-criteria-title>Crit√®res d'adoption :</h4><ul class=chapter-option-criteria-list><li>√âquipe exp√©riment√©e</li><li>Besoin de comprendre la persistance</li><li>Patterns de stockage √† choisir</li><li>Impl√©mentation √† faire</li></ul></div><div class=chapter-option-footer><span class=chapter-option-time>‚è±Ô∏è 30-45 minutes</span>
<span class="chapter-option-link chapter-option-link-disabled">Stockage SQL - Approche Classique
<span class=coming-soon-indicator>üöß</span></span></div></div></div><style>.chapter-option-link-disabled{background:#9ca3af!important;color:#6b7280!important;cursor:not-allowed!important;opacity:.7}.chapter-option-link-disabled:hover{background:#9ca3af!important;color:#6b7280!important;transform:none!important;box-shadow:none!important}.chapter-option-link-disabled::after{display:none!important}.chapter-option[data-draft=true]{opacity:.8;border-style:dashed;border-color:#d1d5db}.chapter-option[data-draft=true] .chapter-option-letter{background:#9ca3af}.chapter-option[data-draft=true] .chapter-option-title{color:#6b7280}.chapter-option[data-draft=true] .chapter-option-subtitle{color:#9ca3af}.draft-indicator,.coming-soon-indicator{margin-left:.5rem;font-size:.875rem}.chapter-option[data-draft=true]{animation:draft-pulse 2s ease-in-out infinite}@keyframes draft-pulse{0%,100%{opacity:.8}50%{opacity:.6}}</style>}} {<div class=chapter-option data-color=yellow data-draft=true><div class=chapter-option-header><div class=chapter-option-letter>B</div><div><h3 class=chapter-option-title>Je veux comprendre les chapitres techniques</h3><p class=chapter-option-subtitle>Vous voulez voir les aspects techniques d'affinement</p></div></div><div class=chapter-option-content><div class=chapter-option-criteria><h4 class=chapter-option-criteria-title>Crit√®res d'adoption :</h4><ul class=chapter-option-criteria-list><li>√âquipe exp√©riment√©e</li><li>Besoin de comprendre les aspects techniques</li><li>Qualit√© et performance importantes</li><li>Bonnes pratiques √† appliquer</li></ul></div><div class=chapter-option-footer><span class=chapter-option-time>‚è±Ô∏è 25-35 minutes</span>
<span class="chapter-option-link chapter-option-link-disabled">Gestion des Donn√©es et Validation
<span class=draft-indicator>üìù</span></span></div></div></div><style>.chapter-option-link-disabled{background:#9ca3af!important;color:#6b7280!important;cursor:not-allowed!important;opacity:.7}.chapter-option-link-disabled:hover{background:#9ca3af!important;color:#6b7280!important;transform:none!important;box-shadow:none!important}.chapter-option-link-disabled::after{display:none!important}.chapter-option[data-draft=true]{opacity:.8;border-style:dashed;border-color:#d1d5db}.chapter-option[data-draft=true] .chapter-option-letter{background:#9ca3af}.chapter-option[data-draft=true] .chapter-option-title{color:#6b7280}.chapter-option[data-draft=true] .chapter-option-subtitle{color:#9ca3af}.draft-indicator,.coming-soon-indicator{margin-left:.5rem;font-size:.875rem}.chapter-option[data-draft=true]{animation:draft-pulse 2s ease-in-out infinite}@keyframes draft-pulse{0%,100%{opacity:.8}50%{opacity:.6}}</style>}} {<div class=chapter-option data-color=green data-draft=true><div class=chapter-option-header><div class=chapter-option-letter>C</div><div><h3 class=chapter-option-title>Je veux comprendre le frontend</h3><p class=chapter-option-subtitle>Vous voulez voir comment int√©grer la s√©curit√© avec le frontend</p></div></div><div class=chapter-option-content><div class=chapter-option-criteria><h4 class=chapter-option-criteria-title>Crit√®res d'adoption :</h4><ul class=chapter-option-criteria-list><li>D√©veloppeur frontend</li><li>Besoin d'int√©grer la s√©curit√©</li><li>API Platform √† s√©curiser</li><li>Interface utilisateur √† cr√©er</li></ul></div><div class=chapter-option-footer><span class=chapter-option-time>‚è±Ô∏è 25-35 minutes</span>
<span class="chapter-option-link chapter-option-link-disabled">Frontend et Int√©gration
<span class=draft-indicator>üìù</span></span></div></div></div><style>.chapter-option-link-disabled{background:#9ca3af!important;color:#6b7280!important;cursor:not-allowed!important;opacity:.7}.chapter-option-link-disabled:hover{background:#9ca3af!important;color:#6b7280!important;transform:none!important;box-shadow:none!important}.chapter-option-link-disabled::after{display:none!important}.chapter-option[data-draft=true]{opacity:.8;border-style:dashed;border-color:#d1d5db}.chapter-option[data-draft=true] .chapter-option-letter{background:#9ca3af}.chapter-option[data-draft=true] .chapter-option-title{color:#6b7280}.chapter-option[data-draft=true] .chapter-option-subtitle{color:#9ca3af}.draft-indicator,.coming-soon-indicator{margin-left:.5rem;font-size:.875rem}.chapter-option[data-draft=true]{animation:draft-pulse 2s ease-in-out infinite}@keyframes draft-pulse{0%,100%{opacity:.8}50%{opacity:.6}}</style>}}</div></div><style>.chapter-navigation{margin:2rem 0;padding:1.5rem;background:linear-gradient(135deg,#f8fafc 0%,#e2e8f0 100%);border-radius:12px;border-left:4px solid #3b82f6}.chapter-nav-title{margin:0 0 .5rem;font-size:1.5rem;font-weight:700;color:#1e293b}.chapter-nav-subtitle{margin:0 0 1.5rem;color:#64748b;font-size:1rem;line-height:1.6}.chapter-options{display:flex;flex-direction:column;gap:1rem}.chapter-option{background:#fff;border-radius:8px;padding:1.25rem;border:1px solid #e2e8f0;transition:all .2s ease;position:relative;overflow:hidden}.chapter-option:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,.1);border-color:#3b82f6}.chapter-option::before{content:'';position:absolute;top:0;left:0;width:4px;height:100%;background:var(--option-color,#6b7280);border-radius:0 2px 2px 0}.chapter-option-header{display:flex;align-items:center;margin-bottom:.75rem}.chapter-option-letter{display:inline-flex;align-items:center;justify-content:center;width:2rem;height:2rem;border-radius:50%;background:var(--option-color,#6b7280);color:#fff;font-weight:700;font-size:.875rem;margin-right:.75rem;flex-shrink:0}.chapter-option-title{font-size:1.125rem;font-weight:600;color:#1e293b;margin:0;line-height:1.4}.chapter-option-subtitle{font-size:.875rem;color:#64748b;font-style:italic;margin:.25rem 0 0;line-height:1.4}.chapter-option-content{margin-left:2.75rem}.chapter-option-criteria{margin-bottom:.75rem}.chapter-option-criteria-title{font-size:.875rem;font-weight:600;color:#374151;margin:0 0 .5rem}.chapter-option-criteria-list{list-style:none;padding:0;margin:0}.chapter-option-criteria-list li{position:relative;padding-left:1.25rem;margin-bottom:.25rem;font-size:.875rem;color:#4b5563;line-height:1.4}.chapter-option-criteria-list li::before{content:'‚úì';position:absolute;left:0;color:#10b981;font-weight:600}.chapter-option-footer{display:flex;justify-content:space-between;align-items:center;margin-top:1rem;padding-top:.75rem;border-top:1px solid #e5e7eb}.chapter-option-time{font-size:.875rem;color:#6b7280;font-weight:500}.chapter-option-link{display:inline-flex;align-items:center;padding:.5rem 1rem;background:var(--option-color,#6b7280);color:#fff!important;text-decoration:none!important;border-radius:6px;font-weight:600;font-size:.875rem;transition:all .2s ease;border:none;cursor:pointer}.chapter-option-link:hover{background:var(--option-color-dark,#4b5563);color:#fff!important;text-decoration:none!important;transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,.15)}.chapter-option-link:visited{color:#fff!important;text-decoration:none!important}.chapter-option-link:focus{color:#fff!important;text-decoration:none!important;outline:2px solid rgba(255,255,255,.5);outline-offset:2px}.chapter-option-link:active{color:#fff!important;text-decoration:none!important}.chapter-option-link::after{content:'‚Üí';margin-left:.5rem;transition:transform .2s ease;color:#fff!important}.chapter-option-link:hover::after{transform:translateX(2px);color:#fff!important}.chapter-navigation a{color:inherit;text-decoration:none}.chapter-navigation a:hover{color:inherit;text-decoration:none}.chapter-navigation a:visited{color:inherit;text-decoration:none}.chapter-navigation a:focus{color:inherit;text-decoration:none}.chapter-navigation a:active{color:inherit;text-decoration:none}.chapter-option[data-color=green]{--option-color:#10b981;--option-color-dark:#059669}.chapter-option[data-color=yellow]{--option-color:#f59e0b;--option-color-dark:#d97706}.chapter-option[data-color=red]{--option-color:#ef4444;--option-color-dark:#dc2626}.chapter-option[data-color=blue]{--option-color:#3b82f6;--option-color-dark:#2563eb}.chapter-option[data-color=purple]{--option-color:#8b5cf6;--option-color-dark:#7c3aed}.chapter-option[data-color=orange]{--option-color:#f97316;--option-color-dark:#ea580c}.chapter-option[data-color=teal]{--option-color:#14b8a6;--option-color-dark:#0d9488}.chapter-option[data-color=indigo]{--option-color:#6366f1;--option-color-dark:#4f46e5}.chapter-option[data-color=pink]{--option-color:#ec4899;--option-color-dark:#db2777}.chapter-option[data-color=cyan]{--option-color:#06b6d4;--option-color-dark:#0891b2}@media(max-width:768px){.chapter-navigation{padding:1rem}.chapter-option{padding:1rem}.chapter-option-content{margin-left:2.5rem}.chapter-option-footer{flex-direction:column;align-items:flex-start;gap:.75rem}.chapter-option-link{align-self:stretch;justify-content:center}}</style><a href=#-objectif-de-ce-chapitre-mon-probl%c3%a8me--comment-s%c3%a9curiser-une-api-platform-complexe-voici-ce-qui-s--javais-une-api-platform-qui-fonctionnait-bien-mais-la-s%c3%a9curit%c3%a9-%c3%a9tait-un-vrai-casse-t%c3%aate-comment-g%c3%a9rer-les-permissions--comment-s%c3%a9curiser-les-endpoints--comment-g%c3%a9rer-lauthentification-multi-tenant-mais-attendez-quand-jai-voulu-impl%c3%a9menter-une-s%c3%a9curit%c3%a9-robuste-j%c3%a9tais-perdu-oauth2-jwt-rbac-abac-keycloak-tellement-doptions--comment-choisir--comment-impl%c3%a9menter-soudain-je-r%c3%a9alisais-que-la-s%c3%a9curit%c3%a9-n-il-me-fallait-une-approche-structur%c3%a9e-et-compl%c3%a8te-la-s%c3%a9curit%c3%a9--mon-guide-completla-s%c3%a9curit%c3%a9-dans-une-api-platform-avec-ddd-ma-permis-de---prot%c3%a9ger-les-donn%c3%a9es-sensibles--contr%c3%b4ler-lacc%c3%a8s-aux-ressources--g%c3%a9rer-les-permissions-granulaires--auditer-les-actions-utilisateurs-quest-ce-que-la-s%c3%a9curit%c3%a9-dans-une-api-platform--le-concept-fondamentalla-s%c3%a9curit%c3%a9-dans-une-api-platform-consiste-%c3%a0-prot%c3%a9ger-les-ressources-et-contr%c3%b4ler-lacc%c3%a8s-l--chaque-requ%c3%aate-doit-%c3%aatre-authentifi%c3%a9e-et-autoris%c3%a9e-avant-dacc%c3%a9der-aux-donn%c3%a9esavec-gyroscops-voici-comment-j--les-4-piliers-de-la-s%c3%a9curit%c3%a9-1-authentification---qui-%c3%aates-vous-voici-comment-j-oauth2--jwt---tokens-jwt-pour-lauthentification--refresh-tokens-pour-la-s%c3%a9curit%c3%a9--expiration-automatique-des-tokenskeycloak---gestion-centralis%c3%a9e-des-utilisateurs--int%c3%a9gration-oauth2--gestion-des-r%c3%b4les-et-permissions-2-autorisation---que-pouvez-vous-faire-voici-comment-j-rbac-role-based-access-control---r%c3%b4les-d%c3%a9finis-par-domaine--permissions-granulaires--hi%c3%a9rarchie-des-r%c3%b4lesabac-attribute-based-access-control---contr%c3%b4le-bas%c3%a9-sur-les-attributs--r%c3%a8gles-m%c3%a9tier-complexes--contexte-dynamique-3-validation---les-donn%c3%a9es-sont-elles-valides-voici-comment-j-validation-des-entr%c3%a9es---validation-des-donn%c3%a9es-dentr%c3%a9e--sanitisation-des-donn%c3%a9es--gestion-des-erreursvalidation-des-permissions---v%c3%a9rification-des-permissions--contr%c3%b4le-dacc%c3%a8s-aux-ressources--audit-des-actions-4-audit---que-sest-il-pass%c3%a9-voici-comment-j-logging-de-s%c3%a9curit%c3%a9---logs-dauthentification--logs-dautorisation--logs-dauditmonitoring---d%c3%a9tection-dintrusions--alertes-de-s%c3%a9curit%c3%a9--m%c3%a9triques-de-s%c3%a9curit%c3%a9-comment-impl%c3%a9menter-la-s%c3%a9curit%c3%a9-1-configuration-de-l--jai-configur%c3%a9-lauthentification-yamlsecurity----providers--------keycloak------------id-appsecuritykeycloakuserprovider----firewalls--------api------------pattern-api------------stateless-true------------jwt-----access_control-----------path-apiauth-roles-public_access------------path-api-roles-role_user-r%c3%a9sultat--authentification-jwt-configur%c3%a9e-2-impl%c3%a9mentation-de-l--jai-impl%c3%a9ment%c3%a9-lautorisation-phprouteapipayments-methods-getisgrantedpayment_read-subject-organizationpublic-function-getpaymentsorganization-organization-jsonresponse-----logique-m%c3%a9tierr%c3%a9sultat--autorisation-bas%c3%a9e-sur-les-permissions-3-gestion-des-permissions--jai-g%c3%a9r%c3%a9-les-permissions-phpfinal-class-paymentvoter-extends-voter----protected-function-supportsstring-attribute-mixed-subject-bool------------return-in_arrayattribute-payment_read-payment_write-payment_delete-------------subject-instanceof-payment------------protected-function-voteonattributestring-attribute-mixed-subject-tokeninterface-token-bool------------user--token-getuser----------------return-match-attribute-------------payment_read--this-canreaduser-subject------------payment_write--this-canwriteuser-subject------------payment_delete--this-candeleteuser-subject------------default--false------------r%c3%a9sultat--permissions-granulaires-et-flexibles-4-audit-et-monitoring--jai-impl%c3%a9ment%c3%a9-laudit-phpfinal-class-securityauditlogger----public-function-logauthenticationstring-userid-bool-success-void------------this-logger-infoauthentication-attempt-------------user_id--userid------------success--success------------timestamp--new-datetimeimmutable--------------------public-function-logauthorizationstring-userid-string-resource-string-action-bool-granted-void------------this-logger-infoauthorization-check-------------user_id--userid------------resource--resource------------action--action------------granted--granted------------timestamp--new-datetimeimmutable------------r%c3%a9sultat--audit-complet-des-actions-de-s%c3%a9curit%c3%a9-les-avantages-de-la-s%c3%a9curit%c3%a9-structur%c3%a9e-1-protection-des-donn%c3%a9es--la-s%c3%a9curit%c3%a9-structur%c3%a9e-prot%c3%a8ge-les-donn%c3%a9es---acc%c3%a8s-contr%c3%b4l%c3%a9-aux-ressources--donn%c3%a9es-sensibles-prot%c3%a9g%c3%a9es--conformit%c3%a9-r%c3%a9glementairer%c3%a9sultat--donn%c3%a9es-s%c3%a9curis%c3%a9es-et-conformes-2-contr%c3%b4le-d--la-s%c3%a9curit%c3%a9-structur%c3%a9e-permet-un-contr%c3%b4le-granulaire---permissions-par-ressource--r%c3%b4les-contextuels--r%c3%a8gles-m%c3%a9tier-complexesr%c3%a9sultat--contr%c3%b4le-dacc%c3%a8s-pr%c3%a9cis-et-flexible-3-audit-et-conformit%c3%a9--la-s%c3%a9curit%c3%a9-structur%c3%a9e-facilite-laudit---logs-complets-des-actions--tra%c3%a7abilit%c3%a9-des-acc%c3%a8s--conformit%c3%a9-r%c3%a9glementairer%c3%a9sultat--audit-complet-et-conformit%c3%a9-assur%c3%a9e-4-%c3%a9volutivit%c3%a9--la-s%c3%a9curit%c3%a9-structur%c3%a9e-est-%c3%a9volutive---ajout-facile-de-nouvelles-permissions--extension-des-r%c3%b4les--adaptation-aux-besoins-m%c3%a9tierr%c3%a9sultat--s%c3%a9curit%c3%a9-%c3%a9volutive-et-maintenable-les-inconv%c3%a9nients-de-la-s%c3%a9curit%c3%a9-structur%c3%a9e-1-complexit%c3%a9-accrue--la-s%c3%a9curit%c3%a9-structur%c3%a9e-ajoute-de-la-complexit%c3%a9---configuration-complexe--gestion-des-permissions--debugging-plus-difficiler%c3%a9sultat--courbe-dapprentissage-plus-importante-2-performance--la-s%c3%a9curit%c3%a9-structur%c3%a9e-peut-impacter-les-performances---v%c3%a9rifications-dautorisation--validation-des-tokens--logs-dauditr%c3%a9sultat--performance-potentiellement-d%c3%a9grad%c3%a9e-3-maintenance--la-s%c3%a9curit%c3%a9-structur%c3%a9e-n%c3%a9cessite-de-la-maintenance---mise-%c3%a0-jour-des-permissions--gestion-des-r%c3%b4les--monitoring-continur%c3%a9sultat--maintenance-plus-complexe-4-gestion-des-erreurs--la-s%c3%a9curit%c3%a9-structur%c3%a9e-complique-la-gestion-des-erreurs---erreurs-dauthentification--erreurs-dautorisation--messages-derreur-appropri%c3%a9sr%c3%a9sultat--gestion-derreurs-plus-complexe-les-pi%c3%a8ges-%c3%a0-%c3%a9viter-1-s%c3%a9curit%c3%a9-par-obscurit%c3%a9-mauvais--compter-sur-lobscurit%c3%a9-pour-la-s%c3%a9curit%c3%a9-bon--s%c3%a9curit%c3%a9-bas%c3%a9e-sur-des-standards-%c3%a9prouv%c3%a9spourquoi-c-lobscurit%c3%a9-nest-pas-une-s%c3%a9curit%c3%a9-2-permissions-trop-granulaires-mauvais--une-permission-pour-chaque-action-bon--permissions-par-domaine-m%c3%a9tierpourquoi-c-des-permissions-trop-granulaires-sont-difficiles-%c3%a0-g%c3%a9rer-3-ignorer-l-mauvais--pas-daudit-des-actions-de-s%c3%a9curit%c3%a9-bon--audit-complet-des-actionspourquoi-c-laudit-est-essentiel-pour-la-s%c3%a9curit%c3%a9-4-tokens-non-s%c3%a9curis%c3%a9s-mauvais--tokens-non-s%c3%a9curis%c3%a9s-ou-non-expir%c3%a9s-bon--tokens-s%c3%a9curis%c3%a9s-avec-expirationpourquoi-c-les-tokens-non-s%c3%a9curis%c3%a9s-sont-une-faille-de-s%c3%a9curit%c3%a9-l%c3%a9volution-vers-la-s%c3%a9curit%c3%a9-structur%c3%a9e-phase-1--authentification-basiqueavec-gyroscops--au-d%c3%a9but-javais-une-authentification-basique---loginpassword-simple--sessions-php--pas-dautorisationr%c3%a9sultat--d%c3%a9veloppement-rapide-s%c3%a9curit%c3%a9-faible-phase-2--introduction-de-lautorisationavec-gyroscops--jai-introduit-lautorisation---r%c3%b4les-basiques--permissions-simples--contr%c3%b4le-dacc%c3%a8sr%c3%a9sultat--s%c3%a9curit%c3%a9-am%c3%a9lior%c3%a9e-complexit%c3%a9-accrue-phase-3--s%c3%a9curit%c3%a9-compl%c3%a8teavec-gyroscops--maintenant-jai-une-s%c3%a9curit%c3%a9-compl%c3%a8te---oauth2--jwt--rbac--abac--audit-completr%c3%a9sultat--s%c3%a9curit%c3%a9-robuste-et-%c3%a9volutive--impl%c3%a9mentation-concr%c3%a8te-dans-le-projet-gyroscops-cloud-s%c3%a9curit%c3%a9-appliqu%c3%a9e-%c3%a0-gyroscops-cloudle-gyroscops-cloud-applique-concr%c3%a8tement-les-principes-de-s%c3%a9curit%c3%a9-%c3%a0-travers-son-architecture-et-ses-adr-architecture-decision-records-voici-comment--syst%c3%a8me-dauthentification-gyroscops-cloudphp--syst%c3%a8me-dauthentification-gyroscops-cloud-projet-gyroscops-cloudfinal-class-hiveauthenticationservice----public-function-__construct--------private-keycloakclient-keycloakclient--------private-jwttokenservice-jwtservice--------private-userrepositoryinterface-userrepository--------private-loggerinterface-logger-------------public-function-authenticatestring-email-string-password-authresult------------this-logger-infoauthentication-attempt-------------email--email------------timestamp--new-datetimeimmutable------------------------try-------------keycloakuser--this-keycloakclient-authenticateemail-password------------------------if-keycloakuser-----------------this-logger-warningauthentication-failed---------------------email--email--------------------reason--invalid-credentials------------------------------------------------return-authresultfailureinvalid-credentials------------------------------------user--this-userrepository-findbyemailnew-emailemail------------if-user-----------------this-logger-warninguser-not-found---------------------email--email------------------------------------------------return-authresultfailureuser-not-found------------------------------------token--this-jwtservice-generatetokenuser------------------------this-logger-infoauthentication-successful-----------------user_id--user-getid-tostring----------------email--email------------------------------------return-authresultsuccessuser-token---------------------catch-exception-e-------------this-logger-errorauthentication-error-----------------email--email----------------error--e-getmessage------------------------------------return-authresultfailureauthentication-failed--------------------public-function-refreshtokenstring-refreshtoken-authresult------------try-------------newtoken--this-jwtservice-refreshtokenrefreshtoken------------------------this-logger-infotoken-refreshed-successfully------------------------return-authresultsuccessnull-newtoken---------------------catch-exception-e-------------this-logger-errortoken-refresh-failed-----------------error--e-getmessage------------------------------------return-authresultfailuretoken-refresh-failed-------------syst%c3%a8me-dautorisation-gyroscops-cloudphp--syst%c3%a8me-dautorisation-gyroscops-cloud-projet-gyroscops-cloudfinal-class-hiveauthorizationservice----public-function-__construct--------private-permissionrepositoryinterface-permissionrepository--------private-rolerepositoryinterface-rolerepository--------private-loggerinterface-logger-------------public-function-haspermissionuser-user-string-resource-string-action-bool------------this-logger-infochecking-permission-------------user_id--user-getid-tostring------------resource--resource------------action--action------------------------try-------------userroles--this-rolerepository-findbyuseruser------------------------foreach-userroles-as-role-----------------permissions--this-permissionrepository-findbyrolerole--------------------------------foreach-permissions-as-permission---------------------if-permission-matchesresource-action-------------------------this-logger-infopermission-granted-----------------------------user_id--user-getid-tostring----------------------------resource--resource----------------------------action--action----------------------------role--role-getname------------------------------------------------------------------------return-true------------------------------------------------------------------------this-logger-warningpermission-denied-----------------user_id--user-getid-tostring----------------resource--resource----------------action--action------------------------------------return-false---------------------catch-exception-e-------------this-logger-errorauthorization-error-----------------user_id--user-getid-tostring----------------resource--resource----------------action--action----------------error--e-getmessage------------------------------------return-false--------------------public-function-checkresourceaccessuser-user-string-resource-string-action-mixed-subject-bool-------------v%c3%a9rification-des-permissions-de-base--------if-this-haspermissionuser-resource-action-------------return-false-------------------------v%c3%a9rification-des-permissions-contextuelles--------if-subject-instanceof-organizationaware-------------return-this-checkorganizationaccessuser-subject------------------------if-subject-instanceof-useraware-------------return-this-checkuseraccessuser-subject------------------------return-true------------private-function-checkorganizationaccessuser-user-organizationaware-subject-bool------------userorganizations--this-getuserorganizationsuser--------subjectorganization--subject-getorganizationid----------------return-in_arraysubjectorganization-userorganizations------------private-function-checkuseraccessuser-user-useraware-subject-bool------------return-user-getid-equalssubject-getuserid-----voters-de-s%c3%a9curit%c3%a9-gyroscops-cloudphp--voters-de-s%c3%a9curit%c3%a9-gyroscops-cloud-projet-gyroscops-cloudfinal-class-paymentvoter-extends-voter----public-function-__construct--------private-hiveauthorizationservice-authorizationservice--------private-loggerinterface-logger-------------protected-function-supportsstring-attribute-mixed-subject-bool------------return-in_arrayattribute-------------payment_read------------payment_write------------payment_delete------------payment_approve------------payment_refund----------subject-instanceof-payment------------protected-function-voteonattributestring-attribute-mixed-subject-tokeninterface-token-bool------------user--token-getuser----------------if-user-instanceof-user-------------return-false------------------------this-logger-infovoting-on-payment-permission-------------user_id--user-getid-tostring------------attribute--attribute------------payment_id--subject-getid-tostring------------------------result--match-attribute-------------payment_read--this-canreaduser-subject------------payment_write--this-canwriteuser-subject------------payment_delete--this-candeleteuser-subject------------payment_approve--this-canapproveuser-subject------------payment_refund--this-canrefunduser-subject------------default--false------------------------this-logger-infovote-result-------------user_id--user-getid-tostring------------attribute--attribute------------result--result------------------------return-result------------private-function-canreaduser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------read------------payment--------------------private-function-canwriteuser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------write------------payment--------------------private-function-candeleteuser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------delete------------payment--------------------private-function-canapproveuser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------approve------------payment--------------------private-function-canrefunduser-user-payment-payment-bool------------return-this-authorizationservice-checkresourceaccess------------user------------payment------------refund------------payment-------------audit-de-s%c3%a9curit%c3%a9-gyroscops-cloudphp--audit-de-s%c3%a9curit%c3%a9-gyroscops-cloud-projet-gyroscops-cloudfinal-class-hivesecurityauditservice----public-function-__construct--------private-loggerinterface-logger--------private-securityeventrepositoryinterface-eventrepository-------------public-function-logauthenticationeventstring-userid-bool-success-array-context---void------------event--new-securityevent------------securityeventtypeauthentication------------userid------------success------------context------------------------this-eventrepository-saveevent----------------this-logger-infoauthentication-event-logged-------------user_id--userid------------success--success------------context--context--------------------public-function-logauthorizationeventstring-userid-string-resource-string-action-bool-granted-array-context---void------------event--new-securityevent------------securityeventtypeauthorization------------userid------------granted------------array_mergecontext-----------------resource--resource----------------action--action------------------------------------this-eventrepository-saveevent----------------this-logger-infoauthorization-event-logged-------------user_id--userid------------resource--resource------------action--action------------granted--granted------------context--context--------------------public-function-logsecurityviolationstring-userid-string-violationtype-array-context---void------------event--new-securityevent------------securityeventtypeviolation------------userid------------false------------array_mergecontext-----------------violation_type--violationtype------------------------------------this-eventrepository-saveevent----------------this-logger-warningsecurity-violation-logged-------------user_id--userid------------violation_type--violationtype------------context--context-------------r%c3%a9f%c3%a9rences-aux-adr-du-projet-gyroscops-cloudce-chapitre-sappuie-sur-les-architecture-decision-records-adr-suivants-du-gyroscops-cloud---hive025--authorization-system---syst%c3%a8me-dautorisation--hive026--keycloak-resource-and-scope-management---gestion-des-ressources-et-scopes--hive040--enhanced-models-with-property-access-patterns---mod%c3%a8les-enrichis-pour-la-s%c3%a9curit%c3%a9--hive041--cross-cutting-concerns-architecture---architecture-des-pr%c3%a9occupations-transversaleshahahugoshortcode9s0hbhb class=anchor aria-hidden=true><i class="material-icons align-middle">link</i></a></h2></div></div><div><hr class=doc-hr><div id=doc-nav class=d-print-none><div class="row flex-xl-nowrap"><div class="col-sm-6 pt-2 doc-next"><a href=/chapitres/techniques/chapitre-61-tests-qualite/><div class="card h-100 my-1"><div class="card-body py-2"><p class="card-title fs-5 fw-semibold lh-base mb-0"><i class="material-icons align-middle">navigate_before</i> Chapitre 61 : Tests et Qualit√©</p></div></div></a></div><div class="col-sm-6 pt-2 doc-prev"><a class=ms-auto href=/chapitres/stockage/api/chapitre-24-stockage-api-cqrs/><div class="card h-100 my-1 text-end"><div class="card-body py-2"><p class="card-title fs-5 fw-semibold lh-base mb-0">Chapitre 62 : Stockage API - Approche CQRS <i class="material-icons align-middle">navigate_next</i></p></div></div></a></div></div></div></div></div></div></div></div><footer class="shadow py-3 d-print-none"><div class=container-fluid><div class="row align-items-center"><div class=col><div class="text-sm-start text-center mx-md-2"><p class=mb-0>¬© 2025 Gr√©gory Planchat. Tous droits r√©serv√©s.</p></div></div></div><div class="row mt-3 pt-3 border-top"><div class=col-12><div class=text-center><h6 class="text-muted mb-2">Nos Sponsors</h6><p class="text-muted small mb-2">Merci √† nos partenaires qui soutiennent cette initiative</p><div class="d-flex justify-content-center align-items-center flex-wrap gap-3"><div class=sponsor-item><a href=https://kiboko.fr target=_blank rel="noopener noreferrer" class="text-decoration-none d-inline-block"><img src=/logo-kiboko-fr.svg alt=Kiboko width=120 height=60 style=display:block;max-width:120px;height:auto></a></div><div class=sponsor-item><a href=https://gyroscops.com target=_blank rel="noopener noreferrer" class="text-decoration-none d-inline-block"><img src=/logo-gyroscops.svg alt=Gyroscops width=120 height=60 style=display:block;max-width:120px;height:auto></a></div></div></div></div></div></div></footer></main></div></div><button onclick=topFunction() id=back-to-top aria-label="Back to Top Button" class="back-to-top fs-5"><svg width="24" height="24"><path d="M12 10.224l-6.3 6.3-1.38-1.372L12 7.472l7.68 7.68-1.38 1.376z" style="fill:#fff"/></svg></button>
<script src=/docs/js/bootstrap.js defer></script><script type=text/javascript src=http://localhost:1313/docs/js/bundle.js defer></script><script type=module>
    var suggestions = document.getElementById('suggestions');
    var search = document.getElementById('flexsearch');

    const flexsearchContainer = document.getElementById('FlexSearchCollapse');

    const hideFlexsearchBtn = document.getElementById('hideFlexsearch');

    const configObject = { toggle: false }
    const flexsearchContainerCollapse = new Collapse(flexsearchContainer, configObject) 

    if (search !== null) {
        document.addEventListener('keydown', inputFocus);
        flexsearchContainer.addEventListener('shown.bs.collapse', function () {
            search.focus();
        });
        
        var topHeader = document.getElementById("top-header");
        document.addEventListener('click', function(elem) {
            if (!flexsearchContainer.contains(elem.target) && !topHeader.contains(elem.target))
                flexsearchContainerCollapse.hide();
        });
    }

    hideFlexsearchBtn.addEventListener('click', () =>{
        flexsearchContainerCollapse.hide()
    })

    function inputFocus(e) {
        if (e.ctrlKey && e.key === '/') {
            e.preventDefault();
            flexsearchContainerCollapse.toggle();
        }
        if (e.key === 'Escape' ) {
            search.blur();
            
            flexsearchContainerCollapse.hide();
        }
    };

    document.addEventListener('click', function(event) {

    var isClickInsideElement = suggestions.contains(event.target);

    if (!isClickInsideElement) {
        suggestions.classList.add('d-none');
    }

    });

    


    document.addEventListener('keydown',suggestionFocus);

    function suggestionFocus(e) {
    const suggestionsHidden = suggestions.classList.contains('d-none');
    if (suggestionsHidden) return;

    const focusableSuggestions= [...suggestions.querySelectorAll('a')];
    if (focusableSuggestions.length === 0) return;

    const index = focusableSuggestions.indexOf(document.activeElement);

    if (e.key === "ArrowUp") {
        e.preventDefault();
        const nextIndex = index > 0 ? index - 1 : 0;
        focusableSuggestions[nextIndex].focus();
    }
    else if (e.key === "ArrowDown") {
        e.preventDefault();
        const nextIndex= index + 1 < focusableSuggestions.length ? index + 1 : index;
        focusableSuggestions[nextIndex].focus();
    }

    }

    


    (function(){

    var index = new FlexSearch.Document({
        
        tokenize: "forward",
        minlength:  0 ,
        cache:  100 ,
        optimize:  true ,
        document: {
        id: 'id',
        store: [
            "href", "title", "description"
        ],
        index: ["title", "description", "content"]
        }
    });


    


    
    


    

    

    search.addEventListener('input', show_results, true);

    function show_results(){
        const maxResult =  5 ;
        const minlength =  0 ;
        var searchQuery = sanitizeHTML(this.value);
        var results = index.search(searchQuery, {limit: maxResult, enrich: true});

        
        const flatResults = new Map(); 
        for (const result of results.flatMap(r => r.result)) {
        if (flatResults.has(result.doc.href)) continue;
        flatResults.set(result.doc.href, result.doc);
        }

        suggestions.innerHTML = "";
        suggestions.classList.remove('d-none');

        
        if (searchQuery.length < minlength) {
            const minCharMessage = document.createElement('div')
            minCharMessage.innerHTML = `Please type at least <strong>${minlength}</strong> characters`
            minCharMessage.classList.add("suggestion__no-results");
            suggestions.appendChild(minCharMessage);
            return;
        } else {
            
            if (flatResults.size === 0 && searchQuery) {
                const noResultsMessage = document.createElement('div')
                noResultsMessage.innerHTML = "No results for" + ` "<strong>${searchQuery}</strong>"`
                noResultsMessage.classList.add("suggestion__no-results");
                suggestions.appendChild(noResultsMessage);
                return;
            }
        }

        
        for(const [href, doc] of flatResults) {
            const entry = document.createElement('div');
            suggestions.appendChild(entry);

            const a = document.createElement('a');
            a.href = href;
            entry.appendChild(a);

            const title = document.createElement('span');
            title.textContent = doc.title;
            title.classList.add("suggestion__title");
            a.appendChild(title);

            const description = document.createElement('span');
            description.textContent = doc.description;
            description.classList.add("suggestion__description");
            a.appendChild(description);

            suggestions.appendChild(entry);

            if(suggestions.childElementCount == maxResult) break;
        }
    }
    }());
</script></body></html>