<!doctype html><html lang=fr-fr><head><meta charset=utf-8><title>CQRS - Command Query Responsibility Segregation | DDD Adventure</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="DÃ©couvrez CQRS, le pattern qui sÃ©pare les commandes des requÃªtes pour une architecture plus claire et performante"><meta name=keywords content="Documentation,Hugo,Hugo Theme,Bootstrap"><meta name=author content="Colin Wilson - Lotus Labs"><meta name=email content="support@aigis.uk"><meta name=website content="https://lotusdocs.dev"><meta name=Version content="v0.1.0"><link rel=icon href=https://votre-domaine.fr/favicon.ico sizes=any><link rel=icon type=image/svg+xml href=https://votre-domaine.fr/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=https://votre-domaine.fr/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://votre-domaine.fr/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://votre-domaine.fr/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://votre-domaine.fr/site.webmanifest><meta property="og:title" content="CQRS - Command Query Responsibility Segregation"><meta property="og:description" content="DÃ©couvrez CQRS, le pattern qui sÃ©pare les commandes des requÃªtes pour une architecture plus claire et performante"><meta property="og:type" content="article"><meta property="og:url" content="https://votre-domaine.fr/patterns/cqrs/"><meta property="og:image" content="https://votre-domaine.fr/opengraph/card-base-2_hu_c282e123f6f1bcf1.png"><meta property="article:section" content="patterns"><meta property="article:published_time" content="2024-12-19T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-19T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://votre-domaine.fr/opengraph/card-base-2_hu_c282e123f6f1bcf1.png"><meta name=twitter:title content="CQRS - Command Query Responsibility Segregation"><meta name=twitter:description content="DÃ©couvrez CQRS, le pattern qui sÃ©pare les commandes des requÃªtes pour une architecture plus claire et performante"><link rel=alternate type=application/atom+xml title="Atom feed for DDD Adventure" href=/index.xml><script type=text/javascript src=https://votre-domaine.fr/docs/js/flexsearch.bundle.min.f5159d5a2151ffbb653996ec17eaff7da4e04c286bd879fc41839d36a5586f3f20eaead0b6089de48f9adc669cdee771.js integrity=sha384-9RWdWiFR/7tlOZbsF+r/faTgTChr2Hn8QYOdNqVYbz8g6urQtgid5I+a3Gac3udx crossorigin=anonymous></script><link rel=stylesheet href=/docs/scss/style.min.9f198180aa929b3c2276b402b796e74ed231639ad7ea837d05515b5be35ef385e0980b2bc2499d09dad5d011b90710cf.css integrity=sha384-nxmBgKqSmzwidrQCt5bnTtIxY5rX6oN9BVFbW+Ne84XgmAsrwkmdCdrV0BG5BxDP crossorigin=anonymous></head><body><div class=content><div class="page-wrapper toggled"><nav id=sidebar class=sidebar-wrapper><div class=sidebar-brand><a href=/ aria-label=HomePage alt=HomePage><svg id="Layer_1" viewBox="0 0 250 250"><path d="m143 39.5c-18 0-18 18-18 18s0-18-18-18H22c-2.76.0-5 2.24-5 5v143c0 2.76 2.24 5 5 5h76c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h76c2.76.0 5-2.24 5-5V44.5c0-2.76-2.24-5-5-5h-85zM206 163c0 1.38-1.12 2.5-2.5 2.5H143c-18 0-18 18-18 18s0-18-18-18H46.5c-1.38.0-2.5-1.12-2.5-2.5V69c0-1.38 1.12-2.5 2.5-2.5H98c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h51.5c1.38.0 2.5 1.12 2.5 2.5v94z" style="fill:#06f"/></svg></a></div><div class=sidebar-content style="height:calc(100% - 131px)"><ul class=sidebar-menu><li class=current><a class=sidebar-root-link href=https://votre-domaine.fr/patterns/cqrs/>CQRS - Command Query Responsibility Segregation</a></li><li><a class=sidebar-root-link href=https://votre-domaine.fr/patterns/event-sourcing/>Event Sourcing - Stocker les Ã‰vÃ©nements comme Source de VÃ©ritÃ©</a></li><li><a class=sidebar-root-link href=https://votre-domaine.fr/patterns/repositories/>Repositories - Patterns de Persistance</a></li></ul></div><ul class="sidebar-footer list-unstyled mb-0"></ul></nav><main class="page-content bg-transparent"><div id=top-header class="top-header d-print-none"><div class="header-bar d-flex justify-content-between"><div class="d-flex align-items-center"><a href=/ class="logo-icon me-3" aria-label=HomePage alt=HomePage><div class=small><svg id="Layer_1" viewBox="0 0 250 250"><path d="m143 39.5c-18 0-18 18-18 18s0-18-18-18H22c-2.76.0-5 2.24-5 5v143c0 2.76 2.24 5 5 5h76c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h76c2.76.0 5-2.24 5-5V44.5c0-2.76-2.24-5-5-5h-85zM206 163c0 1.38-1.12 2.5-2.5 2.5H143c-18 0-18 18-18 18s0-18-18-18H46.5c-1.38.0-2.5-1.12-2.5-2.5V69c0-1.38 1.12-2.5 2.5-2.5H98c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h51.5c1.38.0 2.5 1.12 2.5 2.5v94z" style="fill:#06f"/></svg></div><div class=big><svg id="Layer_1" viewBox="0 0 250 250"><path d="m143 39.5c-18 0-18 18-18 18s0-18-18-18H22c-2.76.0-5 2.24-5 5v143c0 2.76 2.24 5 5 5h76c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h76c2.76.0 5-2.24 5-5V44.5c0-2.76-2.24-5-5-5h-85zM206 163c0 1.38-1.12 2.5-2.5 2.5H143c-18 0-18 18-18 18s0-18-18-18H46.5c-1.38.0-2.5-1.12-2.5-2.5V69c0-1.38 1.12-2.5 2.5-2.5H98c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h51.5c1.38.0 2.5 1.12 2.5 2.5v94z" style="fill:#06f"/></svg></div></a><button id=close-sidebar class="btn btn-icon btn-soft">
<span class="material-icons size-20 menu-icon align-middle">menu</span>
</button>
<button id=flexsearch-button class="ms-3 btn btn-soft" data-bs-toggle=collapse data-bs-target=#FlexSearchCollapse aria-expanded=false aria-controls=FlexSearchCollapse>
<span class="material-icons size-20 menu-icon align-middle">search</span>
<span class="flexsearch-button-placeholder ms-1 me-2 d-none d-sm-block">Search</span><div class="d-none d-sm-block"><span class=flexsearch-button-keys><kbd class=flexsearch-button-cmd-key><svg width="44" height="15"><path d="M2.118 11.5A1.519 1.519.0 011 11.042 1.583 1.583.0 011 8.815a1.519 1.519.0 011.113-.458h.715V6.643h-.71A1.519 1.519.0 011 6.185 1.519 1.519.0 01.547 5.071 1.519 1.519.0 011 3.958 1.519 1.519.0 012.118 3.5a1.519 1.519.0 011.114.458A1.519 1.519.0 013.69 5.071v.715H5.4V5.071A1.564 1.564.0 016.976 3.5 1.564 1.564.0 018.547 5.071 1.564 1.564.0 016.976 6.643H6.261V8.357h.715a1.575 1.575.0 011.113 2.685 1.583 1.583.0 01-2.227.0A1.519 1.519.0 015.4 9.929V9.214H3.69v.715a1.519 1.519.0 01-.458 1.113A1.519 1.519.0 012.118 11.5zm0-.857a.714.714.0 00.715-.714V9.214H2.118a.715.715.0 100 1.429zm4.858.0a.715.715.0 100-1.429H6.261v.715a.714.714.0 00.715.714zM3.69 8.357H5.4V6.643H3.69zM2.118 5.786h.715V5.071a.714.714.0 00-.715-.714.715.715.0 00-.5 1.22A.686.686.0 002.118 5.786zm4.143.0h.715a.715.715.0 00.5-1.22.715.715.0 00-1.22.5z" fill="currentColor"/><path d="M12.4 11.475H11.344l3.879-7.95h1.056z" fill="currentColor"/><path d="M25.073 5.384l-.864.576a2.121 2.121.0 00-1.786-.923 2.207 2.207.0 00-2.266 2.326 2.206 2.206.0 002.266 2.325 2.1 2.1.0 001.782-.918l.84.617a3.108 3.108.0 01-2.622 1.293 3.217 3.217.0 01-3.349-3.317 3.217 3.217.0 013.349-3.317A3.046 3.046.0 0125.073 5.384z" fill="currentColor"/><path d="M30.993 5.142h-2.07v5.419H27.891V5.142h-2.07V4.164h5.172z" fill="currentColor"/><path d="M34.67 4.164c1.471.0 2.266.658 2.266 1.851.0 1.087-.832 1.809-2.134 1.855l2.107 2.691h-1.28L33.591 7.87H33.07v2.691H32.038v-6.4zm-1.6.969v1.8h1.572c.832.0 1.22-.3 1.22-.918s-.411-.882-1.22-.882z" fill="currentColor"/><path d="M42.883 10.561H38.31v-6.4h1.033V9.583h3.54z" fill="currentColor"/></svg>
</kbd><kbd class=flexsearch-button-key><svg width="15" height="15"><path d="M5.926 12.279H4.41L9.073 2.721H10.59z" fill="currentColor"/></svg></kbd></span></div></button></div><div class="d-flex align-items-center"><ul class="list-unstyled mb-0"><li class="list-inline-item mb-0"><a href=https://twitter.com/gplanchat alt=twitter rel="noopener noreferrer" target=_blank><div class="btn btn-icon btn-default border-0"><svg width="24" height="24" viewBox="0 0 24 24"><title>Twitter / X</title><path d="M.088.768l9.266 12.39L.029 23.231h2.1l8.163-8.819 6.6 8.819h7.142L14.242 10.145 22.921.768h-2.1L13.3 8.891 7.229.768zM3.174 2.314H6.455L20.942 21.685h-3.28z" fill="currentColor"/></svg></div></a></li></ul></div></div><div class=collapse id=FlexSearchCollapse><div class=flexsearch-container><div class=flexsearch-keymap><li><kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Arrow down" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 3.5v8m3-3-3 3-3-3"/></g></svg></kbd>
<kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Arrow up" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 11.5v-8m3 3-3-3-3 3"/></g></svg></kbd>
<span class=flexsearch-key-label>to navigate</span></li><li><kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Enter key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M12 3.53088v3c0 1-1 2-2 2H4m3 3-3-3 3-3"/></g></svg></kbd>
<span class=flexsearch-key-label>to select</span></li><li><kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Escape key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M13.6167 8.936c-.1065.3583-.6883.962-1.4875.962-.7993.0-1.653-.9165-1.653-2.1258v-.5678c0-1.2548.7896-2.1016 1.653-2.1016s1.3601.4778 1.4875 1.0724M9 6c-.1352-.4735-.7506-.9219-1.46-.8972-.7092.0246-1.344.57-1.344 1.2166s.4198.8812 1.3445.9805C8.465 7.3992 8.968 7.9337 9 8.5s-.454 1.398-1.4595 1.398C6.6593 9.898 6 9 5.963 8.4851m-1.4748.5368c-.2635.5941-.8099.876-1.5443.876s-1.7073-.6248-1.7073-2.204v-.4603c0-1.0416.721-2.131 1.7073-2.131.9864.0 1.6425 1.031 1.5443 2.2492h-2.956"/></g></svg></kbd>
<span class=flexsearch-key-label>to close</span></li></div><form class="flexsearch position-relative flex-grow-1 ms-2 me-2"><div class="d-flex flex-row"><input id=flexsearch class=form-control type=search placeholder=Search aria-label=Search autocomplete=off>
<button id=hideFlexsearch type=button class="ms-2 btn btn-soft">
cancel</button></div><div id=suggestions class="shadow rounded-1 d-none"></div></form></div></div></div><div class=container-fluid><div class=layout-spacing><div class="d-md-flex justify-content-between align-items-center"><nav aria-label=breadcrumb class="d-inline-block pb-2 mt-1 mt-sm-0"><ul id=breadcrumbs class="breadcrumb bg-transparent mb-0" itemscope itemtype=https://schema.org/BreadcrumbList><li class="breadcrumb-item text-capitalize active" aria-current=page itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=/patterns/><i class="material-icons size-20 align-text-bottom" itemprop=name>Home</i>
</a><meta itemprop=position content='1'></li><li class="breadcrumb-item text-capitalize active" itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><span itemprop=name>CQRS - Command Query Responsibility Segregation</span>
<meta itemprop=position content='2'></li></ul></nav></div><div class="row flex-xl-nowrap"><div class="docs-toc col-xl-3 d-xl-block"><toc><div class="fw-bold text-uppercase mb-2">On this page</div><nav id=TableOfContents><ul><li><a href=#-quest-ce-que-cqrs-cqrs-command-query-responsibility-segregation-est-un-pattern-architectural-qui-sÃ©pare-clairement-les-opÃ©rations-de-lecture-query-des-opÃ©rations-dÃ©criture-command-dans-une-application-le-principe-fondamental----bertrand-meyercqrs-pousse-ce-principe-Ã -lextrÃªme-en-crÃ©ant-deux-modÃ¨les-distincts---modÃ¨le-de-commande--pour-les-opÃ©rations-qui-modifient-lÃ©tat--modÃ¨le-de-requÃªte--pour-les-opÃ©rations-qui-lisent-les-donnÃ©es--architecture-cqrs-dans-gyroscops-contexte-mÃ©tier--gestion-des-paiementsdans-gyroscops-nous-gÃ©rons-des-paiements-avec-des-besoins-trÃ¨s-diffÃ©rents--cÃ´tÃ©-commande-writephp-commande--crÃ©er-un-paiementclass-createpaymentcommand----public-function-__construct--------public-readonly-paymentid-paymentid--------public-readonly-amount-amount--------public-readonly-paymentmethod-method--------public-readonly-customerid-customerid------handler--traiter-la-commandeclass-createpaymenthandler----public-function-__invokecreatepaymentcommand-command-void------------payment--paymentcreate------------command-paymentid------------command-amount------------command-method------------command-customerid------------------------this-paymentrepository-savepayment--------this-eventbus-dispatchnew-paymentcreatedpayment-----cÃ´tÃ©-requÃªte-readphp-requÃªte--obtenir-les-paiements-dun-clientclass-getcustomerpaymentsquery----public-function-__construct--------public-readonly-customerid-customerid--------public-readonly-daterange-daterange--null------handler--exÃ©cuter-la-requÃªteclass-getcustomerpaymentshandler----public-function-__invokegetcustomerpaymentsquery-query-array------------return-this-paymentqueryrepository-findbycustomer------------query-customerid------------query-daterange--------------avantages-de-cqrs-1-sÃ©paration-des-responsabilitÃ©s--commandes--focus-sur-la-logique-mÃ©tier-et-la-validation--requÃªtes--focus-sur-loptimisation-des-performances-de-lecture-2-optimisation-indÃ©pendante--write-model--optimisÃ©-pour-la-cohÃ©rence-et-les-invariants-mÃ©tier--read-model--optimisÃ©-pour-les-performances-et-la-flexibilitÃ©-3-scalabilitÃ©--possibilitÃ©-de-scaler-sÃ©parÃ©ment-les-lectures-et-les-Ã©critures--utilisation-de-technologies-diffÃ©rentes-pour-chaque-cÃ´tÃ©-4-Ã©volutivitÃ©--modification-des-requÃªtes-sans-impact-sur-les-commandes--ajout-de-nouvelles-vues-sans-affecter-la-logique-mÃ©tier--implÃ©mentation-dans-gyroscops-structure-des-dossierssrcaccounting-application----command-------createpayment----------createpaymentcommandphp----------createpaymenthandlerphp----------createpaymentvalidatorphp-------processrefund----query--------getpaymentdetails-----------getpaymentdetailsqueryphp-----------getpaymentdetailshandlerphp-----------paymentdetailsviewphp--------listcustomerpayments-domain----paymentphp-write-model----paymentdetailsphp-read-model-infrastructure-----paymentrepositoryphp-write-----paymentqueryrepositoryphp-read-exemple-concret--gestion-des-abonnements-commande--crÃ©er-un-abonnementphpclass-createsubscriptioncommand----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-planid-planid--------public-readonly-customerid-customerid--------public-readonly-billingcycle-billingcycle-----class-createsubscriptionhandler----public-function-__invokecreatesubscriptioncommand-command-void-------------validation-mÃ©tier--------this-validatesubscriptioncreationcommand-----------------crÃ©ation-de-lagrÃ©gat--------subscription--subscriptioncreate------------command-subscriptionid------------command-planid------------command-customerid------------command-billingcycle-------------------------persistance--------this-subscriptionrepository-savesubscription-----------------Ã©vÃ©nement--------this-eventbus-dispatchnew-subscriptioncreatedsubscription-----requÃªte--obtenir-les-dÃ©tails-dphpclass-getsubscriptiondetailsquery----public-function-__construct--------public-readonly-subscriptionid-subscriptionid-----class-getsubscriptiondetailshandler----public-function-__invokegetsubscriptiondetailsquery-query-subscriptiondetailsview------------return-this-subscriptionqueryrepository-finddetailsquery-subscriptionid----class-subscriptiondetailsview----public-function-__construct--------public-readonly-subscriptionid-id--------public-readonly-string-planname--------public-readonly-string-customername--------public-readonly-string-status--------public-readonly-datetime-startdate--------public-readonly-datetime-enddate--------public-readonly-amount-monthlyprice--------public-readonly-array-features-------patterns-avancÃ©s-avec-cqrs-1-event-sourcing--cqrs--les-commandes-gÃ©nÃ¨rent-des-Ã©vÃ©nements--les-requÃªtes-lisent-depuis-les-projections-2-cqrs-avec-projections--projections-dÃ©normalisÃ©es-pour-les-requÃªtes--mise-Ã -jour-asynchrone-des-vues-3-cqrs-avec-api-platform--ressources-sÃ©parÃ©es-pour-command-et-query--validation-automatique-des-dtos--performance-et-optimisation-optimisations-cÃ´tÃ©-lecture--indexation--index-optimisÃ©s-pour-les-requÃªtes-frÃ©quentes--cache--mise-en-cache-des-vues-frÃ©quemment-consultÃ©es--dÃ©normalisation--donnÃ©es-prÃ©-calculÃ©es-pour-Ã©viter-les-jointures-optimisations-cÃ´tÃ©-Ã©criture--validation--validation-mÃ©tier-centralisÃ©e--transactions--gestion-des-transactions-optimisÃ©e--Ã©vÃ©nements--publication-asynchrone-des-Ã©vÃ©nements--quand-utiliser-cqrs---cas-d--complexitÃ©-mÃ©tier-Ã©levÃ©e--beaucoup-de-rÃ¨gles-mÃ©tier--besoins-de-lectureÃ©criture-diffÃ©rents--requÃªtes-complexes-vs-Ã©critures-simples--performance-critique--besoins-de-performance-diffÃ©rents--Ã©quipes-sÃ©parÃ©es--Ã©quipes-diffÃ©rentes-pour-readwrite--cas-d--applications-simples--crud-basique--cohÃ©rence-forte-requise--besoin-de-cohÃ©rence-immÃ©diate--Ã©quipe-unique--une-seule-Ã©quipe-pour-tout--prototypage--dÃ©veloppement-rapide--migration-vers-cqrs-Ã©tape-1--identifier-les-commandes--lister-toutes-les-opÃ©rations-qui-modifient-lÃ©tat--grouper-par-contexte-mÃ©tier-Ã©tape-2--identifier-les-requÃªtes--lister-toutes-les-opÃ©rations-de-lecture--analyser-les-patterns-daccÃ¨s-Ã©tape-3--sÃ©parer-les-modÃ¨les--crÃ©er-des-modÃ¨les-distincts--migrer-progressivement-Ã©tape-4--optimiser--optimiser-chaque-cÃ´tÃ©-indÃ©pendamment--mesurer-les-performances--mÃ©triques-et-monitoring-mÃ©triques-cÃ´tÃ©-commande--nombre-de-commandes-par-seconde--temps-de-traitement-moyen--taux-derreur-mÃ©triques-cÃ´tÃ©-requÃªte--temps-de-rÃ©ponse-des-requÃªtes--utilisation-du-cache--charge-des-projections--prochaines-Ã©tapesmaintenant-que-vous-comprenez-cqrs-explorez-1-event-sourcing--stocker-les-Ã©vÃ©nements-comme-source-de-vÃ©ritÃ©2-repositories--patterns-de-persistance3-implÃ©mentation-cqrs--guide-dimplÃ©mentation-completcqrs-n>ğŸŒŸ **Quâ€™est-ce que CQRS ?**<strong>CQRS</strong> (Command Query Responsibility Segregation) est un pattern architectural qui sÃ©pare clairement les opÃ©rations de <strong>lecture</strong> (Query) des opÃ©rations dâ€™<strong>Ã©criture</strong> (Command) dans une application.### <strong>Le Principe Fondamental</strong>> <strong>â€œUne mÃ©thode ne devrait jamais retourner de valeur et modifier lâ€™Ã©tat de lâ€™objetâ€</strong> - Bertrand MeyerCQRS pousse ce principe Ã  lâ€™extrÃªme en crÃ©ant deux modÃ¨les distincts :- <strong>ModÃ¨le de Commande</strong> : Pour les opÃ©rations qui modifient lâ€™Ã©tat- <strong>ModÃ¨le de RequÃªte</strong> : Pour les opÃ©rations qui lisent les donnÃ©es## ğŸ—ï¸ <strong>Architecture CQRS dans Gyroscops</strong>### <strong>Contexte MÃ©tier : Gestion des Paiements</strong>Dans Gyroscops, nous gÃ©rons des paiements avec des besoins trÃ¨s diffÃ©rents :#### <strong>CÃ´tÃ© Commande (Write)</strong><code>php// Commande : CrÃ©er un paiementclass CreatePaymentCommand{ public function __construct( public readonly PaymentId $paymentId, public readonly Amount $amount, public readonly PaymentMethod $method, public readonly CustomerId $customerId ) {}}// Handler : Traiter la commandeclass CreatePaymentHandler{ public function __invoke(CreatePaymentCommand $command): void { $payment = Payment::create( $command->paymentId, $command->amount, $command->method, $command->customerId ); $this->paymentRepository->save($payment); $this->eventBus->dispatch(new PaymentCreated($payment)); }}</code>#### <strong>CÃ´tÃ© RequÃªte (Read)</strong><code>php// RequÃªte : Obtenir les paiements d'un clientclass GetCustomerPaymentsQuery{ public function __construct( public readonly CustomerId $customerId, public readonly ?DateRange $dateRange = null ) {}}// Handler : ExÃ©cuter la requÃªteclass GetCustomerPaymentsHandler{ public function __invoke(GetCustomerPaymentsQuery $query): array { return $this->paymentQueryRepository->findByCustomer( $query->customerId, $query->dateRange ); }}</code>## ğŸ¯ <strong>Avantages de CQRS</strong>### <strong>1. SÃ©paration des ResponsabilitÃ©s</strong>- <strong>Commandes</strong> : Focus sur la logique mÃ©tier et la validation- <strong>RequÃªtes</strong> : Focus sur lâ€™optimisation des performances de lecture### <strong>2. Optimisation IndÃ©pendante</strong>- <strong>Write Model</strong> : OptimisÃ© pour la cohÃ©rence et les invariants mÃ©tier- <strong>Read Model</strong> : OptimisÃ© pour les performances et la flexibilitÃ©### <strong>3. ScalabilitÃ©</strong>- PossibilitÃ© de scaler sÃ©parÃ©ment les lectures et les Ã©critures- Utilisation de technologies diffÃ©rentes pour chaque cÃ´tÃ©### <strong>4. Ã‰volutivitÃ©</strong>- Modification des requÃªtes sans impact sur les commandes- Ajout de nouvelles vues sans affecter la logique mÃ©tier## ğŸ”§ <strong>ImplÃ©mentation dans Gyroscops</strong>### <strong>Structure des Dossiers</strong><code>src/Accounting/â”œâ”€â”€ Application/â”‚ â”œâ”€â”€ Command/â”‚ â”‚ â”œâ”€â”€ CreatePayment/â”‚ â”‚ â”‚ â”œâ”€â”€ CreatePaymentCommand.phpâ”‚ â”‚ â”‚ â”œâ”€â”€ CreatePaymentHandler.phpâ”‚ â”‚ â”‚ â””â”€â”€ CreatePaymentValidator.phpâ”‚ â”‚ â””â”€â”€ ProcessRefund/â”‚ â””â”€â”€ Query/â”‚ â”œâ”€â”€ GetPaymentDetails/â”‚ â”‚ â”œâ”€â”€ GetPaymentDetailsQuery.phpâ”‚ â”‚ â”œâ”€â”€ GetPaymentDetailsHandler.phpâ”‚ â”‚ â””â”€â”€ PaymentDetailsView.phpâ”‚ â””â”€â”€ ListCustomerPayments/â”œâ”€â”€ Domain/â”‚ â”œâ”€â”€ Payment.php (Write Model)â”‚ â””â”€â”€ PaymentDetails.php (Read Model)â””â”€â”€ Infrastructure/ â”œâ”€â”€ PaymentRepository.php (Write) â””â”€â”€ PaymentQueryRepository.php (Read)</code>### <strong>Exemple Concret : Gestion des Abonnements</strong>#### <strong>Commande : CrÃ©er un Abonnement</strong><code>phpclass CreateSubscriptionCommand{ public function __construct( public readonly SubscriptionId $subscriptionId, public readonly PlanId $planId, public readonly CustomerId $customerId, public readonly BillingCycle $billingCycle ) {}}class CreateSubscriptionHandler{ public function __invoke(CreateSubscriptionCommand $command): void { // Validation mÃ©tier $this->validateSubscriptionCreation($command); // CrÃ©ation de l'agrÃ©gat $subscription = Subscription::create( $command->subscriptionId, $command->planId, $command->customerId, $command->billingCycle ); // Persistance $this->subscriptionRepository->save($subscription); // Ã‰vÃ©nement $this->eventBus->dispatch(new SubscriptionCreated($subscription)); }}</code>#### <strong>RequÃªte : Obtenir les DÃ©tails dâ€™un Abonnement</strong><code>phpclass GetSubscriptionDetailsQuery{ public function __construct( public readonly SubscriptionId $subscriptionId ) {}}class GetSubscriptionDetailsHandler{ public function __invoke(GetSubscriptionDetailsQuery $query): SubscriptionDetailsView { return $this->subscriptionQueryRepository->findDetails($query->subscriptionId); }}class SubscriptionDetailsView{ public function __construct( public readonly SubscriptionId $id, public readonly string $planName, public readonly string $customerName, public readonly string $status, public readonly DateTime $startDate, public readonly ?DateTime $endDate, public readonly Amount $monthlyPrice, public readonly array $features ) {}}</code>## ğŸš€ <strong>Patterns AvancÃ©s avec CQRS</strong>### <strong>1. Event Sourcing + CQRS</strong>- Les commandes gÃ©nÃ¨rent des Ã©vÃ©nements- Les requÃªtes lisent depuis les projections### <strong>2. CQRS avec Projections</strong>- Projections dÃ©normalisÃ©es pour les requÃªtes- Mise Ã  jour asynchrone des vues### <strong>3. CQRS avec API Platform</strong>- Ressources sÃ©parÃ©es pour Command et Query- Validation automatique des DTOs## âš¡ <strong>Performance et Optimisation</strong>### <strong>Optimisations CÃ´tÃ© Lecture</strong>- <strong>Indexation</strong> : Index optimisÃ©s pour les requÃªtes frÃ©quentes- <strong>Cache</strong> : Mise en cache des vues frÃ©quemment consultÃ©es- <strong>DÃ©normalisation</strong> : DonnÃ©es prÃ©-calculÃ©es pour Ã©viter les jointures### <strong>Optimisations CÃ´tÃ© Ã‰criture</strong>- <strong>Validation</strong> : Validation mÃ©tier centralisÃ©e- <strong>Transactions</strong> : Gestion des transactions optimisÃ©e- <strong>Ã‰vÃ©nements</strong> : Publication asynchrone des Ã©vÃ©nements## ğŸ¯ <strong>Quand Utiliser CQRS ?</strong>### <strong>âœ… Cas dâ€™Usage AppropriÃ©s</strong>- <strong>ComplexitÃ© mÃ©tier Ã©levÃ©e</strong> : Beaucoup de rÃ¨gles mÃ©tier- <strong>Besoins de lecture/Ã©criture diffÃ©rents</strong> : RequÃªtes complexes vs Ã©critures simples- <strong>Performance critique</strong> : Besoins de performance diffÃ©rents- <strong>Ã‰quipes sÃ©parÃ©es</strong> : Ã‰quipes diffÃ©rentes pour read/write### <strong>âŒ Cas dâ€™Usage InappropriÃ©s</strong>- <strong>Applications simples</strong> : CRUD basique- <strong>CohÃ©rence forte requise</strong> : Besoin de cohÃ©rence immÃ©diate- <strong>Ã‰quipe unique</strong> : Une seule Ã©quipe pour tout- <strong>Prototypage</strong> : DÃ©veloppement rapide## ğŸ”„ <strong>Migration vers CQRS</strong>### <strong>Ã‰tape 1 : Identifier les Commandes</strong>- Lister toutes les opÃ©rations qui modifient lâ€™Ã©tat- Grouper par contexte mÃ©tier### <strong>Ã‰tape 2 : Identifier les RequÃªtes</strong>- Lister toutes les opÃ©rations de lecture- Analyser les patterns dâ€™accÃ¨s### <strong>Ã‰tape 3 : SÃ©parer les ModÃ¨les</strong>- CrÃ©er des modÃ¨les distincts- Migrer progressivement### <strong>Ã‰tape 4 : Optimiser</strong>- Optimiser chaque cÃ´tÃ© indÃ©pendamment- Mesurer les performances## ğŸ“Š <strong>MÃ©triques et Monitoring</strong>### <strong>MÃ©triques CÃ´tÃ© Commande</strong>- Nombre de commandes par seconde- Temps de traitement moyen- Taux dâ€™erreur### <strong>MÃ©triques CÃ´tÃ© RequÃªte</strong>- Temps de rÃ©ponse des requÃªtes- Utilisation du cache- Charge des projections## ğŸ¯ <strong>Prochaines Ã‰tapes</strong>Maintenant que vous comprenez CQRS, explorez :1. <strong>Event Sourcing</strong> : Stocker les Ã©vÃ©nements comme source de vÃ©ritÃ©2. <strong>Repositories</strong> : Patterns de persistance3. <strong>ImplÃ©mentation CQRS</strong> : Guide dâ€™implÃ©mentation completâ€”<em>CQRS nâ€™est pas une solution universelle, mais un outil puissant pour les applications complexes. Dans Gyroscops, il nous a permis de gÃ©rer efficacement la complexitÃ© mÃ©tier tout en optimisant les performances.</em></a></li></ul></nav></toc></div><div class="docs-toc-mobile d-print-none d-xl-none"><button id=toc-dropdown-btn class="btn-secondary dropdown-toggle" type=button data-bs-toggle=dropdown data-bs-offset=0,0 aria-expanded=false>
Table of Contents</button><nav id=toc-mobile><ul class=dropdown-menu><li><a href=#-quest-ce-que-cqrs-cqrs-command-query-responsibility-segregation-est-un-pattern-architectural-qui-sÃ©pare-clairement-les-opÃ©rations-de-lecture-query-des-opÃ©rations-dÃ©criture-command-dans-une-application-le-principe-fondamental----bertrand-meyercqrs-pousse-ce-principe-Ã -lextrÃªme-en-crÃ©ant-deux-modÃ¨les-distincts---modÃ¨le-de-commande--pour-les-opÃ©rations-qui-modifient-lÃ©tat--modÃ¨le-de-requÃªte--pour-les-opÃ©rations-qui-lisent-les-donnÃ©es--architecture-cqrs-dans-gyroscops-contexte-mÃ©tier--gestion-des-paiementsdans-gyroscops-nous-gÃ©rons-des-paiements-avec-des-besoins-trÃ¨s-diffÃ©rents--cÃ´tÃ©-commande-writephp-commande--crÃ©er-un-paiementclass-createpaymentcommand----public-function-__construct--------public-readonly-paymentid-paymentid--------public-readonly-amount-amount--------public-readonly-paymentmethod-method--------public-readonly-customerid-customerid------handler--traiter-la-commandeclass-createpaymenthandler----public-function-__invokecreatepaymentcommand-command-void------------payment--paymentcreate------------command-paymentid------------command-amount------------command-method------------command-customerid------------------------this-paymentrepository-savepayment--------this-eventbus-dispatchnew-paymentcreatedpayment-----cÃ´tÃ©-requÃªte-readphp-requÃªte--obtenir-les-paiements-dun-clientclass-getcustomerpaymentsquery----public-function-__construct--------public-readonly-customerid-customerid--------public-readonly-daterange-daterange--null------handler--exÃ©cuter-la-requÃªteclass-getcustomerpaymentshandler----public-function-__invokegetcustomerpaymentsquery-query-array------------return-this-paymentqueryrepository-findbycustomer------------query-customerid------------query-daterange--------------avantages-de-cqrs-1-sÃ©paration-des-responsabilitÃ©s--commandes--focus-sur-la-logique-mÃ©tier-et-la-validation--requÃªtes--focus-sur-loptimisation-des-performances-de-lecture-2-optimisation-indÃ©pendante--write-model--optimisÃ©-pour-la-cohÃ©rence-et-les-invariants-mÃ©tier--read-model--optimisÃ©-pour-les-performances-et-la-flexibilitÃ©-3-scalabilitÃ©--possibilitÃ©-de-scaler-sÃ©parÃ©ment-les-lectures-et-les-Ã©critures--utilisation-de-technologies-diffÃ©rentes-pour-chaque-cÃ´tÃ©-4-Ã©volutivitÃ©--modification-des-requÃªtes-sans-impact-sur-les-commandes--ajout-de-nouvelles-vues-sans-affecter-la-logique-mÃ©tier--implÃ©mentation-dans-gyroscops-structure-des-dossierssrcaccounting-application----command-------createpayment----------createpaymentcommandphp----------createpaymenthandlerphp----------createpaymentvalidatorphp-------processrefund----query--------getpaymentdetails-----------getpaymentdetailsqueryphp-----------getpaymentdetailshandlerphp-----------paymentdetailsviewphp--------listcustomerpayments-domain----paymentphp-write-model----paymentdetailsphp-read-model-infrastructure-----paymentrepositoryphp-write-----paymentqueryrepositoryphp-read-exemple-concret--gestion-des-abonnements-commande--crÃ©er-un-abonnementphpclass-createsubscriptioncommand----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-planid-planid--------public-readonly-customerid-customerid--------public-readonly-billingcycle-billingcycle-----class-createsubscriptionhandler----public-function-__invokecreatesubscriptioncommand-command-void-------------validation-mÃ©tier--------this-validatesubscriptioncreationcommand-----------------crÃ©ation-de-lagrÃ©gat--------subscription--subscriptioncreate------------command-subscriptionid------------command-planid------------command-customerid------------command-billingcycle-------------------------persistance--------this-subscriptionrepository-savesubscription-----------------Ã©vÃ©nement--------this-eventbus-dispatchnew-subscriptioncreatedsubscription-----requÃªte--obtenir-les-dÃ©tails-dphpclass-getsubscriptiondetailsquery----public-function-__construct--------public-readonly-subscriptionid-subscriptionid-----class-getsubscriptiondetailshandler----public-function-__invokegetsubscriptiondetailsquery-query-subscriptiondetailsview------------return-this-subscriptionqueryrepository-finddetailsquery-subscriptionid----class-subscriptiondetailsview----public-function-__construct--------public-readonly-subscriptionid-id--------public-readonly-string-planname--------public-readonly-string-customername--------public-readonly-string-status--------public-readonly-datetime-startdate--------public-readonly-datetime-enddate--------public-readonly-amount-monthlyprice--------public-readonly-array-features-------patterns-avancÃ©s-avec-cqrs-1-event-sourcing--cqrs--les-commandes-gÃ©nÃ¨rent-des-Ã©vÃ©nements--les-requÃªtes-lisent-depuis-les-projections-2-cqrs-avec-projections--projections-dÃ©normalisÃ©es-pour-les-requÃªtes--mise-Ã -jour-asynchrone-des-vues-3-cqrs-avec-api-platform--ressources-sÃ©parÃ©es-pour-command-et-query--validation-automatique-des-dtos--performance-et-optimisation-optimisations-cÃ´tÃ©-lecture--indexation--index-optimisÃ©s-pour-les-requÃªtes-frÃ©quentes--cache--mise-en-cache-des-vues-frÃ©quemment-consultÃ©es--dÃ©normalisation--donnÃ©es-prÃ©-calculÃ©es-pour-Ã©viter-les-jointures-optimisations-cÃ´tÃ©-Ã©criture--validation--validation-mÃ©tier-centralisÃ©e--transactions--gestion-des-transactions-optimisÃ©e--Ã©vÃ©nements--publication-asynchrone-des-Ã©vÃ©nements--quand-utiliser-cqrs---cas-d--complexitÃ©-mÃ©tier-Ã©levÃ©e--beaucoup-de-rÃ¨gles-mÃ©tier--besoins-de-lectureÃ©criture-diffÃ©rents--requÃªtes-complexes-vs-Ã©critures-simples--performance-critique--besoins-de-performance-diffÃ©rents--Ã©quipes-sÃ©parÃ©es--Ã©quipes-diffÃ©rentes-pour-readwrite--cas-d--applications-simples--crud-basique--cohÃ©rence-forte-requise--besoin-de-cohÃ©rence-immÃ©diate--Ã©quipe-unique--une-seule-Ã©quipe-pour-tout--prototypage--dÃ©veloppement-rapide--migration-vers-cqrs-Ã©tape-1--identifier-les-commandes--lister-toutes-les-opÃ©rations-qui-modifient-lÃ©tat--grouper-par-contexte-mÃ©tier-Ã©tape-2--identifier-les-requÃªtes--lister-toutes-les-opÃ©rations-de-lecture--analyser-les-patterns-daccÃ¨s-Ã©tape-3--sÃ©parer-les-modÃ¨les--crÃ©er-des-modÃ¨les-distincts--migrer-progressivement-Ã©tape-4--optimiser--optimiser-chaque-cÃ´tÃ©-indÃ©pendamment--mesurer-les-performances--mÃ©triques-et-monitoring-mÃ©triques-cÃ´tÃ©-commande--nombre-de-commandes-par-seconde--temps-de-traitement-moyen--taux-derreur-mÃ©triques-cÃ´tÃ©-requÃªte--temps-de-rÃ©ponse-des-requÃªtes--utilisation-du-cache--charge-des-projections--prochaines-Ã©tapesmaintenant-que-vous-comprenez-cqrs-explorez-1-event-sourcing--stocker-les-Ã©vÃ©nements-comme-source-de-vÃ©ritÃ©2-repositories--patterns-de-persistance3-implÃ©mentation-cqrs--guide-dimplÃ©mentation-completcqrs-n>ğŸŒŸ **Quâ€™est-ce que CQRS ?**<strong>CQRS</strong> (Command Query Responsibility Segregation) est un pattern architectural qui sÃ©pare clairement les opÃ©rations de <strong>lecture</strong> (Query) des opÃ©rations dâ€™<strong>Ã©criture</strong> (Command) dans une application.### <strong>Le Principe Fondamental</strong>> <strong>â€œUne mÃ©thode ne devrait jamais retourner de valeur et modifier lâ€™Ã©tat de lâ€™objetâ€</strong> - Bertrand MeyerCQRS pousse ce principe Ã  lâ€™extrÃªme en crÃ©ant deux modÃ¨les distincts :- <strong>ModÃ¨le de Commande</strong> : Pour les opÃ©rations qui modifient lâ€™Ã©tat- <strong>ModÃ¨le de RequÃªte</strong> : Pour les opÃ©rations qui lisent les donnÃ©es## ğŸ—ï¸ <strong>Architecture CQRS dans Gyroscops</strong>### <strong>Contexte MÃ©tier : Gestion des Paiements</strong>Dans Gyroscops, nous gÃ©rons des paiements avec des besoins trÃ¨s diffÃ©rents :#### <strong>CÃ´tÃ© Commande (Write)</strong><code>php// Commande : CrÃ©er un paiementclass CreatePaymentCommand{ public function __construct( public readonly PaymentId $paymentId, public readonly Amount $amount, public readonly PaymentMethod $method, public readonly CustomerId $customerId ) {}}// Handler : Traiter la commandeclass CreatePaymentHandler{ public function __invoke(CreatePaymentCommand $command): void { $payment = Payment::create( $command->paymentId, $command->amount, $command->method, $command->customerId ); $this->paymentRepository->save($payment); $this->eventBus->dispatch(new PaymentCreated($payment)); }}</code>#### <strong>CÃ´tÃ© RequÃªte (Read)</strong><code>php// RequÃªte : Obtenir les paiements d'un clientclass GetCustomerPaymentsQuery{ public function __construct( public readonly CustomerId $customerId, public readonly ?DateRange $dateRange = null ) {}}// Handler : ExÃ©cuter la requÃªteclass GetCustomerPaymentsHandler{ public function __invoke(GetCustomerPaymentsQuery $query): array { return $this->paymentQueryRepository->findByCustomer( $query->customerId, $query->dateRange ); }}</code>## ğŸ¯ <strong>Avantages de CQRS</strong>### <strong>1. SÃ©paration des ResponsabilitÃ©s</strong>- <strong>Commandes</strong> : Focus sur la logique mÃ©tier et la validation- <strong>RequÃªtes</strong> : Focus sur lâ€™optimisation des performances de lecture### <strong>2. Optimisation IndÃ©pendante</strong>- <strong>Write Model</strong> : OptimisÃ© pour la cohÃ©rence et les invariants mÃ©tier- <strong>Read Model</strong> : OptimisÃ© pour les performances et la flexibilitÃ©### <strong>3. ScalabilitÃ©</strong>- PossibilitÃ© de scaler sÃ©parÃ©ment les lectures et les Ã©critures- Utilisation de technologies diffÃ©rentes pour chaque cÃ´tÃ©### <strong>4. Ã‰volutivitÃ©</strong>- Modification des requÃªtes sans impact sur les commandes- Ajout de nouvelles vues sans affecter la logique mÃ©tier## ğŸ”§ <strong>ImplÃ©mentation dans Gyroscops</strong>### <strong>Structure des Dossiers</strong><code>src/Accounting/â”œâ”€â”€ Application/â”‚ â”œâ”€â”€ Command/â”‚ â”‚ â”œâ”€â”€ CreatePayment/â”‚ â”‚ â”‚ â”œâ”€â”€ CreatePaymentCommand.phpâ”‚ â”‚ â”‚ â”œâ”€â”€ CreatePaymentHandler.phpâ”‚ â”‚ â”‚ â””â”€â”€ CreatePaymentValidator.phpâ”‚ â”‚ â””â”€â”€ ProcessRefund/â”‚ â””â”€â”€ Query/â”‚ â”œâ”€â”€ GetPaymentDetails/â”‚ â”‚ â”œâ”€â”€ GetPaymentDetailsQuery.phpâ”‚ â”‚ â”œâ”€â”€ GetPaymentDetailsHandler.phpâ”‚ â”‚ â””â”€â”€ PaymentDetailsView.phpâ”‚ â””â”€â”€ ListCustomerPayments/â”œâ”€â”€ Domain/â”‚ â”œâ”€â”€ Payment.php (Write Model)â”‚ â””â”€â”€ PaymentDetails.php (Read Model)â””â”€â”€ Infrastructure/ â”œâ”€â”€ PaymentRepository.php (Write) â””â”€â”€ PaymentQueryRepository.php (Read)</code>### <strong>Exemple Concret : Gestion des Abonnements</strong>#### <strong>Commande : CrÃ©er un Abonnement</strong><code>phpclass CreateSubscriptionCommand{ public function __construct( public readonly SubscriptionId $subscriptionId, public readonly PlanId $planId, public readonly CustomerId $customerId, public readonly BillingCycle $billingCycle ) {}}class CreateSubscriptionHandler{ public function __invoke(CreateSubscriptionCommand $command): void { // Validation mÃ©tier $this->validateSubscriptionCreation($command); // CrÃ©ation de l'agrÃ©gat $subscription = Subscription::create( $command->subscriptionId, $command->planId, $command->customerId, $command->billingCycle ); // Persistance $this->subscriptionRepository->save($subscription); // Ã‰vÃ©nement $this->eventBus->dispatch(new SubscriptionCreated($subscription)); }}</code>#### <strong>RequÃªte : Obtenir les DÃ©tails dâ€™un Abonnement</strong><code>phpclass GetSubscriptionDetailsQuery{ public function __construct( public readonly SubscriptionId $subscriptionId ) {}}class GetSubscriptionDetailsHandler{ public function __invoke(GetSubscriptionDetailsQuery $query): SubscriptionDetailsView { return $this->subscriptionQueryRepository->findDetails($query->subscriptionId); }}class SubscriptionDetailsView{ public function __construct( public readonly SubscriptionId $id, public readonly string $planName, public readonly string $customerName, public readonly string $status, public readonly DateTime $startDate, public readonly ?DateTime $endDate, public readonly Amount $monthlyPrice, public readonly array $features ) {}}</code>## ğŸš€ <strong>Patterns AvancÃ©s avec CQRS</strong>### <strong>1. Event Sourcing + CQRS</strong>- Les commandes gÃ©nÃ¨rent des Ã©vÃ©nements- Les requÃªtes lisent depuis les projections### <strong>2. CQRS avec Projections</strong>- Projections dÃ©normalisÃ©es pour les requÃªtes- Mise Ã  jour asynchrone des vues### <strong>3. CQRS avec API Platform</strong>- Ressources sÃ©parÃ©es pour Command et Query- Validation automatique des DTOs## âš¡ <strong>Performance et Optimisation</strong>### <strong>Optimisations CÃ´tÃ© Lecture</strong>- <strong>Indexation</strong> : Index optimisÃ©s pour les requÃªtes frÃ©quentes- <strong>Cache</strong> : Mise en cache des vues frÃ©quemment consultÃ©es- <strong>DÃ©normalisation</strong> : DonnÃ©es prÃ©-calculÃ©es pour Ã©viter les jointures### <strong>Optimisations CÃ´tÃ© Ã‰criture</strong>- <strong>Validation</strong> : Validation mÃ©tier centralisÃ©e- <strong>Transactions</strong> : Gestion des transactions optimisÃ©e- <strong>Ã‰vÃ©nements</strong> : Publication asynchrone des Ã©vÃ©nements## ğŸ¯ <strong>Quand Utiliser CQRS ?</strong>### <strong>âœ… Cas dâ€™Usage AppropriÃ©s</strong>- <strong>ComplexitÃ© mÃ©tier Ã©levÃ©e</strong> : Beaucoup de rÃ¨gles mÃ©tier- <strong>Besoins de lecture/Ã©criture diffÃ©rents</strong> : RequÃªtes complexes vs Ã©critures simples- <strong>Performance critique</strong> : Besoins de performance diffÃ©rents- <strong>Ã‰quipes sÃ©parÃ©es</strong> : Ã‰quipes diffÃ©rentes pour read/write### <strong>âŒ Cas dâ€™Usage InappropriÃ©s</strong>- <strong>Applications simples</strong> : CRUD basique- <strong>CohÃ©rence forte requise</strong> : Besoin de cohÃ©rence immÃ©diate- <strong>Ã‰quipe unique</strong> : Une seule Ã©quipe pour tout- <strong>Prototypage</strong> : DÃ©veloppement rapide## ğŸ”„ <strong>Migration vers CQRS</strong>### <strong>Ã‰tape 1 : Identifier les Commandes</strong>- Lister toutes les opÃ©rations qui modifient lâ€™Ã©tat- Grouper par contexte mÃ©tier### <strong>Ã‰tape 2 : Identifier les RequÃªtes</strong>- Lister toutes les opÃ©rations de lecture- Analyser les patterns dâ€™accÃ¨s### <strong>Ã‰tape 3 : SÃ©parer les ModÃ¨les</strong>- CrÃ©er des modÃ¨les distincts- Migrer progressivement### <strong>Ã‰tape 4 : Optimiser</strong>- Optimiser chaque cÃ´tÃ© indÃ©pendamment- Mesurer les performances## ğŸ“Š <strong>MÃ©triques et Monitoring</strong>### <strong>MÃ©triques CÃ´tÃ© Commande</strong>- Nombre de commandes par seconde- Temps de traitement moyen- Taux dâ€™erreur### <strong>MÃ©triques CÃ´tÃ© RequÃªte</strong>- Temps de rÃ©ponse des requÃªtes- Utilisation du cache- Charge des projections## ğŸ¯ <strong>Prochaines Ã‰tapes</strong>Maintenant que vous comprenez CQRS, explorez :1. <strong>Event Sourcing</strong> : Stocker les Ã©vÃ©nements comme source de vÃ©ritÃ©2. <strong>Repositories</strong> : Patterns de persistance3. <strong>ImplÃ©mentation CQRS</strong> : Guide dâ€™implÃ©mentation completâ€”<em>CQRS nâ€™est pas une solution universelle, mais un outil puissant pour les applications complexes. Dans Gyroscops, il nous a permis de gÃ©rer efficacement la complexitÃ© mÃ©tier tout en optimisant les performances.</em></a></li></ul></nav></div><div class="docs-content col-12 col-xl-9 mt-0"><div class="mb-0 d-flex"><h1 class="content-title mb-0">CQRS - Command Query Responsibility Segregation</h1></div><div id=content class=main-content><div data-prismjs-copy data-prismjs-copy-success data-prismjs-copy-error><h2 id=-quest-ce-que-cqrs-cqrs-command-query-responsibility-segregation-est-un-pattern-architectural-qui-sÃ©pare-clairement-les-opÃ©rations-de-lecture-query-des-opÃ©rations-dÃ©criture-command-dans-une-application-le-principe-fondamental----bertrand-meyercqrs-pousse-ce-principe-Ã -lextrÃªme-en-crÃ©ant-deux-modÃ¨les-distincts---modÃ¨le-de-commande--pour-les-opÃ©rations-qui-modifient-lÃ©tat--modÃ¨le-de-requÃªte--pour-les-opÃ©rations-qui-lisent-les-donnÃ©es--architecture-cqrs-dans-gyroscops-contexte-mÃ©tier--gestion-des-paiementsdans-gyroscops-nous-gÃ©rons-des-paiements-avec-des-besoins-trÃ¨s-diffÃ©rents--cÃ´tÃ©-commande-writephp-commande--crÃ©er-un-paiementclass-createpaymentcommand----public-function-__construct--------public-readonly-paymentid-paymentid--------public-readonly-amount-amount--------public-readonly-paymentmethod-method--------public-readonly-customerid-customerid------handler--traiter-la-commandeclass-createpaymenthandler----public-function-__invokecreatepaymentcommand-command-void------------payment--paymentcreate------------command-paymentid------------command-amount------------command-method------------command-customerid------------------------this-paymentrepository-savepayment--------this-eventbus-dispatchnew-paymentcreatedpayment-----cÃ´tÃ©-requÃªte-readphp-requÃªte--obtenir-les-paiements-dun-clientclass-getcustomerpaymentsquery----public-function-__construct--------public-readonly-customerid-customerid--------public-readonly-daterange-daterange--null------handler--exÃ©cuter-la-requÃªteclass-getcustomerpaymentshandler----public-function-__invokegetcustomerpaymentsquery-query-array------------return-this-paymentqueryrepository-findbycustomer------------query-customerid------------query-daterange--------------avantages-de-cqrs-1-sÃ©paration-des-responsabilitÃ©s--commandes--focus-sur-la-logique-mÃ©tier-et-la-validation--requÃªtes--focus-sur-loptimisation-des-performances-de-lecture-2-optimisation-indÃ©pendante--write-model--optimisÃ©-pour-la-cohÃ©rence-et-les-invariants-mÃ©tier--read-model--optimisÃ©-pour-les-performances-et-la-flexibilitÃ©-3-scalabilitÃ©--possibilitÃ©-de-scaler-sÃ©parÃ©ment-les-lectures-et-les-Ã©critures--utilisation-de-technologies-diffÃ©rentes-pour-chaque-cÃ´tÃ©-4-Ã©volutivitÃ©--modification-des-requÃªtes-sans-impact-sur-les-commandes--ajout-de-nouvelles-vues-sans-affecter-la-logique-mÃ©tier--implÃ©mentation-dans-gyroscops-structure-des-dossierssrcaccounting-application----command-------createpayment----------createpaymentcommandphp----------createpaymenthandlerphp----------createpaymentvalidatorphp-------processrefund----query--------getpaymentdetails-----------getpaymentdetailsqueryphp-----------getpaymentdetailshandlerphp-----------paymentdetailsviewphp--------listcustomerpayments-domain----paymentphp-write-model----paymentdetailsphp-read-model-infrastructure-----paymentrepositoryphp-write-----paymentqueryrepositoryphp-read-exemple-concret--gestion-des-abonnements-commande--crÃ©er-un-abonnementphpclass-createsubscriptioncommand----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-planid-planid--------public-readonly-customerid-customerid--------public-readonly-billingcycle-billingcycle-----class-createsubscriptionhandler----public-function-__invokecreatesubscriptioncommand-command-void-------------validation-mÃ©tier--------this-validatesubscriptioncreationcommand-----------------crÃ©ation-de-lagrÃ©gat--------subscription--subscriptioncreate------------command-subscriptionid------------command-planid------------command-customerid------------command-billingcycle-------------------------persistance--------this-subscriptionrepository-savesubscription-----------------Ã©vÃ©nement--------this-eventbus-dispatchnew-subscriptioncreatedsubscription-----requÃªte--obtenir-les-dÃ©tails-dphpclass-getsubscriptiondetailsquery----public-function-__construct--------public-readonly-subscriptionid-subscriptionid-----class-getsubscriptiondetailshandler----public-function-__invokegetsubscriptiondetailsquery-query-subscriptiondetailsview------------return-this-subscriptionqueryrepository-finddetailsquery-subscriptionid----class-subscriptiondetailsview----public-function-__construct--------public-readonly-subscriptionid-id--------public-readonly-string-planname--------public-readonly-string-customername--------public-readonly-string-status--------public-readonly-datetime-startdate--------public-readonly-datetime-enddate--------public-readonly-amount-monthlyprice--------public-readonly-array-features-------patterns-avancÃ©s-avec-cqrs-1-event-sourcing--cqrs--les-commandes-gÃ©nÃ¨rent-des-Ã©vÃ©nements--les-requÃªtes-lisent-depuis-les-projections-2-cqrs-avec-projections--projections-dÃ©normalisÃ©es-pour-les-requÃªtes--mise-Ã -jour-asynchrone-des-vues-3-cqrs-avec-api-platform--ressources-sÃ©parÃ©es-pour-command-et-query--validation-automatique-des-dtos--performance-et-optimisation-optimisations-cÃ´tÃ©-lecture--indexation--index-optimisÃ©s-pour-les-requÃªtes-frÃ©quentes--cache--mise-en-cache-des-vues-frÃ©quemment-consultÃ©es--dÃ©normalisation--donnÃ©es-prÃ©-calculÃ©es-pour-Ã©viter-les-jointures-optimisations-cÃ´tÃ©-Ã©criture--validation--validation-mÃ©tier-centralisÃ©e--transactions--gestion-des-transactions-optimisÃ©e--Ã©vÃ©nements--publication-asynchrone-des-Ã©vÃ©nements--quand-utiliser-cqrs---cas-d--complexitÃ©-mÃ©tier-Ã©levÃ©e--beaucoup-de-rÃ¨gles-mÃ©tier--besoins-de-lectureÃ©criture-diffÃ©rents--requÃªtes-complexes-vs-Ã©critures-simples--performance-critique--besoins-de-performance-diffÃ©rents--Ã©quipes-sÃ©parÃ©es--Ã©quipes-diffÃ©rentes-pour-readwrite--cas-d--applications-simples--crud-basique--cohÃ©rence-forte-requise--besoin-de-cohÃ©rence-immÃ©diate--Ã©quipe-unique--une-seule-Ã©quipe-pour-tout--prototypage--dÃ©veloppement-rapide--migration-vers-cqrs-Ã©tape-1--identifier-les-commandes--lister-toutes-les-opÃ©rations-qui-modifient-lÃ©tat--grouper-par-contexte-mÃ©tier-Ã©tape-2--identifier-les-requÃªtes--lister-toutes-les-opÃ©rations-de-lecture--analyser-les-patterns-daccÃ¨s-Ã©tape-3--sÃ©parer-les-modÃ¨les--crÃ©er-des-modÃ¨les-distincts--migrer-progressivement-Ã©tape-4--optimiser--optimiser-chaque-cÃ´tÃ©-indÃ©pendamment--mesurer-les-performances--mÃ©triques-et-monitoring-mÃ©triques-cÃ´tÃ©-commande--nombre-de-commandes-par-seconde--temps-de-traitement-moyen--taux-derreur-mÃ©triques-cÃ´tÃ©-requÃªte--temps-de-rÃ©ponse-des-requÃªtes--utilisation-du-cache--charge-des-projections--prochaines-Ã©tapesmaintenant-que-vous-comprenez-cqrs-explorez-1-event-sourcing--stocker-les-Ã©vÃ©nements-comme-source-de-vÃ©ritÃ©2-repositories--patterns-de-persistance3-implÃ©mentation-cqrs--guide-dimplÃ©mentation-completcqrs-n>ğŸŒŸ **Qu&rsquo;est-ce que CQRS ?**<strong>CQRS</strong> (Command Query Responsibility Segregation) est un pattern architectural qui sÃ©pare clairement les opÃ©rations de <strong>lecture</strong> (Query) des opÃ©rations d&rsquo;<strong>Ã©criture</strong> (Command) dans une application.### <strong>Le Principe Fondamental</strong>> <strong>&ldquo;Une mÃ©thode ne devrait jamais retourner de valeur et modifier l&rsquo;Ã©tat de l&rsquo;objet&rdquo;</strong> - Bertrand MeyerCQRS pousse ce principe Ã  l&rsquo;extrÃªme en crÃ©ant deux modÃ¨les distincts :- <strong>ModÃ¨le de Commande</strong> : Pour les opÃ©rations qui modifient l&rsquo;Ã©tat- <strong>ModÃ¨le de RequÃªte</strong> : Pour les opÃ©rations qui lisent les donnÃ©es## ğŸ—ï¸ <strong>Architecture CQRS dans Gyroscops</strong>### <strong>Contexte MÃ©tier : Gestion des Paiements</strong>Dans Gyroscops, nous gÃ©rons des paiements avec des besoins trÃ¨s diffÃ©rents :#### <strong>CÃ´tÃ© Commande (Write)</strong><code>php// Commande : CrÃ©er un paiementclass CreatePaymentCommand{ public function __construct( public readonly PaymentId $paymentId, public readonly Amount $amount, public readonly PaymentMethod $method, public readonly CustomerId $customerId ) {}}// Handler : Traiter la commandeclass CreatePaymentHandler{ public function __invoke(CreatePaymentCommand $command): void { $payment = Payment::create( $command->paymentId, $command->amount, $command->method, $command->customerId ); $this->paymentRepository->save($payment); $this->eventBus->dispatch(new PaymentCreated($payment)); }}</code>#### <strong>CÃ´tÃ© RequÃªte (Read)</strong><code>php// RequÃªte : Obtenir les paiements d'un clientclass GetCustomerPaymentsQuery{ public function __construct( public readonly CustomerId $customerId, public readonly ?DateRange $dateRange = null ) {}}// Handler : ExÃ©cuter la requÃªteclass GetCustomerPaymentsHandler{ public function __invoke(GetCustomerPaymentsQuery $query): array { return $this->paymentQueryRepository->findByCustomer( $query->customerId, $query->dateRange ); }}</code>## ğŸ¯ <strong>Avantages de CQRS</strong>### <strong>1. SÃ©paration des ResponsabilitÃ©s</strong>- <strong>Commandes</strong> : Focus sur la logique mÃ©tier et la validation- <strong>RequÃªtes</strong> : Focus sur l&rsquo;optimisation des performances de lecture### <strong>2. Optimisation IndÃ©pendante</strong>- <strong>Write Model</strong> : OptimisÃ© pour la cohÃ©rence et les invariants mÃ©tier- <strong>Read Model</strong> : OptimisÃ© pour les performances et la flexibilitÃ©### <strong>3. ScalabilitÃ©</strong>- PossibilitÃ© de scaler sÃ©parÃ©ment les lectures et les Ã©critures- Utilisation de technologies diffÃ©rentes pour chaque cÃ´tÃ©### <strong>4. Ã‰volutivitÃ©</strong>- Modification des requÃªtes sans impact sur les commandes- Ajout de nouvelles vues sans affecter la logique mÃ©tier## ğŸ”§ <strong>ImplÃ©mentation dans Gyroscops</strong>### <strong>Structure des Dossiers</strong><code>src/Accounting/â”œâ”€â”€ Application/â”‚ â”œâ”€â”€ Command/â”‚ â”‚ â”œâ”€â”€ CreatePayment/â”‚ â”‚ â”‚ â”œâ”€â”€ CreatePaymentCommand.phpâ”‚ â”‚ â”‚ â”œâ”€â”€ CreatePaymentHandler.phpâ”‚ â”‚ â”‚ â””â”€â”€ CreatePaymentValidator.phpâ”‚ â”‚ â””â”€â”€ ProcessRefund/â”‚ â””â”€â”€ Query/â”‚ â”œâ”€â”€ GetPaymentDetails/â”‚ â”‚ â”œâ”€â”€ GetPaymentDetailsQuery.phpâ”‚ â”‚ â”œâ”€â”€ GetPaymentDetailsHandler.phpâ”‚ â”‚ â””â”€â”€ PaymentDetailsView.phpâ”‚ â””â”€â”€ ListCustomerPayments/â”œâ”€â”€ Domain/â”‚ â”œâ”€â”€ Payment.php (Write Model)â”‚ â””â”€â”€ PaymentDetails.php (Read Model)â””â”€â”€ Infrastructure/ â”œâ”€â”€ PaymentRepository.php (Write) â””â”€â”€ PaymentQueryRepository.php (Read)</code>### <strong>Exemple Concret : Gestion des Abonnements</strong>#### <strong>Commande : CrÃ©er un Abonnement</strong><code>phpclass CreateSubscriptionCommand{ public function __construct( public readonly SubscriptionId $subscriptionId, public readonly PlanId $planId, public readonly CustomerId $customerId, public readonly BillingCycle $billingCycle ) {}}class CreateSubscriptionHandler{ public function __invoke(CreateSubscriptionCommand $command): void { // Validation mÃ©tier $this->validateSubscriptionCreation($command); // CrÃ©ation de l'agrÃ©gat $subscription = Subscription::create( $command->subscriptionId, $command->planId, $command->customerId, $command->billingCycle ); // Persistance $this->subscriptionRepository->save($subscription); // Ã‰vÃ©nement $this->eventBus->dispatch(new SubscriptionCreated($subscription)); }}</code>#### <strong>RequÃªte : Obtenir les DÃ©tails d&rsquo;un Abonnement</strong><code>phpclass GetSubscriptionDetailsQuery{ public function __construct( public readonly SubscriptionId $subscriptionId ) {}}class GetSubscriptionDetailsHandler{ public function __invoke(GetSubscriptionDetailsQuery $query): SubscriptionDetailsView { return $this->subscriptionQueryRepository->findDetails($query->subscriptionId); }}class SubscriptionDetailsView{ public function __construct( public readonly SubscriptionId $id, public readonly string $planName, public readonly string $customerName, public readonly string $status, public readonly DateTime $startDate, public readonly ?DateTime $endDate, public readonly Amount $monthlyPrice, public readonly array $features ) {}}</code>## ğŸš€ <strong>Patterns AvancÃ©s avec CQRS</strong>### <strong>1. Event Sourcing + CQRS</strong>- Les commandes gÃ©nÃ¨rent des Ã©vÃ©nements- Les requÃªtes lisent depuis les projections### <strong>2. CQRS avec Projections</strong>- Projections dÃ©normalisÃ©es pour les requÃªtes- Mise Ã  jour asynchrone des vues### <strong>3. CQRS avec API Platform</strong>- Ressources sÃ©parÃ©es pour Command et Query- Validation automatique des DTOs## âš¡ <strong>Performance et Optimisation</strong>### <strong>Optimisations CÃ´tÃ© Lecture</strong>- <strong>Indexation</strong> : Index optimisÃ©s pour les requÃªtes frÃ©quentes- <strong>Cache</strong> : Mise en cache des vues frÃ©quemment consultÃ©es- <strong>DÃ©normalisation</strong> : DonnÃ©es prÃ©-calculÃ©es pour Ã©viter les jointures### <strong>Optimisations CÃ´tÃ© Ã‰criture</strong>- <strong>Validation</strong> : Validation mÃ©tier centralisÃ©e- <strong>Transactions</strong> : Gestion des transactions optimisÃ©e- <strong>Ã‰vÃ©nements</strong> : Publication asynchrone des Ã©vÃ©nements## ğŸ¯ <strong>Quand Utiliser CQRS ?</strong>### <strong>âœ… Cas d&rsquo;Usage AppropriÃ©s</strong>- <strong>ComplexitÃ© mÃ©tier Ã©levÃ©e</strong> : Beaucoup de rÃ¨gles mÃ©tier- <strong>Besoins de lecture/Ã©criture diffÃ©rents</strong> : RequÃªtes complexes vs Ã©critures simples- <strong>Performance critique</strong> : Besoins de performance diffÃ©rents- <strong>Ã‰quipes sÃ©parÃ©es</strong> : Ã‰quipes diffÃ©rentes pour read/write### <strong>âŒ Cas d&rsquo;Usage InappropriÃ©s</strong>- <strong>Applications simples</strong> : CRUD basique- <strong>CohÃ©rence forte requise</strong> : Besoin de cohÃ©rence immÃ©diate- <strong>Ã‰quipe unique</strong> : Une seule Ã©quipe pour tout- <strong>Prototypage</strong> : DÃ©veloppement rapide## ğŸ”„ <strong>Migration vers CQRS</strong>### <strong>Ã‰tape 1 : Identifier les Commandes</strong>- Lister toutes les opÃ©rations qui modifient l&rsquo;Ã©tat- Grouper par contexte mÃ©tier### <strong>Ã‰tape 2 : Identifier les RequÃªtes</strong>- Lister toutes les opÃ©rations de lecture- Analyser les patterns d&rsquo;accÃ¨s### <strong>Ã‰tape 3 : SÃ©parer les ModÃ¨les</strong>- CrÃ©er des modÃ¨les distincts- Migrer progressivement### <strong>Ã‰tape 4 : Optimiser</strong>- Optimiser chaque cÃ´tÃ© indÃ©pendamment- Mesurer les performances## ğŸ“Š <strong>MÃ©triques et Monitoring</strong>### <strong>MÃ©triques CÃ´tÃ© Commande</strong>- Nombre de commandes par seconde- Temps de traitement moyen- Taux d&rsquo;erreur### <strong>MÃ©triques CÃ´tÃ© RequÃªte</strong>- Temps de rÃ©ponse des requÃªtes- Utilisation du cache- Charge des projections## ğŸ¯ <strong>Prochaines Ã‰tapes</strong>Maintenant que vous comprenez CQRS, explorez :1. <strong><a href=/concept/event-sourcing/>Event Sourcing</a></strong> : Stocker les Ã©vÃ©nements comme source de vÃ©ritÃ©2. <strong><a href=/concept/repositories/>Repositories</a></strong> : Patterns de persistance3. <strong><a href=/chapitres/optionnels/chapitre-13-architecture-cqrs/>ImplÃ©mentation CQRS</a></strong> : Guide d&rsquo;implÃ©mentation complet&mdash;<em>CQRS n&rsquo;est pas une solution universelle, mais un outil puissant pour les applications complexes. Dans Gyroscops, il nous a permis de gÃ©rer efficacement la complexitÃ© mÃ©tier tout en optimisant les performances.</em> <a href=#-quest-ce-que-cqrs-cqrs-command-query-responsibility-segregation-est-un-pattern-architectural-qui-s%c3%a9pare-clairement-les-op%c3%a9rations-de-lecture-query-des-op%c3%a9rations-d%c3%a9criture-command-dans-une-application-le-principe-fondamental----bertrand-meyercqrs-pousse-ce-principe-%c3%a0-lextr%c3%aame-en-cr%c3%a9ant-deux-mod%c3%a8les-distincts---mod%c3%a8le-de-commande--pour-les-op%c3%a9rations-qui-modifient-l%c3%a9tat--mod%c3%a8le-de-requ%c3%aate--pour-les-op%c3%a9rations-qui-lisent-les-donn%c3%a9es--architecture-cqrs-dans-gyroscops-contexte-m%c3%a9tier--gestion-des-paiementsdans-gyroscops-nous-g%c3%a9rons-des-paiements-avec-des-besoins-tr%c3%a8s-diff%c3%a9rents--c%c3%b4t%c3%a9-commande-writephp-commande--cr%c3%a9er-un-paiementclass-createpaymentcommand----public-function-__construct--------public-readonly-paymentid-paymentid--------public-readonly-amount-amount--------public-readonly-paymentmethod-method--------public-readonly-customerid-customerid------handler--traiter-la-commandeclass-createpaymenthandler----public-function-__invokecreatepaymentcommand-command-void------------payment--paymentcreate------------command-paymentid------------command-amount------------command-method------------command-customerid------------------------this-paymentrepository-savepayment--------this-eventbus-dispatchnew-paymentcreatedpayment-----c%c3%b4t%c3%a9-requ%c3%aate-readphp-requ%c3%aate--obtenir-les-paiements-dun-clientclass-getcustomerpaymentsquery----public-function-__construct--------public-readonly-customerid-customerid--------public-readonly-daterange-daterange--null------handler--ex%c3%a9cuter-la-requ%c3%aateclass-getcustomerpaymentshandler----public-function-__invokegetcustomerpaymentsquery-query-array------------return-this-paymentqueryrepository-findbycustomer------------query-customerid------------query-daterange--------------avantages-de-cqrs-1-s%c3%a9paration-des-responsabilit%c3%a9s--commandes--focus-sur-la-logique-m%c3%a9tier-et-la-validation--requ%c3%aates--focus-sur-loptimisation-des-performances-de-lecture-2-optimisation-ind%c3%a9pendante--write-model--optimis%c3%a9-pour-la-coh%c3%a9rence-et-les-invariants-m%c3%a9tier--read-model--optimis%c3%a9-pour-les-performances-et-la-flexibilit%c3%a9-3-scalabilit%c3%a9--possibilit%c3%a9-de-scaler-s%c3%a9par%c3%a9ment-les-lectures-et-les-%c3%a9critures--utilisation-de-technologies-diff%c3%a9rentes-pour-chaque-c%c3%b4t%c3%a9-4-%c3%a9volutivit%c3%a9--modification-des-requ%c3%aates-sans-impact-sur-les-commandes--ajout-de-nouvelles-vues-sans-affecter-la-logique-m%c3%a9tier--impl%c3%a9mentation-dans-gyroscops-structure-des-dossierssrcaccounting-application----command-------createpayment----------createpaymentcommandphp----------createpaymenthandlerphp----------createpaymentvalidatorphp-------processrefund----query--------getpaymentdetails-----------getpaymentdetailsqueryphp-----------getpaymentdetailshandlerphp-----------paymentdetailsviewphp--------listcustomerpayments-domain----paymentphp-write-model----paymentdetailsphp-read-model-infrastructure-----paymentrepositoryphp-write-----paymentqueryrepositoryphp-read-exemple-concret--gestion-des-abonnements-commande--cr%c3%a9er-un-abonnementphpclass-createsubscriptioncommand----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-planid-planid--------public-readonly-customerid-customerid--------public-readonly-billingcycle-billingcycle-----class-createsubscriptionhandler----public-function-__invokecreatesubscriptioncommand-command-void-------------validation-m%c3%a9tier--------this-validatesubscriptioncreationcommand-----------------cr%c3%a9ation-de-lagr%c3%a9gat--------subscription--subscriptioncreate------------command-subscriptionid------------command-planid------------command-customerid------------command-billingcycle-------------------------persistance--------this-subscriptionrepository-savesubscription-----------------%c3%a9v%c3%a9nement--------this-eventbus-dispatchnew-subscriptioncreatedsubscription-----requ%c3%aate--obtenir-les-d%c3%a9tails-dphpclass-getsubscriptiondetailsquery----public-function-__construct--------public-readonly-subscriptionid-subscriptionid-----class-getsubscriptiondetailshandler----public-function-__invokegetsubscriptiondetailsquery-query-subscriptiondetailsview------------return-this-subscriptionqueryrepository-finddetailsquery-subscriptionid----class-subscriptiondetailsview----public-function-__construct--------public-readonly-subscriptionid-id--------public-readonly-string-planname--------public-readonly-string-customername--------public-readonly-string-status--------public-readonly-datetime-startdate--------public-readonly-datetime-enddate--------public-readonly-amount-monthlyprice--------public-readonly-array-features-------patterns-avanc%c3%a9s-avec-cqrs-1-event-sourcing--cqrs--les-commandes-g%c3%a9n%c3%a8rent-des-%c3%a9v%c3%a9nements--les-requ%c3%aates-lisent-depuis-les-projections-2-cqrs-avec-projections--projections-d%c3%a9normalis%c3%a9es-pour-les-requ%c3%aates--mise-%c3%a0-jour-asynchrone-des-vues-3-cqrs-avec-api-platform--ressources-s%c3%a9par%c3%a9es-pour-command-et-query--validation-automatique-des-dtos--performance-et-optimisation-optimisations-c%c3%b4t%c3%a9-lecture--indexation--index-optimis%c3%a9s-pour-les-requ%c3%aates-fr%c3%a9quentes--cache--mise-en-cache-des-vues-fr%c3%a9quemment-consult%c3%a9es--d%c3%a9normalisation--donn%c3%a9es-pr%c3%a9-calcul%c3%a9es-pour-%c3%a9viter-les-jointures-optimisations-c%c3%b4t%c3%a9-%c3%a9criture--validation--validation-m%c3%a9tier-centralis%c3%a9e--transactions--gestion-des-transactions-optimis%c3%a9e--%c3%a9v%c3%a9nements--publication-asynchrone-des-%c3%a9v%c3%a9nements--quand-utiliser-cqrs---cas-d--complexit%c3%a9-m%c3%a9tier-%c3%a9lev%c3%a9e--beaucoup-de-r%c3%a8gles-m%c3%a9tier--besoins-de-lecture%c3%a9criture-diff%c3%a9rents--requ%c3%aates-complexes-vs-%c3%a9critures-simples--performance-critique--besoins-de-performance-diff%c3%a9rents--%c3%a9quipes-s%c3%a9par%c3%a9es--%c3%a9quipes-diff%c3%a9rentes-pour-readwrite--cas-d--applications-simples--crud-basique--coh%c3%a9rence-forte-requise--besoin-de-coh%c3%a9rence-imm%c3%a9diate--%c3%a9quipe-unique--une-seule-%c3%a9quipe-pour-tout--prototypage--d%c3%a9veloppement-rapide--migration-vers-cqrs-%c3%a9tape-1--identifier-les-commandes--lister-toutes-les-op%c3%a9rations-qui-modifient-l%c3%a9tat--grouper-par-contexte-m%c3%a9tier-%c3%a9tape-2--identifier-les-requ%c3%aates--lister-toutes-les-op%c3%a9rations-de-lecture--analyser-les-patterns-dacc%c3%a8s-%c3%a9tape-3--s%c3%a9parer-les-mod%c3%a8les--cr%c3%a9er-des-mod%c3%a8les-distincts--migrer-progressivement-%c3%a9tape-4--optimiser--optimiser-chaque-c%c3%b4t%c3%a9-ind%c3%a9pendamment--mesurer-les-performances--m%c3%a9triques-et-monitoring-m%c3%a9triques-c%c3%b4t%c3%a9-commande--nombre-de-commandes-par-seconde--temps-de-traitement-moyen--taux-derreur-m%c3%a9triques-c%c3%b4t%c3%a9-requ%c3%aate--temps-de-r%c3%a9ponse-des-requ%c3%aates--utilisation-du-cache--charge-des-projections--prochaines-%c3%a9tapesmaintenant-que-vous-comprenez-cqrs-explorez-1-event-sourcing--stocker-les-%c3%a9v%c3%a9nements-comme-source-de-v%c3%a9rit%c3%a92-repositories--patterns-de-persistance3-impl%c3%a9mentation-cqrs--guide-dimpl%c3%a9mentation-completcqrs-n class=anchor aria-hidden=true><i class="material-icons align-middle">link</i></a></h2></div></div><div><hr class=doc-hr><div id=doc-nav class=d-print-none><div class="row flex-xl-nowrap"><div class="col-sm-6 pt-2 doc-prev"><a class=ms-auto href=/patterns/event-sourcing/><div class="card h-100 my-1 text-end"><div class="card-body py-2"><p class="card-title fs-5 fw-semibold lh-base mb-0">Event Sourcing - Stocker les Ã‰vÃ©nements comme Source de VÃ©ritÃ© <i class="material-icons align-middle">navigate_next</i></p></div></div></a></div></div></div></div></div></div></div></div><footer class="shadow py-3 d-print-none"><div class=container-fluid><div class="row align-items-center"><div class=col><div class="text-sm-start text-center mx-md-2"><p class=mb-0>Â© 2025 GrÃ©gory Planchat. Tous droits rÃ©servÃ©s.</p></div></div></div><div class="row mt-3 pt-3 border-top"><div class=col-12><div class=text-center><h6 class="text-muted mb-2">Nos Sponsors</h6><p class="text-muted small mb-2">Merci Ã  nos partenaires qui soutiennent cette initiative</p><div class="d-flex justify-content-center align-items-center flex-wrap gap-3"><div class=sponsor-item><a href=https://kiboko.fr target=_blank rel="noopener noreferrer" class="text-decoration-none d-inline-block"><img src=/logo-kiboko-fr.svg alt=Kiboko width=120 height=60 style=display:block;max-width:120px;height:auto></a></div><div class=sponsor-item><a href=https://gyroscops.com target=_blank rel="noopener noreferrer" class="text-decoration-none d-inline-block"><img src=/logo-gyroscops.svg alt=Gyroscops width=120 height=60 style=display:block;max-width:120px;height:auto></a></div></div></div></div></div></div></footer></main></div></div><button onclick=topFunction() id=back-to-top aria-label="Back to Top Button" class="back-to-top fs-5"><svg width="24" height="24"><path d="M12 10.224l-6.3 6.3-1.38-1.372L12 7.472l7.68 7.68-1.38 1.376z" style="fill:#fff"/></svg></button>
<script src=/docs/js/bootstrap.c7927bdd82eceb076739257add3f4b0e11379da037c07d5c7110daeb6de0e3edcb2de867604550f88815157e4ec4ddb7.js integrity=sha384-x5J73YLs6wdnOSV63T9LDhE3naA3wH1ccRDa623g4+3LLehnYEVQ+IgVFX5OxN23 defer></script><script type=text/javascript src=https://votre-domaine.fr/docs/js/bundle.min.a046e72674401a45bf99217648934a99ff03a7c46d105e47916156e66969388a0643f55a1e850acb495c9bd8be985171.js integrity=sha384-oEbnJnRAGkW/mSF2SJNKmf8Dp8RtEF5HkWFW5mlpOIoGQ/VaHoUKy0lcm9i+mFFx crossorigin=anonymous defer></script><script type=module>
    var suggestions = document.getElementById('suggestions');
    var search = document.getElementById('flexsearch');

    const flexsearchContainer = document.getElementById('FlexSearchCollapse');

    const hideFlexsearchBtn = document.getElementById('hideFlexsearch');

    const configObject = { toggle: false }
    const flexsearchContainerCollapse = new Collapse(flexsearchContainer, configObject) 

    if (search !== null) {
        document.addEventListener('keydown', inputFocus);
        flexsearchContainer.addEventListener('shown.bs.collapse', function () {
            search.focus();
        });
        
        var topHeader = document.getElementById("top-header");
        document.addEventListener('click', function(elem) {
            if (!flexsearchContainer.contains(elem.target) && !topHeader.contains(elem.target))
                flexsearchContainerCollapse.hide();
        });
    }

    hideFlexsearchBtn.addEventListener('click', () =>{
        flexsearchContainerCollapse.hide()
    })

    function inputFocus(e) {
        if (e.ctrlKey && e.key === '/') {
            e.preventDefault();
            flexsearchContainerCollapse.toggle();
        }
        if (e.key === 'Escape' ) {
            search.blur();
            
            flexsearchContainerCollapse.hide();
        }
    };

    document.addEventListener('click', function(event) {

    var isClickInsideElement = suggestions.contains(event.target);

    if (!isClickInsideElement) {
        suggestions.classList.add('d-none');
    }

    });

    


    document.addEventListener('keydown',suggestionFocus);

    function suggestionFocus(e) {
    const suggestionsHidden = suggestions.classList.contains('d-none');
    if (suggestionsHidden) return;

    const focusableSuggestions= [...suggestions.querySelectorAll('a')];
    if (focusableSuggestions.length === 0) return;

    const index = focusableSuggestions.indexOf(document.activeElement);

    if (e.key === "ArrowUp") {
        e.preventDefault();
        const nextIndex = index > 0 ? index - 1 : 0;
        focusableSuggestions[nextIndex].focus();
    }
    else if (e.key === "ArrowDown") {
        e.preventDefault();
        const nextIndex= index + 1 < focusableSuggestions.length ? index + 1 : index;
        focusableSuggestions[nextIndex].focus();
    }

    }

    


    (function(){

    var index = new FlexSearch.Document({
        
        tokenize: "forward",
        minlength:  0 ,
        cache:  100 ,
        optimize:  true ,
        document: {
        id: 'id',
        store: [
            "href", "title", "description"
        ],
        index: ["title", "description", "content"]
        }
    });


    


    
    


    

    

    search.addEventListener('input', show_results, true);

    function show_results(){
        const maxResult =  5 ;
        const minlength =  0 ;
        var searchQuery = sanitizeHTML(this.value);
        var results = index.search(searchQuery, {limit: maxResult, enrich: true});

        
        const flatResults = new Map(); 
        for (const result of results.flatMap(r => r.result)) {
        if (flatResults.has(result.doc.href)) continue;
        flatResults.set(result.doc.href, result.doc);
        }

        suggestions.innerHTML = "";
        suggestions.classList.remove('d-none');

        
        if (searchQuery.length < minlength) {
            const minCharMessage = document.createElement('div')
            minCharMessage.innerHTML = `Please type at least <strong>${minlength}</strong> characters`
            minCharMessage.classList.add("suggestion__no-results");
            suggestions.appendChild(minCharMessage);
            return;
        } else {
            
            if (flatResults.size === 0 && searchQuery) {
                const noResultsMessage = document.createElement('div')
                noResultsMessage.innerHTML = "No results for" + ` "<strong>${searchQuery}</strong>"`
                noResultsMessage.classList.add("suggestion__no-results");
                suggestions.appendChild(noResultsMessage);
                return;
            }
        }

        
        for(const [href, doc] of flatResults) {
            const entry = document.createElement('div');
            suggestions.appendChild(entry);

            const a = document.createElement('a');
            a.href = href;
            entry.appendChild(a);

            const title = document.createElement('span');
            title.textContent = doc.title;
            title.classList.add("suggestion__title");
            a.appendChild(title);

            const description = document.createElement('span');
            description.textContent = doc.description;
            description.classList.add("suggestion__description");
            a.appendChild(description);

            suggestions.appendChild(entry);

            if(suggestions.childElementCount == maxResult) break;
        }
    }
    }());
</script></body></html>