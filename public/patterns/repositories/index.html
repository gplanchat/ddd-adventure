<!doctype html><html lang=fr-fr><head><meta charset=utf-8><title>Repositories - Patterns de Persistance | DDD Adventure</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Découvrez les patterns Repository, la couche d'abstraction qui sépare la logique métier de la persistance"><meta name=keywords content="Documentation,Hugo,Hugo Theme,Bootstrap"><meta name=author content="Colin Wilson - Lotus Labs"><meta name=email content="support@aigis.uk"><meta name=website content="https://lotusdocs.dev"><meta name=Version content="v0.1.0"><link rel=icon href=https://votre-domaine.fr/favicon.ico sizes=any><link rel=icon type=image/svg+xml href=https://votre-domaine.fr/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=https://votre-domaine.fr/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://votre-domaine.fr/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://votre-domaine.fr/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://votre-domaine.fr/site.webmanifest><meta property="og:title" content="Repositories - Patterns de Persistance"><meta property="og:description" content="Découvrez les patterns Repository, la couche d'abstraction qui sépare la logique métier de la persistance"><meta property="og:type" content="article"><meta property="og:url" content="https://votre-domaine.fr/patterns/repositories/"><meta property="og:image" content="https://votre-domaine.fr/opengraph/card-base-2_hu_5e45361855535645.png"><meta property="article:section" content="patterns"><meta property="article:published_time" content="2024-12-19T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-19T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://votre-domaine.fr/opengraph/card-base-2_hu_5e45361855535645.png"><meta name=twitter:title content="Repositories - Patterns de Persistance"><meta name=twitter:description content="Découvrez les patterns Repository, la couche d'abstraction qui sépare la logique métier de la persistance"><link rel=alternate type=application/atom+xml title="Atom feed for DDD Adventure" href=/index.xml><script type=text/javascript src=https://votre-domaine.fr/docs/js/flexsearch.bundle.min.f5159d5a2151ffbb653996ec17eaff7da4e04c286bd879fc41839d36a5586f3f20eaead0b6089de48f9adc669cdee771.js integrity=sha384-9RWdWiFR/7tlOZbsF+r/faTgTChr2Hn8QYOdNqVYbz8g6urQtgid5I+a3Gac3udx crossorigin=anonymous></script><link rel=stylesheet href=/docs/scss/style.min.9f198180aa929b3c2276b402b796e74ed231639ad7ea837d05515b5be35ef385e0980b2bc2499d09dad5d011b90710cf.css integrity=sha384-nxmBgKqSmzwidrQCt5bnTtIxY5rX6oN9BVFbW+Ne84XgmAsrwkmdCdrV0BG5BxDP crossorigin=anonymous></head><body><div class=content><div class="page-wrapper toggled"><nav id=sidebar class=sidebar-wrapper><div class=sidebar-brand><a href=/ aria-label=HomePage alt=HomePage><svg id="Layer_1" viewBox="0 0 250 250"><path d="m143 39.5c-18 0-18 18-18 18s0-18-18-18H22c-2.76.0-5 2.24-5 5v143c0 2.76 2.24 5 5 5h76c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h76c2.76.0 5-2.24 5-5V44.5c0-2.76-2.24-5-5-5h-85zM206 163c0 1.38-1.12 2.5-2.5 2.5H143c-18 0-18 18-18 18s0-18-18-18H46.5c-1.38.0-2.5-1.12-2.5-2.5V69c0-1.38 1.12-2.5 2.5-2.5H98c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h51.5c1.38.0 2.5 1.12 2.5 2.5v94z" style="fill:#06f"/></svg></a></div><div class=sidebar-content style="height:calc(100% - 131px)"><ul class=sidebar-menu><li><a class=sidebar-root-link href=https://votre-domaine.fr/patterns/cqrs/>CQRS - Command Query Responsibility Segregation</a></li><li><a class=sidebar-root-link href=https://votre-domaine.fr/patterns/event-sourcing/>Event Sourcing - Stocker les Événements comme Source de Vérité</a></li><li class=current><a class=sidebar-root-link href=https://votre-domaine.fr/patterns/repositories/>Repositories - Patterns de Persistance</a></li></ul></div><ul class="sidebar-footer list-unstyled mb-0"></ul></nav><main class="page-content bg-transparent"><div id=top-header class="top-header d-print-none"><div class="header-bar d-flex justify-content-between"><div class="d-flex align-items-center"><a href=/ class="logo-icon me-3" aria-label=HomePage alt=HomePage><div class=small><svg id="Layer_1" viewBox="0 0 250 250"><path d="m143 39.5c-18 0-18 18-18 18s0-18-18-18H22c-2.76.0-5 2.24-5 5v143c0 2.76 2.24 5 5 5h76c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h76c2.76.0 5-2.24 5-5V44.5c0-2.76-2.24-5-5-5h-85zM206 163c0 1.38-1.12 2.5-2.5 2.5H143c-18 0-18 18-18 18s0-18-18-18H46.5c-1.38.0-2.5-1.12-2.5-2.5V69c0-1.38 1.12-2.5 2.5-2.5H98c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h51.5c1.38.0 2.5 1.12 2.5 2.5v94z" style="fill:#06f"/></svg></div><div class=big><svg id="Layer_1" viewBox="0 0 250 250"><path d="m143 39.5c-18 0-18 18-18 18s0-18-18-18H22c-2.76.0-5 2.24-5 5v143c0 2.76 2.24 5 5 5h76c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h76c2.76.0 5-2.24 5-5V44.5c0-2.76-2.24-5-5-5h-85zM206 163c0 1.38-1.12 2.5-2.5 2.5H143c-18 0-18 18-18 18s0-18-18-18H46.5c-1.38.0-2.5-1.12-2.5-2.5V69c0-1.38 1.12-2.5 2.5-2.5H98c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h51.5c1.38.0 2.5 1.12 2.5 2.5v94z" style="fill:#06f"/></svg></div></a><button id=close-sidebar class="btn btn-icon btn-soft">
<span class="material-icons size-20 menu-icon align-middle">menu</span>
</button>
<button id=flexsearch-button class="ms-3 btn btn-soft" data-bs-toggle=collapse data-bs-target=#FlexSearchCollapse aria-expanded=false aria-controls=FlexSearchCollapse>
<span class="material-icons size-20 menu-icon align-middle">search</span>
<span class="flexsearch-button-placeholder ms-1 me-2 d-none d-sm-block">Search</span><div class="d-none d-sm-block"><span class=flexsearch-button-keys><kbd class=flexsearch-button-cmd-key><svg width="44" height="15"><path d="M2.118 11.5A1.519 1.519.0 011 11.042 1.583 1.583.0 011 8.815a1.519 1.519.0 011.113-.458h.715V6.643h-.71A1.519 1.519.0 011 6.185 1.519 1.519.0 01.547 5.071 1.519 1.519.0 011 3.958 1.519 1.519.0 012.118 3.5a1.519 1.519.0 011.114.458A1.519 1.519.0 013.69 5.071v.715H5.4V5.071A1.564 1.564.0 016.976 3.5 1.564 1.564.0 018.547 5.071 1.564 1.564.0 016.976 6.643H6.261V8.357h.715a1.575 1.575.0 011.113 2.685 1.583 1.583.0 01-2.227.0A1.519 1.519.0 015.4 9.929V9.214H3.69v.715a1.519 1.519.0 01-.458 1.113A1.519 1.519.0 012.118 11.5zm0-.857a.714.714.0 00.715-.714V9.214H2.118a.715.715.0 100 1.429zm4.858.0a.715.715.0 100-1.429H6.261v.715a.714.714.0 00.715.714zM3.69 8.357H5.4V6.643H3.69zM2.118 5.786h.715V5.071a.714.714.0 00-.715-.714.715.715.0 00-.5 1.22A.686.686.0 002.118 5.786zm4.143.0h.715a.715.715.0 00.5-1.22.715.715.0 00-1.22.5z" fill="currentColor"/><path d="M12.4 11.475H11.344l3.879-7.95h1.056z" fill="currentColor"/><path d="M25.073 5.384l-.864.576a2.121 2.121.0 00-1.786-.923 2.207 2.207.0 00-2.266 2.326 2.206 2.206.0 002.266 2.325 2.1 2.1.0 001.782-.918l.84.617a3.108 3.108.0 01-2.622 1.293 3.217 3.217.0 01-3.349-3.317 3.217 3.217.0 013.349-3.317A3.046 3.046.0 0125.073 5.384z" fill="currentColor"/><path d="M30.993 5.142h-2.07v5.419H27.891V5.142h-2.07V4.164h5.172z" fill="currentColor"/><path d="M34.67 4.164c1.471.0 2.266.658 2.266 1.851.0 1.087-.832 1.809-2.134 1.855l2.107 2.691h-1.28L33.591 7.87H33.07v2.691H32.038v-6.4zm-1.6.969v1.8h1.572c.832.0 1.22-.3 1.22-.918s-.411-.882-1.22-.882z" fill="currentColor"/><path d="M42.883 10.561H38.31v-6.4h1.033V9.583h3.54z" fill="currentColor"/></svg>
</kbd><kbd class=flexsearch-button-key><svg width="15" height="15"><path d="M5.926 12.279H4.41L9.073 2.721H10.59z" fill="currentColor"/></svg></kbd></span></div></button></div><div class="d-flex align-items-center"><ul class="list-unstyled mb-0"><li class="list-inline-item mb-0"><a href=https://twitter.com/gplanchat alt=twitter rel="noopener noreferrer" target=_blank><div class="btn btn-icon btn-default border-0"><svg width="24" height="24" viewBox="0 0 24 24"><title>Twitter / X</title><path d="M.088.768l9.266 12.39L.029 23.231h2.1l8.163-8.819 6.6 8.819h7.142L14.242 10.145 22.921.768h-2.1L13.3 8.891 7.229.768zM3.174 2.314H6.455L20.942 21.685h-3.28z" fill="currentColor"/></svg></div></a></li></ul></div></div><div class=collapse id=FlexSearchCollapse><div class=flexsearch-container><div class=flexsearch-keymap><li><kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Arrow down" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 3.5v8m3-3-3 3-3-3"/></g></svg></kbd>
<kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Arrow up" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 11.5v-8m3 3-3-3-3 3"/></g></svg></kbd>
<span class=flexsearch-key-label>to navigate</span></li><li><kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Enter key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M12 3.53088v3c0 1-1 2-2 2H4m3 3-3-3 3-3"/></g></svg></kbd>
<span class=flexsearch-key-label>to select</span></li><li><kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Escape key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M13.6167 8.936c-.1065.3583-.6883.962-1.4875.962-.7993.0-1.653-.9165-1.653-2.1258v-.5678c0-1.2548.7896-2.1016 1.653-2.1016s1.3601.4778 1.4875 1.0724M9 6c-.1352-.4735-.7506-.9219-1.46-.8972-.7092.0246-1.344.57-1.344 1.2166s.4198.8812 1.3445.9805C8.465 7.3992 8.968 7.9337 9 8.5s-.454 1.398-1.4595 1.398C6.6593 9.898 6 9 5.963 8.4851m-1.4748.5368c-.2635.5941-.8099.876-1.5443.876s-1.7073-.6248-1.7073-2.204v-.4603c0-1.0416.721-2.131 1.7073-2.131.9864.0 1.6425 1.031 1.5443 2.2492h-2.956"/></g></svg></kbd>
<span class=flexsearch-key-label>to close</span></li></div><form class="flexsearch position-relative flex-grow-1 ms-2 me-2"><div class="d-flex flex-row"><input id=flexsearch class=form-control type=search placeholder=Search aria-label=Search autocomplete=off>
<button id=hideFlexsearch type=button class="ms-2 btn btn-soft">
cancel</button></div><div id=suggestions class="shadow rounded-1 d-none"></div></form></div></div></div><div class=container-fluid><div class=layout-spacing><div class="d-md-flex justify-content-between align-items-center"><nav aria-label=breadcrumb class="d-inline-block pb-2 mt-1 mt-sm-0"><ul id=breadcrumbs class="breadcrumb bg-transparent mb-0" itemscope itemtype=https://schema.org/BreadcrumbList><li class="breadcrumb-item text-capitalize active" aria-current=page itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=/patterns/><i class="material-icons size-20 align-text-bottom" itemprop=name>Home</i>
</a><meta itemprop=position content='1'></li><li class="breadcrumb-item text-capitalize active" itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><span itemprop=name>Repositories - Patterns de Persistance</span>
<meta itemprop=position content='2'></li></ul></nav></div><div class="row flex-xl-nowrap"><div class="docs-toc col-xl-3 d-xl-block"><toc><div class="fw-bold text-uppercase mb-2">On this page</div><nav id=TableOfContents><ul><li><a href=#-quest-ce-quun-repository-un-repository-est-un-pattern-qui-encapsule-la-logique-daccès-aux-données-fournissant-une-interface-orientée-objet-pour-accéder-à-la-couche-de-persistance-le-principe-fondamental----eric-evansle-repository---abstrait-la-persistance-des-données--encapsule-la-logique-daccès-aux-données--fournit-une-interface-métier-claire--cache-la-complexité-de-la-persistance--repositories-dans-gyroscops-contexte-métier--gestion-des-utilisateursdans-gyroscops-nous-gérons-des-utilisateurs-avec-différents-besoins-daccès--interface-repositoryphpinterface-userrepository----public-function-saveuser-user-void----public-function-findbyiduserid-id-user----public-function-findbyemailemail-email-user----public-function-findbyorganizationorganizationid-organizationid-array----public-function-deleteuserid-id-void----public-function-existsuserid-id-bool-implémentation-doctrinephpclass-doctrineuserrepository-implements-userrepository----public-function-__construct--------private-entitymanagerinterface-entitymanager-------------public-function-saveuser-user-void------------this-entitymanager-persistuser--------this-entitymanager-flush------------public-function-findbyiduserid-id-user------------return-this-entitymanager-------------getrepositoryuserclass-------------findid-value------------public-function-findbyemailemail-email-user------------return-this-entitymanager-------------getrepositoryuserclass-------------findonebyemail--email-value------------public-function-findbyorganizationorganizationid-organizationid-array------------return-this-entitymanager-------------getrepositoryuserclass-------------findbyorganizationid--organizationid-value------------public-function-deleteuserid-id-void------------user--this-findbyidid--------if-user-------------this-entitymanager-removeuser------------this-entitymanager-flush--------------------public-function-existsuserid-id-bool------------return-this-entitymanager-------------getrepositoryuserclass-------------countid--id-value--0------types-de-repositories-1-repository-de-commande-writephpinterface-paymentcommandrepository----public-function-savepayment-payment-void----public-function-findbyidpaymentid-id-payment----public-function-deletepaymentid-id-voidclass-doctrinepaymentcommandrepository-implements-paymentcommandrepository----public-function-savepayment-payment-void------------this-entitymanager-persistpayment--------this-entitymanager-flush------------public-function-findbyidpaymentid-id-payment------------return-this-entitymanager-------------getrepositorypaymentclass-------------findid-value-----2-repository-de-requête-readphpinterface-paymentqueryrepository----public-function-findpaymentdetailspaymentid-id-paymentdetailsview----public-function-findpaymentsbycustomercustomerid-customerid-array----public-function-findpaymentsbydaterangedaterange-daterange-array----public-function-findpendingpayments-arrayclass-doctrinepaymentqueryrepository-implements-paymentqueryrepository----public-function-findpaymentdetailspaymentid-id-paymentdetailsview------------result--this-entitymanager-------------createquery----------------select-pid-pamount-pstatus-pcreatedat-----------------------cname-as-customername-sname-as-subscriptionname----------------from-payment-p----------------join-pcustomer-c----------------join-psubscription-s----------------where-pid--id-------------------------setparameterid-id-value-------------getoneornullresult--------------------return-result--paymentdetailsviewfromarrayresult--null------------public-function-findpaymentsbycustomercustomerid-customerid-array------------return-this-entitymanager-------------createquery----------------select-pid-pamount-pstatus-pcreatedat----------------from-payment-p----------------where-pcustomerid--customerid----------------order-by-pcreatedat-desc-------------------------setparametercustomerid-customerid-value-------------getresult-----3-repository-spécialiséphpinterface-paymentanalyticsrepository----public-function-getmonthlyrevenueint-year-int-month-amount----public-function-getpaymenttrendsdaterange-daterange-array----public-function-gettopcustomersint-limit-arrayclass-elasticsearchpaymentanalyticsrepository-implements-paymentanalyticsrepository----public-function-getmonthlyrevenueint-year-int-month-amount------------query--------------query------------------bool----------------------must--------------------------term--status--completed------------------------range--createdat------------------------------gte--year-month-01----------------------------lt--year---month--1---01------------------------------------------------------------------------------------aggs------------------total_revenue----------------------sum--field--amount----------------------------------------------------result--this-elasticsearch-searchquery--------return-new-amountresultaggregationstotal_revenuevalue------patterns-avancés-de-repository-1-repository-avec-spécificationsphpinterface-specification----public-function-issatisfiedbyentity-bool----public-function-toquerybuilderquerybuilder-qb-querybuilderclass-userbyorganizationspecification-implements-specification----public-function-__construct--------private-organizationid-organizationid-------------public-function-issatisfiedbyentity-bool------------return-entity-instanceof-user-----------------entity-organizationid-equalsthis-organizationid------------public-function-toquerybuilderquerybuilder-qb-querybuilder------------return-qb-andwhereuorganizationid--organizationid-------------------setparameterorganizationid-this-organizationid-value----interface-userrepository----public-function-findbyspecificationspecification-spec-array----public-function-countbyspecificationspecification-spec-intclass-doctrineuserrepository-implements-userrepository----public-function-findbyspecificationspecification-spec-array------------qb--this-entitymanager-createquerybuilder-------------selectu-------------fromuserclass-u--------------------return-spec-toquerybuilderqb-getquery-getresult-----2-repository-avec-cachephpclass-cacheduserrepository-implements-userrepository----public-function-__construct--------private-userrepository-decorated--------private-cacheinterface-cache-------------public-function-findbyiduserid-id-user------------cachekey--user_id-value----------------return-this-cache-getcachekey-function--use-id-------------return-this-decorated-findbyidid--------------------public-function-saveuser-user-void------------this-decorated-saveuser-----------------invalider-le-cache--------this-cache-deleteuser_user-id-value-----3-repository-avec-event-sourcingphpinterface-eventstore----public-function-appendstreamid-streamid-array-events-void----public-function-geteventsstreamid-streamid-arrayclass-eventsourceduserrepository-implements-userrepository----public-function-__construct--------private-eventstore-eventstore-------------public-function-saveuser-user-void------------events--user-getuncommittedevents--------streamid--streamidfromuseriduser-id----------------this-eventstore-appendstreamid-events--------user-markeventsascommitted------------public-function-findbyiduserid-id-user------------streamid--streamidfromuseridid--------events--this-eventstore-geteventsstreamid----------------if-emptyevents-------------return-null------------------------return-userfromeventsevents------repositories-multi-sources-repository-avec-fallbackphpclass-fallbackuserrepository-implements-userrepository----public-function-__construct--------private-userrepository-primary--------private-userrepository-fallback-------------public-function-findbyiduserid-id-user------------try-------------return-this-primary-findbyidid---------catch-exception-e-------------this-logger-warningprimary-repository-failed-using-fallback-----------------error--e-getmessage----------------userid--id-value------------------------------------return-this-fallback-findbyidid-------------repository-avec-routingphpclass-routeduserrepository-implements-userrepository----public-function-__construct--------private-userrepository-sqlrepository--------private-userrepository-mongorepository-------------public-function-findbyiduserid-id-user-------------route-basée-sur-lid--------if-this-shouldusemongoid-------------return-this-mongorepository-findbyidid------------------------return-this-sqlrepository-findbyidid------------private-function-shouldusemongouserid-id-bool-------------logique-de-routing-ex-utilisateurs-récents-en-mongodb--------return-id-value--1000000------performance-et-optimisation-optimisations-de-requêtephpclass-optimizeduserrepository-implements-userrepository----public-function-findbyorganizationorganizationid-organizationid-array-------------utiliser-des-requêtes-optimisées--------return-this-entitymanager-------------createquery----------------select-uid-uemail-ufirstname-ulastname----------------from-user-u----------------where-uorganizationid--organizationid----------------and-ustatus--status-------------------------setparameterorganizationid-organizationid-value-------------setparameterstatus-userstatusactive-------------setmaxresults100--limiter-les-résultats-------------getresult-----optimisations-de-cachephpclass-smartcacheduserrepository-implements-userrepository----public-function-findbyorganizationorganizationid-organizationid-array------------cachekey--users_org_organizationid-value----------------return-this-cache-getcachekey-function--use-organizationid-------------users--this-decorated-findbyorganizationorganizationid-------------------------cache-individuel-pour-chaque-utilisateur------------foreach-users-as-user-----------------this-cache-setuser_user-id-value-user-3600------------------------------------return-users---------1800--ttl-de-30-minutes------quand-utiliser-les-repositories---cas-d--abstraction-de-persistance--changer-de-technologie-de-stockage--tests-unitaires--mocker-facilement-laccès-aux-données--logique-métier-complexe--encapsuler-la-logique-daccès--performance--optimiser-les-requêtes--cas-d--applications-simples--crud-basique--over-engineering--complexité-inutile--performance-critique--overhead-des-abstractions--prototypage--développement-rapide--migration-vers-les-repositories-étape-1--identifier-les-accès-aux-données--lister-tous-les-accès-aux-données--grouper-par-entité-métier-étape-2--créer-les-interfaces--définir-les-contrats-repository--spécifier-les-méthodes-nécessaires-étape-3--implémenter-les-repositories--créer-les-implémentations--migrer-progressivement-étape-4--optimiser--ajouter-le-cache-si-nécessaire--optimiser-les-requêtes--métriques-et-monitoring-métriques-repository--temps-de-réponse-des-requêtes--taux-de-cache-hit--nombre-de-requêtes-par-seconde-métriques-de-performance--temps-de-traitement-des-requêtes-complexes--utilisation-mémoire--charge-des-bases-de-données--prochaines-étapesmaintenant-que-vous-comprenez-les-repositories-explorez-1-cqrs--séparer-les-commandes-des-requêtes2-event-sourcing--stocker-les-événements-comme-source-de-vérité3-implémentation-repositories--guide-dimplémentation-completles-repositories-sont-la-pierre-angulaire-d>🌟 **Qu’est-ce qu’un Repository ?**Un <strong>Repository</strong> est un pattern qui encapsule la logique d’accès aux données, fournissant une interface orientée objet pour accéder à la couche de persistance.### <strong>Le Principe Fondamental</strong>> <strong>“Un Repository représente une collection d’objets en mémoire”</strong> - Eric EvansLe Repository :- <strong>Abstrait</strong> la persistance des données- <strong>Encapsule</strong> la logique d’accès aux données- <strong>Fournit</strong> une interface métier claire- <strong>Cache</strong> la complexité de la persistance## 🏗️ <strong>Repositories dans Gyroscops</strong>### <strong>Contexte Métier : Gestion des Utilisateurs</strong>Dans Gyroscops, nous gérons des utilisateurs avec différents besoins d’accès :#### <strong>Interface Repository</strong><code>phpinterface UserRepository{ public function save(User $user): void; public function findById(UserId $id): ?User; public function findByEmail(Email $email): ?User; public function findByOrganization(OrganizationId $organizationId): array; public function delete(UserId $id): void; public function exists(UserId $id): bool;}</code>#### <strong>Implémentation Doctrine</strong><code>phpclass DoctrineUserRepository implements UserRepository{ public function __construct( private EntityManagerInterface $entityManager ) {} public function save(User $user): void { $this->entityManager->persist($user); $this->entityManager->flush(); } public function findById(UserId $id): ?User { return $this->entityManager ->getRepository(User::class) ->find($id->value()); } public function findByEmail(Email $email): ?User { return $this->entityManager ->getRepository(User::class) ->findOneBy(['email' => $email->value()]); } public function findByOrganization(OrganizationId $organizationId): array { return $this->entityManager ->getRepository(User::class) ->findBy(['organizationId' => $organizationId->value()]); } public function delete(UserId $id): void { $user = $this->findById($id); if ($user) { $this->entityManager->remove($user); $this->entityManager->flush(); } } public function exists(UserId $id): bool { return $this->entityManager ->getRepository(User::class) ->count(['id' => $id->value()]) > 0; }}</code>## 🎯 <strong>Types de Repositories</strong>### <strong>1. Repository de Commande (Write)</strong><code>phpinterface PaymentCommandRepository{ public function save(Payment $payment): void; public function findById(PaymentId $id): ?Payment; public function delete(PaymentId $id): void;}class DoctrinePaymentCommandRepository implements PaymentCommandRepository{ public function save(Payment $payment): void { $this->entityManager->persist($payment); $this->entityManager->flush(); } public function findById(PaymentId $id): ?Payment { return $this->entityManager ->getRepository(Payment::class) ->find($id->value()); }}</code>### <strong>2. Repository de Requête (Read)</strong><code>phpinterface PaymentQueryRepository{ public function findPaymentDetails(PaymentId $id): ?PaymentDetailsView; public function findPaymentsByCustomer(CustomerId $customerId): array; public function findPaymentsByDateRange(DateRange $dateRange): array; public function findPendingPayments(): array;}class DoctrinePaymentQueryRepository implements PaymentQueryRepository{ public function findPaymentDetails(PaymentId $id): ?PaymentDetailsView { $result = $this->entityManager ->createQuery(' SELECT p.id, p.amount, p.status, p.createdAt, c.name as customerName, s.name as subscriptionName FROM Payment p JOIN p.customer c JOIN p.subscription s WHERE p.id = :id ') ->setParameter('id', $id->value()) ->getOneOrNullResult(); return $result ? PaymentDetailsView::fromArray($result) : null; } public function findPaymentsByCustomer(CustomerId $customerId): array { return $this->entityManager ->createQuery(' SELECT p.id, p.amount, p.status, p.createdAt FROM Payment p WHERE p.customerId = :customerId ORDER BY p.createdAt DESC ') ->setParameter('customerId', $customerId->value()) ->getResult(); }}</code>### <strong>3. Repository Spécialisé</strong><code>phpinterface PaymentAnalyticsRepository{ public function getMonthlyRevenue(int $year, int $month): Amount; public function getPaymentTrends(DateRange $dateRange): array; public function getTopCustomers(int $limit): array;}class ElasticsearchPaymentAnalyticsRepository implements PaymentAnalyticsRepository{ public function getMonthlyRevenue(int $year, int $month): Amount { $query = [ 'query' => [ 'bool' => [ 'must' => [ ['term' => ['status' => 'completed']], ['range' => ['createdAt' => [ 'gte' => "$year-$month-01", 'lt' => "$year-" . ($month + 1) . "-01" ]]] ] ] ], 'aggs' => [ 'total_revenue' => [ 'sum' => ['field' => 'amount'] ] ] ]; $result = $this->elasticsearch->search($query); return new Amount($result['aggregations']['total_revenue']['value']); }}</code>## 🔧 <strong>Patterns Avancés de Repository</strong>### <strong>1. Repository avec Spécifications</strong><code>phpinterface Specification{ public function isSatisfiedBy($entity): bool; public function toQueryBuilder(QueryBuilder $qb): QueryBuilder;}class UserByOrganizationSpecification implements Specification{ public function __construct( private OrganizationId $organizationId ) {} public function isSatisfiedBy($entity): bool { return $entity instanceof User && $entity->organizationId()->equals($this->organizationId); } public function toQueryBuilder(QueryBuilder $qb): QueryBuilder { return $qb->andWhere('u.organizationId = :organizationId') ->setParameter('organizationId', $this->organizationId->value()); }}interface UserRepository{ public function findBySpecification(Specification $spec): array; public function countBySpecification(Specification $spec): int;}class DoctrineUserRepository implements UserRepository{ public function findBySpecification(Specification $spec): array { $qb = $this->entityManager->createQueryBuilder() ->select('u') ->from(User::class, 'u'); return $spec->toQueryBuilder($qb)->getQuery()->getResult(); }}</code>### <strong>2. Repository avec Cache</strong><code>phpclass CachedUserRepository implements UserRepository{ public function __construct( private UserRepository $decorated, private CacheInterface $cache ) {} public function findById(UserId $id): ?User { $cacheKey = "user_{$id->value()}"; return $this->cache->get($cacheKey, function () use ($id) { return $this->decorated->findById($id); }); } public function save(User $user): void { $this->decorated->save($user); // Invalider le cache $this->cache->delete("user_{$user->id()->value()}"); }}</code>### <strong>3. Repository avec Event Sourcing</strong><code>phpinterface EventStore{ public function append(StreamId $streamId, array $events): void; public function getEvents(StreamId $streamId): array;}class EventSourcedUserRepository implements UserRepository{ public function __construct( private EventStore $eventStore ) {} public function save(User $user): void { $events = $user->getUncommittedEvents(); $streamId = StreamId::fromUserId($user->id()); $this->eventStore->append($streamId, $events); $user->markEventsAsCommitted(); } public function findById(UserId $id): ?User { $streamId = StreamId::fromUserId($id); $events = $this->eventStore->getEvents($streamId); if (empty($events)) { return null; } return User::fromEvents($events); }}</code>## 🚀 <strong>Repositories Multi-Sources</strong>### <strong>Repository avec Fallback</strong><code>phpclass FallbackUserRepository implements UserRepository{ public function __construct( private UserRepository $primary, private UserRepository $fallback ) {} public function findById(UserId $id): ?User { try { return $this->primary->findById($id); } catch (Exception $e) { $this->logger->warning('Primary repository failed, using fallback', [ 'error' => $e->getMessage(), 'userId' => $id->value() ]); return $this->fallback->findById($id); } }}</code>### <strong>Repository avec Routing</strong><code>phpclass RoutedUserRepository implements UserRepository{ public function __construct( private UserRepository $sqlRepository, private UserRepository $mongoRepository ) {} public function findById(UserId $id): ?User { // Route basée sur l'ID if ($this->shouldUseMongo($id)) { return $this->mongoRepository->findById($id); } return $this->sqlRepository->findById($id); } private function shouldUseMongo(UserId $id): bool { // Logique de routing (ex: utilisateurs récents en MongoDB) return $id->value() > 1000000; }}</code>## ⚡ <strong>Performance et Optimisation</strong>### <strong>Optimisations de Requête</strong><code>phpclass OptimizedUserRepository implements UserRepository{ public function findByOrganization(OrganizationId $organizationId): array { // Utiliser des requêtes optimisées return $this->entityManager ->createQuery(' SELECT u.id, u.email, u.firstName, u.lastName FROM User u WHERE u.organizationId = :organizationId AND u.status = :status ') ->setParameter('organizationId', $organizationId->value()) ->setParameter('status', UserStatus::ACTIVE) ->setMaxResults(100) // Limiter les résultats ->getResult(); }}</code>### <strong>Optimisations de Cache</strong><code>phpclass SmartCachedUserRepository implements UserRepository{ public function findByOrganization(OrganizationId $organizationId): array { $cacheKey = "users_org_{$organizationId->value()}"; return $this->cache->get($cacheKey, function () use ($organizationId) { $users = $this->decorated->findByOrganization($organizationId); // Cache individuel pour chaque utilisateur foreach ($users as $user) { $this->cache->set("user_{$user->id()->value()}", $user, 3600); } return $users; }, 1800); // TTL de 30 minutes }}</code>## 🎯 <strong>Quand Utiliser les Repositories ?</strong>### <strong>✅ Cas d’Usage Appropriés</strong>- <strong>Abstraction de persistance</strong> : Changer de technologie de stockage- <strong>Tests unitaires</strong> : Mocker facilement l’accès aux données- <strong>Logique métier complexe</strong> : Encapsuler la logique d’accès- <strong>Performance</strong> : Optimiser les requêtes### <strong>❌ Cas d’Usage Inappropriés</strong>- <strong>Applications simples</strong> : CRUD basique- <strong>Over-engineering</strong> : Complexité inutile- <strong>Performance critique</strong> : Overhead des abstractions- <strong>Prototypage</strong> : Développement rapide## 🔄 <strong>Migration vers les Repositories</strong>### <strong>Étape 1 : Identifier les Accès aux Données</strong>- Lister tous les accès aux données- Grouper par entité métier### <strong>Étape 2 : Créer les Interfaces</strong>- Définir les contrats Repository- Spécifier les méthodes nécessaires### <strong>Étape 3 : Implémenter les Repositories</strong>- Créer les implémentations- Migrer progressivement### <strong>Étape 4 : Optimiser</strong>- Ajouter le cache si nécessaire- Optimiser les requêtes## 📊 <strong>Métriques et Monitoring</strong>### <strong>Métriques Repository</strong>- Temps de réponse des requêtes- Taux de cache hit- Nombre de requêtes par seconde### <strong>Métriques de Performance</strong>- Temps de traitement des requêtes complexes- Utilisation mémoire- Charge des bases de données## 🎯 <strong>Prochaines Étapes</strong>Maintenant que vous comprenez les Repositories, explorez :1. <strong>CQRS</strong> : Séparer les commandes des requêtes2. <strong>Event Sourcing</strong> : Stocker les événements comme source de vérité3. <strong>Implémentation Repositories</strong> : Guide d’implémentation complet—<em>Les Repositories sont la pierre angulaire d’une architecture propre. Dans Gyroscops, ils nous ont permis de séparer clairement la logique métier de la persistance, rendant le code plus testable et évolutif.</em></a></li></ul></nav></toc></div><div class="docs-toc-mobile d-print-none d-xl-none"><button id=toc-dropdown-btn class="btn-secondary dropdown-toggle" type=button data-bs-toggle=dropdown data-bs-offset=0,0 aria-expanded=false>
Table of Contents</button><nav id=toc-mobile><ul class=dropdown-menu><li><a href=#-quest-ce-quun-repository-un-repository-est-un-pattern-qui-encapsule-la-logique-daccès-aux-données-fournissant-une-interface-orientée-objet-pour-accéder-à-la-couche-de-persistance-le-principe-fondamental----eric-evansle-repository---abstrait-la-persistance-des-données--encapsule-la-logique-daccès-aux-données--fournit-une-interface-métier-claire--cache-la-complexité-de-la-persistance--repositories-dans-gyroscops-contexte-métier--gestion-des-utilisateursdans-gyroscops-nous-gérons-des-utilisateurs-avec-différents-besoins-daccès--interface-repositoryphpinterface-userrepository----public-function-saveuser-user-void----public-function-findbyiduserid-id-user----public-function-findbyemailemail-email-user----public-function-findbyorganizationorganizationid-organizationid-array----public-function-deleteuserid-id-void----public-function-existsuserid-id-bool-implémentation-doctrinephpclass-doctrineuserrepository-implements-userrepository----public-function-__construct--------private-entitymanagerinterface-entitymanager-------------public-function-saveuser-user-void------------this-entitymanager-persistuser--------this-entitymanager-flush------------public-function-findbyiduserid-id-user------------return-this-entitymanager-------------getrepositoryuserclass-------------findid-value------------public-function-findbyemailemail-email-user------------return-this-entitymanager-------------getrepositoryuserclass-------------findonebyemail--email-value------------public-function-findbyorganizationorganizationid-organizationid-array------------return-this-entitymanager-------------getrepositoryuserclass-------------findbyorganizationid--organizationid-value------------public-function-deleteuserid-id-void------------user--this-findbyidid--------if-user-------------this-entitymanager-removeuser------------this-entitymanager-flush--------------------public-function-existsuserid-id-bool------------return-this-entitymanager-------------getrepositoryuserclass-------------countid--id-value--0------types-de-repositories-1-repository-de-commande-writephpinterface-paymentcommandrepository----public-function-savepayment-payment-void----public-function-findbyidpaymentid-id-payment----public-function-deletepaymentid-id-voidclass-doctrinepaymentcommandrepository-implements-paymentcommandrepository----public-function-savepayment-payment-void------------this-entitymanager-persistpayment--------this-entitymanager-flush------------public-function-findbyidpaymentid-id-payment------------return-this-entitymanager-------------getrepositorypaymentclass-------------findid-value-----2-repository-de-requête-readphpinterface-paymentqueryrepository----public-function-findpaymentdetailspaymentid-id-paymentdetailsview----public-function-findpaymentsbycustomercustomerid-customerid-array----public-function-findpaymentsbydaterangedaterange-daterange-array----public-function-findpendingpayments-arrayclass-doctrinepaymentqueryrepository-implements-paymentqueryrepository----public-function-findpaymentdetailspaymentid-id-paymentdetailsview------------result--this-entitymanager-------------createquery----------------select-pid-pamount-pstatus-pcreatedat-----------------------cname-as-customername-sname-as-subscriptionname----------------from-payment-p----------------join-pcustomer-c----------------join-psubscription-s----------------where-pid--id-------------------------setparameterid-id-value-------------getoneornullresult--------------------return-result--paymentdetailsviewfromarrayresult--null------------public-function-findpaymentsbycustomercustomerid-customerid-array------------return-this-entitymanager-------------createquery----------------select-pid-pamount-pstatus-pcreatedat----------------from-payment-p----------------where-pcustomerid--customerid----------------order-by-pcreatedat-desc-------------------------setparametercustomerid-customerid-value-------------getresult-----3-repository-spécialiséphpinterface-paymentanalyticsrepository----public-function-getmonthlyrevenueint-year-int-month-amount----public-function-getpaymenttrendsdaterange-daterange-array----public-function-gettopcustomersint-limit-arrayclass-elasticsearchpaymentanalyticsrepository-implements-paymentanalyticsrepository----public-function-getmonthlyrevenueint-year-int-month-amount------------query--------------query------------------bool----------------------must--------------------------term--status--completed------------------------range--createdat------------------------------gte--year-month-01----------------------------lt--year---month--1---01------------------------------------------------------------------------------------aggs------------------total_revenue----------------------sum--field--amount----------------------------------------------------result--this-elasticsearch-searchquery--------return-new-amountresultaggregationstotal_revenuevalue------patterns-avancés-de-repository-1-repository-avec-spécificationsphpinterface-specification----public-function-issatisfiedbyentity-bool----public-function-toquerybuilderquerybuilder-qb-querybuilderclass-userbyorganizationspecification-implements-specification----public-function-__construct--------private-organizationid-organizationid-------------public-function-issatisfiedbyentity-bool------------return-entity-instanceof-user-----------------entity-organizationid-equalsthis-organizationid------------public-function-toquerybuilderquerybuilder-qb-querybuilder------------return-qb-andwhereuorganizationid--organizationid-------------------setparameterorganizationid-this-organizationid-value----interface-userrepository----public-function-findbyspecificationspecification-spec-array----public-function-countbyspecificationspecification-spec-intclass-doctrineuserrepository-implements-userrepository----public-function-findbyspecificationspecification-spec-array------------qb--this-entitymanager-createquerybuilder-------------selectu-------------fromuserclass-u--------------------return-spec-toquerybuilderqb-getquery-getresult-----2-repository-avec-cachephpclass-cacheduserrepository-implements-userrepository----public-function-__construct--------private-userrepository-decorated--------private-cacheinterface-cache-------------public-function-findbyiduserid-id-user------------cachekey--user_id-value----------------return-this-cache-getcachekey-function--use-id-------------return-this-decorated-findbyidid--------------------public-function-saveuser-user-void------------this-decorated-saveuser-----------------invalider-le-cache--------this-cache-deleteuser_user-id-value-----3-repository-avec-event-sourcingphpinterface-eventstore----public-function-appendstreamid-streamid-array-events-void----public-function-geteventsstreamid-streamid-arrayclass-eventsourceduserrepository-implements-userrepository----public-function-__construct--------private-eventstore-eventstore-------------public-function-saveuser-user-void------------events--user-getuncommittedevents--------streamid--streamidfromuseriduser-id----------------this-eventstore-appendstreamid-events--------user-markeventsascommitted------------public-function-findbyiduserid-id-user------------streamid--streamidfromuseridid--------events--this-eventstore-geteventsstreamid----------------if-emptyevents-------------return-null------------------------return-userfromeventsevents------repositories-multi-sources-repository-avec-fallbackphpclass-fallbackuserrepository-implements-userrepository----public-function-__construct--------private-userrepository-primary--------private-userrepository-fallback-------------public-function-findbyiduserid-id-user------------try-------------return-this-primary-findbyidid---------catch-exception-e-------------this-logger-warningprimary-repository-failed-using-fallback-----------------error--e-getmessage----------------userid--id-value------------------------------------return-this-fallback-findbyidid-------------repository-avec-routingphpclass-routeduserrepository-implements-userrepository----public-function-__construct--------private-userrepository-sqlrepository--------private-userrepository-mongorepository-------------public-function-findbyiduserid-id-user-------------route-basée-sur-lid--------if-this-shouldusemongoid-------------return-this-mongorepository-findbyidid------------------------return-this-sqlrepository-findbyidid------------private-function-shouldusemongouserid-id-bool-------------logique-de-routing-ex-utilisateurs-récents-en-mongodb--------return-id-value--1000000------performance-et-optimisation-optimisations-de-requêtephpclass-optimizeduserrepository-implements-userrepository----public-function-findbyorganizationorganizationid-organizationid-array-------------utiliser-des-requêtes-optimisées--------return-this-entitymanager-------------createquery----------------select-uid-uemail-ufirstname-ulastname----------------from-user-u----------------where-uorganizationid--organizationid----------------and-ustatus--status-------------------------setparameterorganizationid-organizationid-value-------------setparameterstatus-userstatusactive-------------setmaxresults100--limiter-les-résultats-------------getresult-----optimisations-de-cachephpclass-smartcacheduserrepository-implements-userrepository----public-function-findbyorganizationorganizationid-organizationid-array------------cachekey--users_org_organizationid-value----------------return-this-cache-getcachekey-function--use-organizationid-------------users--this-decorated-findbyorganizationorganizationid-------------------------cache-individuel-pour-chaque-utilisateur------------foreach-users-as-user-----------------this-cache-setuser_user-id-value-user-3600------------------------------------return-users---------1800--ttl-de-30-minutes------quand-utiliser-les-repositories---cas-d--abstraction-de-persistance--changer-de-technologie-de-stockage--tests-unitaires--mocker-facilement-laccès-aux-données--logique-métier-complexe--encapsuler-la-logique-daccès--performance--optimiser-les-requêtes--cas-d--applications-simples--crud-basique--over-engineering--complexité-inutile--performance-critique--overhead-des-abstractions--prototypage--développement-rapide--migration-vers-les-repositories-étape-1--identifier-les-accès-aux-données--lister-tous-les-accès-aux-données--grouper-par-entité-métier-étape-2--créer-les-interfaces--définir-les-contrats-repository--spécifier-les-méthodes-nécessaires-étape-3--implémenter-les-repositories--créer-les-implémentations--migrer-progressivement-étape-4--optimiser--ajouter-le-cache-si-nécessaire--optimiser-les-requêtes--métriques-et-monitoring-métriques-repository--temps-de-réponse-des-requêtes--taux-de-cache-hit--nombre-de-requêtes-par-seconde-métriques-de-performance--temps-de-traitement-des-requêtes-complexes--utilisation-mémoire--charge-des-bases-de-données--prochaines-étapesmaintenant-que-vous-comprenez-les-repositories-explorez-1-cqrs--séparer-les-commandes-des-requêtes2-event-sourcing--stocker-les-événements-comme-source-de-vérité3-implémentation-repositories--guide-dimplémentation-completles-repositories-sont-la-pierre-angulaire-d>🌟 **Qu’est-ce qu’un Repository ?**Un <strong>Repository</strong> est un pattern qui encapsule la logique d’accès aux données, fournissant une interface orientée objet pour accéder à la couche de persistance.### <strong>Le Principe Fondamental</strong>> <strong>“Un Repository représente une collection d’objets en mémoire”</strong> - Eric EvansLe Repository :- <strong>Abstrait</strong> la persistance des données- <strong>Encapsule</strong> la logique d’accès aux données- <strong>Fournit</strong> une interface métier claire- <strong>Cache</strong> la complexité de la persistance## 🏗️ <strong>Repositories dans Gyroscops</strong>### <strong>Contexte Métier : Gestion des Utilisateurs</strong>Dans Gyroscops, nous gérons des utilisateurs avec différents besoins d’accès :#### <strong>Interface Repository</strong><code>phpinterface UserRepository{ public function save(User $user): void; public function findById(UserId $id): ?User; public function findByEmail(Email $email): ?User; public function findByOrganization(OrganizationId $organizationId): array; public function delete(UserId $id): void; public function exists(UserId $id): bool;}</code>#### <strong>Implémentation Doctrine</strong><code>phpclass DoctrineUserRepository implements UserRepository{ public function __construct( private EntityManagerInterface $entityManager ) {} public function save(User $user): void { $this->entityManager->persist($user); $this->entityManager->flush(); } public function findById(UserId $id): ?User { return $this->entityManager ->getRepository(User::class) ->find($id->value()); } public function findByEmail(Email $email): ?User { return $this->entityManager ->getRepository(User::class) ->findOneBy(['email' => $email->value()]); } public function findByOrganization(OrganizationId $organizationId): array { return $this->entityManager ->getRepository(User::class) ->findBy(['organizationId' => $organizationId->value()]); } public function delete(UserId $id): void { $user = $this->findById($id); if ($user) { $this->entityManager->remove($user); $this->entityManager->flush(); } } public function exists(UserId $id): bool { return $this->entityManager ->getRepository(User::class) ->count(['id' => $id->value()]) > 0; }}</code>## 🎯 <strong>Types de Repositories</strong>### <strong>1. Repository de Commande (Write)</strong><code>phpinterface PaymentCommandRepository{ public function save(Payment $payment): void; public function findById(PaymentId $id): ?Payment; public function delete(PaymentId $id): void;}class DoctrinePaymentCommandRepository implements PaymentCommandRepository{ public function save(Payment $payment): void { $this->entityManager->persist($payment); $this->entityManager->flush(); } public function findById(PaymentId $id): ?Payment { return $this->entityManager ->getRepository(Payment::class) ->find($id->value()); }}</code>### <strong>2. Repository de Requête (Read)</strong><code>phpinterface PaymentQueryRepository{ public function findPaymentDetails(PaymentId $id): ?PaymentDetailsView; public function findPaymentsByCustomer(CustomerId $customerId): array; public function findPaymentsByDateRange(DateRange $dateRange): array; public function findPendingPayments(): array;}class DoctrinePaymentQueryRepository implements PaymentQueryRepository{ public function findPaymentDetails(PaymentId $id): ?PaymentDetailsView { $result = $this->entityManager ->createQuery(' SELECT p.id, p.amount, p.status, p.createdAt, c.name as customerName, s.name as subscriptionName FROM Payment p JOIN p.customer c JOIN p.subscription s WHERE p.id = :id ') ->setParameter('id', $id->value()) ->getOneOrNullResult(); return $result ? PaymentDetailsView::fromArray($result) : null; } public function findPaymentsByCustomer(CustomerId $customerId): array { return $this->entityManager ->createQuery(' SELECT p.id, p.amount, p.status, p.createdAt FROM Payment p WHERE p.customerId = :customerId ORDER BY p.createdAt DESC ') ->setParameter('customerId', $customerId->value()) ->getResult(); }}</code>### <strong>3. Repository Spécialisé</strong><code>phpinterface PaymentAnalyticsRepository{ public function getMonthlyRevenue(int $year, int $month): Amount; public function getPaymentTrends(DateRange $dateRange): array; public function getTopCustomers(int $limit): array;}class ElasticsearchPaymentAnalyticsRepository implements PaymentAnalyticsRepository{ public function getMonthlyRevenue(int $year, int $month): Amount { $query = [ 'query' => [ 'bool' => [ 'must' => [ ['term' => ['status' => 'completed']], ['range' => ['createdAt' => [ 'gte' => "$year-$month-01", 'lt' => "$year-" . ($month + 1) . "-01" ]]] ] ] ], 'aggs' => [ 'total_revenue' => [ 'sum' => ['field' => 'amount'] ] ] ]; $result = $this->elasticsearch->search($query); return new Amount($result['aggregations']['total_revenue']['value']); }}</code>## 🔧 <strong>Patterns Avancés de Repository</strong>### <strong>1. Repository avec Spécifications</strong><code>phpinterface Specification{ public function isSatisfiedBy($entity): bool; public function toQueryBuilder(QueryBuilder $qb): QueryBuilder;}class UserByOrganizationSpecification implements Specification{ public function __construct( private OrganizationId $organizationId ) {} public function isSatisfiedBy($entity): bool { return $entity instanceof User && $entity->organizationId()->equals($this->organizationId); } public function toQueryBuilder(QueryBuilder $qb): QueryBuilder { return $qb->andWhere('u.organizationId = :organizationId') ->setParameter('organizationId', $this->organizationId->value()); }}interface UserRepository{ public function findBySpecification(Specification $spec): array; public function countBySpecification(Specification $spec): int;}class DoctrineUserRepository implements UserRepository{ public function findBySpecification(Specification $spec): array { $qb = $this->entityManager->createQueryBuilder() ->select('u') ->from(User::class, 'u'); return $spec->toQueryBuilder($qb)->getQuery()->getResult(); }}</code>### <strong>2. Repository avec Cache</strong><code>phpclass CachedUserRepository implements UserRepository{ public function __construct( private UserRepository $decorated, private CacheInterface $cache ) {} public function findById(UserId $id): ?User { $cacheKey = "user_{$id->value()}"; return $this->cache->get($cacheKey, function () use ($id) { return $this->decorated->findById($id); }); } public function save(User $user): void { $this->decorated->save($user); // Invalider le cache $this->cache->delete("user_{$user->id()->value()}"); }}</code>### <strong>3. Repository avec Event Sourcing</strong><code>phpinterface EventStore{ public function append(StreamId $streamId, array $events): void; public function getEvents(StreamId $streamId): array;}class EventSourcedUserRepository implements UserRepository{ public function __construct( private EventStore $eventStore ) {} public function save(User $user): void { $events = $user->getUncommittedEvents(); $streamId = StreamId::fromUserId($user->id()); $this->eventStore->append($streamId, $events); $user->markEventsAsCommitted(); } public function findById(UserId $id): ?User { $streamId = StreamId::fromUserId($id); $events = $this->eventStore->getEvents($streamId); if (empty($events)) { return null; } return User::fromEvents($events); }}</code>## 🚀 <strong>Repositories Multi-Sources</strong>### <strong>Repository avec Fallback</strong><code>phpclass FallbackUserRepository implements UserRepository{ public function __construct( private UserRepository $primary, private UserRepository $fallback ) {} public function findById(UserId $id): ?User { try { return $this->primary->findById($id); } catch (Exception $e) { $this->logger->warning('Primary repository failed, using fallback', [ 'error' => $e->getMessage(), 'userId' => $id->value() ]); return $this->fallback->findById($id); } }}</code>### <strong>Repository avec Routing</strong><code>phpclass RoutedUserRepository implements UserRepository{ public function __construct( private UserRepository $sqlRepository, private UserRepository $mongoRepository ) {} public function findById(UserId $id): ?User { // Route basée sur l'ID if ($this->shouldUseMongo($id)) { return $this->mongoRepository->findById($id); } return $this->sqlRepository->findById($id); } private function shouldUseMongo(UserId $id): bool { // Logique de routing (ex: utilisateurs récents en MongoDB) return $id->value() > 1000000; }}</code>## ⚡ <strong>Performance et Optimisation</strong>### <strong>Optimisations de Requête</strong><code>phpclass OptimizedUserRepository implements UserRepository{ public function findByOrganization(OrganizationId $organizationId): array { // Utiliser des requêtes optimisées return $this->entityManager ->createQuery(' SELECT u.id, u.email, u.firstName, u.lastName FROM User u WHERE u.organizationId = :organizationId AND u.status = :status ') ->setParameter('organizationId', $organizationId->value()) ->setParameter('status', UserStatus::ACTIVE) ->setMaxResults(100) // Limiter les résultats ->getResult(); }}</code>### <strong>Optimisations de Cache</strong><code>phpclass SmartCachedUserRepository implements UserRepository{ public function findByOrganization(OrganizationId $organizationId): array { $cacheKey = "users_org_{$organizationId->value()}"; return $this->cache->get($cacheKey, function () use ($organizationId) { $users = $this->decorated->findByOrganization($organizationId); // Cache individuel pour chaque utilisateur foreach ($users as $user) { $this->cache->set("user_{$user->id()->value()}", $user, 3600); } return $users; }, 1800); // TTL de 30 minutes }}</code>## 🎯 <strong>Quand Utiliser les Repositories ?</strong>### <strong>✅ Cas d’Usage Appropriés</strong>- <strong>Abstraction de persistance</strong> : Changer de technologie de stockage- <strong>Tests unitaires</strong> : Mocker facilement l’accès aux données- <strong>Logique métier complexe</strong> : Encapsuler la logique d’accès- <strong>Performance</strong> : Optimiser les requêtes### <strong>❌ Cas d’Usage Inappropriés</strong>- <strong>Applications simples</strong> : CRUD basique- <strong>Over-engineering</strong> : Complexité inutile- <strong>Performance critique</strong> : Overhead des abstractions- <strong>Prototypage</strong> : Développement rapide## 🔄 <strong>Migration vers les Repositories</strong>### <strong>Étape 1 : Identifier les Accès aux Données</strong>- Lister tous les accès aux données- Grouper par entité métier### <strong>Étape 2 : Créer les Interfaces</strong>- Définir les contrats Repository- Spécifier les méthodes nécessaires### <strong>Étape 3 : Implémenter les Repositories</strong>- Créer les implémentations- Migrer progressivement### <strong>Étape 4 : Optimiser</strong>- Ajouter le cache si nécessaire- Optimiser les requêtes## 📊 <strong>Métriques et Monitoring</strong>### <strong>Métriques Repository</strong>- Temps de réponse des requêtes- Taux de cache hit- Nombre de requêtes par seconde### <strong>Métriques de Performance</strong>- Temps de traitement des requêtes complexes- Utilisation mémoire- Charge des bases de données## 🎯 <strong>Prochaines Étapes</strong>Maintenant que vous comprenez les Repositories, explorez :1. <strong>CQRS</strong> : Séparer les commandes des requêtes2. <strong>Event Sourcing</strong> : Stocker les événements comme source de vérité3. <strong>Implémentation Repositories</strong> : Guide d’implémentation complet—<em>Les Repositories sont la pierre angulaire d’une architecture propre. Dans Gyroscops, ils nous ont permis de séparer clairement la logique métier de la persistance, rendant le code plus testable et évolutif.</em></a></li></ul></nav></div><div class="docs-content col-12 col-xl-9 mt-0"><div class="mb-0 d-flex"><h1 class="content-title mb-0">Repositories - Patterns de Persistance</h1></div><div id=content class=main-content><div data-prismjs-copy data-prismjs-copy-success data-prismjs-copy-error><h2 id=-quest-ce-quun-repository-un-repository-est-un-pattern-qui-encapsule-la-logique-daccès-aux-données-fournissant-une-interface-orientée-objet-pour-accéder-à-la-couche-de-persistance-le-principe-fondamental----eric-evansle-repository---abstrait-la-persistance-des-données--encapsule-la-logique-daccès-aux-données--fournit-une-interface-métier-claire--cache-la-complexité-de-la-persistance--repositories-dans-gyroscops-contexte-métier--gestion-des-utilisateursdans-gyroscops-nous-gérons-des-utilisateurs-avec-différents-besoins-daccès--interface-repositoryphpinterface-userrepository----public-function-saveuser-user-void----public-function-findbyiduserid-id-user----public-function-findbyemailemail-email-user----public-function-findbyorganizationorganizationid-organizationid-array----public-function-deleteuserid-id-void----public-function-existsuserid-id-bool-implémentation-doctrinephpclass-doctrineuserrepository-implements-userrepository----public-function-__construct--------private-entitymanagerinterface-entitymanager-------------public-function-saveuser-user-void------------this-entitymanager-persistuser--------this-entitymanager-flush------------public-function-findbyiduserid-id-user------------return-this-entitymanager-------------getrepositoryuserclass-------------findid-value------------public-function-findbyemailemail-email-user------------return-this-entitymanager-------------getrepositoryuserclass-------------findonebyemail--email-value------------public-function-findbyorganizationorganizationid-organizationid-array------------return-this-entitymanager-------------getrepositoryuserclass-------------findbyorganizationid--organizationid-value------------public-function-deleteuserid-id-void------------user--this-findbyidid--------if-user-------------this-entitymanager-removeuser------------this-entitymanager-flush--------------------public-function-existsuserid-id-bool------------return-this-entitymanager-------------getrepositoryuserclass-------------countid--id-value--0------types-de-repositories-1-repository-de-commande-writephpinterface-paymentcommandrepository----public-function-savepayment-payment-void----public-function-findbyidpaymentid-id-payment----public-function-deletepaymentid-id-voidclass-doctrinepaymentcommandrepository-implements-paymentcommandrepository----public-function-savepayment-payment-void------------this-entitymanager-persistpayment--------this-entitymanager-flush------------public-function-findbyidpaymentid-id-payment------------return-this-entitymanager-------------getrepositorypaymentclass-------------findid-value-----2-repository-de-requête-readphpinterface-paymentqueryrepository----public-function-findpaymentdetailspaymentid-id-paymentdetailsview----public-function-findpaymentsbycustomercustomerid-customerid-array----public-function-findpaymentsbydaterangedaterange-daterange-array----public-function-findpendingpayments-arrayclass-doctrinepaymentqueryrepository-implements-paymentqueryrepository----public-function-findpaymentdetailspaymentid-id-paymentdetailsview------------result--this-entitymanager-------------createquery----------------select-pid-pamount-pstatus-pcreatedat-----------------------cname-as-customername-sname-as-subscriptionname----------------from-payment-p----------------join-pcustomer-c----------------join-psubscription-s----------------where-pid--id-------------------------setparameterid-id-value-------------getoneornullresult--------------------return-result--paymentdetailsviewfromarrayresult--null------------public-function-findpaymentsbycustomercustomerid-customerid-array------------return-this-entitymanager-------------createquery----------------select-pid-pamount-pstatus-pcreatedat----------------from-payment-p----------------where-pcustomerid--customerid----------------order-by-pcreatedat-desc-------------------------setparametercustomerid-customerid-value-------------getresult-----3-repository-spécialiséphpinterface-paymentanalyticsrepository----public-function-getmonthlyrevenueint-year-int-month-amount----public-function-getpaymenttrendsdaterange-daterange-array----public-function-gettopcustomersint-limit-arrayclass-elasticsearchpaymentanalyticsrepository-implements-paymentanalyticsrepository----public-function-getmonthlyrevenueint-year-int-month-amount------------query--------------query------------------bool----------------------must--------------------------term--status--completed------------------------range--createdat------------------------------gte--year-month-01----------------------------lt--year---month--1---01------------------------------------------------------------------------------------aggs------------------total_revenue----------------------sum--field--amount----------------------------------------------------result--this-elasticsearch-searchquery--------return-new-amountresultaggregationstotal_revenuevalue------patterns-avancés-de-repository-1-repository-avec-spécificationsphpinterface-specification----public-function-issatisfiedbyentity-bool----public-function-toquerybuilderquerybuilder-qb-querybuilderclass-userbyorganizationspecification-implements-specification----public-function-__construct--------private-organizationid-organizationid-------------public-function-issatisfiedbyentity-bool------------return-entity-instanceof-user-----------------entity-organizationid-equalsthis-organizationid------------public-function-toquerybuilderquerybuilder-qb-querybuilder------------return-qb-andwhereuorganizationid--organizationid-------------------setparameterorganizationid-this-organizationid-value----interface-userrepository----public-function-findbyspecificationspecification-spec-array----public-function-countbyspecificationspecification-spec-intclass-doctrineuserrepository-implements-userrepository----public-function-findbyspecificationspecification-spec-array------------qb--this-entitymanager-createquerybuilder-------------selectu-------------fromuserclass-u--------------------return-spec-toquerybuilderqb-getquery-getresult-----2-repository-avec-cachephpclass-cacheduserrepository-implements-userrepository----public-function-__construct--------private-userrepository-decorated--------private-cacheinterface-cache-------------public-function-findbyiduserid-id-user------------cachekey--user_id-value----------------return-this-cache-getcachekey-function--use-id-------------return-this-decorated-findbyidid--------------------public-function-saveuser-user-void------------this-decorated-saveuser-----------------invalider-le-cache--------this-cache-deleteuser_user-id-value-----3-repository-avec-event-sourcingphpinterface-eventstore----public-function-appendstreamid-streamid-array-events-void----public-function-geteventsstreamid-streamid-arrayclass-eventsourceduserrepository-implements-userrepository----public-function-__construct--------private-eventstore-eventstore-------------public-function-saveuser-user-void------------events--user-getuncommittedevents--------streamid--streamidfromuseriduser-id----------------this-eventstore-appendstreamid-events--------user-markeventsascommitted------------public-function-findbyiduserid-id-user------------streamid--streamidfromuseridid--------events--this-eventstore-geteventsstreamid----------------if-emptyevents-------------return-null------------------------return-userfromeventsevents------repositories-multi-sources-repository-avec-fallbackphpclass-fallbackuserrepository-implements-userrepository----public-function-__construct--------private-userrepository-primary--------private-userrepository-fallback-------------public-function-findbyiduserid-id-user------------try-------------return-this-primary-findbyidid---------catch-exception-e-------------this-logger-warningprimary-repository-failed-using-fallback-----------------error--e-getmessage----------------userid--id-value------------------------------------return-this-fallback-findbyidid-------------repository-avec-routingphpclass-routeduserrepository-implements-userrepository----public-function-__construct--------private-userrepository-sqlrepository--------private-userrepository-mongorepository-------------public-function-findbyiduserid-id-user-------------route-basée-sur-lid--------if-this-shouldusemongoid-------------return-this-mongorepository-findbyidid------------------------return-this-sqlrepository-findbyidid------------private-function-shouldusemongouserid-id-bool-------------logique-de-routing-ex-utilisateurs-récents-en-mongodb--------return-id-value--1000000------performance-et-optimisation-optimisations-de-requêtephpclass-optimizeduserrepository-implements-userrepository----public-function-findbyorganizationorganizationid-organizationid-array-------------utiliser-des-requêtes-optimisées--------return-this-entitymanager-------------createquery----------------select-uid-uemail-ufirstname-ulastname----------------from-user-u----------------where-uorganizationid--organizationid----------------and-ustatus--status-------------------------setparameterorganizationid-organizationid-value-------------setparameterstatus-userstatusactive-------------setmaxresults100--limiter-les-résultats-------------getresult-----optimisations-de-cachephpclass-smartcacheduserrepository-implements-userrepository----public-function-findbyorganizationorganizationid-organizationid-array------------cachekey--users_org_organizationid-value----------------return-this-cache-getcachekey-function--use-organizationid-------------users--this-decorated-findbyorganizationorganizationid-------------------------cache-individuel-pour-chaque-utilisateur------------foreach-users-as-user-----------------this-cache-setuser_user-id-value-user-3600------------------------------------return-users---------1800--ttl-de-30-minutes------quand-utiliser-les-repositories---cas-d--abstraction-de-persistance--changer-de-technologie-de-stockage--tests-unitaires--mocker-facilement-laccès-aux-données--logique-métier-complexe--encapsuler-la-logique-daccès--performance--optimiser-les-requêtes--cas-d--applications-simples--crud-basique--over-engineering--complexité-inutile--performance-critique--overhead-des-abstractions--prototypage--développement-rapide--migration-vers-les-repositories-étape-1--identifier-les-accès-aux-données--lister-tous-les-accès-aux-données--grouper-par-entité-métier-étape-2--créer-les-interfaces--définir-les-contrats-repository--spécifier-les-méthodes-nécessaires-étape-3--implémenter-les-repositories--créer-les-implémentations--migrer-progressivement-étape-4--optimiser--ajouter-le-cache-si-nécessaire--optimiser-les-requêtes--métriques-et-monitoring-métriques-repository--temps-de-réponse-des-requêtes--taux-de-cache-hit--nombre-de-requêtes-par-seconde-métriques-de-performance--temps-de-traitement-des-requêtes-complexes--utilisation-mémoire--charge-des-bases-de-données--prochaines-étapesmaintenant-que-vous-comprenez-les-repositories-explorez-1-cqrs--séparer-les-commandes-des-requêtes2-event-sourcing--stocker-les-événements-comme-source-de-vérité3-implémentation-repositories--guide-dimplémentation-completles-repositories-sont-la-pierre-angulaire-d>🌟 **Qu&rsquo;est-ce qu&rsquo;un Repository ?**Un <strong>Repository</strong> est un pattern qui encapsule la logique d&rsquo;accès aux données, fournissant une interface orientée objet pour accéder à la couche de persistance.### <strong>Le Principe Fondamental</strong>> <strong>&ldquo;Un Repository représente une collection d&rsquo;objets en mémoire&rdquo;</strong> - Eric EvansLe Repository :- <strong>Abstrait</strong> la persistance des données- <strong>Encapsule</strong> la logique d&rsquo;accès aux données- <strong>Fournit</strong> une interface métier claire- <strong>Cache</strong> la complexité de la persistance## 🏗️ <strong>Repositories dans Gyroscops</strong>### <strong>Contexte Métier : Gestion des Utilisateurs</strong>Dans Gyroscops, nous gérons des utilisateurs avec différents besoins d&rsquo;accès :#### <strong>Interface Repository</strong><code>phpinterface UserRepository{ public function save(User $user): void; public function findById(UserId $id): ?User; public function findByEmail(Email $email): ?User; public function findByOrganization(OrganizationId $organizationId): array; public function delete(UserId $id): void; public function exists(UserId $id): bool;}</code>#### <strong>Implémentation Doctrine</strong><code>phpclass DoctrineUserRepository implements UserRepository{ public function __construct( private EntityManagerInterface $entityManager ) {} public function save(User $user): void { $this->entityManager->persist($user); $this->entityManager->flush(); } public function findById(UserId $id): ?User { return $this->entityManager ->getRepository(User::class) ->find($id->value()); } public function findByEmail(Email $email): ?User { return $this->entityManager ->getRepository(User::class) ->findOneBy(['email' => $email->value()]); } public function findByOrganization(OrganizationId $organizationId): array { return $this->entityManager ->getRepository(User::class) ->findBy(['organizationId' => $organizationId->value()]); } public function delete(UserId $id): void { $user = $this->findById($id); if ($user) { $this->entityManager->remove($user); $this->entityManager->flush(); } } public function exists(UserId $id): bool { return $this->entityManager ->getRepository(User::class) ->count(['id' => $id->value()]) > 0; }}</code>## 🎯 <strong>Types de Repositories</strong>### <strong>1. Repository de Commande (Write)</strong><code>phpinterface PaymentCommandRepository{ public function save(Payment $payment): void; public function findById(PaymentId $id): ?Payment; public function delete(PaymentId $id): void;}class DoctrinePaymentCommandRepository implements PaymentCommandRepository{ public function save(Payment $payment): void { $this->entityManager->persist($payment); $this->entityManager->flush(); } public function findById(PaymentId $id): ?Payment { return $this->entityManager ->getRepository(Payment::class) ->find($id->value()); }}</code>### <strong>2. Repository de Requête (Read)</strong><code>phpinterface PaymentQueryRepository{ public function findPaymentDetails(PaymentId $id): ?PaymentDetailsView; public function findPaymentsByCustomer(CustomerId $customerId): array; public function findPaymentsByDateRange(DateRange $dateRange): array; public function findPendingPayments(): array;}class DoctrinePaymentQueryRepository implements PaymentQueryRepository{ public function findPaymentDetails(PaymentId $id): ?PaymentDetailsView { $result = $this->entityManager ->createQuery(' SELECT p.id, p.amount, p.status, p.createdAt, c.name as customerName, s.name as subscriptionName FROM Payment p JOIN p.customer c JOIN p.subscription s WHERE p.id = :id ') ->setParameter('id', $id->value()) ->getOneOrNullResult(); return $result ? PaymentDetailsView::fromArray($result) : null; } public function findPaymentsByCustomer(CustomerId $customerId): array { return $this->entityManager ->createQuery(' SELECT p.id, p.amount, p.status, p.createdAt FROM Payment p WHERE p.customerId = :customerId ORDER BY p.createdAt DESC ') ->setParameter('customerId', $customerId->value()) ->getResult(); }}</code>### <strong>3. Repository Spécialisé</strong><code>phpinterface PaymentAnalyticsRepository{ public function getMonthlyRevenue(int $year, int $month): Amount; public function getPaymentTrends(DateRange $dateRange): array; public function getTopCustomers(int $limit): array;}class ElasticsearchPaymentAnalyticsRepository implements PaymentAnalyticsRepository{ public function getMonthlyRevenue(int $year, int $month): Amount { $query = [ 'query' => [ 'bool' => [ 'must' => [ ['term' => ['status' => 'completed']], ['range' => ['createdAt' => [ 'gte' => "$year-$month-01", 'lt' => "$year-" . ($month + 1) . "-01" ]]] ] ] ], 'aggs' => [ 'total_revenue' => [ 'sum' => ['field' => 'amount'] ] ] ]; $result = $this->elasticsearch->search($query); return new Amount($result['aggregations']['total_revenue']['value']); }}</code>## 🔧 <strong>Patterns Avancés de Repository</strong>### <strong>1. Repository avec Spécifications</strong><code>phpinterface Specification{ public function isSatisfiedBy($entity): bool; public function toQueryBuilder(QueryBuilder $qb): QueryBuilder;}class UserByOrganizationSpecification implements Specification{ public function __construct( private OrganizationId $organizationId ) {} public function isSatisfiedBy($entity): bool { return $entity instanceof User && $entity->organizationId()->equals($this->organizationId); } public function toQueryBuilder(QueryBuilder $qb): QueryBuilder { return $qb->andWhere('u.organizationId = :organizationId') ->setParameter('organizationId', $this->organizationId->value()); }}interface UserRepository{ public function findBySpecification(Specification $spec): array; public function countBySpecification(Specification $spec): int;}class DoctrineUserRepository implements UserRepository{ public function findBySpecification(Specification $spec): array { $qb = $this->entityManager->createQueryBuilder() ->select('u') ->from(User::class, 'u'); return $spec->toQueryBuilder($qb)->getQuery()->getResult(); }}</code>### <strong>2. Repository avec Cache</strong><code>phpclass CachedUserRepository implements UserRepository{ public function __construct( private UserRepository $decorated, private CacheInterface $cache ) {} public function findById(UserId $id): ?User { $cacheKey = "user_{$id->value()}"; return $this->cache->get($cacheKey, function () use ($id) { return $this->decorated->findById($id); }); } public function save(User $user): void { $this->decorated->save($user); // Invalider le cache $this->cache->delete("user_{$user->id()->value()}"); }}</code>### <strong>3. Repository avec Event Sourcing</strong><code>phpinterface EventStore{ public function append(StreamId $streamId, array $events): void; public function getEvents(StreamId $streamId): array;}class EventSourcedUserRepository implements UserRepository{ public function __construct( private EventStore $eventStore ) {} public function save(User $user): void { $events = $user->getUncommittedEvents(); $streamId = StreamId::fromUserId($user->id()); $this->eventStore->append($streamId, $events); $user->markEventsAsCommitted(); } public function findById(UserId $id): ?User { $streamId = StreamId::fromUserId($id); $events = $this->eventStore->getEvents($streamId); if (empty($events)) { return null; } return User::fromEvents($events); }}</code>## 🚀 <strong>Repositories Multi-Sources</strong>### <strong>Repository avec Fallback</strong><code>phpclass FallbackUserRepository implements UserRepository{ public function __construct( private UserRepository $primary, private UserRepository $fallback ) {} public function findById(UserId $id): ?User { try { return $this->primary->findById($id); } catch (Exception $e) { $this->logger->warning('Primary repository failed, using fallback', [ 'error' => $e->getMessage(), 'userId' => $id->value() ]); return $this->fallback->findById($id); } }}</code>### <strong>Repository avec Routing</strong><code>phpclass RoutedUserRepository implements UserRepository{ public function __construct( private UserRepository $sqlRepository, private UserRepository $mongoRepository ) {} public function findById(UserId $id): ?User { // Route basée sur l'ID if ($this->shouldUseMongo($id)) { return $this->mongoRepository->findById($id); } return $this->sqlRepository->findById($id); } private function shouldUseMongo(UserId $id): bool { // Logique de routing (ex: utilisateurs récents en MongoDB) return $id->value() > 1000000; }}</code>## ⚡ <strong>Performance et Optimisation</strong>### <strong>Optimisations de Requête</strong><code>phpclass OptimizedUserRepository implements UserRepository{ public function findByOrganization(OrganizationId $organizationId): array { // Utiliser des requêtes optimisées return $this->entityManager ->createQuery(' SELECT u.id, u.email, u.firstName, u.lastName FROM User u WHERE u.organizationId = :organizationId AND u.status = :status ') ->setParameter('organizationId', $organizationId->value()) ->setParameter('status', UserStatus::ACTIVE) ->setMaxResults(100) // Limiter les résultats ->getResult(); }}</code>### <strong>Optimisations de Cache</strong><code>phpclass SmartCachedUserRepository implements UserRepository{ public function findByOrganization(OrganizationId $organizationId): array { $cacheKey = "users_org_{$organizationId->value()}"; return $this->cache->get($cacheKey, function () use ($organizationId) { $users = $this->decorated->findByOrganization($organizationId); // Cache individuel pour chaque utilisateur foreach ($users as $user) { $this->cache->set("user_{$user->id()->value()}", $user, 3600); } return $users; }, 1800); // TTL de 30 minutes }}</code>## 🎯 <strong>Quand Utiliser les Repositories ?</strong>### <strong>✅ Cas d&rsquo;Usage Appropriés</strong>- <strong>Abstraction de persistance</strong> : Changer de technologie de stockage- <strong>Tests unitaires</strong> : Mocker facilement l&rsquo;accès aux données- <strong>Logique métier complexe</strong> : Encapsuler la logique d&rsquo;accès- <strong>Performance</strong> : Optimiser les requêtes### <strong>❌ Cas d&rsquo;Usage Inappropriés</strong>- <strong>Applications simples</strong> : CRUD basique- <strong>Over-engineering</strong> : Complexité inutile- <strong>Performance critique</strong> : Overhead des abstractions- <strong>Prototypage</strong> : Développement rapide## 🔄 <strong>Migration vers les Repositories</strong>### <strong>Étape 1 : Identifier les Accès aux Données</strong>- Lister tous les accès aux données- Grouper par entité métier### <strong>Étape 2 : Créer les Interfaces</strong>- Définir les contrats Repository- Spécifier les méthodes nécessaires### <strong>Étape 3 : Implémenter les Repositories</strong>- Créer les implémentations- Migrer progressivement### <strong>Étape 4 : Optimiser</strong>- Ajouter le cache si nécessaire- Optimiser les requêtes## 📊 <strong>Métriques et Monitoring</strong>### <strong>Métriques Repository</strong>- Temps de réponse des requêtes- Taux de cache hit- Nombre de requêtes par seconde### <strong>Métriques de Performance</strong>- Temps de traitement des requêtes complexes- Utilisation mémoire- Charge des bases de données## 🎯 <strong>Prochaines Étapes</strong>Maintenant que vous comprenez les Repositories, explorez :1. <strong><a href=/concept/cqrs/>CQRS</a></strong> : Séparer les commandes des requêtes2. <strong><a href=/concept/event-sourcing/>Event Sourcing</a></strong> : Stocker les événements comme source de vérité3. <strong><a href=/chapitres/fondamentaux/chapitre-09-repositories-persistance/>Implémentation Repositories</a></strong> : Guide d&rsquo;implémentation complet&mdash;<em>Les Repositories sont la pierre angulaire d&rsquo;une architecture propre. Dans Gyroscops, ils nous ont permis de séparer clairement la logique métier de la persistance, rendant le code plus testable et évolutif.</em> <a href=#-quest-ce-quun-repository-un-repository-est-un-pattern-qui-encapsule-la-logique-dacc%c3%a8s-aux-donn%c3%a9es-fournissant-une-interface-orient%c3%a9e-objet-pour-acc%c3%a9der-%c3%a0-la-couche-de-persistance-le-principe-fondamental----eric-evansle-repository---abstrait-la-persistance-des-donn%c3%a9es--encapsule-la-logique-dacc%c3%a8s-aux-donn%c3%a9es--fournit-une-interface-m%c3%a9tier-claire--cache-la-complexit%c3%a9-de-la-persistance--repositories-dans-gyroscops-contexte-m%c3%a9tier--gestion-des-utilisateursdans-gyroscops-nous-g%c3%a9rons-des-utilisateurs-avec-diff%c3%a9rents-besoins-dacc%c3%a8s--interface-repositoryphpinterface-userrepository----public-function-saveuser-user-void----public-function-findbyiduserid-id-user----public-function-findbyemailemail-email-user----public-function-findbyorganizationorganizationid-organizationid-array----public-function-deleteuserid-id-void----public-function-existsuserid-id-bool-impl%c3%a9mentation-doctrinephpclass-doctrineuserrepository-implements-userrepository----public-function-__construct--------private-entitymanagerinterface-entitymanager-------------public-function-saveuser-user-void------------this-entitymanager-persistuser--------this-entitymanager-flush------------public-function-findbyiduserid-id-user------------return-this-entitymanager-------------getrepositoryuserclass-------------findid-value------------public-function-findbyemailemail-email-user------------return-this-entitymanager-------------getrepositoryuserclass-------------findonebyemail--email-value------------public-function-findbyorganizationorganizationid-organizationid-array------------return-this-entitymanager-------------getrepositoryuserclass-------------findbyorganizationid--organizationid-value------------public-function-deleteuserid-id-void------------user--this-findbyidid--------if-user-------------this-entitymanager-removeuser------------this-entitymanager-flush--------------------public-function-existsuserid-id-bool------------return-this-entitymanager-------------getrepositoryuserclass-------------countid--id-value--0------types-de-repositories-1-repository-de-commande-writephpinterface-paymentcommandrepository----public-function-savepayment-payment-void----public-function-findbyidpaymentid-id-payment----public-function-deletepaymentid-id-voidclass-doctrinepaymentcommandrepository-implements-paymentcommandrepository----public-function-savepayment-payment-void------------this-entitymanager-persistpayment--------this-entitymanager-flush------------public-function-findbyidpaymentid-id-payment------------return-this-entitymanager-------------getrepositorypaymentclass-------------findid-value-----2-repository-de-requ%c3%aate-readphpinterface-paymentqueryrepository----public-function-findpaymentdetailspaymentid-id-paymentdetailsview----public-function-findpaymentsbycustomercustomerid-customerid-array----public-function-findpaymentsbydaterangedaterange-daterange-array----public-function-findpendingpayments-arrayclass-doctrinepaymentqueryrepository-implements-paymentqueryrepository----public-function-findpaymentdetailspaymentid-id-paymentdetailsview------------result--this-entitymanager-------------createquery----------------select-pid-pamount-pstatus-pcreatedat-----------------------cname-as-customername-sname-as-subscriptionname----------------from-payment-p----------------join-pcustomer-c----------------join-psubscription-s----------------where-pid--id-------------------------setparameterid-id-value-------------getoneornullresult--------------------return-result--paymentdetailsviewfromarrayresult--null------------public-function-findpaymentsbycustomercustomerid-customerid-array------------return-this-entitymanager-------------createquery----------------select-pid-pamount-pstatus-pcreatedat----------------from-payment-p----------------where-pcustomerid--customerid----------------order-by-pcreatedat-desc-------------------------setparametercustomerid-customerid-value-------------getresult-----3-repository-sp%c3%a9cialis%c3%a9phpinterface-paymentanalyticsrepository----public-function-getmonthlyrevenueint-year-int-month-amount----public-function-getpaymenttrendsdaterange-daterange-array----public-function-gettopcustomersint-limit-arrayclass-elasticsearchpaymentanalyticsrepository-implements-paymentanalyticsrepository----public-function-getmonthlyrevenueint-year-int-month-amount------------query--------------query------------------bool----------------------must--------------------------term--status--completed------------------------range--createdat------------------------------gte--year-month-01----------------------------lt--year---month--1---01------------------------------------------------------------------------------------aggs------------------total_revenue----------------------sum--field--amount----------------------------------------------------result--this-elasticsearch-searchquery--------return-new-amountresultaggregationstotal_revenuevalue------patterns-avanc%c3%a9s-de-repository-1-repository-avec-sp%c3%a9cificationsphpinterface-specification----public-function-issatisfiedbyentity-bool----public-function-toquerybuilderquerybuilder-qb-querybuilderclass-userbyorganizationspecification-implements-specification----public-function-__construct--------private-organizationid-organizationid-------------public-function-issatisfiedbyentity-bool------------return-entity-instanceof-user-----------------entity-organizationid-equalsthis-organizationid------------public-function-toquerybuilderquerybuilder-qb-querybuilder------------return-qb-andwhereuorganizationid--organizationid-------------------setparameterorganizationid-this-organizationid-value----interface-userrepository----public-function-findbyspecificationspecification-spec-array----public-function-countbyspecificationspecification-spec-intclass-doctrineuserrepository-implements-userrepository----public-function-findbyspecificationspecification-spec-array------------qb--this-entitymanager-createquerybuilder-------------selectu-------------fromuserclass-u--------------------return-spec-toquerybuilderqb-getquery-getresult-----2-repository-avec-cachephpclass-cacheduserrepository-implements-userrepository----public-function-__construct--------private-userrepository-decorated--------private-cacheinterface-cache-------------public-function-findbyiduserid-id-user------------cachekey--user_id-value----------------return-this-cache-getcachekey-function--use-id-------------return-this-decorated-findbyidid--------------------public-function-saveuser-user-void------------this-decorated-saveuser-----------------invalider-le-cache--------this-cache-deleteuser_user-id-value-----3-repository-avec-event-sourcingphpinterface-eventstore----public-function-appendstreamid-streamid-array-events-void----public-function-geteventsstreamid-streamid-arrayclass-eventsourceduserrepository-implements-userrepository----public-function-__construct--------private-eventstore-eventstore-------------public-function-saveuser-user-void------------events--user-getuncommittedevents--------streamid--streamidfromuseriduser-id----------------this-eventstore-appendstreamid-events--------user-markeventsascommitted------------public-function-findbyiduserid-id-user------------streamid--streamidfromuseridid--------events--this-eventstore-geteventsstreamid----------------if-emptyevents-------------return-null------------------------return-userfromeventsevents------repositories-multi-sources-repository-avec-fallbackphpclass-fallbackuserrepository-implements-userrepository----public-function-__construct--------private-userrepository-primary--------private-userrepository-fallback-------------public-function-findbyiduserid-id-user------------try-------------return-this-primary-findbyidid---------catch-exception-e-------------this-logger-warningprimary-repository-failed-using-fallback-----------------error--e-getmessage----------------userid--id-value------------------------------------return-this-fallback-findbyidid-------------repository-avec-routingphpclass-routeduserrepository-implements-userrepository----public-function-__construct--------private-userrepository-sqlrepository--------private-userrepository-mongorepository-------------public-function-findbyiduserid-id-user-------------route-bas%c3%a9e-sur-lid--------if-this-shouldusemongoid-------------return-this-mongorepository-findbyidid------------------------return-this-sqlrepository-findbyidid------------private-function-shouldusemongouserid-id-bool-------------logique-de-routing-ex-utilisateurs-r%c3%a9cents-en-mongodb--------return-id-value--1000000------performance-et-optimisation-optimisations-de-requ%c3%aatephpclass-optimizeduserrepository-implements-userrepository----public-function-findbyorganizationorganizationid-organizationid-array-------------utiliser-des-requ%c3%aates-optimis%c3%a9es--------return-this-entitymanager-------------createquery----------------select-uid-uemail-ufirstname-ulastname----------------from-user-u----------------where-uorganizationid--organizationid----------------and-ustatus--status-------------------------setparameterorganizationid-organizationid-value-------------setparameterstatus-userstatusactive-------------setmaxresults100--limiter-les-r%c3%a9sultats-------------getresult-----optimisations-de-cachephpclass-smartcacheduserrepository-implements-userrepository----public-function-findbyorganizationorganizationid-organizationid-array------------cachekey--users_org_organizationid-value----------------return-this-cache-getcachekey-function--use-organizationid-------------users--this-decorated-findbyorganizationorganizationid-------------------------cache-individuel-pour-chaque-utilisateur------------foreach-users-as-user-----------------this-cache-setuser_user-id-value-user-3600------------------------------------return-users---------1800--ttl-de-30-minutes------quand-utiliser-les-repositories---cas-d--abstraction-de-persistance--changer-de-technologie-de-stockage--tests-unitaires--mocker-facilement-lacc%c3%a8s-aux-donn%c3%a9es--logique-m%c3%a9tier-complexe--encapsuler-la-logique-dacc%c3%a8s--performance--optimiser-les-requ%c3%aates--cas-d--applications-simples--crud-basique--over-engineering--complexit%c3%a9-inutile--performance-critique--overhead-des-abstractions--prototypage--d%c3%a9veloppement-rapide--migration-vers-les-repositories-%c3%a9tape-1--identifier-les-acc%c3%a8s-aux-donn%c3%a9es--lister-tous-les-acc%c3%a8s-aux-donn%c3%a9es--grouper-par-entit%c3%a9-m%c3%a9tier-%c3%a9tape-2--cr%c3%a9er-les-interfaces--d%c3%a9finir-les-contrats-repository--sp%c3%a9cifier-les-m%c3%a9thodes-n%c3%a9cessaires-%c3%a9tape-3--impl%c3%a9menter-les-repositories--cr%c3%a9er-les-impl%c3%a9mentations--migrer-progressivement-%c3%a9tape-4--optimiser--ajouter-le-cache-si-n%c3%a9cessaire--optimiser-les-requ%c3%aates--m%c3%a9triques-et-monitoring-m%c3%a9triques-repository--temps-de-r%c3%a9ponse-des-requ%c3%aates--taux-de-cache-hit--nombre-de-requ%c3%aates-par-seconde-m%c3%a9triques-de-performance--temps-de-traitement-des-requ%c3%aates-complexes--utilisation-m%c3%a9moire--charge-des-bases-de-donn%c3%a9es--prochaines-%c3%a9tapesmaintenant-que-vous-comprenez-les-repositories-explorez-1-cqrs--s%c3%a9parer-les-commandes-des-requ%c3%aates2-event-sourcing--stocker-les-%c3%a9v%c3%a9nements-comme-source-de-v%c3%a9rit%c3%a93-impl%c3%a9mentation-repositories--guide-dimpl%c3%a9mentation-completles-repositories-sont-la-pierre-angulaire-d class=anchor aria-hidden=true><i class="material-icons align-middle">link</i></a></h2></div></div><div><hr class=doc-hr><div id=doc-nav class=d-print-none><div class="row flex-xl-nowrap"><div class="col-sm-6 pt-2 doc-next"><a href=/patterns/event-sourcing/><div class="card h-100 my-1"><div class="card-body py-2"><p class="card-title fs-5 fw-semibold lh-base mb-0"><i class="material-icons align-middle">navigate_before</i> Event Sourcing - Stocker les Événements comme Source de Vérité</p></div></div></a></div></div></div></div></div></div></div></div><footer class="shadow py-3 d-print-none"><div class=container-fluid><div class="row align-items-center"><div class=col><div class="text-sm-start text-center mx-md-2"><p class=mb-0>© 2025 Grégory Planchat. Tous droits réservés.</p></div></div></div><div class="row mt-3 pt-3 border-top"><div class=col-12><div class=text-center><h6 class="text-muted mb-2">Nos Sponsors</h6><p class="text-muted small mb-2">Merci à nos partenaires qui soutiennent cette initiative</p><div class="d-flex justify-content-center align-items-center flex-wrap gap-3"><div class=sponsor-item><a href=https://kiboko.fr target=_blank rel="noopener noreferrer" class="text-decoration-none d-inline-block"><img src=/logo-kiboko-fr.svg alt=Kiboko width=120 height=60 style=display:block;max-width:120px;height:auto></a></div><div class=sponsor-item><a href=https://gyroscops.com target=_blank rel="noopener noreferrer" class="text-decoration-none d-inline-block"><img src=/logo-gyroscops.svg alt=Gyroscops width=120 height=60 style=display:block;max-width:120px;height:auto></a></div></div></div></div></div></div></footer></main></div></div><button onclick=topFunction() id=back-to-top aria-label="Back to Top Button" class="back-to-top fs-5"><svg width="24" height="24"><path d="M12 10.224l-6.3 6.3-1.38-1.372L12 7.472l7.68 7.68-1.38 1.376z" style="fill:#fff"/></svg></button>
<script src=/docs/js/bootstrap.c7927bdd82eceb076739257add3f4b0e11379da037c07d5c7110daeb6de0e3edcb2de867604550f88815157e4ec4ddb7.js integrity=sha384-x5J73YLs6wdnOSV63T9LDhE3naA3wH1ccRDa623g4+3LLehnYEVQ+IgVFX5OxN23 defer></script><script type=text/javascript src=https://votre-domaine.fr/docs/js/bundle.min.a046e72674401a45bf99217648934a99ff03a7c46d105e47916156e66969388a0643f55a1e850acb495c9bd8be985171.js integrity=sha384-oEbnJnRAGkW/mSF2SJNKmf8Dp8RtEF5HkWFW5mlpOIoGQ/VaHoUKy0lcm9i+mFFx crossorigin=anonymous defer></script><script type=module>
    var suggestions = document.getElementById('suggestions');
    var search = document.getElementById('flexsearch');

    const flexsearchContainer = document.getElementById('FlexSearchCollapse');

    const hideFlexsearchBtn = document.getElementById('hideFlexsearch');

    const configObject = { toggle: false }
    const flexsearchContainerCollapse = new Collapse(flexsearchContainer, configObject) 

    if (search !== null) {
        document.addEventListener('keydown', inputFocus);
        flexsearchContainer.addEventListener('shown.bs.collapse', function () {
            search.focus();
        });
        
        var topHeader = document.getElementById("top-header");
        document.addEventListener('click', function(elem) {
            if (!flexsearchContainer.contains(elem.target) && !topHeader.contains(elem.target))
                flexsearchContainerCollapse.hide();
        });
    }

    hideFlexsearchBtn.addEventListener('click', () =>{
        flexsearchContainerCollapse.hide()
    })

    function inputFocus(e) {
        if (e.ctrlKey && e.key === '/') {
            e.preventDefault();
            flexsearchContainerCollapse.toggle();
        }
        if (e.key === 'Escape' ) {
            search.blur();
            
            flexsearchContainerCollapse.hide();
        }
    };

    document.addEventListener('click', function(event) {

    var isClickInsideElement = suggestions.contains(event.target);

    if (!isClickInsideElement) {
        suggestions.classList.add('d-none');
    }

    });

    


    document.addEventListener('keydown',suggestionFocus);

    function suggestionFocus(e) {
    const suggestionsHidden = suggestions.classList.contains('d-none');
    if (suggestionsHidden) return;

    const focusableSuggestions= [...suggestions.querySelectorAll('a')];
    if (focusableSuggestions.length === 0) return;

    const index = focusableSuggestions.indexOf(document.activeElement);

    if (e.key === "ArrowUp") {
        e.preventDefault();
        const nextIndex = index > 0 ? index - 1 : 0;
        focusableSuggestions[nextIndex].focus();
    }
    else if (e.key === "ArrowDown") {
        e.preventDefault();
        const nextIndex= index + 1 < focusableSuggestions.length ? index + 1 : index;
        focusableSuggestions[nextIndex].focus();
    }

    }

    


    (function(){

    var index = new FlexSearch.Document({
        
        tokenize: "forward",
        minlength:  0 ,
        cache:  100 ,
        optimize:  true ,
        document: {
        id: 'id',
        store: [
            "href", "title", "description"
        ],
        index: ["title", "description", "content"]
        }
    });


    


    
    


    

    

    search.addEventListener('input', show_results, true);

    function show_results(){
        const maxResult =  5 ;
        const minlength =  0 ;
        var searchQuery = sanitizeHTML(this.value);
        var results = index.search(searchQuery, {limit: maxResult, enrich: true});

        
        const flatResults = new Map(); 
        for (const result of results.flatMap(r => r.result)) {
        if (flatResults.has(result.doc.href)) continue;
        flatResults.set(result.doc.href, result.doc);
        }

        suggestions.innerHTML = "";
        suggestions.classList.remove('d-none');

        
        if (searchQuery.length < minlength) {
            const minCharMessage = document.createElement('div')
            minCharMessage.innerHTML = `Please type at least <strong>${minlength}</strong> characters`
            minCharMessage.classList.add("suggestion__no-results");
            suggestions.appendChild(minCharMessage);
            return;
        } else {
            
            if (flatResults.size === 0 && searchQuery) {
                const noResultsMessage = document.createElement('div')
                noResultsMessage.innerHTML = "No results for" + ` "<strong>${searchQuery}</strong>"`
                noResultsMessage.classList.add("suggestion__no-results");
                suggestions.appendChild(noResultsMessage);
                return;
            }
        }

        
        for(const [href, doc] of flatResults) {
            const entry = document.createElement('div');
            suggestions.appendChild(entry);

            const a = document.createElement('a');
            a.href = href;
            entry.appendChild(a);

            const title = document.createElement('span');
            title.textContent = doc.title;
            title.classList.add("suggestion__title");
            a.appendChild(title);

            const description = document.createElement('span');
            description.textContent = doc.description;
            description.classList.add("suggestion__description");
            a.appendChild(description);

            suggestions.appendChild(entry);

            if(suggestions.childElementCount == maxResult) break;
        }
    }
    }());
</script></body></html>