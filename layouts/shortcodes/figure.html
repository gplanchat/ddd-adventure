{{/*
Shortcode figure personnalisé avec support du zoom pour les SVG
Usage: {{< figure src="/images/..." title="..." >}}
*/}}

{{ $src := .Get "src" }}
{{ $title := .Get "title" }}
{{ $alt := .Get "alt" | default $title }}
{{ $caption := .Get "caption" | default $title }}
{{ $isSvg := strings.HasSuffix $src ".svg" }}

<figure class="figure-container {{ if $isSvg }}figure-svg-zoomable{{ end }}">
  {{ if $isSvg }}
  <div class="svg-zoom-wrapper">
    <div class="svg-zoom-controls">
      <button class="svg-zoom-btn svg-zoom-in" title="Zoomer" aria-label="Zoomer">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="M21 21l-4.35-4.35"></path>
          <line x1="11" y1="8" x2="11" y2="14"></line>
          <line x1="8" y1="11" x2="14" y2="11"></line>
        </svg>
      </button>
      <button class="svg-zoom-btn svg-zoom-out" title="Dézoomer" aria-label="Dézoomer">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"></circle>
          <path d="M21 21l-4.35-4.35"></path>
          <line x1="8" y1="11" x2="14" y2="11"></line>
        </svg>
      </button>
      <button class="svg-zoom-btn svg-zoom-reset" title="Réinitialiser" aria-label="Réinitialiser le zoom">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M1 4v6h6"></path>
          <path d="M23 20v-6h-6"></path>
          <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path>
        </svg>
      </button>
      <button class="svg-zoom-btn svg-zoom-fullscreen" title="Plein écran" aria-label="Basculer en plein écran">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path>
        </svg>
      </button>
    </div>
    <div class="svg-pan-container">
      <img src="{{ $src }}" alt="{{ $alt }}" class="svg-zoomable-image" draggable="false" />
    </div>
  </div>
  {{ else }}
  <img src="{{ $src }}" alt="{{ $alt }}" />
  {{ end }}
  
  {{ if $caption }}
  <figcaption>{{ $caption | markdownify }}</figcaption>
  {{ end }}
</figure>

{{ if $isSvg }}
<script>
(function() {
  // Initialiser le zoom pour toutes les figures SVG
  document.querySelectorAll('.figure-svg-zoomable').forEach(function(figure) {
    const container = figure.querySelector('.svg-pan-container');
    const img = figure.querySelector('.svg-zoomable-image');
    const zoomInBtn = figure.querySelector('.svg-zoom-in');
    const zoomOutBtn = figure.querySelector('.svg-zoom-out');
    const resetBtn = figure.querySelector('.svg-zoom-reset');
    const fullscreenBtn = figure.querySelector('.svg-zoom-fullscreen');
    
    let scale = 1;
    let translateX = 0;
    let translateY = 0;
    let isDragging = false;
    let startX = 0;
    let startY = 0;
    
    const MIN_SCALE = 0.5;
    const MAX_SCALE = 5;
    const ZOOM_STEP = 0.2;
    
    function updateTransform() {
      img.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
    }
    
    function zoom(delta) {
      const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, scale + delta));
      
      if (newScale !== scale) {
        // Calculer le centre de l'image visible
        const rect = container.getBoundingClientRect();
        const centerX = rect.width / 2;
        const centerY = rect.height / 2;
        
        // Ajuster la translation pour zoomer vers le centre
        const scaleRatio = newScale / scale;
        translateX = centerX - (centerX - translateX) * scaleRatio;
        translateY = centerY - (centerY - translateY) * scaleRatio;
        
        scale = newScale;
        updateTransform();
      }
    }
    
    function reset() {
      scale = 1;
      translateX = 0;
      translateY = 0;
      updateTransform();
    }
    
    function toggleFullscreen() {
      const wrapper = figure.querySelector('.svg-zoom-wrapper');
      
      if (!document.fullscreenElement) {
        if (wrapper.requestFullscreen) {
          wrapper.requestFullscreen();
        } else if (wrapper.webkitRequestFullscreen) {
          wrapper.webkitRequestFullscreen();
        } else if (wrapper.msRequestFullscreen) {
          wrapper.msRequestFullscreen();
        }
      } else {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.webkitExitFullscreen) {
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          document.msExitFullscreen();
        }
      }
    }
    
    // Event listeners pour les boutons
    zoomInBtn.addEventListener('click', function() { zoom(ZOOM_STEP); });
    zoomOutBtn.addEventListener('click', function() { zoom(-ZOOM_STEP); });
    resetBtn.addEventListener('click', reset);
    fullscreenBtn.addEventListener('click', toggleFullscreen);
    
    // Zoom avec la molette de souris
    container.addEventListener('wheel', function(e) {
      e.preventDefault();
      const delta = e.deltaY > 0 ? -ZOOM_STEP : ZOOM_STEP;
      zoom(delta);
    }, { passive: false });
    
    // Pan avec la souris (drag)
    img.addEventListener('mousedown', function(e) {
      if (scale > 1) {
        isDragging = true;
        startX = e.clientX - translateX;
        startY = e.clientY - translateY;
        img.style.cursor = 'grabbing';
        e.preventDefault();
      }
    });
    
    document.addEventListener('mousemove', function(e) {
      if (isDragging) {
        translateX = e.clientX - startX;
        translateY = e.clientY - startY;
        updateTransform();
      }
    });
    
    document.addEventListener('mouseup', function() {
      if (isDragging) {
        isDragging = false;
        img.style.cursor = scale > 1 ? 'grab' : 'default';
      }
    });
    
    // Touch support pour mobile
    let touchStartDistance = 0;
    let touchStartScale = 1;
    
    container.addEventListener('touchstart', function(e) {
      if (e.touches.length === 2) {
        e.preventDefault();
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        touchStartDistance = Math.sqrt(dx * dx + dy * dy);
        touchStartScale = scale;
      } else if (e.touches.length === 1 && scale > 1) {
        isDragging = true;
        startX = e.touches[0].clientX - translateX;
        startY = e.touches[0].clientY - translateY;
      }
    }, { passive: false });
    
    container.addEventListener('touchmove', function(e) {
      if (e.touches.length === 2) {
        e.preventDefault();
        const dx = e.touches[0].clientX - e.touches[1].clientX;
        const dy = e.touches[0].clientY - e.touches[1].clientY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, touchStartScale * (distance / touchStartDistance)));
        scale = newScale;
        updateTransform();
      } else if (e.touches.length === 1 && isDragging) {
        e.preventDefault();
        translateX = e.touches[0].clientX - startX;
        translateY = e.touches[0].clientY - startY;
        updateTransform();
      }
    }, { passive: false });
    
    container.addEventListener('touchend', function(e) {
      if (e.touches.length === 0) {
        isDragging = false;
      }
    });
    
    // Mettre à jour le curseur selon le zoom
    img.style.cursor = scale > 1 ? 'grab' : 'default';
  });
})();
</script>

<style>
.figure-container {
  margin: 2rem 0;
  text-align: center;
}

.figure-svg-zoomable {
  position: relative;
  margin: 2rem auto;
  max-width: 100%;
}

.svg-zoom-wrapper {
  position: relative;
  border: 1px solid #e2e8f0;
  border-radius: 8px;
  overflow: hidden;
  background: #f8f9fa;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.svg-zoom-wrapper:fullscreen {
  background: #1a1a1a;
}

.svg-zoom-wrapper:-webkit-full-screen {
  background: #1a1a1a;
}

.svg-zoom-wrapper:-moz-full-screen {
  background: #1a1a1a;
}

.svg-zoom-wrapper:-ms-fullscreen {
  background: #1a1a1a;
}

.svg-zoom-controls {
  position: absolute;
  top: 1rem;
  right: 1rem;
  z-index: 10;
  display: flex;
  gap: 0.5rem;
  background: rgba(255, 255, 255, 0.95);
  padding: 0.5rem;
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

.svg-zoom-wrapper:fullscreen .svg-zoom-controls,
.svg-zoom-wrapper:-webkit-full-screen .svg-zoom-controls,
.svg-zoom-wrapper:-moz-full-screen .svg-zoom-controls,
.svg-zoom-wrapper:-ms-fullscreen .svg-zoom-controls {
  background: rgba(0, 0, 0, 0.8);
}

.svg-zoom-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border: none;
  background: #f8f9fa;
  color: #334155;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  padding: 0;
}

.svg-zoom-btn:hover {
  background: #3b82f6;
  color: white;
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.svg-zoom-btn:active {
  transform: translateY(0);
}

.svg-zoom-wrapper:fullscreen .svg-zoom-btn,
.svg-zoom-wrapper:-webkit-full-screen .svg-zoom-btn,
.svg-zoom-wrapper:-moz-full-screen .svg-zoom-btn,
.svg-zoom-wrapper:-ms-fullscreen .svg-zoom-btn {
  background: rgba(255, 255, 255, 0.1);
  color: white;
}

.svg-zoom-wrapper:fullscreen .svg-zoom-btn:hover,
.svg-zoom-wrapper:-webkit-full-screen .svg-zoom-btn:hover,
.svg-zoom-wrapper:-moz-full-screen .svg-zoom-btn:hover,
.svg-zoom-wrapper:-ms-fullscreen .svg-zoom-btn:hover {
  background: rgba(59, 130, 246, 0.8);
}

.svg-pan-container {
  position: relative;
  width: 100%;
  min-height: 400px;
  overflow: hidden;
  touch-action: none;
  display: flex;
  align-items: center;
  justify-content: center;
}

.svg-zoom-wrapper:fullscreen .svg-pan-container,
.svg-zoom-wrapper:-webkit-full-screen .svg-pan-container,
.svg-zoom-wrapper:-moz-full-screen .svg-pan-container,
.svg-zoom-wrapper:-ms-fullscreen .svg-pan-container {
  height: 100vh;
}

.svg-zoomable-image {
  max-width: 100%;
  height: auto;
  transition: transform 0.1s ease-out;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}

figcaption {
  margin-top: 0.75rem;
  font-size: 0.9rem;
  color: #64748b;
  font-style: italic;
  padding: 0 1rem;
}

/* Responsive */
@media (max-width: 768px) {
  .svg-zoom-controls {
    top: 0.5rem;
    right: 0.5rem;
    padding: 0.25rem;
    gap: 0.25rem;
  }
  
  .svg-zoom-btn {
    width: 32px;
    height: 32px;
  }
  
  .svg-pan-container {
    min-height: 300px;
  }
}

/* Message d'aide au survol */
.svg-pan-container::after {
  content: 'Utilisez la molette de souris pour zoomer, cliquez et glissez pour déplacer';
  position: absolute;
  bottom: 1rem;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.7);
  color: white;
  padding: 0.5rem 1rem;
  border-radius: 6px;
  font-size: 0.8rem;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
}

.svg-zoom-wrapper:hover .svg-pan-container::after {
  opacity: 1;
}

.svg-zoom-wrapper:fullscreen .svg-pan-container::after,
.svg-zoom-wrapper:-webkit-full-screen .svg-pan-container::after,
.svg-zoom-wrapper:-moz-full-screen .svg-pan-container::after,
.svg-zoom-wrapper:-ms-fullscreen .svg-pan-container::after {
  display: none;
}

@media (max-width: 768px) {
  .svg-pan-container::after {
    content: 'Pincez pour zoomer';
    font-size: 0.75rem;
    padding: 0.4rem 0.8rem;
  }
}
</style>
{{ end }}

