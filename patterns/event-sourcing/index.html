<!doctype html><html lang=fr-fr><head><meta charset=utf-8><title>Event Sourcing - Stocker les Ã‰vÃ©nements comme Source de VÃ©ritÃ© | DDD Adventure</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="DÃ©couvrez Event Sourcing, le pattern qui stocke les Ã©vÃ©nements mÃ©tier comme source de vÃ©ritÃ© pour une traÃ§abilitÃ© complÃ¨te"><meta name=keywords content="Documentation,Hugo,Hugo Theme,Bootstrap"><meta name=author content="Colin Wilson - Lotus Labs"><meta name=email content="support@aigis.uk"><meta name=website content="https://lotusdocs.dev"><meta name=Version content="v0.1.0"><link rel=icon href=https://votre-domaine.fr/favicon.ico sizes=any><link rel=icon type=image/svg+xml href=https://votre-domaine.fr/favicon.svg><link rel=apple-touch-icon sizes=180x180 href=https://votre-domaine.fr/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://votre-domaine.fr/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://votre-domaine.fr/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://votre-domaine.fr/site.webmanifest><meta property="og:title" content="Event Sourcing - Stocker les Ã‰vÃ©nements comme Source de VÃ©ritÃ©"><meta property="og:description" content="DÃ©couvrez Event Sourcing, le pattern qui stocke les Ã©vÃ©nements mÃ©tier comme source de vÃ©ritÃ© pour une traÃ§abilitÃ© complÃ¨te"><meta property="og:type" content="article"><meta property="og:url" content="https://votre-domaine.fr/patterns/event-sourcing/"><meta property="og:image" content="https://votre-domaine.fr/opengraph/card-base-2_hu_fcb07a20e7579b4.png"><meta property="article:section" content="patterns"><meta property="article:published_time" content="2024-12-19T00:00:00+00:00"><meta property="article:modified_time" content="2024-12-19T00:00:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://votre-domaine.fr/opengraph/card-base-2_hu_fcb07a20e7579b4.png"><meta name=twitter:title content="Event Sourcing - Stocker les Ã‰vÃ©nements comme Source de VÃ©ritÃ©"><meta name=twitter:description content="DÃ©couvrez Event Sourcing, le pattern qui stocke les Ã©vÃ©nements mÃ©tier comme source de vÃ©ritÃ© pour une traÃ§abilitÃ© complÃ¨te"><link rel=alternate type=application/atom+xml title="Atom feed for DDD Adventure" href=/index.xml><script type=text/javascript src=https://votre-domaine.fr/docs/js/flexsearch.bundle.min.f5159d5a2151ffbb653996ec17eaff7da4e04c286bd879fc41839d36a5586f3f20eaead0b6089de48f9adc669cdee771.js integrity=sha384-9RWdWiFR/7tlOZbsF+r/faTgTChr2Hn8QYOdNqVYbz8g6urQtgid5I+a3Gac3udx crossorigin=anonymous></script><link rel=stylesheet href=/docs/scss/style.min.3377194a2707d3dadf7a16321e3f45dec030951decd2b724d6e046d8a72467cab3654273b75f2768a9a72140ee026ecf.css integrity=sha384-M3cZSicH09rfehYyHj9F3sAwlR3s0rck1uBG2KckZ8qzZUJzt18naKmnIUDuAm7P crossorigin=anonymous></head><body><div class=content><div class="page-wrapper toggled"><nav id=sidebar class=sidebar-wrapper><div class=sidebar-brand><a href=/ aria-label=HomePage alt=HomePage><svg id="Layer_1" viewBox="0 0 250 250"><path d="m143 39.5c-18 0-18 18-18 18s0-18-18-18H22c-2.76.0-5 2.24-5 5v143c0 2.76 2.24 5 5 5h76c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h76c2.76.0 5-2.24 5-5V44.5c0-2.76-2.24-5-5-5h-85zM206 163c0 1.38-1.12 2.5-2.5 2.5H143c-18 0-18 18-18 18s0-18-18-18H46.5c-1.38.0-2.5-1.12-2.5-2.5V69c0-1.38 1.12-2.5 2.5-2.5H98c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h51.5c1.38.0 2.5 1.12 2.5 2.5v94z" style="fill:#06f"/></svg></a></div><div class=sidebar-content style="height:calc(100% - 131px)"><ul class=sidebar-menu><li><a class=sidebar-root-link href=https://votre-domaine.fr/patterns/cqrs/>CQRS - Command Query Responsibility Segregation</a></li><li class=current><a class=sidebar-root-link href=https://votre-domaine.fr/patterns/event-sourcing/>Event Sourcing - Stocker les Ã‰vÃ©nements comme Source de VÃ©ritÃ©</a></li><li><a class=sidebar-root-link href=https://votre-domaine.fr/patterns/repositories/>Repositories - Patterns de Persistance</a></li></ul></div><ul class="sidebar-footer list-unstyled mb-0"></ul></nav><main class="page-content bg-transparent"><div id=top-header class="top-header d-print-none"><div class="header-bar d-flex justify-content-between"><div class="d-flex align-items-center"><a href=/ class="logo-icon me-3" aria-label=HomePage alt=HomePage><div class=small><svg id="Layer_1" viewBox="0 0 250 250"><path d="m143 39.5c-18 0-18 18-18 18s0-18-18-18H22c-2.76.0-5 2.24-5 5v143c0 2.76 2.24 5 5 5h76c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h76c2.76.0 5-2.24 5-5V44.5c0-2.76-2.24-5-5-5h-85zM206 163c0 1.38-1.12 2.5-2.5 2.5H143c-18 0-18 18-18 18s0-18-18-18H46.5c-1.38.0-2.5-1.12-2.5-2.5V69c0-1.38 1.12-2.5 2.5-2.5H98c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h51.5c1.38.0 2.5 1.12 2.5 2.5v94z" style="fill:#06f"/></svg></div><div class=big><svg id="Layer_1" viewBox="0 0 250 250"><path d="m143 39.5c-18 0-18 18-18 18s0-18-18-18H22c-2.76.0-5 2.24-5 5v143c0 2.76 2.24 5 5 5h76c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h76c2.76.0 5-2.24 5-5V44.5c0-2.76-2.24-5-5-5h-85zM206 163c0 1.38-1.12 2.5-2.5 2.5H143c-18 0-18 18-18 18s0-18-18-18H46.5c-1.38.0-2.5-1.12-2.5-2.5V69c0-1.38 1.12-2.5 2.5-2.5H98c7.2.0 8.64 11.52 8.93 16.13.07 1.05.95 1.87 2 1.87h32.14c1.06.0 1.94-.82 2-1.87.29-4.61 1.73-16.13 8.93-16.13h51.5c1.38.0 2.5 1.12 2.5 2.5v94z" style="fill:#06f"/></svg></div></a><button id=close-sidebar class="btn btn-icon btn-soft">
<span class="material-icons size-20 menu-icon align-middle">menu</span>
</button>
<button id=flexsearch-button class="ms-3 btn btn-soft" data-bs-toggle=collapse data-bs-target=#FlexSearchCollapse aria-expanded=false aria-controls=FlexSearchCollapse>
<span class="material-icons size-20 menu-icon align-middle">search</span>
<span class="flexsearch-button-placeholder ms-1 me-2 d-none d-sm-block">Search</span><div class="d-none d-sm-block"><span class=flexsearch-button-keys><kbd class=flexsearch-button-cmd-key><svg width="44" height="15"><path d="M2.118 11.5A1.519 1.519.0 011 11.042 1.583 1.583.0 011 8.815a1.519 1.519.0 011.113-.458h.715V6.643h-.71A1.519 1.519.0 011 6.185 1.519 1.519.0 01.547 5.071 1.519 1.519.0 011 3.958 1.519 1.519.0 012.118 3.5a1.519 1.519.0 011.114.458A1.519 1.519.0 013.69 5.071v.715H5.4V5.071A1.564 1.564.0 016.976 3.5 1.564 1.564.0 018.547 5.071 1.564 1.564.0 016.976 6.643H6.261V8.357h.715a1.575 1.575.0 011.113 2.685 1.583 1.583.0 01-2.227.0A1.519 1.519.0 015.4 9.929V9.214H3.69v.715a1.519 1.519.0 01-.458 1.113A1.519 1.519.0 012.118 11.5zm0-.857a.714.714.0 00.715-.714V9.214H2.118a.715.715.0 100 1.429zm4.858.0a.715.715.0 100-1.429H6.261v.715a.714.714.0 00.715.714zM3.69 8.357H5.4V6.643H3.69zM2.118 5.786h.715V5.071a.714.714.0 00-.715-.714.715.715.0 00-.5 1.22A.686.686.0 002.118 5.786zm4.143.0h.715a.715.715.0 00.5-1.22.715.715.0 00-1.22.5z" fill="currentColor"/><path d="M12.4 11.475H11.344l3.879-7.95h1.056z" fill="currentColor"/><path d="M25.073 5.384l-.864.576a2.121 2.121.0 00-1.786-.923 2.207 2.207.0 00-2.266 2.326 2.206 2.206.0 002.266 2.325 2.1 2.1.0 001.782-.918l.84.617a3.108 3.108.0 01-2.622 1.293 3.217 3.217.0 01-3.349-3.317 3.217 3.217.0 013.349-3.317A3.046 3.046.0 0125.073 5.384z" fill="currentColor"/><path d="M30.993 5.142h-2.07v5.419H27.891V5.142h-2.07V4.164h5.172z" fill="currentColor"/><path d="M34.67 4.164c1.471.0 2.266.658 2.266 1.851.0 1.087-.832 1.809-2.134 1.855l2.107 2.691h-1.28L33.591 7.87H33.07v2.691H32.038v-6.4zm-1.6.969v1.8h1.572c.832.0 1.22-.3 1.22-.918s-.411-.882-1.22-.882z" fill="currentColor"/><path d="M42.883 10.561H38.31v-6.4h1.033V9.583h3.54z" fill="currentColor"/></svg>
</kbd><kbd class=flexsearch-button-key><svg width="15" height="15"><path d="M5.926 12.279H4.41L9.073 2.721H10.59z" fill="currentColor"/></svg></kbd></span></div></button></div><div class="d-flex align-items-center"><ul class="list-unstyled mb-0"><li class="list-inline-item mb-0"><a href=https://twitter.com/gplanchat alt=twitter rel="noopener noreferrer" target=_blank><div class="btn btn-icon btn-default border-0"><svg width="24" height="24" viewBox="0 0 24 24"><title>Twitter / X</title><path d="M.088.768l9.266 12.39L.029 23.231h2.1l8.163-8.819 6.6 8.819h7.142L14.242 10.145 22.921.768h-2.1L13.3 8.891 7.229.768zM3.174 2.314H6.455L20.942 21.685h-3.28z" fill="currentColor"/></svg></div></a></li></ul></div></div><div class=collapse id=FlexSearchCollapse><div class=flexsearch-container><div class=flexsearch-keymap><li><kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Arrow down" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 3.5v8m3-3-3 3-3-3"/></g></svg></kbd>
<kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Arrow up" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M7.5 11.5v-8m3 3-3-3-3 3"/></g></svg></kbd>
<span class=flexsearch-key-label>to navigate</span></li><li><kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Enter key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M12 3.53088v3c0 1-1 2-2 2H4m3 3-3-3 3-3"/></g></svg></kbd>
<span class=flexsearch-key-label>to select</span></li><li><kbd class=flexsearch-button-cmd-key><svg width="15" height="15" aria-label="Escape key" role="img"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.2"><path d="M13.6167 8.936c-.1065.3583-.6883.962-1.4875.962-.7993.0-1.653-.9165-1.653-2.1258v-.5678c0-1.2548.7896-2.1016 1.653-2.1016s1.3601.4778 1.4875 1.0724M9 6c-.1352-.4735-.7506-.9219-1.46-.8972-.7092.0246-1.344.57-1.344 1.2166s.4198.8812 1.3445.9805C8.465 7.3992 8.968 7.9337 9 8.5s-.454 1.398-1.4595 1.398C6.6593 9.898 6 9 5.963 8.4851m-1.4748.5368c-.2635.5941-.8099.876-1.5443.876s-1.7073-.6248-1.7073-2.204v-.4603c0-1.0416.721-2.131 1.7073-2.131.9864.0 1.6425 1.031 1.5443 2.2492h-2.956"/></g></svg></kbd>
<span class=flexsearch-key-label>to close</span></li></div><form class="flexsearch position-relative flex-grow-1 ms-2 me-2"><div class="d-flex flex-row"><input id=flexsearch class=form-control type=search placeholder=Search aria-label=Search autocomplete=off>
<button id=hideFlexsearch type=button class="ms-2 btn btn-soft">
cancel</button></div><div id=suggestions class="shadow rounded-1 d-none"></div></form></div></div></div><div class=container-fluid><div class=layout-spacing><div class="d-md-flex justify-content-between align-items-center"><nav aria-label=breadcrumb class="d-inline-block pb-2 mt-1 mt-sm-0"><ul id=breadcrumbs class="breadcrumb bg-transparent mb-0" itemscope itemtype=https://schema.org/BreadcrumbList><li class="breadcrumb-item text-capitalize active" aria-current=page itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><a itemprop=item href=/patterns/><i class="material-icons size-20 align-text-bottom" itemprop=name>Home</i>
</a><meta itemprop=position content='1'></li><li class="breadcrumb-item text-capitalize active" itemprop=itemListElement itemscope itemtype=https://schema.org/ListItem><span itemprop=name>Event Sourcing - Stocker les Ã‰vÃ©nements comme Source de VÃ©ritÃ©</span>
<meta itemprop=position content='2'></li></ul></nav></div><div class="row flex-xl-nowrap"><div class="docs-toc col-xl-3 d-xl-block"><toc><div class="fw-bold text-uppercase mb-2">On this page</div><nav id=TableOfContents><ul><li><a href=#-quest-ce-que-levent-sourcing-event-sourcing-est-un-pattern-architectural-qui-stocke-les-Ã©vÃ©nements-mÃ©tier-comme-source-de-vÃ©ritÃ©-plutÃ´t-que-lÃ©tat-actuel-des-entitÃ©s-le-principe-fondamental-lÃ©tat-dune-entitÃ©-est-la-consÃ©quence-de-tous-les-Ã©vÃ©nements-qui-lui-sont-arrivÃ©sau-lieu-de-stocker-lÃ©tat-actuel-on-stocke---tous-les-Ã©vÃ©nements-qui-ont-modifiÃ©-lentitÃ©--l-de-ces-Ã©vÃ©nements--les-mÃ©tadonnÃ©es-associÃ©es-Ã -chaque-Ã©vÃ©nement--event-sourcing-dans-gyroscops-contexte-mÃ©tier--gestion-des-abonnementsdans-gyroscops-un-abonnement-passe-par-plusieurs-Ã©tats--Ã©vÃ©nements-mÃ©tierphp-Ã©vÃ©nement--abonnement-crÃ©Ã©class-subscriptioncreated-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-planid-planid--------public-readonly-customerid-customerid--------public-readonly-datetime-createdat--------public-readonly-billingcycle-billingcycle------Ã©vÃ©nement--abonnement-activÃ©class-subscriptionactivated-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-datetime-activatedat--------public-readonly-datetime-nextbillingdate------Ã©vÃ©nement--paiement-traitÃ©class-paymentprocessed-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-paymentid-paymentid--------public-readonly-amount-amount--------public-readonly-datetime-processedat------Ã©vÃ©nement--abonnement-suspenduclass-subscriptionsuspended-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-string-reason--------public-readonly-datetime-suspendedat------reconstruction-de-lphpclass-subscription----private-subscriptionid-id----private-subscriptionstatus-status----private-datetime-nextbillingdate----private-array-payments----------public-static-function-fromeventsarray-events-self------------subscription--new-self----------------foreach-events-as-event-------------subscription-applyevent------------------------return-subscription------------private-function-applydomainevent-event-void------------match-eventclass-------------subscriptioncreatedclass--this-applysubscriptioncreatedevent------------subscriptionactivatedclass--this-applysubscriptionactivatedevent------------paymentprocessedclass--this-applypaymentprocessedevent------------subscriptionsuspendedclass--this-applysubscriptionsuspendedevent--------------------private-function-applysubscriptioncreatedsubscriptioncreated-event-void------------this-id--event-subscriptionid--------this-status--subscriptionstatuspending--------this-nextbillingdate--event-createdat-addevent-billingcycle-interval------------private-function-applysubscriptionactivatedsubscriptionactivated-event-void------------this-status--subscriptionstatusactive--------this-nextbillingdate--event-nextbillingdate------------private-function-applypaymentprocessedpaymentprocessed-event-void------------this-payments--event-paymentid--------this-nextbillingdate--this-nextbillingdate-addthis-billingcycle-interval------------private-function-applysubscriptionsuspendedsubscriptionsuspended-event-void------------this-status--subscriptionstatussuspended------avantages-de-l-1-traÃ§abilitÃ©-complÃ¨te--historique-complet--tous-les-changements-sont-enregistrÃ©s--audit-trail--qui-a-fait-quoi-et-quand--debugging--possibilitÃ©-de-rejouer-lhistorique-2-flexibilitÃ©-temporelle--time-travel--voir-lÃ©tat-Ã -nimporte-quel-moment--replay--rejouer-les-Ã©vÃ©nements-pour-tester--debugging--comprendre-comment-on-est-arrivÃ©-Ã -un-Ã©tat-3-Ã©volutivitÃ©--nouvelles-projections--crÃ©er-de-nouvelles-vues-sans-modifier-le-code-existant--migration--faciliter-les-migrations-de-donnÃ©es--analytics--analyser-lhistorique-des-Ã©vÃ©nements-4-cohÃ©rence-Ã©vÃ©nementielle--source-de-vÃ©ritÃ©-unique--les-Ã©vÃ©nements-sont-la-seule-source-de-vÃ©ritÃ©--intÃ©gritÃ©--impossible-de-corrompre-lhistorique--rÃ©conciliation--possibilitÃ©-de-dÃ©tecter-les-incohÃ©rences--implÃ©mentation-dans-gyroscops-structure-des-dossierssrcaccounting-domain----events-------subscriptioncreatedphp-------subscriptionactivatedphp-------paymentprocessedphp-------subscriptionsuspendedphp----subscriptionphp----eventstorephp-infrastructure----eventstore-------doctrineeventstorephp-------eventstorerepositoryphp----projections--------subscriptionprojectionphp--------paymentprojectionphp-application-----command--------activatesubscription-----query---------getsubscriptionhistory-event-storephpinterface-eventstore----public-function-appendstreamid-streamid-array-events-int-expectedversion-void----public-function-geteventsstreamid-streamid-array----public-function-geteventsfromversionstreamid-streamid-int-fromversion-arrayclass-doctrineeventstore-implements-eventstore----public-function-appendstreamid-streamid-array-events-int-expectedversion-void------------this-entitymanager-transactionalfunction--use-streamid-events-expectedversion--------------vÃ©rifier-la-version-attendue------------currentversion--this-getcurrentversionstreamid------------if-currentversion--expectedversion-----------------throw-new-concurrencyexceptionversion-mismatch-------------------------------------enregistrer-les-Ã©vÃ©nements------------foreach-events-as-event-----------------this-persisteventstreamid-event--------------------------------public-function-geteventsstreamid-streamid-array------------return-this-eventrepository-findbystreamidstreamid-----projectionsphpclass-subscriptionprojection----public-function-__construct--------private-subscriptionqueryrepository-queryrepository-------------public-function-handledomainevent-event-void------------match-eventclass-------------subscriptioncreatedclass--this-handlesubscriptioncreatedevent------------subscriptionactivatedclass--this-handlesubscriptionactivatedevent------------paymentprocessedclass--this-handlepaymentprocessedevent--------------------private-function-handlesubscriptioncreatedsubscriptioncreated-event-void------------this-queryrepository-createsubscriptionview------------event-subscriptionid------------event-planid------------event-customerid------------subscriptionstatuspending------------event-createdat--------------------private-function-handlesubscriptionactivatedsubscriptionactivated-event-void------------this-queryrepository-updatesubscriptionstatus------------event-subscriptionid------------subscriptionstatusactive------------event-nextbillingdate--------------patterns-avancÃ©s-avec-event-sourcing-1-snapshotsphpclass-subscriptionsnapshot----public-function-__construct--------public-readonly-subscriptionid-id--------public-readonly-subscriptionstatus-status--------public-readonly-datetime-nextbillingdate--------public-readonly-int-version-----class-snapshotservice----public-function-createsnapshotsubscription-subscription-subscriptionsnapshot------------return-new-subscriptionsnapshot------------subscription-id------------subscription-status------------subscription-nextbillingdate------------subscription-version--------------------public-function-restorefromsnapshotsubscriptionsnapshot-snapshot-array-events-subscription------------subscription--subscriptionfromsnapshotsnapshot-----------------appliquer-seulement-les-Ã©vÃ©nements-aprÃ¨s-le-snapshot--------eventsaftersnapshot--array_filter------------events------------fnevent--event-version--snapshot-version------------------------foreach-eventsaftersnapshot-as-event-------------subscription-applyevent------------------------return-subscription-----2-event-sourcing--cqrs--command-side--gÃ¨re-les-Ã©vÃ©nements-et-levent-store--query-side--lit-depuis-les-projections-3-event-sourcing--api-platform--ressources--exposer-les-Ã©vÃ©nements-via-lapi--validation--valider-les-Ã©vÃ©nements-avant-stockage--performance-et-optimisation-optimisations-de-l--indexation--index-sur-stream_id-et-version--partitioning--partitionner-par-stream_id--compression--compresser-les-anciens-Ã©vÃ©nements-optimisations-des-projections--snapshots--crÃ©er-des-snapshots-rÃ©guliers--projections-asynchrones--traiter-les-projections-en-arriÃ¨re-plan--cache--mettre-en-cache-les-projections-frÃ©quentes--quand-utiliser-l--cas-d--audit-critique--besoin-de-traÃ§abilitÃ©-complÃ¨te--compliance--rÃ©glementations-strictes--analytics--besoin-danalyser-lhistorique--debugging-complexe--systÃ¨mes-complexes-Ã -dÃ©boguer--cas-d--applications-simples--crud-basique--performance-critique--besoins-de-performance-extrÃªme--Ã©quipe-inexpÃ©rimentÃ©e--complexitÃ©-Ã©levÃ©e--prototypage--dÃ©veloppement-rapide--migration-vers-event-sourcing-Ã©tape-1--identifier-les-Ã©vÃ©nements-mÃ©tier--lister-tous-les-changements-dÃ©tat--grouper-par-contexte-mÃ©tier-Ã©tape-2--crÃ©er-l--choisir-la-technologie-de-stockage--implÃ©menter-les-interfaces-Ã©tape-3--migrer-les-agrÃ©gats--convertir-les-entitÃ©s-en-Ã©vÃ©nements--implÃ©menter-la-reconstruction-Ã©tape-4--crÃ©er-les-projections--crÃ©er-les-vues-de-lecture--implÃ©menter-la-synchronisation--mÃ©triques-et-monitoring-mÃ©triques-event-store--nombre-dÃ©vÃ©nements-par-seconde--taille-des-streams--temps-de-reconstruction-mÃ©triques-projections--dÃ©lai-de-traitement-des-Ã©vÃ©nements--taille-des-projections--performance-des-requÃªtes--prochaines-Ã©tapesmaintenant-que-vous-comprenez-levent-sourcing-explorez-1-cqrs--sÃ©parer-les-commandes-des-requÃªtes2-repositories--patterns-de-persistance3-implÃ©mentation-event-sourcing--guide-dimplÃ©mentation-completevent-sourcing-transforme-la-faÃ§on-dont-nous-pensons-la-persistance-dans-gyroscops-il-nous-a-permis-de-gÃ©rer-la-complexitÃ©-mÃ©tier-tout-en-gardant-une-traÃ§abilitÃ©-complÃ¨te-de-tous-les-changements>ğŸŒŸ **Quâ€™est-ce que lâ€™Event Sourcing ?**<strong>Event Sourcing</strong> est un pattern architectural qui stocke les <strong>Ã©vÃ©nements mÃ©tier</strong> comme source de vÃ©ritÃ©, plutÃ´t que lâ€™Ã©tat actuel des entitÃ©s.### <strong>Le Principe Fondamental</strong>> **â€œLâ€™Ã©tat dâ€™une entitÃ© est la consÃ©quence de tous les Ã©vÃ©nements qui lui sont arrivÃ©sâ€**Au lieu de stocker lâ€™Ã©tat actuel, on stocke :- <strong>Tous les Ã©vÃ©nements</strong> qui ont modifiÃ© lâ€™entitÃ©- <strong>Lâ€™ordre chronologique</strong> de ces Ã©vÃ©nements- <strong>Les mÃ©tadonnÃ©es</strong> associÃ©es Ã  chaque Ã©vÃ©nement## ğŸ—ï¸ <strong>Event Sourcing dans Gyroscops</strong>### <strong>Contexte MÃ©tier : Gestion des Abonnements</strong>Dans Gyroscops, un abonnement passe par plusieurs Ã©tats :#### <strong>Ã‰vÃ©nements MÃ©tier</strong><code>php// Ã‰vÃ©nement : Abonnement crÃ©Ã©class SubscriptionCreated implements DomainEvent{ public function __construct( public readonly SubscriptionId $subscriptionId, public readonly PlanId $planId, public readonly CustomerId $customerId, public readonly DateTime $createdAt, public readonly BillingCycle $billingCycle ) {}}// Ã‰vÃ©nement : Abonnement activÃ©class SubscriptionActivated implements DomainEvent{ public function __construct( public readonly SubscriptionId $subscriptionId, public readonly DateTime $activatedAt, public readonly DateTime $nextBillingDate ) {}}// Ã‰vÃ©nement : Paiement traitÃ©class PaymentProcessed implements DomainEvent{ public function __construct( public readonly SubscriptionId $subscriptionId, public readonly PaymentId $paymentId, public readonly Amount $amount, public readonly DateTime $processedAt ) {}}// Ã‰vÃ©nement : Abonnement suspenduclass SubscriptionSuspended implements DomainEvent{ public function __construct( public readonly SubscriptionId $subscriptionId, public readonly string $reason, public readonly DateTime $suspendedAt ) {}}</code>#### <strong>Reconstruction de lâ€™Ã‰tat</strong><code>phpclass Subscription{ private SubscriptionId $id; private SubscriptionStatus $status; private ?DateTime $nextBillingDate; private array $payments = []; public static function fromEvents(array $events): self { $subscription = new self(); foreach ($events as $event) { $subscription->apply($event); } return $subscription; } private function apply(DomainEvent $event): void { match ($event::class) { SubscriptionCreated::class => $this->applySubscriptionCreated($event), SubscriptionActivated::class => $this->applySubscriptionActivated($event), PaymentProcessed::class => $this->applyPaymentProcessed($event), SubscriptionSuspended::class => $this->applySubscriptionSuspended($event), }; } private function applySubscriptionCreated(SubscriptionCreated $event): void { $this->id = $event->subscriptionId; $this->status = SubscriptionStatus::PENDING; $this->nextBillingDate = $event->createdAt->add($event->billingCycle->interval()); } private function applySubscriptionActivated(SubscriptionActivated $event): void { $this->status = SubscriptionStatus::ACTIVE; $this->nextBillingDate = $event->nextBillingDate; } private function applyPaymentProcessed(PaymentProcessed $event): void { $this->payments[] = $event->paymentId; $this->nextBillingDate = $this->nextBillingDate->add($this->billingCycle->interval()); } private function applySubscriptionSuspended(SubscriptionSuspended $event): void { $this->status = SubscriptionStatus::SUSPENDED; }}</code>## ğŸ¯ <strong>Avantages de lâ€™Event Sourcing</strong>### <strong>1. TraÃ§abilitÃ© ComplÃ¨te</strong>- <strong>Historique complet</strong> : Tous les changements sont enregistrÃ©s- <strong>Audit trail</strong> : Qui a fait quoi et quand- <strong>Debugging</strong> : PossibilitÃ© de rejouer lâ€™historique### <strong>2. FlexibilitÃ© Temporelle</strong>- <strong>Time travel</strong> : Voir lâ€™Ã©tat Ã  nâ€™importe quel moment- <strong>Replay</strong> : Rejouer les Ã©vÃ©nements pour tester- <strong>Debugging</strong> : Comprendre comment on est arrivÃ© Ã  un Ã©tat### <strong>3. Ã‰volutivitÃ©</strong>- <strong>Nouvelles projections</strong> : CrÃ©er de nouvelles vues sans modifier le code existant- <strong>Migration</strong> : Faciliter les migrations de donnÃ©es- <strong>Analytics</strong> : Analyser lâ€™historique des Ã©vÃ©nements### <strong>4. CohÃ©rence Ã‰vÃ©nementielle</strong>- <strong>Source de vÃ©ritÃ© unique</strong> : Les Ã©vÃ©nements sont la seule source de vÃ©ritÃ©- <strong>IntÃ©gritÃ©</strong> : Impossible de corrompre lâ€™historique- <strong>RÃ©conciliation</strong> : PossibilitÃ© de dÃ©tecter les incohÃ©rences## ğŸ”§ <strong>ImplÃ©mentation dans Gyroscops</strong>### <strong>Structure des Dossiers</strong><code>src/Accounting/â”œâ”€â”€ Domain/â”‚ â”œâ”€â”€ Events/â”‚ â”‚ â”œâ”€â”€ SubscriptionCreated.phpâ”‚ â”‚ â”œâ”€â”€ SubscriptionActivated.phpâ”‚ â”‚ â”œâ”€â”€ PaymentProcessed.phpâ”‚ â”‚ â””â”€â”€ SubscriptionSuspended.phpâ”‚ â”œâ”€â”€ Subscription.phpâ”‚ â””â”€â”€ EventStore.phpâ”œâ”€â”€ Infrastructure/â”‚ â”œâ”€â”€ EventStore/â”‚ â”‚ â”œâ”€â”€ DoctrineEventStore.phpâ”‚ â”‚ â””â”€â”€ EventStoreRepository.phpâ”‚ â””â”€â”€ Projections/â”‚ â”œâ”€â”€ SubscriptionProjection.phpâ”‚ â””â”€â”€ PaymentProjection.phpâ””â”€â”€ Application/ â”œâ”€â”€ Command/ â”‚ â””â”€â”€ ActivateSubscription/ â””â”€â”€ Query/ â””â”€â”€ GetSubscriptionHistory/</code>### <strong>Event Store</strong><code>phpinterface EventStore{ public function append(StreamId $streamId, array $events, int $expectedVersion): void; public function getEvents(StreamId $streamId): array; public function getEventsFromVersion(StreamId $streamId, int $fromVersion): array;}class DoctrineEventStore implements EventStore{ public function append(StreamId $streamId, array $events, int $expectedVersion): void { $this->entityManager->transactional(function () use ($streamId, $events, $expectedVersion) { // VÃ©rifier la version attendue $currentVersion = $this->getCurrentVersion($streamId); if ($currentVersion !== $expectedVersion) { throw new ConcurrencyException('Version mismatch'); } // Enregistrer les Ã©vÃ©nements foreach ($events as $event) { $this->persistEvent($streamId, $event); } }); } public function getEvents(StreamId $streamId): array { return $this->eventRepository->findByStreamId($streamId); }}</code>### <strong>Projections</strong><code>phpclass SubscriptionProjection{ public function __construct( private SubscriptionQueryRepository $queryRepository ) {} public function handle(DomainEvent $event): void { match ($event::class) { SubscriptionCreated::class => $this->handleSubscriptionCreated($event), SubscriptionActivated::class => $this->handleSubscriptionActivated($event), PaymentProcessed::class => $this->handlePaymentProcessed($event), }; } private function handleSubscriptionCreated(SubscriptionCreated $event): void { $this->queryRepository->createSubscriptionView( $event->subscriptionId, $event->planId, $event->customerId, SubscriptionStatus::PENDING, $event->createdAt ); } private function handleSubscriptionActivated(SubscriptionActivated $event): void { $this->queryRepository->updateSubscriptionStatus( $event->subscriptionId, SubscriptionStatus::ACTIVE, $event->nextBillingDate ); }}</code>## ğŸš€ <strong>Patterns AvancÃ©s avec Event Sourcing</strong>### <strong>1. Snapshots</strong><code>phpclass SubscriptionSnapshot{ public function __construct( public readonly SubscriptionId $id, public readonly SubscriptionStatus $status, public readonly DateTime $nextBillingDate, public readonly int $version ) {}}class SnapshotService{ public function createSnapshot(Subscription $subscription): SubscriptionSnapshot { return new SubscriptionSnapshot( $subscription->id(), $subscription->status(), $subscription->nextBillingDate(), $subscription->version() ); } public function restoreFromSnapshot(SubscriptionSnapshot $snapshot, array $events): Subscription { $subscription = Subscription::fromSnapshot($snapshot); // Appliquer seulement les Ã©vÃ©nements aprÃ¨s le snapshot $eventsAfterSnapshot = array_filter( $events, fn($event) => $event->version() > $snapshot->version ); foreach ($eventsAfterSnapshot as $event) { $subscription->apply($event); } return $subscription; }}</code>### <strong>2. Event Sourcing + CQRS</strong>- <strong>Command Side</strong> : GÃ¨re les Ã©vÃ©nements et lâ€™event store- <strong>Query Side</strong> : Lit depuis les projections### <strong>3. Event Sourcing + API Platform</strong>- <strong>Ressources</strong> : Exposer les Ã©vÃ©nements via lâ€™API- <strong>Validation</strong> : Valider les Ã©vÃ©nements avant stockage## âš¡ <strong>Performance et Optimisation</strong>### <strong>Optimisations de lâ€™Event Store</strong>- <strong>Indexation</strong> : Index sur stream_id et version- <strong>Partitioning</strong> : Partitionner par stream_id- <strong>Compression</strong> : Compresser les anciens Ã©vÃ©nements### <strong>Optimisations des Projections</strong>- <strong>Snapshots</strong> : CrÃ©er des snapshots rÃ©guliers- <strong>Projections asynchrones</strong> : Traiter les projections en arriÃ¨re-plan- <strong>Cache</strong> : Mettre en cache les projections frÃ©quentes## ğŸ¯ <strong>Quand Utiliser lâ€™Event Sourcing ?</strong>### <strong>âœ… Cas dâ€™Usage AppropriÃ©s</strong>- <strong>Audit critique</strong> : Besoin de traÃ§abilitÃ© complÃ¨te- <strong>Compliance</strong> : RÃ©glementations strictes- <strong>Analytics</strong> : Besoin dâ€™analyser lâ€™historique- <strong>Debugging complexe</strong> : SystÃ¨mes complexes Ã  dÃ©boguer### <strong>âŒ Cas dâ€™Usage InappropriÃ©s</strong>- <strong>Applications simples</strong> : CRUD basique- <strong>Performance critique</strong> : Besoins de performance extrÃªme- <strong>Ã‰quipe inexpÃ©rimentÃ©e</strong> : ComplexitÃ© Ã©levÃ©e- <strong>Prototypage</strong> : DÃ©veloppement rapide## ğŸ”„ <strong>Migration vers Event Sourcing</strong>### <strong>Ã‰tape 1 : Identifier les Ã‰vÃ©nements MÃ©tier</strong>- Lister tous les changements dâ€™Ã©tat- Grouper par contexte mÃ©tier### <strong>Ã‰tape 2 : CrÃ©er lâ€™Event Store</strong>- Choisir la technologie de stockage- ImplÃ©menter les interfaces### <strong>Ã‰tape 3 : Migrer les AgrÃ©gats</strong>- Convertir les entitÃ©s en Ã©vÃ©nements- ImplÃ©menter la reconstruction### <strong>Ã‰tape 4 : CrÃ©er les Projections</strong>- CrÃ©er les vues de lecture- ImplÃ©menter la synchronisation## ğŸ“Š <strong>MÃ©triques et Monitoring</strong>### <strong>MÃ©triques Event Store</strong>- Nombre dâ€™Ã©vÃ©nements par seconde- Taille des streams- Temps de reconstruction### <strong>MÃ©triques Projections</strong>- DÃ©lai de traitement des Ã©vÃ©nements- Taille des projections- Performance des requÃªtes## ğŸ¯ <strong>Prochaines Ã‰tapes</strong>Maintenant que vous comprenez lâ€™Event Sourcing, explorez :1. <strong>CQRS</strong> : SÃ©parer les commandes des requÃªtes2. <strong>Repositories</strong> : Patterns de persistance3. <strong>ImplÃ©mentation Event Sourcing</strong> : Guide dâ€™implÃ©mentation completâ€”<em>Event Sourcing transforme la faÃ§on dont nous pensons la persistance. Dans Gyroscops, il nous a permis de gÃ©rer la complexitÃ© mÃ©tier tout en gardant une traÃ§abilitÃ© complÃ¨te de tous les changements.</em></a></li></ul></nav></toc></div><div class="docs-toc-mobile d-print-none d-xl-none"><button id=toc-dropdown-btn class="btn-secondary dropdown-toggle" type=button data-bs-toggle=dropdown data-bs-offset=0,0 aria-expanded=false>
Table of Contents</button><nav id=toc-mobile><ul class=dropdown-menu><li><a href=#-quest-ce-que-levent-sourcing-event-sourcing-est-un-pattern-architectural-qui-stocke-les-Ã©vÃ©nements-mÃ©tier-comme-source-de-vÃ©ritÃ©-plutÃ´t-que-lÃ©tat-actuel-des-entitÃ©s-le-principe-fondamental-lÃ©tat-dune-entitÃ©-est-la-consÃ©quence-de-tous-les-Ã©vÃ©nements-qui-lui-sont-arrivÃ©sau-lieu-de-stocker-lÃ©tat-actuel-on-stocke---tous-les-Ã©vÃ©nements-qui-ont-modifiÃ©-lentitÃ©--l-de-ces-Ã©vÃ©nements--les-mÃ©tadonnÃ©es-associÃ©es-Ã -chaque-Ã©vÃ©nement--event-sourcing-dans-gyroscops-contexte-mÃ©tier--gestion-des-abonnementsdans-gyroscops-un-abonnement-passe-par-plusieurs-Ã©tats--Ã©vÃ©nements-mÃ©tierphp-Ã©vÃ©nement--abonnement-crÃ©Ã©class-subscriptioncreated-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-planid-planid--------public-readonly-customerid-customerid--------public-readonly-datetime-createdat--------public-readonly-billingcycle-billingcycle------Ã©vÃ©nement--abonnement-activÃ©class-subscriptionactivated-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-datetime-activatedat--------public-readonly-datetime-nextbillingdate------Ã©vÃ©nement--paiement-traitÃ©class-paymentprocessed-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-paymentid-paymentid--------public-readonly-amount-amount--------public-readonly-datetime-processedat------Ã©vÃ©nement--abonnement-suspenduclass-subscriptionsuspended-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-string-reason--------public-readonly-datetime-suspendedat------reconstruction-de-lphpclass-subscription----private-subscriptionid-id----private-subscriptionstatus-status----private-datetime-nextbillingdate----private-array-payments----------public-static-function-fromeventsarray-events-self------------subscription--new-self----------------foreach-events-as-event-------------subscription-applyevent------------------------return-subscription------------private-function-applydomainevent-event-void------------match-eventclass-------------subscriptioncreatedclass--this-applysubscriptioncreatedevent------------subscriptionactivatedclass--this-applysubscriptionactivatedevent------------paymentprocessedclass--this-applypaymentprocessedevent------------subscriptionsuspendedclass--this-applysubscriptionsuspendedevent--------------------private-function-applysubscriptioncreatedsubscriptioncreated-event-void------------this-id--event-subscriptionid--------this-status--subscriptionstatuspending--------this-nextbillingdate--event-createdat-addevent-billingcycle-interval------------private-function-applysubscriptionactivatedsubscriptionactivated-event-void------------this-status--subscriptionstatusactive--------this-nextbillingdate--event-nextbillingdate------------private-function-applypaymentprocessedpaymentprocessed-event-void------------this-payments--event-paymentid--------this-nextbillingdate--this-nextbillingdate-addthis-billingcycle-interval------------private-function-applysubscriptionsuspendedsubscriptionsuspended-event-void------------this-status--subscriptionstatussuspended------avantages-de-l-1-traÃ§abilitÃ©-complÃ¨te--historique-complet--tous-les-changements-sont-enregistrÃ©s--audit-trail--qui-a-fait-quoi-et-quand--debugging--possibilitÃ©-de-rejouer-lhistorique-2-flexibilitÃ©-temporelle--time-travel--voir-lÃ©tat-Ã -nimporte-quel-moment--replay--rejouer-les-Ã©vÃ©nements-pour-tester--debugging--comprendre-comment-on-est-arrivÃ©-Ã -un-Ã©tat-3-Ã©volutivitÃ©--nouvelles-projections--crÃ©er-de-nouvelles-vues-sans-modifier-le-code-existant--migration--faciliter-les-migrations-de-donnÃ©es--analytics--analyser-lhistorique-des-Ã©vÃ©nements-4-cohÃ©rence-Ã©vÃ©nementielle--source-de-vÃ©ritÃ©-unique--les-Ã©vÃ©nements-sont-la-seule-source-de-vÃ©ritÃ©--intÃ©gritÃ©--impossible-de-corrompre-lhistorique--rÃ©conciliation--possibilitÃ©-de-dÃ©tecter-les-incohÃ©rences--implÃ©mentation-dans-gyroscops-structure-des-dossierssrcaccounting-domain----events-------subscriptioncreatedphp-------subscriptionactivatedphp-------paymentprocessedphp-------subscriptionsuspendedphp----subscriptionphp----eventstorephp-infrastructure----eventstore-------doctrineeventstorephp-------eventstorerepositoryphp----projections--------subscriptionprojectionphp--------paymentprojectionphp-application-----command--------activatesubscription-----query---------getsubscriptionhistory-event-storephpinterface-eventstore----public-function-appendstreamid-streamid-array-events-int-expectedversion-void----public-function-geteventsstreamid-streamid-array----public-function-geteventsfromversionstreamid-streamid-int-fromversion-arrayclass-doctrineeventstore-implements-eventstore----public-function-appendstreamid-streamid-array-events-int-expectedversion-void------------this-entitymanager-transactionalfunction--use-streamid-events-expectedversion--------------vÃ©rifier-la-version-attendue------------currentversion--this-getcurrentversionstreamid------------if-currentversion--expectedversion-----------------throw-new-concurrencyexceptionversion-mismatch-------------------------------------enregistrer-les-Ã©vÃ©nements------------foreach-events-as-event-----------------this-persisteventstreamid-event--------------------------------public-function-geteventsstreamid-streamid-array------------return-this-eventrepository-findbystreamidstreamid-----projectionsphpclass-subscriptionprojection----public-function-__construct--------private-subscriptionqueryrepository-queryrepository-------------public-function-handledomainevent-event-void------------match-eventclass-------------subscriptioncreatedclass--this-handlesubscriptioncreatedevent------------subscriptionactivatedclass--this-handlesubscriptionactivatedevent------------paymentprocessedclass--this-handlepaymentprocessedevent--------------------private-function-handlesubscriptioncreatedsubscriptioncreated-event-void------------this-queryrepository-createsubscriptionview------------event-subscriptionid------------event-planid------------event-customerid------------subscriptionstatuspending------------event-createdat--------------------private-function-handlesubscriptionactivatedsubscriptionactivated-event-void------------this-queryrepository-updatesubscriptionstatus------------event-subscriptionid------------subscriptionstatusactive------------event-nextbillingdate--------------patterns-avancÃ©s-avec-event-sourcing-1-snapshotsphpclass-subscriptionsnapshot----public-function-__construct--------public-readonly-subscriptionid-id--------public-readonly-subscriptionstatus-status--------public-readonly-datetime-nextbillingdate--------public-readonly-int-version-----class-snapshotservice----public-function-createsnapshotsubscription-subscription-subscriptionsnapshot------------return-new-subscriptionsnapshot------------subscription-id------------subscription-status------------subscription-nextbillingdate------------subscription-version--------------------public-function-restorefromsnapshotsubscriptionsnapshot-snapshot-array-events-subscription------------subscription--subscriptionfromsnapshotsnapshot-----------------appliquer-seulement-les-Ã©vÃ©nements-aprÃ¨s-le-snapshot--------eventsaftersnapshot--array_filter------------events------------fnevent--event-version--snapshot-version------------------------foreach-eventsaftersnapshot-as-event-------------subscription-applyevent------------------------return-subscription-----2-event-sourcing--cqrs--command-side--gÃ¨re-les-Ã©vÃ©nements-et-levent-store--query-side--lit-depuis-les-projections-3-event-sourcing--api-platform--ressources--exposer-les-Ã©vÃ©nements-via-lapi--validation--valider-les-Ã©vÃ©nements-avant-stockage--performance-et-optimisation-optimisations-de-l--indexation--index-sur-stream_id-et-version--partitioning--partitionner-par-stream_id--compression--compresser-les-anciens-Ã©vÃ©nements-optimisations-des-projections--snapshots--crÃ©er-des-snapshots-rÃ©guliers--projections-asynchrones--traiter-les-projections-en-arriÃ¨re-plan--cache--mettre-en-cache-les-projections-frÃ©quentes--quand-utiliser-l--cas-d--audit-critique--besoin-de-traÃ§abilitÃ©-complÃ¨te--compliance--rÃ©glementations-strictes--analytics--besoin-danalyser-lhistorique--debugging-complexe--systÃ¨mes-complexes-Ã -dÃ©boguer--cas-d--applications-simples--crud-basique--performance-critique--besoins-de-performance-extrÃªme--Ã©quipe-inexpÃ©rimentÃ©e--complexitÃ©-Ã©levÃ©e--prototypage--dÃ©veloppement-rapide--migration-vers-event-sourcing-Ã©tape-1--identifier-les-Ã©vÃ©nements-mÃ©tier--lister-tous-les-changements-dÃ©tat--grouper-par-contexte-mÃ©tier-Ã©tape-2--crÃ©er-l--choisir-la-technologie-de-stockage--implÃ©menter-les-interfaces-Ã©tape-3--migrer-les-agrÃ©gats--convertir-les-entitÃ©s-en-Ã©vÃ©nements--implÃ©menter-la-reconstruction-Ã©tape-4--crÃ©er-les-projections--crÃ©er-les-vues-de-lecture--implÃ©menter-la-synchronisation--mÃ©triques-et-monitoring-mÃ©triques-event-store--nombre-dÃ©vÃ©nements-par-seconde--taille-des-streams--temps-de-reconstruction-mÃ©triques-projections--dÃ©lai-de-traitement-des-Ã©vÃ©nements--taille-des-projections--performance-des-requÃªtes--prochaines-Ã©tapesmaintenant-que-vous-comprenez-levent-sourcing-explorez-1-cqrs--sÃ©parer-les-commandes-des-requÃªtes2-repositories--patterns-de-persistance3-implÃ©mentation-event-sourcing--guide-dimplÃ©mentation-completevent-sourcing-transforme-la-faÃ§on-dont-nous-pensons-la-persistance-dans-gyroscops-il-nous-a-permis-de-gÃ©rer-la-complexitÃ©-mÃ©tier-tout-en-gardant-une-traÃ§abilitÃ©-complÃ¨te-de-tous-les-changements>ğŸŒŸ **Quâ€™est-ce que lâ€™Event Sourcing ?**<strong>Event Sourcing</strong> est un pattern architectural qui stocke les <strong>Ã©vÃ©nements mÃ©tier</strong> comme source de vÃ©ritÃ©, plutÃ´t que lâ€™Ã©tat actuel des entitÃ©s.### <strong>Le Principe Fondamental</strong>> **â€œLâ€™Ã©tat dâ€™une entitÃ© est la consÃ©quence de tous les Ã©vÃ©nements qui lui sont arrivÃ©sâ€**Au lieu de stocker lâ€™Ã©tat actuel, on stocke :- <strong>Tous les Ã©vÃ©nements</strong> qui ont modifiÃ© lâ€™entitÃ©- <strong>Lâ€™ordre chronologique</strong> de ces Ã©vÃ©nements- <strong>Les mÃ©tadonnÃ©es</strong> associÃ©es Ã  chaque Ã©vÃ©nement## ğŸ—ï¸ <strong>Event Sourcing dans Gyroscops</strong>### <strong>Contexte MÃ©tier : Gestion des Abonnements</strong>Dans Gyroscops, un abonnement passe par plusieurs Ã©tats :#### <strong>Ã‰vÃ©nements MÃ©tier</strong><code>php// Ã‰vÃ©nement : Abonnement crÃ©Ã©class SubscriptionCreated implements DomainEvent{ public function __construct( public readonly SubscriptionId $subscriptionId, public readonly PlanId $planId, public readonly CustomerId $customerId, public readonly DateTime $createdAt, public readonly BillingCycle $billingCycle ) {}}// Ã‰vÃ©nement : Abonnement activÃ©class SubscriptionActivated implements DomainEvent{ public function __construct( public readonly SubscriptionId $subscriptionId, public readonly DateTime $activatedAt, public readonly DateTime $nextBillingDate ) {}}// Ã‰vÃ©nement : Paiement traitÃ©class PaymentProcessed implements DomainEvent{ public function __construct( public readonly SubscriptionId $subscriptionId, public readonly PaymentId $paymentId, public readonly Amount $amount, public readonly DateTime $processedAt ) {}}// Ã‰vÃ©nement : Abonnement suspenduclass SubscriptionSuspended implements DomainEvent{ public function __construct( public readonly SubscriptionId $subscriptionId, public readonly string $reason, public readonly DateTime $suspendedAt ) {}}</code>#### <strong>Reconstruction de lâ€™Ã‰tat</strong><code>phpclass Subscription{ private SubscriptionId $id; private SubscriptionStatus $status; private ?DateTime $nextBillingDate; private array $payments = []; public static function fromEvents(array $events): self { $subscription = new self(); foreach ($events as $event) { $subscription->apply($event); } return $subscription; } private function apply(DomainEvent $event): void { match ($event::class) { SubscriptionCreated::class => $this->applySubscriptionCreated($event), SubscriptionActivated::class => $this->applySubscriptionActivated($event), PaymentProcessed::class => $this->applyPaymentProcessed($event), SubscriptionSuspended::class => $this->applySubscriptionSuspended($event), }; } private function applySubscriptionCreated(SubscriptionCreated $event): void { $this->id = $event->subscriptionId; $this->status = SubscriptionStatus::PENDING; $this->nextBillingDate = $event->createdAt->add($event->billingCycle->interval()); } private function applySubscriptionActivated(SubscriptionActivated $event): void { $this->status = SubscriptionStatus::ACTIVE; $this->nextBillingDate = $event->nextBillingDate; } private function applyPaymentProcessed(PaymentProcessed $event): void { $this->payments[] = $event->paymentId; $this->nextBillingDate = $this->nextBillingDate->add($this->billingCycle->interval()); } private function applySubscriptionSuspended(SubscriptionSuspended $event): void { $this->status = SubscriptionStatus::SUSPENDED; }}</code>## ğŸ¯ <strong>Avantages de lâ€™Event Sourcing</strong>### <strong>1. TraÃ§abilitÃ© ComplÃ¨te</strong>- <strong>Historique complet</strong> : Tous les changements sont enregistrÃ©s- <strong>Audit trail</strong> : Qui a fait quoi et quand- <strong>Debugging</strong> : PossibilitÃ© de rejouer lâ€™historique### <strong>2. FlexibilitÃ© Temporelle</strong>- <strong>Time travel</strong> : Voir lâ€™Ã©tat Ã  nâ€™importe quel moment- <strong>Replay</strong> : Rejouer les Ã©vÃ©nements pour tester- <strong>Debugging</strong> : Comprendre comment on est arrivÃ© Ã  un Ã©tat### <strong>3. Ã‰volutivitÃ©</strong>- <strong>Nouvelles projections</strong> : CrÃ©er de nouvelles vues sans modifier le code existant- <strong>Migration</strong> : Faciliter les migrations de donnÃ©es- <strong>Analytics</strong> : Analyser lâ€™historique des Ã©vÃ©nements### <strong>4. CohÃ©rence Ã‰vÃ©nementielle</strong>- <strong>Source de vÃ©ritÃ© unique</strong> : Les Ã©vÃ©nements sont la seule source de vÃ©ritÃ©- <strong>IntÃ©gritÃ©</strong> : Impossible de corrompre lâ€™historique- <strong>RÃ©conciliation</strong> : PossibilitÃ© de dÃ©tecter les incohÃ©rences## ğŸ”§ <strong>ImplÃ©mentation dans Gyroscops</strong>### <strong>Structure des Dossiers</strong><code>src/Accounting/â”œâ”€â”€ Domain/â”‚ â”œâ”€â”€ Events/â”‚ â”‚ â”œâ”€â”€ SubscriptionCreated.phpâ”‚ â”‚ â”œâ”€â”€ SubscriptionActivated.phpâ”‚ â”‚ â”œâ”€â”€ PaymentProcessed.phpâ”‚ â”‚ â””â”€â”€ SubscriptionSuspended.phpâ”‚ â”œâ”€â”€ Subscription.phpâ”‚ â””â”€â”€ EventStore.phpâ”œâ”€â”€ Infrastructure/â”‚ â”œâ”€â”€ EventStore/â”‚ â”‚ â”œâ”€â”€ DoctrineEventStore.phpâ”‚ â”‚ â””â”€â”€ EventStoreRepository.phpâ”‚ â””â”€â”€ Projections/â”‚ â”œâ”€â”€ SubscriptionProjection.phpâ”‚ â””â”€â”€ PaymentProjection.phpâ””â”€â”€ Application/ â”œâ”€â”€ Command/ â”‚ â””â”€â”€ ActivateSubscription/ â””â”€â”€ Query/ â””â”€â”€ GetSubscriptionHistory/</code>### <strong>Event Store</strong><code>phpinterface EventStore{ public function append(StreamId $streamId, array $events, int $expectedVersion): void; public function getEvents(StreamId $streamId): array; public function getEventsFromVersion(StreamId $streamId, int $fromVersion): array;}class DoctrineEventStore implements EventStore{ public function append(StreamId $streamId, array $events, int $expectedVersion): void { $this->entityManager->transactional(function () use ($streamId, $events, $expectedVersion) { // VÃ©rifier la version attendue $currentVersion = $this->getCurrentVersion($streamId); if ($currentVersion !== $expectedVersion) { throw new ConcurrencyException('Version mismatch'); } // Enregistrer les Ã©vÃ©nements foreach ($events as $event) { $this->persistEvent($streamId, $event); } }); } public function getEvents(StreamId $streamId): array { return $this->eventRepository->findByStreamId($streamId); }}</code>### <strong>Projections</strong><code>phpclass SubscriptionProjection{ public function __construct( private SubscriptionQueryRepository $queryRepository ) {} public function handle(DomainEvent $event): void { match ($event::class) { SubscriptionCreated::class => $this->handleSubscriptionCreated($event), SubscriptionActivated::class => $this->handleSubscriptionActivated($event), PaymentProcessed::class => $this->handlePaymentProcessed($event), }; } private function handleSubscriptionCreated(SubscriptionCreated $event): void { $this->queryRepository->createSubscriptionView( $event->subscriptionId, $event->planId, $event->customerId, SubscriptionStatus::PENDING, $event->createdAt ); } private function handleSubscriptionActivated(SubscriptionActivated $event): void { $this->queryRepository->updateSubscriptionStatus( $event->subscriptionId, SubscriptionStatus::ACTIVE, $event->nextBillingDate ); }}</code>## ğŸš€ <strong>Patterns AvancÃ©s avec Event Sourcing</strong>### <strong>1. Snapshots</strong><code>phpclass SubscriptionSnapshot{ public function __construct( public readonly SubscriptionId $id, public readonly SubscriptionStatus $status, public readonly DateTime $nextBillingDate, public readonly int $version ) {}}class SnapshotService{ public function createSnapshot(Subscription $subscription): SubscriptionSnapshot { return new SubscriptionSnapshot( $subscription->id(), $subscription->status(), $subscription->nextBillingDate(), $subscription->version() ); } public function restoreFromSnapshot(SubscriptionSnapshot $snapshot, array $events): Subscription { $subscription = Subscription::fromSnapshot($snapshot); // Appliquer seulement les Ã©vÃ©nements aprÃ¨s le snapshot $eventsAfterSnapshot = array_filter( $events, fn($event) => $event->version() > $snapshot->version ); foreach ($eventsAfterSnapshot as $event) { $subscription->apply($event); } return $subscription; }}</code>### <strong>2. Event Sourcing + CQRS</strong>- <strong>Command Side</strong> : GÃ¨re les Ã©vÃ©nements et lâ€™event store- <strong>Query Side</strong> : Lit depuis les projections### <strong>3. Event Sourcing + API Platform</strong>- <strong>Ressources</strong> : Exposer les Ã©vÃ©nements via lâ€™API- <strong>Validation</strong> : Valider les Ã©vÃ©nements avant stockage## âš¡ <strong>Performance et Optimisation</strong>### <strong>Optimisations de lâ€™Event Store</strong>- <strong>Indexation</strong> : Index sur stream_id et version- <strong>Partitioning</strong> : Partitionner par stream_id- <strong>Compression</strong> : Compresser les anciens Ã©vÃ©nements### <strong>Optimisations des Projections</strong>- <strong>Snapshots</strong> : CrÃ©er des snapshots rÃ©guliers- <strong>Projections asynchrones</strong> : Traiter les projections en arriÃ¨re-plan- <strong>Cache</strong> : Mettre en cache les projections frÃ©quentes## ğŸ¯ <strong>Quand Utiliser lâ€™Event Sourcing ?</strong>### <strong>âœ… Cas dâ€™Usage AppropriÃ©s</strong>- <strong>Audit critique</strong> : Besoin de traÃ§abilitÃ© complÃ¨te- <strong>Compliance</strong> : RÃ©glementations strictes- <strong>Analytics</strong> : Besoin dâ€™analyser lâ€™historique- <strong>Debugging complexe</strong> : SystÃ¨mes complexes Ã  dÃ©boguer### <strong>âŒ Cas dâ€™Usage InappropriÃ©s</strong>- <strong>Applications simples</strong> : CRUD basique- <strong>Performance critique</strong> : Besoins de performance extrÃªme- <strong>Ã‰quipe inexpÃ©rimentÃ©e</strong> : ComplexitÃ© Ã©levÃ©e- <strong>Prototypage</strong> : DÃ©veloppement rapide## ğŸ”„ <strong>Migration vers Event Sourcing</strong>### <strong>Ã‰tape 1 : Identifier les Ã‰vÃ©nements MÃ©tier</strong>- Lister tous les changements dâ€™Ã©tat- Grouper par contexte mÃ©tier### <strong>Ã‰tape 2 : CrÃ©er lâ€™Event Store</strong>- Choisir la technologie de stockage- ImplÃ©menter les interfaces### <strong>Ã‰tape 3 : Migrer les AgrÃ©gats</strong>- Convertir les entitÃ©s en Ã©vÃ©nements- ImplÃ©menter la reconstruction### <strong>Ã‰tape 4 : CrÃ©er les Projections</strong>- CrÃ©er les vues de lecture- ImplÃ©menter la synchronisation## ğŸ“Š <strong>MÃ©triques et Monitoring</strong>### <strong>MÃ©triques Event Store</strong>- Nombre dâ€™Ã©vÃ©nements par seconde- Taille des streams- Temps de reconstruction### <strong>MÃ©triques Projections</strong>- DÃ©lai de traitement des Ã©vÃ©nements- Taille des projections- Performance des requÃªtes## ğŸ¯ <strong>Prochaines Ã‰tapes</strong>Maintenant que vous comprenez lâ€™Event Sourcing, explorez :1. <strong>CQRS</strong> : SÃ©parer les commandes des requÃªtes2. <strong>Repositories</strong> : Patterns de persistance3. <strong>ImplÃ©mentation Event Sourcing</strong> : Guide dâ€™implÃ©mentation completâ€”<em>Event Sourcing transforme la faÃ§on dont nous pensons la persistance. Dans Gyroscops, il nous a permis de gÃ©rer la complexitÃ© mÃ©tier tout en gardant une traÃ§abilitÃ© complÃ¨te de tous les changements.</em></a></li></ul></nav></div><div class="docs-content col-12 col-xl-9 mt-0"><div class="mb-0 d-flex"><h1 class="content-title mb-0">Event Sourcing - Stocker les Ã‰vÃ©nements comme Source de VÃ©ritÃ©</h1></div><div id=content class=main-content><div data-prismjs-copy data-prismjs-copy-success data-prismjs-copy-error><h2 id=-quest-ce-que-levent-sourcing-event-sourcing-est-un-pattern-architectural-qui-stocke-les-Ã©vÃ©nements-mÃ©tier-comme-source-de-vÃ©ritÃ©-plutÃ´t-que-lÃ©tat-actuel-des-entitÃ©s-le-principe-fondamental-lÃ©tat-dune-entitÃ©-est-la-consÃ©quence-de-tous-les-Ã©vÃ©nements-qui-lui-sont-arrivÃ©sau-lieu-de-stocker-lÃ©tat-actuel-on-stocke---tous-les-Ã©vÃ©nements-qui-ont-modifiÃ©-lentitÃ©--l-de-ces-Ã©vÃ©nements--les-mÃ©tadonnÃ©es-associÃ©es-Ã -chaque-Ã©vÃ©nement--event-sourcing-dans-gyroscops-contexte-mÃ©tier--gestion-des-abonnementsdans-gyroscops-un-abonnement-passe-par-plusieurs-Ã©tats--Ã©vÃ©nements-mÃ©tierphp-Ã©vÃ©nement--abonnement-crÃ©Ã©class-subscriptioncreated-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-planid-planid--------public-readonly-customerid-customerid--------public-readonly-datetime-createdat--------public-readonly-billingcycle-billingcycle------Ã©vÃ©nement--abonnement-activÃ©class-subscriptionactivated-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-datetime-activatedat--------public-readonly-datetime-nextbillingdate------Ã©vÃ©nement--paiement-traitÃ©class-paymentprocessed-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-paymentid-paymentid--------public-readonly-amount-amount--------public-readonly-datetime-processedat------Ã©vÃ©nement--abonnement-suspenduclass-subscriptionsuspended-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-string-reason--------public-readonly-datetime-suspendedat------reconstruction-de-lphpclass-subscription----private-subscriptionid-id----private-subscriptionstatus-status----private-datetime-nextbillingdate----private-array-payments----------public-static-function-fromeventsarray-events-self------------subscription--new-self----------------foreach-events-as-event-------------subscription-applyevent------------------------return-subscription------------private-function-applydomainevent-event-void------------match-eventclass-------------subscriptioncreatedclass--this-applysubscriptioncreatedevent------------subscriptionactivatedclass--this-applysubscriptionactivatedevent------------paymentprocessedclass--this-applypaymentprocessedevent------------subscriptionsuspendedclass--this-applysubscriptionsuspendedevent--------------------private-function-applysubscriptioncreatedsubscriptioncreated-event-void------------this-id--event-subscriptionid--------this-status--subscriptionstatuspending--------this-nextbillingdate--event-createdat-addevent-billingcycle-interval------------private-function-applysubscriptionactivatedsubscriptionactivated-event-void------------this-status--subscriptionstatusactive--------this-nextbillingdate--event-nextbillingdate------------private-function-applypaymentprocessedpaymentprocessed-event-void------------this-payments--event-paymentid--------this-nextbillingdate--this-nextbillingdate-addthis-billingcycle-interval------------private-function-applysubscriptionsuspendedsubscriptionsuspended-event-void------------this-status--subscriptionstatussuspended------avantages-de-l-1-traÃ§abilitÃ©-complÃ¨te--historique-complet--tous-les-changements-sont-enregistrÃ©s--audit-trail--qui-a-fait-quoi-et-quand--debugging--possibilitÃ©-de-rejouer-lhistorique-2-flexibilitÃ©-temporelle--time-travel--voir-lÃ©tat-Ã -nimporte-quel-moment--replay--rejouer-les-Ã©vÃ©nements-pour-tester--debugging--comprendre-comment-on-est-arrivÃ©-Ã -un-Ã©tat-3-Ã©volutivitÃ©--nouvelles-projections--crÃ©er-de-nouvelles-vues-sans-modifier-le-code-existant--migration--faciliter-les-migrations-de-donnÃ©es--analytics--analyser-lhistorique-des-Ã©vÃ©nements-4-cohÃ©rence-Ã©vÃ©nementielle--source-de-vÃ©ritÃ©-unique--les-Ã©vÃ©nements-sont-la-seule-source-de-vÃ©ritÃ©--intÃ©gritÃ©--impossible-de-corrompre-lhistorique--rÃ©conciliation--possibilitÃ©-de-dÃ©tecter-les-incohÃ©rences--implÃ©mentation-dans-gyroscops-structure-des-dossierssrcaccounting-domain----events-------subscriptioncreatedphp-------subscriptionactivatedphp-------paymentprocessedphp-------subscriptionsuspendedphp----subscriptionphp----eventstorephp-infrastructure----eventstore-------doctrineeventstorephp-------eventstorerepositoryphp----projections--------subscriptionprojectionphp--------paymentprojectionphp-application-----command--------activatesubscription-----query---------getsubscriptionhistory-event-storephpinterface-eventstore----public-function-appendstreamid-streamid-array-events-int-expectedversion-void----public-function-geteventsstreamid-streamid-array----public-function-geteventsfromversionstreamid-streamid-int-fromversion-arrayclass-doctrineeventstore-implements-eventstore----public-function-appendstreamid-streamid-array-events-int-expectedversion-void------------this-entitymanager-transactionalfunction--use-streamid-events-expectedversion--------------vÃ©rifier-la-version-attendue------------currentversion--this-getcurrentversionstreamid------------if-currentversion--expectedversion-----------------throw-new-concurrencyexceptionversion-mismatch-------------------------------------enregistrer-les-Ã©vÃ©nements------------foreach-events-as-event-----------------this-persisteventstreamid-event--------------------------------public-function-geteventsstreamid-streamid-array------------return-this-eventrepository-findbystreamidstreamid-----projectionsphpclass-subscriptionprojection----public-function-__construct--------private-subscriptionqueryrepository-queryrepository-------------public-function-handledomainevent-event-void------------match-eventclass-------------subscriptioncreatedclass--this-handlesubscriptioncreatedevent------------subscriptionactivatedclass--this-handlesubscriptionactivatedevent------------paymentprocessedclass--this-handlepaymentprocessedevent--------------------private-function-handlesubscriptioncreatedsubscriptioncreated-event-void------------this-queryrepository-createsubscriptionview------------event-subscriptionid------------event-planid------------event-customerid------------subscriptionstatuspending------------event-createdat--------------------private-function-handlesubscriptionactivatedsubscriptionactivated-event-void------------this-queryrepository-updatesubscriptionstatus------------event-subscriptionid------------subscriptionstatusactive------------event-nextbillingdate--------------patterns-avancÃ©s-avec-event-sourcing-1-snapshotsphpclass-subscriptionsnapshot----public-function-__construct--------public-readonly-subscriptionid-id--------public-readonly-subscriptionstatus-status--------public-readonly-datetime-nextbillingdate--------public-readonly-int-version-----class-snapshotservice----public-function-createsnapshotsubscription-subscription-subscriptionsnapshot------------return-new-subscriptionsnapshot------------subscription-id------------subscription-status------------subscription-nextbillingdate------------subscription-version--------------------public-function-restorefromsnapshotsubscriptionsnapshot-snapshot-array-events-subscription------------subscription--subscriptionfromsnapshotsnapshot-----------------appliquer-seulement-les-Ã©vÃ©nements-aprÃ¨s-le-snapshot--------eventsaftersnapshot--array_filter------------events------------fnevent--event-version--snapshot-version------------------------foreach-eventsaftersnapshot-as-event-------------subscription-applyevent------------------------return-subscription-----2-event-sourcing--cqrs--command-side--gÃ¨re-les-Ã©vÃ©nements-et-levent-store--query-side--lit-depuis-les-projections-3-event-sourcing--api-platform--ressources--exposer-les-Ã©vÃ©nements-via-lapi--validation--valider-les-Ã©vÃ©nements-avant-stockage--performance-et-optimisation-optimisations-de-l--indexation--index-sur-stream_id-et-version--partitioning--partitionner-par-stream_id--compression--compresser-les-anciens-Ã©vÃ©nements-optimisations-des-projections--snapshots--crÃ©er-des-snapshots-rÃ©guliers--projections-asynchrones--traiter-les-projections-en-arriÃ¨re-plan--cache--mettre-en-cache-les-projections-frÃ©quentes--quand-utiliser-l--cas-d--audit-critique--besoin-de-traÃ§abilitÃ©-complÃ¨te--compliance--rÃ©glementations-strictes--analytics--besoin-danalyser-lhistorique--debugging-complexe--systÃ¨mes-complexes-Ã -dÃ©boguer--cas-d--applications-simples--crud-basique--performance-critique--besoins-de-performance-extrÃªme--Ã©quipe-inexpÃ©rimentÃ©e--complexitÃ©-Ã©levÃ©e--prototypage--dÃ©veloppement-rapide--migration-vers-event-sourcing-Ã©tape-1--identifier-les-Ã©vÃ©nements-mÃ©tier--lister-tous-les-changements-dÃ©tat--grouper-par-contexte-mÃ©tier-Ã©tape-2--crÃ©er-l--choisir-la-technologie-de-stockage--implÃ©menter-les-interfaces-Ã©tape-3--migrer-les-agrÃ©gats--convertir-les-entitÃ©s-en-Ã©vÃ©nements--implÃ©menter-la-reconstruction-Ã©tape-4--crÃ©er-les-projections--crÃ©er-les-vues-de-lecture--implÃ©menter-la-synchronisation--mÃ©triques-et-monitoring-mÃ©triques-event-store--nombre-dÃ©vÃ©nements-par-seconde--taille-des-streams--temps-de-reconstruction-mÃ©triques-projections--dÃ©lai-de-traitement-des-Ã©vÃ©nements--taille-des-projections--performance-des-requÃªtes--prochaines-Ã©tapesmaintenant-que-vous-comprenez-levent-sourcing-explorez-1-cqrs--sÃ©parer-les-commandes-des-requÃªtes2-repositories--patterns-de-persistance3-implÃ©mentation-event-sourcing--guide-dimplÃ©mentation-completevent-sourcing-transforme-la-faÃ§on-dont-nous-pensons-la-persistance-dans-gyroscops-il-nous-a-permis-de-gÃ©rer-la-complexitÃ©-mÃ©tier-tout-en-gardant-une-traÃ§abilitÃ©-complÃ¨te-de-tous-les-changements>ğŸŒŸ **Qu&rsquo;est-ce que l&rsquo;Event Sourcing ?**<strong>Event Sourcing</strong> est un pattern architectural qui stocke les <strong>Ã©vÃ©nements mÃ©tier</strong> comme source de vÃ©ritÃ©, plutÃ´t que l&rsquo;Ã©tat actuel des entitÃ©s.### <strong>Le Principe Fondamental</strong>> **&ldquo;L&rsquo;Ã©tat d&rsquo;une entitÃ© est la consÃ©quence de tous les Ã©vÃ©nements qui lui sont arrivÃ©s&rdquo;**Au lieu de stocker l&rsquo;Ã©tat actuel, on stocke :- <strong>Tous les Ã©vÃ©nements</strong> qui ont modifiÃ© l&rsquo;entitÃ©- <strong>L&rsquo;ordre chronologique</strong> de ces Ã©vÃ©nements- <strong>Les mÃ©tadonnÃ©es</strong> associÃ©es Ã  chaque Ã©vÃ©nement## ğŸ—ï¸ <strong>Event Sourcing dans Gyroscops</strong>### <strong>Contexte MÃ©tier : Gestion des Abonnements</strong>Dans Gyroscops, un abonnement passe par plusieurs Ã©tats :#### <strong>Ã‰vÃ©nements MÃ©tier</strong><code>php// Ã‰vÃ©nement : Abonnement crÃ©Ã©class SubscriptionCreated implements DomainEvent{ public function __construct( public readonly SubscriptionId $subscriptionId, public readonly PlanId $planId, public readonly CustomerId $customerId, public readonly DateTime $createdAt, public readonly BillingCycle $billingCycle ) {}}// Ã‰vÃ©nement : Abonnement activÃ©class SubscriptionActivated implements DomainEvent{ public function __construct( public readonly SubscriptionId $subscriptionId, public readonly DateTime $activatedAt, public readonly DateTime $nextBillingDate ) {}}// Ã‰vÃ©nement : Paiement traitÃ©class PaymentProcessed implements DomainEvent{ public function __construct( public readonly SubscriptionId $subscriptionId, public readonly PaymentId $paymentId, public readonly Amount $amount, public readonly DateTime $processedAt ) {}}// Ã‰vÃ©nement : Abonnement suspenduclass SubscriptionSuspended implements DomainEvent{ public function __construct( public readonly SubscriptionId $subscriptionId, public readonly string $reason, public readonly DateTime $suspendedAt ) {}}</code>#### <strong>Reconstruction de l&rsquo;Ã‰tat</strong><code>phpclass Subscription{ private SubscriptionId $id; private SubscriptionStatus $status; private ?DateTime $nextBillingDate; private array $payments = []; public static function fromEvents(array $events): self { $subscription = new self(); foreach ($events as $event) { $subscription->apply($event); } return $subscription; } private function apply(DomainEvent $event): void { match ($event::class) { SubscriptionCreated::class => $this->applySubscriptionCreated($event), SubscriptionActivated::class => $this->applySubscriptionActivated($event), PaymentProcessed::class => $this->applyPaymentProcessed($event), SubscriptionSuspended::class => $this->applySubscriptionSuspended($event), }; } private function applySubscriptionCreated(SubscriptionCreated $event): void { $this->id = $event->subscriptionId; $this->status = SubscriptionStatus::PENDING; $this->nextBillingDate = $event->createdAt->add($event->billingCycle->interval()); } private function applySubscriptionActivated(SubscriptionActivated $event): void { $this->status = SubscriptionStatus::ACTIVE; $this->nextBillingDate = $event->nextBillingDate; } private function applyPaymentProcessed(PaymentProcessed $event): void { $this->payments[] = $event->paymentId; $this->nextBillingDate = $this->nextBillingDate->add($this->billingCycle->interval()); } private function applySubscriptionSuspended(SubscriptionSuspended $event): void { $this->status = SubscriptionStatus::SUSPENDED; }}</code>## ğŸ¯ <strong>Avantages de l&rsquo;Event Sourcing</strong>### <strong>1. TraÃ§abilitÃ© ComplÃ¨te</strong>- <strong>Historique complet</strong> : Tous les changements sont enregistrÃ©s- <strong>Audit trail</strong> : Qui a fait quoi et quand- <strong>Debugging</strong> : PossibilitÃ© de rejouer l&rsquo;historique### <strong>2. FlexibilitÃ© Temporelle</strong>- <strong>Time travel</strong> : Voir l&rsquo;Ã©tat Ã  n&rsquo;importe quel moment- <strong>Replay</strong> : Rejouer les Ã©vÃ©nements pour tester- <strong>Debugging</strong> : Comprendre comment on est arrivÃ© Ã  un Ã©tat### <strong>3. Ã‰volutivitÃ©</strong>- <strong>Nouvelles projections</strong> : CrÃ©er de nouvelles vues sans modifier le code existant- <strong>Migration</strong> : Faciliter les migrations de donnÃ©es- <strong>Analytics</strong> : Analyser l&rsquo;historique des Ã©vÃ©nements### <strong>4. CohÃ©rence Ã‰vÃ©nementielle</strong>- <strong>Source de vÃ©ritÃ© unique</strong> : Les Ã©vÃ©nements sont la seule source de vÃ©ritÃ©- <strong>IntÃ©gritÃ©</strong> : Impossible de corrompre l&rsquo;historique- <strong>RÃ©conciliation</strong> : PossibilitÃ© de dÃ©tecter les incohÃ©rences## ğŸ”§ <strong>ImplÃ©mentation dans Gyroscops</strong>### <strong>Structure des Dossiers</strong><code>src/Accounting/â”œâ”€â”€ Domain/â”‚ â”œâ”€â”€ Events/â”‚ â”‚ â”œâ”€â”€ SubscriptionCreated.phpâ”‚ â”‚ â”œâ”€â”€ SubscriptionActivated.phpâ”‚ â”‚ â”œâ”€â”€ PaymentProcessed.phpâ”‚ â”‚ â””â”€â”€ SubscriptionSuspended.phpâ”‚ â”œâ”€â”€ Subscription.phpâ”‚ â””â”€â”€ EventStore.phpâ”œâ”€â”€ Infrastructure/â”‚ â”œâ”€â”€ EventStore/â”‚ â”‚ â”œâ”€â”€ DoctrineEventStore.phpâ”‚ â”‚ â””â”€â”€ EventStoreRepository.phpâ”‚ â””â”€â”€ Projections/â”‚ â”œâ”€â”€ SubscriptionProjection.phpâ”‚ â””â”€â”€ PaymentProjection.phpâ””â”€â”€ Application/ â”œâ”€â”€ Command/ â”‚ â””â”€â”€ ActivateSubscription/ â””â”€â”€ Query/ â””â”€â”€ GetSubscriptionHistory/</code>### <strong>Event Store</strong><code>phpinterface EventStore{ public function append(StreamId $streamId, array $events, int $expectedVersion): void; public function getEvents(StreamId $streamId): array; public function getEventsFromVersion(StreamId $streamId, int $fromVersion): array;}class DoctrineEventStore implements EventStore{ public function append(StreamId $streamId, array $events, int $expectedVersion): void { $this->entityManager->transactional(function () use ($streamId, $events, $expectedVersion) { // VÃ©rifier la version attendue $currentVersion = $this->getCurrentVersion($streamId); if ($currentVersion !== $expectedVersion) { throw new ConcurrencyException('Version mismatch'); } // Enregistrer les Ã©vÃ©nements foreach ($events as $event) { $this->persistEvent($streamId, $event); } }); } public function getEvents(StreamId $streamId): array { return $this->eventRepository->findByStreamId($streamId); }}</code>### <strong>Projections</strong><code>phpclass SubscriptionProjection{ public function __construct( private SubscriptionQueryRepository $queryRepository ) {} public function handle(DomainEvent $event): void { match ($event::class) { SubscriptionCreated::class => $this->handleSubscriptionCreated($event), SubscriptionActivated::class => $this->handleSubscriptionActivated($event), PaymentProcessed::class => $this->handlePaymentProcessed($event), }; } private function handleSubscriptionCreated(SubscriptionCreated $event): void { $this->queryRepository->createSubscriptionView( $event->subscriptionId, $event->planId, $event->customerId, SubscriptionStatus::PENDING, $event->createdAt ); } private function handleSubscriptionActivated(SubscriptionActivated $event): void { $this->queryRepository->updateSubscriptionStatus( $event->subscriptionId, SubscriptionStatus::ACTIVE, $event->nextBillingDate ); }}</code>## ğŸš€ <strong>Patterns AvancÃ©s avec Event Sourcing</strong>### <strong>1. Snapshots</strong><code>phpclass SubscriptionSnapshot{ public function __construct( public readonly SubscriptionId $id, public readonly SubscriptionStatus $status, public readonly DateTime $nextBillingDate, public readonly int $version ) {}}class SnapshotService{ public function createSnapshot(Subscription $subscription): SubscriptionSnapshot { return new SubscriptionSnapshot( $subscription->id(), $subscription->status(), $subscription->nextBillingDate(), $subscription->version() ); } public function restoreFromSnapshot(SubscriptionSnapshot $snapshot, array $events): Subscription { $subscription = Subscription::fromSnapshot($snapshot); // Appliquer seulement les Ã©vÃ©nements aprÃ¨s le snapshot $eventsAfterSnapshot = array_filter( $events, fn($event) => $event->version() > $snapshot->version ); foreach ($eventsAfterSnapshot as $event) { $subscription->apply($event); } return $subscription; }}</code>### <strong>2. Event Sourcing + CQRS</strong>- <strong>Command Side</strong> : GÃ¨re les Ã©vÃ©nements et l&rsquo;event store- <strong>Query Side</strong> : Lit depuis les projections### <strong>3. Event Sourcing + API Platform</strong>- <strong>Ressources</strong> : Exposer les Ã©vÃ©nements via l&rsquo;API- <strong>Validation</strong> : Valider les Ã©vÃ©nements avant stockage## âš¡ <strong>Performance et Optimisation</strong>### <strong>Optimisations de l&rsquo;Event Store</strong>- <strong>Indexation</strong> : Index sur stream_id et version- <strong>Partitioning</strong> : Partitionner par stream_id- <strong>Compression</strong> : Compresser les anciens Ã©vÃ©nements### <strong>Optimisations des Projections</strong>- <strong>Snapshots</strong> : CrÃ©er des snapshots rÃ©guliers- <strong>Projections asynchrones</strong> : Traiter les projections en arriÃ¨re-plan- <strong>Cache</strong> : Mettre en cache les projections frÃ©quentes## ğŸ¯ <strong>Quand Utiliser l&rsquo;Event Sourcing ?</strong>### <strong>âœ… Cas d&rsquo;Usage AppropriÃ©s</strong>- <strong>Audit critique</strong> : Besoin de traÃ§abilitÃ© complÃ¨te- <strong>Compliance</strong> : RÃ©glementations strictes- <strong>Analytics</strong> : Besoin d&rsquo;analyser l&rsquo;historique- <strong>Debugging complexe</strong> : SystÃ¨mes complexes Ã  dÃ©boguer### <strong>âŒ Cas d&rsquo;Usage InappropriÃ©s</strong>- <strong>Applications simples</strong> : CRUD basique- <strong>Performance critique</strong> : Besoins de performance extrÃªme- <strong>Ã‰quipe inexpÃ©rimentÃ©e</strong> : ComplexitÃ© Ã©levÃ©e- <strong>Prototypage</strong> : DÃ©veloppement rapide## ğŸ”„ <strong>Migration vers Event Sourcing</strong>### <strong>Ã‰tape 1 : Identifier les Ã‰vÃ©nements MÃ©tier</strong>- Lister tous les changements d&rsquo;Ã©tat- Grouper par contexte mÃ©tier### <strong>Ã‰tape 2 : CrÃ©er l&rsquo;Event Store</strong>- Choisir la technologie de stockage- ImplÃ©menter les interfaces### <strong>Ã‰tape 3 : Migrer les AgrÃ©gats</strong>- Convertir les entitÃ©s en Ã©vÃ©nements- ImplÃ©menter la reconstruction### <strong>Ã‰tape 4 : CrÃ©er les Projections</strong>- CrÃ©er les vues de lecture- ImplÃ©menter la synchronisation## ğŸ“Š <strong>MÃ©triques et Monitoring</strong>### <strong>MÃ©triques Event Store</strong>- Nombre d&rsquo;Ã©vÃ©nements par seconde- Taille des streams- Temps de reconstruction### <strong>MÃ©triques Projections</strong>- DÃ©lai de traitement des Ã©vÃ©nements- Taille des projections- Performance des requÃªtes## ğŸ¯ <strong>Prochaines Ã‰tapes</strong>Maintenant que vous comprenez l&rsquo;Event Sourcing, explorez :1. <strong><a href=/concept/cqrs/>CQRS</a></strong> : SÃ©parer les commandes des requÃªtes2. <strong><a href=/concept/repositories/>Repositories</a></strong> : Patterns de persistance3. <strong><a href=/chapitres/optionnels/chapitre-11-event-sourcing/>ImplÃ©mentation Event Sourcing</a></strong> : Guide d&rsquo;implÃ©mentation complet&mdash;<em>Event Sourcing transforme la faÃ§on dont nous pensons la persistance. Dans Gyroscops, il nous a permis de gÃ©rer la complexitÃ© mÃ©tier tout en gardant une traÃ§abilitÃ© complÃ¨te de tous les changements.</em> <a href=#-quest-ce-que-levent-sourcing-event-sourcing-est-un-pattern-architectural-qui-stocke-les-%c3%a9v%c3%a9nements-m%c3%a9tier-comme-source-de-v%c3%a9rit%c3%a9-plut%c3%b4t-que-l%c3%a9tat-actuel-des-entit%c3%a9s-le-principe-fondamental-l%c3%a9tat-dune-entit%c3%a9-est-la-cons%c3%a9quence-de-tous-les-%c3%a9v%c3%a9nements-qui-lui-sont-arriv%c3%a9sau-lieu-de-stocker-l%c3%a9tat-actuel-on-stocke---tous-les-%c3%a9v%c3%a9nements-qui-ont-modifi%c3%a9-lentit%c3%a9--l-de-ces-%c3%a9v%c3%a9nements--les-m%c3%a9tadonn%c3%a9es-associ%c3%a9es-%c3%a0-chaque-%c3%a9v%c3%a9nement--event-sourcing-dans-gyroscops-contexte-m%c3%a9tier--gestion-des-abonnementsdans-gyroscops-un-abonnement-passe-par-plusieurs-%c3%a9tats--%c3%a9v%c3%a9nements-m%c3%a9tierphp-%c3%a9v%c3%a9nement--abonnement-cr%c3%a9%c3%a9class-subscriptioncreated-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-planid-planid--------public-readonly-customerid-customerid--------public-readonly-datetime-createdat--------public-readonly-billingcycle-billingcycle------%c3%a9v%c3%a9nement--abonnement-activ%c3%a9class-subscriptionactivated-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-datetime-activatedat--------public-readonly-datetime-nextbillingdate------%c3%a9v%c3%a9nement--paiement-trait%c3%a9class-paymentprocessed-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-paymentid-paymentid--------public-readonly-amount-amount--------public-readonly-datetime-processedat------%c3%a9v%c3%a9nement--abonnement-suspenduclass-subscriptionsuspended-implements-domainevent----public-function-__construct--------public-readonly-subscriptionid-subscriptionid--------public-readonly-string-reason--------public-readonly-datetime-suspendedat------reconstruction-de-lphpclass-subscription----private-subscriptionid-id----private-subscriptionstatus-status----private-datetime-nextbillingdate----private-array-payments----------public-static-function-fromeventsarray-events-self------------subscription--new-self----------------foreach-events-as-event-------------subscription-applyevent------------------------return-subscription------------private-function-applydomainevent-event-void------------match-eventclass-------------subscriptioncreatedclass--this-applysubscriptioncreatedevent------------subscriptionactivatedclass--this-applysubscriptionactivatedevent------------paymentprocessedclass--this-applypaymentprocessedevent------------subscriptionsuspendedclass--this-applysubscriptionsuspendedevent--------------------private-function-applysubscriptioncreatedsubscriptioncreated-event-void------------this-id--event-subscriptionid--------this-status--subscriptionstatuspending--------this-nextbillingdate--event-createdat-addevent-billingcycle-interval------------private-function-applysubscriptionactivatedsubscriptionactivated-event-void------------this-status--subscriptionstatusactive--------this-nextbillingdate--event-nextbillingdate------------private-function-applypaymentprocessedpaymentprocessed-event-void------------this-payments--event-paymentid--------this-nextbillingdate--this-nextbillingdate-addthis-billingcycle-interval------------private-function-applysubscriptionsuspendedsubscriptionsuspended-event-void------------this-status--subscriptionstatussuspended------avantages-de-l-1-tra%c3%a7abilit%c3%a9-compl%c3%a8te--historique-complet--tous-les-changements-sont-enregistr%c3%a9s--audit-trail--qui-a-fait-quoi-et-quand--debugging--possibilit%c3%a9-de-rejouer-lhistorique-2-flexibilit%c3%a9-temporelle--time-travel--voir-l%c3%a9tat-%c3%a0-nimporte-quel-moment--replay--rejouer-les-%c3%a9v%c3%a9nements-pour-tester--debugging--comprendre-comment-on-est-arriv%c3%a9-%c3%a0-un-%c3%a9tat-3-%c3%a9volutivit%c3%a9--nouvelles-projections--cr%c3%a9er-de-nouvelles-vues-sans-modifier-le-code-existant--migration--faciliter-les-migrations-de-donn%c3%a9es--analytics--analyser-lhistorique-des-%c3%a9v%c3%a9nements-4-coh%c3%a9rence-%c3%a9v%c3%a9nementielle--source-de-v%c3%a9rit%c3%a9-unique--les-%c3%a9v%c3%a9nements-sont-la-seule-source-de-v%c3%a9rit%c3%a9--int%c3%a9grit%c3%a9--impossible-de-corrompre-lhistorique--r%c3%a9conciliation--possibilit%c3%a9-de-d%c3%a9tecter-les-incoh%c3%a9rences--impl%c3%a9mentation-dans-gyroscops-structure-des-dossierssrcaccounting-domain----events-------subscriptioncreatedphp-------subscriptionactivatedphp-------paymentprocessedphp-------subscriptionsuspendedphp----subscriptionphp----eventstorephp-infrastructure----eventstore-------doctrineeventstorephp-------eventstorerepositoryphp----projections--------subscriptionprojectionphp--------paymentprojectionphp-application-----command--------activatesubscription-----query---------getsubscriptionhistory-event-storephpinterface-eventstore----public-function-appendstreamid-streamid-array-events-int-expectedversion-void----public-function-geteventsstreamid-streamid-array----public-function-geteventsfromversionstreamid-streamid-int-fromversion-arrayclass-doctrineeventstore-implements-eventstore----public-function-appendstreamid-streamid-array-events-int-expectedversion-void------------this-entitymanager-transactionalfunction--use-streamid-events-expectedversion--------------v%c3%a9rifier-la-version-attendue------------currentversion--this-getcurrentversionstreamid------------if-currentversion--expectedversion-----------------throw-new-concurrencyexceptionversion-mismatch-------------------------------------enregistrer-les-%c3%a9v%c3%a9nements------------foreach-events-as-event-----------------this-persisteventstreamid-event--------------------------------public-function-geteventsstreamid-streamid-array------------return-this-eventrepository-findbystreamidstreamid-----projectionsphpclass-subscriptionprojection----public-function-__construct--------private-subscriptionqueryrepository-queryrepository-------------public-function-handledomainevent-event-void------------match-eventclass-------------subscriptioncreatedclass--this-handlesubscriptioncreatedevent------------subscriptionactivatedclass--this-handlesubscriptionactivatedevent------------paymentprocessedclass--this-handlepaymentprocessedevent--------------------private-function-handlesubscriptioncreatedsubscriptioncreated-event-void------------this-queryrepository-createsubscriptionview------------event-subscriptionid------------event-planid------------event-customerid------------subscriptionstatuspending------------event-createdat--------------------private-function-handlesubscriptionactivatedsubscriptionactivated-event-void------------this-queryrepository-updatesubscriptionstatus------------event-subscriptionid------------subscriptionstatusactive------------event-nextbillingdate--------------patterns-avanc%c3%a9s-avec-event-sourcing-1-snapshotsphpclass-subscriptionsnapshot----public-function-__construct--------public-readonly-subscriptionid-id--------public-readonly-subscriptionstatus-status--------public-readonly-datetime-nextbillingdate--------public-readonly-int-version-----class-snapshotservice----public-function-createsnapshotsubscription-subscription-subscriptionsnapshot------------return-new-subscriptionsnapshot------------subscription-id------------subscription-status------------subscription-nextbillingdate------------subscription-version--------------------public-function-restorefromsnapshotsubscriptionsnapshot-snapshot-array-events-subscription------------subscription--subscriptionfromsnapshotsnapshot-----------------appliquer-seulement-les-%c3%a9v%c3%a9nements-apr%c3%a8s-le-snapshot--------eventsaftersnapshot--array_filter------------events------------fnevent--event-version--snapshot-version------------------------foreach-eventsaftersnapshot-as-event-------------subscription-applyevent------------------------return-subscription-----2-event-sourcing--cqrs--command-side--g%c3%a8re-les-%c3%a9v%c3%a9nements-et-levent-store--query-side--lit-depuis-les-projections-3-event-sourcing--api-platform--ressources--exposer-les-%c3%a9v%c3%a9nements-via-lapi--validation--valider-les-%c3%a9v%c3%a9nements-avant-stockage--performance-et-optimisation-optimisations-de-l--indexation--index-sur-stream_id-et-version--partitioning--partitionner-par-stream_id--compression--compresser-les-anciens-%c3%a9v%c3%a9nements-optimisations-des-projections--snapshots--cr%c3%a9er-des-snapshots-r%c3%a9guliers--projections-asynchrones--traiter-les-projections-en-arri%c3%a8re-plan--cache--mettre-en-cache-les-projections-fr%c3%a9quentes--quand-utiliser-l--cas-d--audit-critique--besoin-de-tra%c3%a7abilit%c3%a9-compl%c3%a8te--compliance--r%c3%a9glementations-strictes--analytics--besoin-danalyser-lhistorique--debugging-complexe--syst%c3%a8mes-complexes-%c3%a0-d%c3%a9boguer--cas-d--applications-simples--crud-basique--performance-critique--besoins-de-performance-extr%c3%aame--%c3%a9quipe-inexp%c3%a9riment%c3%a9e--complexit%c3%a9-%c3%a9lev%c3%a9e--prototypage--d%c3%a9veloppement-rapide--migration-vers-event-sourcing-%c3%a9tape-1--identifier-les-%c3%a9v%c3%a9nements-m%c3%a9tier--lister-tous-les-changements-d%c3%a9tat--grouper-par-contexte-m%c3%a9tier-%c3%a9tape-2--cr%c3%a9er-l--choisir-la-technologie-de-stockage--impl%c3%a9menter-les-interfaces-%c3%a9tape-3--migrer-les-agr%c3%a9gats--convertir-les-entit%c3%a9s-en-%c3%a9v%c3%a9nements--impl%c3%a9menter-la-reconstruction-%c3%a9tape-4--cr%c3%a9er-les-projections--cr%c3%a9er-les-vues-de-lecture--impl%c3%a9menter-la-synchronisation--m%c3%a9triques-et-monitoring-m%c3%a9triques-event-store--nombre-d%c3%a9v%c3%a9nements-par-seconde--taille-des-streams--temps-de-reconstruction-m%c3%a9triques-projections--d%c3%a9lai-de-traitement-des-%c3%a9v%c3%a9nements--taille-des-projections--performance-des-requ%c3%aates--prochaines-%c3%a9tapesmaintenant-que-vous-comprenez-levent-sourcing-explorez-1-cqrs--s%c3%a9parer-les-commandes-des-requ%c3%aates2-repositories--patterns-de-persistance3-impl%c3%a9mentation-event-sourcing--guide-dimpl%c3%a9mentation-completevent-sourcing-transforme-la-fa%c3%a7on-dont-nous-pensons-la-persistance-dans-gyroscops-il-nous-a-permis-de-g%c3%a9rer-la-complexit%c3%a9-m%c3%a9tier-tout-en-gardant-une-tra%c3%a7abilit%c3%a9-compl%c3%a8te-de-tous-les-changements class=anchor aria-hidden=true><i class="material-icons align-middle">link</i></a></h2></div></div><div><hr class=doc-hr><div id=doc-nav class=d-print-none><div class="row flex-xl-nowrap"><div class="col-sm-6 pt-2 doc-next"><a href=/patterns/cqrs/><div class="card h-100 my-1"><div class="card-body py-2"><p class="card-title fs-5 fw-semibold lh-base mb-0"><i class="material-icons align-middle">navigate_before</i> CQRS - Command Query Responsibility Segregation</p></div></div></a></div><div class="col-sm-6 pt-2 doc-prev"><a class=ms-auto href=/patterns/repositories/><div class="card h-100 my-1 text-end"><div class="card-body py-2"><p class="card-title fs-5 fw-semibold lh-base mb-0">Repositories - Patterns de Persistance <i class="material-icons align-middle">navigate_next</i></p></div></div></a></div></div></div></div></div></div></div></div><footer class="shadow py-3 d-print-none"><div class=container-fluid><div class="row align-items-center"><div class=col><div class="text-sm-start text-center mx-md-2"><p class=mb-0>Â© 2025 GrÃ©gory Planchat. Tous droits rÃ©servÃ©s.</p></div></div></div><div class="row mt-3 pt-3 border-top"><div class=col-12><div class=text-center><h6 class="text-muted mb-2">Nos Sponsors</h6><p class="text-muted small mb-2">Merci Ã  nos partenaires qui soutiennent cette initiative</p><div class="d-flex justify-content-center align-items-center flex-wrap gap-3"><div class=sponsor-item><a href=https://kiboko.fr target=_blank rel="noopener noreferrer" class="text-decoration-none d-inline-block"><img src=/logo-kiboko-fr.svg alt=Kiboko width=120 height=60 style=display:block;max-width:120px;height:auto></a></div><div class=sponsor-item><a href=https://gyroscops.com target=_blank rel="noopener noreferrer" class="text-decoration-none d-inline-block"><img src=/logo-gyroscops.svg alt=Gyroscops width=120 height=60 style=display:block;max-width:120px;height:auto></a></div></div></div></div></div></div></footer></main></div></div><button onclick=topFunction() id=back-to-top aria-label="Back to Top Button" class="back-to-top fs-5"><svg width="24" height="24"><path d="M12 10.224l-6.3 6.3-1.38-1.372L12 7.472l7.68 7.68-1.38 1.376z" style="fill:#fff"/></svg></button>
<script src=/docs/js/bootstrap.c7927bdd82eceb076739257add3f4b0e11379da037c07d5c7110daeb6de0e3edcb2de867604550f88815157e4ec4ddb7.js integrity=sha384-x5J73YLs6wdnOSV63T9LDhE3naA3wH1ccRDa623g4+3LLehnYEVQ+IgVFX5OxN23 defer></script><script type=text/javascript src=https://votre-domaine.fr/docs/js/bundle.min.a046e72674401a45bf99217648934a99ff03a7c46d105e47916156e66969388a0643f55a1e850acb495c9bd8be985171.js integrity=sha384-oEbnJnRAGkW/mSF2SJNKmf8Dp8RtEF5HkWFW5mlpOIoGQ/VaHoUKy0lcm9i+mFFx crossorigin=anonymous defer></script><script type=module>
    var suggestions = document.getElementById('suggestions');
    var search = document.getElementById('flexsearch');

    const flexsearchContainer = document.getElementById('FlexSearchCollapse');

    const hideFlexsearchBtn = document.getElementById('hideFlexsearch');

    const configObject = { toggle: false }
    const flexsearchContainerCollapse = new Collapse(flexsearchContainer, configObject) 

    if (search !== null) {
        document.addEventListener('keydown', inputFocus);
        flexsearchContainer.addEventListener('shown.bs.collapse', function () {
            search.focus();
        });
        
        var topHeader = document.getElementById("top-header");
        document.addEventListener('click', function(elem) {
            if (!flexsearchContainer.contains(elem.target) && !topHeader.contains(elem.target))
                flexsearchContainerCollapse.hide();
        });
    }

    hideFlexsearchBtn.addEventListener('click', () =>{
        flexsearchContainerCollapse.hide()
    })

    function inputFocus(e) {
        if (e.ctrlKey && e.key === '/') {
            e.preventDefault();
            flexsearchContainerCollapse.toggle();
        }
        if (e.key === 'Escape' ) {
            search.blur();
            
            flexsearchContainerCollapse.hide();
        }
    };

    document.addEventListener('click', function(event) {

    var isClickInsideElement = suggestions.contains(event.target);

    if (!isClickInsideElement) {
        suggestions.classList.add('d-none');
    }

    });

    


    document.addEventListener('keydown',suggestionFocus);

    function suggestionFocus(e) {
    const suggestionsHidden = suggestions.classList.contains('d-none');
    if (suggestionsHidden) return;

    const focusableSuggestions= [...suggestions.querySelectorAll('a')];
    if (focusableSuggestions.length === 0) return;

    const index = focusableSuggestions.indexOf(document.activeElement);

    if (e.key === "ArrowUp") {
        e.preventDefault();
        const nextIndex = index > 0 ? index - 1 : 0;
        focusableSuggestions[nextIndex].focus();
    }
    else if (e.key === "ArrowDown") {
        e.preventDefault();
        const nextIndex= index + 1 < focusableSuggestions.length ? index + 1 : index;
        focusableSuggestions[nextIndex].focus();
    }

    }

    


    (function(){

    var index = new FlexSearch.Document({
        
        tokenize: "forward",
        minlength:  0 ,
        cache:  100 ,
        optimize:  true ,
        document: {
        id: 'id',
        store: [
            "href", "title", "description"
        ],
        index: ["title", "description", "content"]
        }
    });


    


    
    


    

    

    search.addEventListener('input', show_results, true);

    function show_results(){
        const maxResult =  5 ;
        const minlength =  0 ;
        var searchQuery = sanitizeHTML(this.value);
        var results = index.search(searchQuery, {limit: maxResult, enrich: true});

        
        const flatResults = new Map(); 
        for (const result of results.flatMap(r => r.result)) {
        if (flatResults.has(result.doc.href)) continue;
        flatResults.set(result.doc.href, result.doc);
        }

        suggestions.innerHTML = "";
        suggestions.classList.remove('d-none');

        
        if (searchQuery.length < minlength) {
            const minCharMessage = document.createElement('div')
            minCharMessage.innerHTML = `Please type at least <strong>${minlength}</strong> characters`
            minCharMessage.classList.add("suggestion__no-results");
            suggestions.appendChild(minCharMessage);
            return;
        } else {
            
            if (flatResults.size === 0 && searchQuery) {
                const noResultsMessage = document.createElement('div')
                noResultsMessage.innerHTML = "No results for" + ` "<strong>${searchQuery}</strong>"`
                noResultsMessage.classList.add("suggestion__no-results");
                suggestions.appendChild(noResultsMessage);
                return;
            }
        }

        
        for(const [href, doc] of flatResults) {
            const entry = document.createElement('div');
            suggestions.appendChild(entry);

            const a = document.createElement('a');
            a.href = href;
            entry.appendChild(a);

            const title = document.createElement('span');
            title.textContent = doc.title;
            title.classList.add("suggestion__title");
            a.appendChild(title);

            const description = document.createElement('span');
            description.textContent = doc.description;
            description.classList.add("suggestion__description");
            a.appendChild(description);

            suggestions.appendChild(entry);

            if(suggestions.childElementCount == maxResult) break;
        }
    }
    }());
</script></body></html>